<!DOCTYPE html>
<html lang="tr" class="scroll-smooth">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Hertz Motor — Stok Takip</title>
  <!-- Tailwind (dark mode kaldırıldı) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="theme-color" content="rgb(205,105,40)" />
  <style>
    :root { --brand: 205,105,40; }
    dialog::backdrop { background: rgb(0 0 0 / 0.5); }
    .badge{display:inline-block;padding:.125rem .5rem;border-radius:.5rem;font-size:.75rem}
    .btn-brand{ background: rgb(var(--brand)); color:white; }
    .btn-brand:hover{ filter: brightness(0.95); }
    .no-scrollbar::-webkit-scrollbar{ display:none; }
    .no-scrollbar{ -ms-overflow-style:none; scrollbar-width:none; }
  </style>
</head>
<body class="bg-slate-50 text-slate-800">

<!-- === Simple Login Gate (user: hertz / pass: hertz) === -->
<style>
  #authGate {
    position: fixed; inset: 0; display: none; place-items: center; z-index: 99999;
    background: radial-gradient(1000px 600px at 30% 20%, rgba(205,105,40,.08), transparent 60%) , #0b1220;
    color: #e5e7eb; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  }
  #authCard {
    width: min(380px, 92vw); background: #111827; border: 1px solid #1f2937; border-radius: 14px;
    padding: 22px 22px 16px; box-shadow: 0 10px 40px rgba(0,0,0,.35);
  }
  #authCard h2 { margin: 0 0 8px; font-size: 18px; color: #f3f4f6; }
  #authCard p  { margin: 0 0 16px; font-size: 13px; color: #94a3b8; }
  .row { display: grid; gap: 8px; margin: 10px 0 12px; }
  .row label { font-size: 12px; color: #cbd5e1; }
  .row input {
    font: 14px/1.2 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    padding: 10px 12px; border-radius: 10px; border: 1px solid #303a4a; background:#0f172a; color:#e5e7eb;
  }
  #authBtn {
    width: 100%; padding: 10px 12px; border-radius: 10px; border: 1px solid #cc7a44;
    background: linear-gradient(120deg, #cd6928, #de7a39); color: white; font-weight: 600; cursor: pointer;
  }
  #authErr { min-height: 18px; color: #fca5a5; font-size: 12px; margin-top: 8px; }
  #logoutBtn {
  @apply px-3 py-2 rounded-xl border border-slate-300 bg-white hover:bg-gray-100;
}


</style>
<div id="authGate">
  <div id="authCard">
    <h2>Giriş yap</h2>
    <p>Devam etmek için kullanıcı adı ve şifre girin.</p>
    <form id="authForm">
      <div class="row">
        <label for="authUser">Kullanıcı adı</label>
        <input id="authUser" name="u" autocomplete="username" placeholder="Kullanıcı adı" required>
      </div>
      <div class="row">
        <label for="authPass">Şifre</label>
        <input id="authPass" name="p" type="password" autocomplete="current-password" placeholder="••••••••" required>
      </div>
      <button id="authBtn" type="submit">Giriş</button>

<script>
(function(){
  const USERS = {
    "hertz":   { pass: "hertz", role: "admin" },
    "muhasebe":{ pass: "2",     role: "user"  },
    "imalat1": { pass: "3",     role: "user"  },
    "imalat2": { pass: "4",     role: "user"  },
    "imalat3": { pass: "5",     role: "user"  },
    "imalat4": { pass: "6",     role: "user"  },
    "imalat5": { pass: "7",     role: "user"  },
    "imalat6": { pass: "8",     role: "user"  }
  };
  const KEY  = "auth_ok"; // sessionStorage
  const UN   = "auth_user";
  const RL   = "role";
  const gate = document.getElementById("authGate");
  const form = document.getElementById("authForm");
  const err  = document.getElementById("authErr");
  const getOut = () => document.getElementById("logoutBtn");

  function openGate(){ gate.style.display = "grid"; }
  function closeGate(){
    gate.style.display = "none";
    const _out = getOut(); if (_out) { _out.style.display = "inline-block"; }
    document.dispatchEvent(new Event("auth_ok"));
    applyRoleUI();
  }

  function applyRoleUI(){
    const role = sessionStorage.getItem(RL);
    // 1) Hide clear-all button for non-admins by ID
    const btnById = document.getElementById("btnClearAll");
    if (btnById) btnById.style.display = (role === "admin") ? "" : "none";
    // 2) Hide any button-like element that has text "tüm verileri sil"
    const candidates = document.querySelectorAll("button, a, [role='button'], .btn, .button");
    const norm = s => (s||"").toLowerCase().replace(/\s+/g, " ").trim();
    candidates.forEach(el => {
      const t = norm(el.textContent);
      if (t.includes("tüm verileri sil") || t.includes("tum verileri sil")) {
        if (role !== "admin") el.style.display = "none";
      }
    });
  }

  // Persistent per-tab session
  if (sessionStorage.getItem(KEY) === "1") {
    closeGate();
  } else {
    openGate();
  }

  form.addEventListener("submit", (e)=>{
    e.preventDefault();
    const u = (form.u.value || "").trim();
    const p = form.p.value || "";
    const rec = USERS[u];
    if (rec && p === rec.pass){
      sessionStorage.setItem(KEY, "1");
      sessionStorage.setItem(UN, u);
      sessionStorage.setItem(RL, rec.role);
      closeGate();
    } else {
      err.textContent = "Hatalı kullanıcı adı/şifre";
      form.p.value = "";
    }
  });

  window.addEventListener("load", ()=>{ const _out = getOut(); if (_out) { _out.addEventListener("click", ()=>{
    sessionStorage.removeItem(KEY);
    sessionStorage.removeItem(UN);
    sessionStorage.removeItem(RL);
    location.reload();
  }); }});

  // Apply role once content loads (in case auth_ok fired before areas exist)
  window.addEventListener("load", applyRoleUI);
  document.addEventListener("auth_ok", applyRoleUI);
})();
</script>

      <div id="authErr"></div>
    </form>
  </div>
</div>
<script>
(function(){
  const USER = "hertz";
  const PASS = "hertz";
  const KEY  = "auth_ok"; // sessionStorage
  const gate = document.getElementById("authGate");
  const form = document.getElementById("authForm");
  const err  = document.getElementById("authErr");
  const out  = document.getElementById("logoutBtn");
  let fails = 0;

  function openGate(){ gate.style.display = "grid"; }
  function closeGate(){
    gate.style.display = "none";
    out.style.display = "inline-block";
    document.dispatchEvent(new Event("auth_ok"));
  }

  // Persist only per-tab (sessionStorage). If you want persistent, switch to localStorage.
  if (sessionStorage.getItem(KEY) === "1") { closeGate(); }
  else { openGate(); }

  form.addEventListener("submit", (e)=>{
    e.preventDefault();
    const u = (form.u.value || "").trim();
    const p = form.p.value || "";
    if (u === USER && p === PASS){
      sessionStorage.setItem(KEY, "1");
      closeGate();
    } else {
      fails++;
      err.textContent = "Hatalı kullanıcı adı/şifre";
      form.p.value = "";
      if (fails >= 5){
        err.textContent = "5 başarısız deneme. Lütfen 60 sn sonra tekrar deneyin.";
        form.querySelector("button[type=submit]").disabled = true;
        setTimeout(()=>{ form.querySelector("button[type=submit]").disabled = false; err.textContent=""; fails=0; }, 60000);
      }
    }
  });

  out.addEventListener("click", ()=>{
    sessionStorage.removeItem(KEY);
    location.reload();
  });
})();
</script>
<!-- === /Login Gate === -->


  <header class="sticky top-0 z-10 bg-white/90 backdrop-blur border-b border-slate-200">
    <div class="mx-auto max-w-7xl px-3 md:px-4 py-3 flex items-center gap-3">
      <div class="shrink-0 w-10 h-10 grid place-items-center rounded-2xl text-white font-bold" style="background: rgb(var(--brand))">HM</div>
      <div class="grow min-w-0">
        <h1 class="text-lg md:text-2xl font-semibold truncate">Hertz Motor — Stok Takip</h1>
        <p class="hidden md:block text-xs text-slate-500">Üretim odaklı alanlar • İçe/Dışa aktar • Yerel kayıt</p>
      </div>
      <div class="flex flex-wrap gap-2 items-center">
        <button id="btnAdd" class="px-3 py-2 rounded-xl btn-brand">Ürün Ekle</button>
        <button id="btnImport" class="px-3 py-2 rounded-xl border border-slate-300 bg-white">İçe aktar</button>
        <button id="btnExport" class="px-3 py-2 rounded-xl border border-slate-300 bg-white">Dışa aktar</button>
        <button id="btnExportCSV" class="px-3 py-2 rounded-xl border border-slate-300 bg-white">CSV</button>
        <button id="btnExportLogCSV" class="px-3 py-2 rounded-xl border border-slate-300 bg-white">Log CSV</button>
        <button id="btnClear" class="px-3 py-2 rounded-xl text-white bg-rose-600">Tüm Veriyi Sil</button>
        <button id="logoutBtn" class="px-3 py-2 rounded-xl border border-slate-300 bg-white">Çıkış</button>
      </div>
    </div>
  </header>

  <main class="mx-auto max-w-7xl p-3 md:p-4">
    <!-- Üst araç çubuğu -->
    <div class="flex flex-col md:flex-row gap-2 md:gap-3 items-stretch md:items-center mb-3 md:mb-4">
      <div class="flex items-center gap-2 grow">
        <input id="search" type="search" placeholder="Ara: ad, stok kodu…" class="w-full md:max-w-sm px-3 py-2 rounded-xl border border-slate-300 bg-white" />
        <label class="flex items-center gap-2 text-sm text-slate-600">
          <input id="onlyLow" type="checkbox" class="w-4 h-4"> Sadece kritik stok
        </label>
      </div>
      <div class="text-sm text-slate-500">Kayıt: <span id="count">0</span></div>
    </div>

    <!-- Masaüstü tablo -->
    <div class="hidden md:block overflow-auto rounded-2xl border border-slate-200 bg-white">
      <table class="min-w-full text-sm">
        <thead id="thead" class="bg-slate-100 text-slate-700">
          <tr>
            <th data-sort="sku" class="text-left px-3 py-2 cursor-pointer select-none">Stok Kodu</th>
            <th data-sort="name" class="text-left px-3 py-2 cursor-pointer select-none">Ad</th>
            <th class="text-left px-3 py-2">Tür/Çeşit</th>
            <th data-sort="qty" class="text-right px-3 py-2 cursor-pointer select-none">Stok</th>
            <th data-sort="min" class="text-right px-3 py-2 cursor-pointer select-none">Minimum</th>
            <th class="text-left px-3 py-2">Özellikler</th>
            <th class="text-left px-3 py-2">Not</th>
            <th class="text-right px-3 py-2">İşlemler</th>
          </tr>
        </thead>
        <tbody id="tbodyDesktop" class="divide-y divide-slate-100"></tbody>
      </table>
    </div>

    <!-- Mobil kart liste -->
    <div id="listMobile" class="md:hidden space-y-2"></div>

    <!-- Log -->
    <details class="mt-5 group">
      <summary class="cursor-pointer select-none text-sm text-slate-600 flex items-center gap-2">
        <span class="inline-block w-2 h-2 rounded-full" style="background: rgb(var(--brand))"></span>
        Hareket Geçmişi
      </summary>
      <div class="mt-3 overflow-auto rounded-2xl border border-slate-200 bg-white max-h-[50vh] no-scrollbar">
        <table class="min-w-full text-sm">
          <thead class="bg-slate-100 text-slate-700">
            <tr>
              <th class="text-left px-3 py-2">Tarih</th>
              <th class="text-left px-3 py-2">Ürün</th>
              <th class="text-left px-3 py-2">Tür</th>
              <th class="text-right px-3 py-2">Miktar</th>
              <th class="text-right px-3 py-2">Önce</th>
              <th class="text-right px-3 py-2">Sonra</th>
              <th class="text-left px-3 py-2">Not</th>
              <th class="text-left px-3 py-2">Kullanıcı</th>
            </tr>
          </thead>
          <tbody id="logBody" class="divide-y divide-slate-100"></tbody>
        </table>
      </div>
    </details>
  </main>

  <!-- Ürün formu -->
  <dialog id="productDialog" class="rounded-2xl p-0 w-[96vw] max-w-xl">
    <form id="productForm" class="p-4" novalidate>
      <h3 id="productDialogTitle" class="text-lg font-semibold mb-4">Ürün Ekle</h3>
      <div class="grid md:grid-cols-2 gap-3">
        <div>
          <label class="text-sm text-slate-600">Ürün Türü</label>
          <select name="kind" id="kind" class="w-full px-3 py-2 rounded-xl border border-slate-300">
            <option value="mamul">Mamul</option>
            <option value="yari">Yarı-mamul</option>
            <option value="ham">Hammadde</option>
          </select>
        </div>
        <div>
          <label class="text-sm text-slate-600">Ürün Çeşidi</label>
          <select name="category" id="category" class="w-full px-3 py-2 rounded-xl border border-slate-300">
            <option value="stator">Stator</option>
            <option value="rotor">Rotor</option>
            <option value="mil">Mil</option>
            <option value="rotorluMil">Rotorlu Mil</option>
            <option value="taslanmisMil">Taşlanmış Mil</option>
            <option value="sargiliPaket">Sargılı Paket</option>
            <option value="paketliGovde">Paketli Gövde</option>
            <option value="motor">Motor</option>
          
            
            
            
            <option value="yardimci_parcalar">Yardımcı Parçalar</option><option value="aluminyum_govde">Alüminyum Gövde</option><option value="rulman">Rulman</option><option value="kapak">Kapak</option>
            <option value="islenmisKapak">İşlenmiş Kapak</option>
            <option value="taslanmisKapak">Taşlanmış Kapak</option></select>
        </div>
        <div class="md:col-span-2">
          <label class="text-sm text-slate-600">Ad</label>
          <input name="name" type="text" required class="w-full px-3 py-2 rounded-xl border border-slate-300" />
        </div>
        <div>
          <label class="text-sm text-slate-600">Stok Kodu</label>
          <div class="flex gap-2">
            <input name="sku" id="sku" type="text" required class="w-full px-3 py-2 rounded-xl border border-slate-300" />
            <button id="btnAutoSku" type="button" class="px-3 py-2 rounded-xl border border-slate-300">Oluştur</button>
          </div>
          <p class="text-xs text-slate-500 mt-1">Ürün çeşidine göre otomatik kod önerilir. Dilersen düzenleyebilirsin.</p>
        </div>
        <div>
          <label class="text-sm text-slate-600">Birim</label>
          <input name="unit" type="text" placeholder="adet, kg, m…" class="w-full px-3 py-2 rounded-xl border border-slate-300" />
        </div>
        <div>
          <label class="text-sm text-slate-600">Minimum Stok</label>
          <input name="min" type="number" step="any" value="0" class="w-full px-3 py-2 rounded-xl border border-slate-300" />
        </div>
        <div class="md:col-span-2">
          <label class="text-sm text-slate-600">Not</label>
          <input name="note" type="text" class="w-full px-3 py-2 rounded-xl border border-slate-300" />
        </div>

        <!-- Koşullu alanlar -->
        <div data-section="sargiliPaket" class="md:col-span-2 hidden">
          <div class="grid md:grid-cols-3 gap-3">
            <div>
              <label class="text-sm text-slate-600">kW</label>
              <input name="kw" type="number" step="any" class="w-full px-3 py-2 rounded-xl border border-slate-300" />
            </div>
            <div>
              <label class="text-sm text-slate-600">Devir (rpm)</label>
              <input name="rpm" type="number" step="1" class="w-full px-3 py-2 rounded-xl border border-slate-300" />
            </div>
            <div>
              <label class="text-sm text-slate-600">Voltaj (V)</label>
              <input name="volt" type="number" step="1" class="w-full px-3 py-2 rounded-xl border border-slate-300" />
            </div>
          </div>
        </div>

        <div data-section="paketliGovde" class="md:col-span-2 hidden">
          <div class="grid md:grid-cols-3 gap-3">
            <div>
              <label class="text-sm text-slate-600">Devir (rpm)</label>
              <input name="pg_rpm" type="number" step="1" class="w-full px-3 py-2 rounded-xl border border-slate-300" />
            </div>
            <div>
              <label class="text-sm text-slate-600">kW</label>
              <input name="pg_kw" type="number" step="any" class="w-full px-3 py-2 rounded-xl border border-slate-300" />
            </div>
            <div>
              <label class="text-sm text-slate-600">Voltaj (V)</label>
              <input name="pg_volt" type="number" step="1" class="w-full px-3 py-2 rounded-xl border border-slate-300" />
            </div>
          </div>
          <div class="grid md:grid-cols-2 gap-3 mt-3">
            <div>
              <label class="text-sm text-slate-600">Müşteri</label>
              <input name="pg_customer" type="text" class="w-full px-3 py-2 rounded-xl border border-slate-300" />
            </div>
            <div>
              <label class="text-sm text-slate-600">Bağlantı Tipi</label>
              <select name="pg_conn" class="w-full px-3 py-2 rounded-xl border border-slate-300">
                <option value="soketli">Soketli</option>
                <option value="duz">Düz klemensli</option>
                <option value="ters">Ters klemensli</option>
                <option value="ykr">YKR</option>
                <option value="ykl">YKL</option>
              </select>
            </div>
          </div>
        </div>

        <div data-section="mil" class="md:col-span-2 hidden">
          <label class="text-sm text-slate-600">Mil Kodu</label>
          <input name="milCode" type="text" class="w-full px-3 py-2 rounded-xl border border-slate-300" />
        </div>

        <div data-section="motor" class="md:col-span-2 hidden">
          <div class="grid md:grid-cols-3 gap-3">
            <div>
              <label class="text-sm text-slate-600">Müşteri</label>
              <input name="customer" type="text" class="w-full px-3 py-2 rounded-xl border border-slate-300" />
            </div>
            <div>
              <label class="text-sm text-slate-600">Devir (rpm)</label>
              <input name="m_rpm" type="number" step="1" class="w-full px-3 py-2 rounded-xl border border-slate-300" />
            </div>
            <div>
              <label class="text-sm text-slate-600">kW</label>
              <input name="m_kw" type="number" step="any" class="w-full px-3 py-2 rounded-xl border border-slate-300" />
            </div>
            <div>
              <label class="text-sm text-slate-600">Voltaj (V)</label>
              <input name="m_volt" type="number" step="1" class="w-full px-3 py-2 rounded-xl border border-slate-300" />
            </div>
            <div>
              <label class="text-sm text-slate-600">Bağlantı Tipi</label>
              <select name="m_conn" class="w-full px-3 py-2 rounded-xl border border-slate-300">
                <option value="soketli">Soketli</option>
                <option value="duz">Düz klemensli</option>
                <option value="ters">Ters klemensli</option>
                <option value="ykr">YKR</option>
                <option value="ykl">YKL</option>
              </select>
            </div>
            <div>
              <label class="text-sm text-slate-600">Mil Tipi</label>
              <input name="milType" type="text" placeholder="Örn: DIN 6885" class="w-full px-3 py-2 rounded-xl border border-slate-300" />
            
            </div>
            <div>
              <label class="text-sm text-slate-600">Kapak Çeşidi</label>
              <select name="m_cover" class="w-full px-3 py-2 rounded-xl border border-slate-300">
                <option value="AK">AK</option>
                <option value="CK">CK</option>
                <option value="CK/CR">CK/CR</option>
              </select>
            </div>
</div>
          </div>
        </div>
      </div>
      <div class="mt-5 flex justify-end gap-2">
        <button id="productCancelBtn" type="button" class="px-3 py-2 rounded-xl border border-slate-300 bg-white">Vazgeç</button>
        <button id="productSaveBtn" type="submit" class="px-3 py-2 rounded-xl btn-brand">Kaydet</button>
      </div>
      <input type="hidden" name="id" />
    </form>
  </dialog>

  <!-- Stok hareketi formu -->
  <dialog id="moveDialog" class="rounded-2xl p-0 w-[96vw] max-w-md">
    <form id="moveForm" class="p-4" novalidate>
      <h3 class="text-lg font-semibold mb-4">Stok Hareketi</h3>
      <div class="space-y-3">
        <div class="text-sm">Ürün: <span id="moveProductName" class="font-medium"></span></div>
        <div class="grid grid-cols-2 gap-3">
          <label class="flex items-center gap-2"><input type="radio" name="type" value="in" checked> <span>Giriş</span></label>
          <label class="flex items-center gap-2"><input type="radio" name="type" value="out"> <span>Çıkış</span></label>
        </div>
        <div>
          <label class="text-sm">Miktar</label>
          <input name="amount" type="number" step="any" required class="w-full px-3 py-2 rounded-xl border border-slate-300" />
        </div>
        <div>
          <label class="text-sm">Not (isteğe bağlı)</label>
          <input name="note" type="text" class="w-full px-3 py-2 rounded-xl border border-slate-300" />
        </div>
      </div>
      <div class="mt-5 flex justify-end gap-2">
        <button id="moveCancelBtn" type="button" class="px-3 py-2 rounded-xl border border-slate-300 bg-white">Vazgeç</button>
        <button id="moveApplyBtn" type="submit" class="px-3 py-2 rounded-xl btn-brand">Uygula</button>
      </div>
      <input type="hidden" name="id" />
    </form>
  </dialog>

  <input id="fileInput" type="file" accept="application/json" class="hidden" />

  <footer class="mx-auto max-w-7xl p-3 md:p-4 text-xs text-slate-500">
    <p>Veriler bu cihazın tarayıcısında saklanır. Cihazlar arasında paylaşmak için <strong>Dışa aktar</strong> ile dosya indirip diğer cihazda <strong>İçe aktar</strong> yapabilirsiniz.</p>
  </footer>

  <script>
  ;(() => {
    const LS_KEY='stokTakip.v1';
    const $=(s,r=document)=>r.querySelector(s);
    const $$=(s,r=document)=>Array.from(r.querySelectorAll(s));

    // Kategori/etiket sabitleri
    const CATEGORY_PREFIX={stator:'ST',rotor:'RT',mil:'MIL',rotorluMil:'RMIL',taslanmisMil:'TMIL',sargiliPaket:'SP',paketliGovde:'PG',motor:'MOT',kapak:'KAP',islenmisKapak:'IKAP',taslanmisKapak:'TKAP', rulman:'RUL', aluminyum_govde:'ALU', yardimci_parcalar:'ACC'};
    const CATEGORY_LABEL={stator:'Stator',rotor:'Rotor',mil:'Mil',rotorluMil:'Rotorlu Mil',taslanmisMil:'Taşlanmış Mil',sargiliPaket:'Sargılı Paket',paketliGovde:'Paketli Gövde',motor:'Motor',kapak:'Kapak',islenmisKapak:'İşlenmiş Kapak',taslanmisKapak:'Taşlanmış Kapak', rulman:'Rulman', aluminyum_govde:'Alüminyum Gövde', yardimci_parcalar:'Yardımcı Parçalar'};

    const state={products:[],logs:[]};
    const uuid=()=> (crypto?.randomUUID?.() || 'id-'+Math.random().toString(36).slice(2)+Date.now());

    function load(){ try{ const raw=localStorage.getItem(LS_KEY); if(!raw) return; const data=JSON.parse(raw); state.products=data.products||[]; state.logs=data.logs||[]; }catch(e){ console.error('Yükleme hatası',e);} }
    function save(){ try{ localStorage.setItem(LS_KEY, JSON.stringify({products:state.products,logs:state.logs})); }catch(e){ console.error('Kaydetme hatası',e);} render(); }

    const fmt=n=>{const v=Number(n); return Number.isFinite(v)? new Intl.NumberFormat('tr-TR',{maximumFractionDigits:3}).format(v):n};
    const nowISO=()=>new Date().toISOString();
    const currentUser=()=> (sessionStorage.getItem('auth_user')||'anon');
    const addLog=(entry)=>
    state.logs.unshift({id:uuid(),ts:nowISO(),user:currentUser(),...entry});
    const findProduct=id=>state.products.find(p=>p.id===id);

    let sortBy='name', sortDir='asc';

    
// ----------------- Ek Yardımcı Fonksiyonlar -----------------
function specs(p){
  const parts=[];
  if(p.category==='paketliGovde'){
    if(p.pg_rpm) parts.push(`${p.pg_rpm} rpm`);
    if(p.pg_kw) parts.push(`${p.pg_kw} kW`);
    if(p.pg_volt) parts.push(`${p.pg_volt} V`);
    if(p.pg_customer) parts.push(`${p.pg_customer}`);
    if(p.pg_conn) parts.push(`${p.pg_conn}`);
  }else if(p.category==='motor'){
    if(p.m_rpm) parts.push(`${p.m_rpm} rpm`);
    if(p.m_kw) parts.push(`${p.m_kw} kW`);
    if(p.m_volt) parts.push(`${p.m_volt} V`);
    if(p.m_customer) parts.push(`${p.m_customer}`);
    if(p.m_conn) parts.push(`${p.m_conn}`);
    if(p.m_cover) parts.push(`Kapak: ${p.m_cover}`);
  }else{
    if(p.rpm) parts.push(`${p.rpm} rpm`);
    if(p.kw) parts.push(`${p.kw} kW`);
    if(p.volt) parts.push(`${p.volt} V`);
    if(p.material) parts.push(`${p.material}`);
    if(p.milCode) parts.push(`Mil: ${p.milCode}`);
    if(p.customer) parts.push(`${p.customer}`);
  }
  return parts.join(' • ');
}

function searchable(p){
  const base = [(p.name||''),(p.sku||''),(p.note||''),(CATEGORY_LABEL[p.category]||p.category||'')].join(' ');
  const extra = [
    p.pg_rpm,p.pg_kw,p.pg_volt,p.pg_customer,p.pg_conn,
    p.m_rpm,p.m_kw,p.m_volt,p.m_customer,p.m_conn,p.m_cover,
    p.material,p.milCode,p.rpm,p.kw,p.volt,p.customer
  ].filter(Boolean).join(' ');
  return (base+' '+extra).toLowerCase();
}
// -------------------------------------------------------------

function render(){
      const qRaw=$('#search').value.trim(); const q=qRaw.toLowerCase();
      const onlyLow=$('#onlyLow').checked;
      const tbody=$('#tbodyDesktop'); tbody.innerHTML='';
      const listMobile=$('#listMobile'); listMobile.innerHTML='';

      let list=[...state.products];
      // Advanced colon-based search (e.g., MOT:HMB90:Önfreze)
      if(qRaw.includes(':')){
        const tokens = qRaw.split(':').map(s=>s.trim()).filter(Boolean);
        if(tokens.length){
          const norm = (s)=>String(s||'').toLowerCase()
            .replaceAll('ı','i').replaceAll('İ','i')
            .replaceAll('ğ','g').replaceAll('Ğ','g')
            .replaceAll('ü','u').replaceAll('Ü','u')
            .replaceAll('ş','s').replaceAll('Ş','s')
            .replaceAll('ö','o').replaceAll('Ö','o')
            .replaceAll('ç','c').replaceAll('Ç','c');
          list = list.filter(p=>{
            const hay = {
              sku: norm(p.sku),
              name: norm(p.name),
              cat: norm(p.category)+' '+norm((CATEGORY_LABEL[p.category]||'')),
              kind: norm(p.kind),
              mil: norm(p.milType)+' '+norm(p.milCode),
              customer: norm(p.m_customer)+' '+norm(p.customer)+' '+norm(p.pg_customer),
              specs: norm(typeof specs==='function'? specs(p):'')
            };
            return tokens.every(t=>{
              const tt = norm(t);
              return (hay.sku.includes(tt) || hay.name.includes(tt) || hay.cat.includes(tt) || hay.kind.includes(tt)
                      || hay.mil.includes(tt) || hay.customer.includes(tt) || hay.specs.includes(tt));
            });
          });
        }
      } else if(q){
        // fallback: classic broad search
        list=list.filter(p=> searchable(p).includes(q));
      }
      if(onlyLow) list=list.filter(p=>Number(p.qty||0) < Number(p.min||0));

      // Sıralama
      list.sort((a,b)=>{ let va,vb; switch(sortBy){ case 'sku': va=(a.sku||'').toLowerCase(); vb=(b.sku||'').toLowerCase(); break; case 'qty': va=Number(a.qty||0); vb=Number(b.qty||0); break; case 'min': va=Number(a.min||0); vb=Number(b.min||0); break; default: va=(a.name||'').toLowerCase(); vb=(b.name||'').toLowerCase(); } return (va<vb?-1:va>vb?1:0) * (sortDir==='asc'?1:-1); });

      $('#count').textContent=list.length;

      for(const p of list){
        const low=Number(p.qty||0) < Number(p.min||0);
        // Masaüstü satırı
        const tr=document.createElement('tr');
        const kindBadge=p.kind?`<span class="badge bg-slate-100 border border-slate-200 mr-1">${p.kind==='ham'?'Hammadde':(p.kind==='yari'?'Yarı-mamul':'Mamul')}</span>`:'';
        const catBadge=p.category?`<span class="badge" style="background: rgba(var(--brand), .15); border:1px solid rgba(var(--brand), .4); color: rgb(var(--brand))">${CATEGORY_LABEL[p.category]||p.category}</span>`:'';
        tr.className=low? 'bg-amber-50':'';
        tr.innerHTML=`
          <td class="px-3 py-2 align-top">${p.sku||'-'}</td>
          <td class="px-3 py-2 align-top">${p.name||'-'}</td>
          <td class="px-3 py-2 align-top">${kindBadge} ${catBadge}</td>
          <td class="px-3 py-2 align-top text-right font-medium ${low?'text-amber-700':''}">${fmt(p.qty||0)}</td>
          <td class="px-3 py-2 align-top text-right">${fmt(p.min||0)}</td>
          <td class="px-3 py-2 align-top text-slate-700">${specs(p)}</td>
          <td class="px-3 py-2 align-top text-slate-600">${p.note||''}</td>
          <td class="px-3 py-2 align-top text-right">
            <div class="flex justify-end gap-1">
              <button class="px-2 py-1 rounded-lg border border-slate-300 bg-white" data-act="move-in" data-id="${p.id}">Giriş</button>
              <button class="px-2 py-1 rounded-lg border border-slate-300 bg-white" data-act="move-out" data-id="${p.id}">Çıkış</button>
              <button class="px-2 py-1 rounded-lg" style="border:1px solid rgba(var(--brand), .5); color: rgb(var(--brand)); background:transparent" data-act="edit" data-id="${p.id}">Düzenle</button>
              <button class="px-2 py-1 rounded-lg border border-rose-300 text-rose-700 bg-white" data-act="del" data-id="${p.id}">Sil</button>
            </div>
          </td>`;
        tbody.appendChild(tr);

        // Mobil kartı
        const card=document.createElement('div');
        card.className='rounded-2xl border border-slate-200 bg-white p-3';
        card.innerHTML=`
          <div class="flex items-start justify-between gap-2">
            <div class="min-w-0">
              <div class="text-sm text-slate-500">${p.sku||'-'}</div>
              <div class="font-medium truncate">${p.name||'-'}</div>
              <div class="mt-1 text-xs">${kindBadge} ${catBadge}</div>
              <div class="mt-1 text-xs text-slate-600 truncate">${specs(p)}</div>
            </div>
            <div class="text-right">
              <div class="text-xs text-slate-500">Stok</div>
              <div class="text-base font-semibold ${low?'text-amber-700':''}">${fmt(p.qty||0)}</div>
              <div class="text-xs text-slate-500">Min ${fmt(p.min||0)}</div>
            </div>
          </div>
          ${p.note?`<div class="mt-2 text-xs text-slate-600">${p.note}</div>`:''}
          <div class="mt-3 flex flex-wrap gap-1">
            <button class="px-2 py-1 rounded-lg border border-slate-300 bg-white" data-act="move-in" data-id="${p.id}">Giriş</button>
            <button class="px-2 py-1 rounded-lg border border-slate-300 bg-white" data-act="move-out" data-id="${p.id}">Çıkış</button>
            <button class="px-2 py-1 rounded-lg" style="border:1px solid rgba(var(--brand), .5); color: rgb(var(--brand)); background:transparent" data-act="edit" data-id="${p.id}">Düzenle</button>
            <button class="px-2 py-1 rounded-lg border border-rose-300 text-rose-700 bg-white" data-act="del" data-id="${p.id}">Sil</button>
          </div>`;
        listMobile.appendChild(card);
      }

      // Log
      const logBody=$('#logBody'); logBody.innerHTML='';
      for(const L of state.logs){ const p=findProduct(L.productId)||{name:'(silinmiş ürün)'}; const tr=document.createElement('tr'); const typeTxt=L.type==='in'?'Giriş':(L.type==='out'?'Çıkış':L.type); tr.innerHTML=`
        <td class="px-3 py-2">${new Date(L.ts).toLocaleString('tr-TR')}</td>
        <td class="px-3 py-2">${p.name}</td>
        <td class="px-3 py-2">${typeTxt}</td>
        <td class="px-3 py-2 text-right">${fmt(L.amount)}</td>
        <td class="px-3 py-2 text-right">${fmt(L.fromQty)}</td>
        <td class="px-3 py-2 text-right">${fmt(L.toQty)}</td>
        <td class="px-3 py-2">${L.note||''}</td>
        <td class="px-3 py-2">${L.user||"(bilinmiyor)"}</td>`; logBody.appendChild(tr); }
    }

    function openProductDialog(product){ const dlg=$('#productDialog'); const form=$('#productForm'); form.reset(); toggleConditionalSections(); if(product){ $('#productDialogTitle').textContent='Ürünü Düzenle'; form.kind.value=product.kind||'mamul'; form.category.value=product.category||'stator';
      try{ ensureMaterialField(); }catch(e){}; form.name.value=product.name||''; form.sku.value=product.sku||''; form.unit.value=product.unit||''; form.min.value=product.min??0; form.note.value=product.note||'';
      if(form.material){ form.material.value = product.material ?? ''; } form.kw.value=product.kw??''; form.rpm.value=product.rpm??''; form.volt.value=product.volt??''; form.milCode.value=product.milCode??''; form.customer.value=product.customer??''; form.pg_rpm.value=product.pg_rpm??''; form.pg_kw.value=product.pg_kw??''; form.pg_volt.value=product.pg_volt??''; form.pg_customer.value=product.pg_customer??''; form.pg_conn.value=product.pg_conn??'soketli'; form.m_rpm.value=product.m_rpm??''; form.m_kw.value=product.m_kw??''; form.m_volt.value=product.m_volt??''; form.m_conn.value=product.m_conn??'soketli'; form.milType.value=product.milType??''; form.m_cover.value=product.m_cover??'AK'; form.id.value=product.id; toggleConditionalSections(); } else { $('#productDialogTitle').textContent='Ürün Ekle'; form.kind.value='mamul'; form.category.value='stator';
      try{ ensureMaterialField(); }catch(e){}; form.id.value=''; suggestSku(true); toggleConditionalSections(); } dlg.showModal(); }

    function openMoveDialog(product,type){ const dlg=$('#moveDialog'); const form=$('#moveForm'); form.reset(); form.id.value=product.id; $('#moveProductName').textContent=`${product.name} (${product.sku||'kod yok'})`; if(type){ $$('input[name="type"]').forEach(r=>r.checked=(r.value===type)); } dlg.showModal(); }

    function exportJSON(){ const blob=new Blob([JSON.stringify({products:state.products,logs:state.logs},null,2)],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=`stok-data-${new Date().toISOString().replace(/[:.]/g,'-')}.json`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); }
    function exportCSV(){ const rows=[[ 'id','sku','name','kind','category','unit','material','qty','min','note','kw','rpm','volt','milCode','customer','pg_kw','pg_rpm','pg_volt','pg_customer','pg_conn','m_kw','m_rpm','m_volt','m_conn','milType' ]].concat( state.products.map(p=>[ p.id, p.sku, p.name, p.kind, p.category, p.unit, p.material,p.qty,p.min,(p.note||'').replaceAll('\n',' '), p.kw??'',p.rpm??'',p.volt??'',p.milCode??'',p.customer??'', p.pg_kw??'',p.pg_rpm??'',p.pg_volt??'',p.pg_customer??'',p.pg_conn??'', p.m_kw??'',p.m_rpm??'',p.m_volt??'',p.m_conn??'',p.milType??'' ]) ); const csv=rows.map(r=>r.map(x=>'"'+(String(x??'').replaceAll('"','""'))+'"').join(',')).join('\n'); const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=`stok-urunler-${new Date().toISOString().slice(0,10)}.csv`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); }
    function exportLogCSV(){ const rows=[['ts','product','type','amount','from','to','note','user']]; for(const L of state.logs){ const p=findProduct(L.productId)||{}; rows.push([L.ts,p.name||'',L.type,L.amount,L.fromQty,L.toQty,(L.note||'').replaceAll('\\n',' '), (L.user||'')]);} const csv=rows.map(r=>r.map(x=>'"'+(String(x??'').replaceAll('"','""'))+'"').join(',')).join('\n'); const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=`stok-log-${new Date().toISOString().slice(0,10)}.csv`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); }

    function importJSONFile(file){ const reader=new FileReader(); reader.onload=()=>{ try{ const data=JSON.parse(reader.result); if(!data||typeof data!=='object') throw new Error('Geçersiz dosya'); state.products=Array.isArray(data.products)?data.products:[]; state.logs=Array.isArray(data.logs)?data.logs:[]; save(); alert('İçe aktarıldı'); }catch(e){ alert('Dosya okunamadı: '+e.message); } }; reader.readAsText(file); }

    function toggleConditionalSections(){ try{ ensureMaterialField(); }catch(e){};
const form=$('#productForm'); const cat=form.category.value; $('[data-section="sargiliPaket"]').classList.toggle('hidden', cat!=='sargiliPaket'); $('[data-section="paketliGovde"]').classList.toggle('hidden', cat!=='paketliGovde'); const isMil=(cat==='mil'||cat==='rotorluMil'||cat==='taslanmisMil'); $('[data-section="mil"]').classList.toggle('hidden', !isMil); $('[data-section="motor"]').classList.toggle('hidden', cat!=='motor'); }

    
    
    function refreshProductDialogUI(){
      try{
        toggleConditionalSections();
        const covers = document.querySelectorAll('select[name=\"m_cover\"]');
        if(covers.length>1){ for(let i=1;i<covers.length;i++){ const el=covers[i]; const wrap=el.closest('div'); (wrap||el).remove(); } }

        const form = document.getElementById('productForm');
        if(!form) return;
        // If new product (no id), keep SKU in sync with category prefix
        if(!form.id.value){ form.sku.value = nextSkuForCategory(form.category.value); }
      }catch(e){ console && console.warn && console.warn('refreshProductDialogUI:', e); }
    }
function prefixForCategory(cat){
      switch(cat){
        case 'yardimci_parcalar': return 'ACC';

        case 'aluminyum_govde': return 'ALU';

        case 'rulman': return 'RUL';

        case 'stator': return 'ST';
        case 'rotor': return 'RT';
        case 'mil': return 'MIL';
        case 'rotorluMil': return 'RMIL';
        case 'taslanmisMil': return 'TMIL';
        case 'sargiliPaket': return 'SP';
        case 'paketliGovde': return 'PG';
        case 'motor': return 'MOT';
        default: return 'GEN';
      }
    }
    function nextSkuForCategory(cat){
      const prefix = prefixForCategory(cat);
      let max = 0;
      for(const p of state.products){
        const s = String(p.sku||'');
        const m = s.match(new RegExp('^'+prefix+'-(\\d{4})$'));
        if(m){ const n = parseInt(m[1],10); if(n>max) max=n; }
      }
      const next = String(max+1).padStart(4,'0');
      return `${prefix}-${next}`;
    }
function nextSkuForCategory(cat){ const prefix=CATEGORY_PREFIX[cat]||'PRD'; let max=0; for(const p of state.products){ if(p.category!==cat) continue; const m=String(p.sku||'').match(new RegExp('^'+prefix+'-(\\d+)$')); if(m){ const n=parseInt(m[1],10); if(n>max) max=n; } } const next=String(max+1).padStart(4,'0'); return `${prefix}-${next}`; }
    function suggestSku(force=false){ const form=$('#productForm'); const cat=form.category.value; const suggestion=nextSkuForCategory(cat); const prefix=(CATEGORY_PREFIX[cat]||'PRD')+'-'; if(force || !form.sku.value || !form.sku.value.startsWith(prefix)){ form.sku.value=suggestion; } else { if(state.products.some(p=>(p.sku||'').toLowerCase()===form.sku.value.toLowerCase())) form.sku.value=suggestion; } }

    // Eventler
    $('#btnAdd').addEventListener('click',()=>openProductDialog());
    $('#btnExport').addEventListener('click',exportJSON);
    $('#btnExportCSV').addEventListener('click',exportCSV);
    $('#btnExportLogCSV').addEventListener('click',exportLogCSV);
    $('#btnImport').addEventListener('click',()=>$('#fileInput').click());
    $('#fileInput').addEventListener('change',e=>{ const f=e.target.files?.[0]; if(f) importJSONFile(f); e.target.value=''; });

    $('#btnClear').addEventListener('click',()=>{ if(!state.products.length && !state.logs.length){ alert('Zaten boş.'); return; } if(confirm('Tüm ürünler ve hareket geçmişi silinsin mi? Bu işlem geri alınamaz.\nİşlemden önce otomatik yedek indirilecektir.')){ exportJSON(); state.products=[]; state.logs=[]; try{ localStorage.removeItem(LS_KEY);}catch{} render(); } });

    $('#search').addEventListener('input',render);
    $('#onlyLow').addEventListener('change',render);
    $('#thead').addEventListener('click',e=>{ const th=e.target.closest('th[data-sort]'); if(!th) return; const key=th.dataset.sort; if(sortBy===key) sortDir=(sortDir==='asc'?'desc':'asc'); else { sortBy=key; sortDir='asc'; } render(); });

    // Masaüstü ve mobilde ortak buton delegasyonu
    function delegate(container){ container.addEventListener('click', e=>{ const btn=e.target.closest('button'); if(!btn) return; const id=btn.dataset.id; const p=findProduct(id); if(!p) return; const act=btn.dataset.act; if(act==='edit'){ openProductDialog(p); } else if(act==='del'){ if(confirm('Silinsin mi?')){ state.products=state.products.filter(x=>x.id!==id); addLog({productId:id,type:'delete',amount:0,fromQty:p.qty||0,toQty:0,note:'Ürün silindi'}); save(); } } else if(act==='move-in'){ openMoveDialog(p,'in'); } else if(act==='move-out'){ openMoveDialog(p,'out'); } }); }
    delegate(document.body);

    $('#productForm').addEventListener('submit',e=>{ e.preventDefault(); const form=e.target; const data=Object.fromEntries(new FormData(form).entries()); data.m_cover=(form.m_cover&&form.m_cover.value)||data.m_cover||''; const isEdit=!!data.id; const min=Number(data.min||0); if(isNaN(min)||min<0){ alert('Minimum stok 0 veya daha büyük olmalı'); return; } if(!data.name||!data.sku){ alert('Ad ve stok kodu zorunlu'); return; } if(data.category==='sargiliPaket'){ if(!(data.kw && data.rpm && data.volt)){ alert('Sargılı paket için kW, rpm ve Volt zorunludur.'); return; } } if(['mil','rotorluMil','taslanmisMil'].includes(data.category)){ if(!data.milCode){ alert('Mil türlerinde Mil Kodu zorunludur.'); return; } }
      const clash=state.products.some(x=>x.id!==data.id && (x.sku||'').toLowerCase()===data.sku.toLowerCase()); if(clash){ alert('Bu stok kodu başka bir üründe kullanılıyor. Otomatik yeni kod önerilecek.'); form.sku.value=nextSkuForCategory(data.category); data.sku=form.sku.value; }
      if(isEdit){ const p=findProduct(data.id); if(!p) return; Object.assign(p,{ kind:data.kind, category:data.category, name:data.name, sku:data.sku, unit:data.unit, min, note:data.note, kw:toNumOrNull(data.kw), rpm:toNumOrNull(data.rpm), volt:toNumOrNull(data.volt), milCode:data.milCode||'', customer:data.customer||'', m_rpm:toNumOrNull(data.m_rpm), m_kw:toNumOrNull(data.m_kw), m_volt:toNumOrNull(data.m_volt), m_conn:data.m_conn||'', m_cover:data.m_cover||'', milType:data.milType||'', pg_rpm:toNumOrNull(data.pg_rpm), pg_kw:toNumOrNull(data.pg_kw), pg_volt:toNumOrNull(data.pg_volt), pg_customer:data.pg_customer||'', pg_conn:data.pg_conn||''  , material:data.material||'',}); addLog({productId:p.id,type:'edit',amount:0,fromQty:p.qty||0,toQty:p.qty||0,note:'Ürün bilgisi güncellendi'}); } else { const p={ id:uuid(), kind:data.kind, category:data.category, name:data.name, sku:data.sku, unit:data.unit, qty:0, min, note:data.note, kw:toNumOrNull(data.kw), rpm:toNumOrNull(data.rpm), volt:toNumOrNull(data.volt), milCode:data.milCode||'', customer:data.customer||'', m_rpm:toNumOrNull(data.m_rpm), m_kw:toNumOrNull(data.m_kw), m_volt:toNumOrNull(data.m_volt), m_conn:data.m_conn||'', m_cover:data.m_cover||'', milType:data.milType||'', pg_rpm:toNumOrNull(data.pg_rpm), pg_kw:toNumOrNull(data.pg_kw), pg_volt:toNumOrNull(data.pg_volt), pg_customer:data.pg_customer||'', pg_conn:data.pg_conn||'' , material:data.material||'' }; state.products.unshift(p); addLog({productId:p.id,type:'new',amount:0,fromQty:0,toQty:0,note:'Yeni ürün eklendi'}); }
      $('#productDialog').close(); save(); });

    // İPTAL butonları — diyalogları kapat
    $('#productCancelBtn').addEventListener('click',()=> $('#productDialog').close());
    $('#moveCancelBtn').addEventListener('click',()=> $('#moveDialog').close());

    // Stok hareketini uygula
    $('#moveForm').addEventListener('submit', (e) => {
      e.preventDefault();
      const form = e.target;
      const data = Object.fromEntries(new FormData(form).entries()); data.m_cover=(form.m_cover&&form.m_cover.value)||data.m_cover||''; data.m_cover = (form.m_cover && form.m_cover.value) || data.m_cover || '';
      const p = findProduct(data.id);
      if(!p){ alert('Ürün bulunamadı'); return; }
      const amt = Number(data.amount);
      if(!(amt>0)){ alert('Miktar pozitif olmalı'); return; }
      const from = Number(p.qty||0);
      const to = data.type==='in' ? from + amt : from - amt;
      p.qty = to;
      addLog({ productId:p.id, type:data.type, amount:amt, fromQty:from, toQty:to, note:data.note });
      $('#moveDialog').close();
      save();
    });

    function toNumOrNull(v){ const n=Number(v); return Number.isFinite(n)?n:null; }

    // İlk yükleme
    load();
    render();
    
    // Auto SKU update on category change for new items
    function autoUpdateSkuOnCategory(){ const form=$('#productForm'); if(!form) return; if(form.id.value) return; form.sku.value = nextSkuForCategory(form.category.value); }
    document.getElementById('category').addEventListener('change', autoUpdateSkuOnCategory);
    document.getElementById('kind').addEventListener('change', toggleConditionalSections);
    document.getElementById('category').addEventListener('change', toggleConditionalSections);
// Kısayol: Ctrl/Cmd+K arama
    document.addEventListener('keydown',e=>{ if((e.ctrlKey||e.metaKey)&&e.key.toLowerCase()==='k'){ e.preventDefault(); $('#search').focus(); } });
    // Sekmeler arası senkron
    window.addEventListener('storage',e=>{ if(e.key===LS_KEY){ load(); render(); } });
  })();
  </script>

<!-- === Firebase Live Sync (guarded by login) === -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
  import { getDatabase, ref, onValue, update, set, onDisconnect } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-database.js";

  // Config
  const firebaseConfig = {
    apiKey: "AIzaSyAyx_HVYwckqw2bYl_sdu57XPUP_tdDsxA",
    authDomain: "hertz-stok-takip.firebaseapp.com",
    databaseURL: "https://hertz-stok-takip-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "hertz-stok-takip",
    storageBucket: "hertz-stok-takip.appspot.com",
    messagingSenderId: "512663727455",
    appId: "1:512663727455:web:99e15a20f7ae9b77a39aea"
  };

  function startSync(){
    const app = initializeApp(firebaseConfig);
    const db  = getDatabase(app);

    const urlDoc = new URLSearchParams(location.search).get("doc");
    const DOC_ID = urlDoc || "stoktakip-paylasimli-orta-oda";
    const rootRef = ref(db, `docs/${DOC_ID}`);
    const presRef = ref(db, `docs/${DOC_ID}/presence`);
    const meId    = crypto.randomUUID();
    const meRef   = ref(db, `docs/${DOC_ID}/presence/${meId}`);
    set(meRef, { at: Date.now(), ua: navigator.userAgent.slice(0,64) }).catch(()=>{});
    onDisconnect(meRef).remove();

    const APP_LS_KEY = "stokTakip.v1";
    const EMPTY_DATA = { products: [], logs: [], updatedAt: Date.now() };
    const safeParse = (x)=>{ try { return JSON.parse(x); } catch { return null; } };
    const push = (obj)=> update(rootRef, { products: obj.products||[], logs: obj.logs||[], updatedAt: Date.now() })
                          .catch(err => console.error("Buluta yazma hatası:", err));

    // Hook LS
    const _setItem    = localStorage.setItem.bind(localStorage);
    const _removeItem = localStorage.removeItem.bind(localStorage);
    const _clear      = localStorage.clear.bind(localStorage);

    localStorage.setItem = function(k, v){
      _setItem(k, v);
      if (k === APP_LS_KEY || (typeof window.LS_KEY === "string" && k === window.LS_KEY)) push(safeParse(v)||{});
    };
    localStorage.removeItem = function(k){
      _removeItem(k);
      if (k === APP_LS_KEY || (typeof window.LS_KEY === "string" && k === window.LS_KEY)) push(EMPTY_DATA);
    };
    localStorage.clear = function(){ _clear(); push(EMPTY_DATA); };

    if (typeof window.save === "function") {
      const __orig = window.save;
      window.save = function(){ try{ __orig(); }catch(e){ console.error(e); } 
        const raw = localStorage.getItem(APP_LS_KEY);
        if (raw) push(safeParse(raw)||{}); else push(EMPTY_DATA);
      };
    }

    let lastSent = null;
    setInterval(() => {
      const now = localStorage.getItem(APP_LS_KEY);
      if (now !== lastSent) { lastSent = now; if (now) push(safeParse(now)||{}); else push(EMPTY_DATA); }
    }, 1000);

    onValue(rootRef, (snap) => {
      const v = snap.val();
      if(!v || typeof v !== "object") return;
      const { products = [], logs = [] } = v;
      const local = safeParse(localStorage.getItem(APP_LS_KEY) || "null") || {products:[], logs:[]};
      if (JSON.stringify(local.products||[]) === JSON.stringify(products) &&
          JSON.stringify(local.logs||[])     === JSON.stringify(logs)) return;
      localStorage.setItem(APP_LS_KEY, JSON.stringify({ products, logs }));
      try { if (typeof render === "function") render(); } catch(e){ console.warn("render() çağrısı hata:", e); }
    });

    setTimeout(() => {
      onValue(rootRef, (snap) => {
        if(!snap.exists()){
          const local = safeParse(localStorage.getItem(APP_LS_KEY) || "null") || {products:[], logs:[]};
          set(rootRef, { products: local.products||[], logs: local.logs||[], updatedAt: Date.now() }).catch(console.error);
        }
      }, { onlyOnce: true });
    }, 300);

    onValue(presRef, (snap) => {
      const n = snap.exists() ? Object.keys(snap.val()||{}).length : 0;
      const el = document.getElementById("statusOnline");
      if (el) el.textContent = `Çevrimiçi: ${n}`;
    });
  }

  if (sessionStorage.getItem("auth_ok") === "1") startSync();
  else document.addEventListener("auth_ok", startSync, { once: true });
</script>
<!-- === /Firebase Live Sync (guarded) === -->


<!-- === Kullanıcı Tablosu (Referans) ===
| Kullanıcı Adı | Şifre | Rol    |
| hertz         | hertz | admin  |
| muhasebe      | 2     | user   |
| imalat1       | 3     | user   |
| imalat2       | 4     | user   |
| imalat3       | 5     | user   |
| imalat4       | 6     | user   |
| imalat5       | 7     | user   |
| imalat6       | 8     | user   |
=== -->


<!-- === Non-admin guard: continuously hide "Tüm verileri sil" === -->
<script>
(function(){
  function norm(s){ return (s||"").toLowerCase().replace(/\s+/g," ").trim(); }
  function hideClearForNonAdmin(){
    const role = sessionStorage.getItem("role");
    if (role === "admin") return; // admins see everything

    // 1) By ID
    const byId = document.getElementById("btnClearAll");
    if (byId) byId.style.display = "none";

    // 2) By text content (covers dynamically re-rendered buttons)
    const nodes = document.querySelectorAll("button, a, [role='button'], .btn, .button");
    nodes.forEach(el => {
      const t = norm(el.textContent);
      if (t.includes("tüm verileri sil") || t.includes("tum verileri sil")) {
        el.style.display = "none";
        el.disabled = true; // extra safety
        el.setAttribute("aria-hidden", "true");
      }
    });
  }

  // Run on load and then every 500ms to catch re-renders
  window.addEventListener("load", hideClearForNonAdmin);
  setInterval(hideClearForNonAdmin, 500);
  document.addEventListener("auth_ok", hideClearForNonAdmin);
})();
</script>
<!-- === /Non-admin guard === -->


<!-- === RTDB Real-time Sync (v26): pure polling, no overrides, in-place apply === -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
  import { getDatabase, ref, onValue, update, set, onDisconnect } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAyx_HVYwckqw2bYl_sdu57XPUP_tdDsxA",
    authDomain: "hertz-stok-takip.firebaseapp.com",
    databaseURL: "https://hertz-stok-takip-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "hertz-stok-takip",
    storageBucket: "hertz-stok-takip.appspot.com",
    messagingSenderId: "512663727455",
    appId: "1:512663727455:web:99e15a20f7ae9b77a39aea"
  };

  const app = initializeApp(firebaseConfig);
  const db  = getDatabase(app);

  const DOC_ID = new URL(location.href).searchParams.get("doc") || "stoktakip-paylasimli-orta-oda";

  // ---- utils ----
  const safeParse = (x)=>{ try { return JSON.parse(x); } catch { return null; } };
  const isStockPayload = (obj)=> obj && typeof obj==="object" && ("products" in obj || "logs" in obj);
  const stable = (obj)=>{
    try{ return JSON.stringify(obj, Object.keys(obj).sort()); } catch { return ""; }
  };
  const hash = (str)=>{
    let h=0, i=0, len=str.length|0; for(; i<len; i++){ h = (h*31 + str.charCodeAt(i)) | 0; }
    return h.toString(16);
  };

  function discoverStockKeys(){
    const keys = new Set();
    for (let i=0;i<localStorage.length;i++){
      const k = localStorage.key(i);
      if (isStockPayload(safeParse(localStorage.getItem(k)))) keys.add(k);
    }
    for (let i=0;i<sessionStorage.length;i++){
      const k = sessionStorage.key(i);
      if (isStockPayload(safeParse(sessionStorage.getItem(k)))) keys.add(k);
    }
    // If none found, create default key so app can pick it up
    if (keys.size === 0){
      const def = "stokTakip.v1";
      localStorage.setItem(def, JSON.stringify({products:[], logs:[]}));
      keys.add(def);
    }
    return keys;
  }

  // Initial key set
  let STOCK_KEYS = discoverStockKeys();

  // Presence (optional)
  const presRef = ref(db, `docs/${DOC_ID}/presence`);
  const meId = crypto.randomUUID();
  const meRef = ref(db, `docs/${DOC_ID}/presence/${meId}`);
  set(meRef, { at: Date.now(), ua: navigator.userAgent.slice(0,64) }).catch(()=>{});
  onDisconnect(meRef).remove();

  const rootRef = ref(db, `docs/${DOC_ID}`);

  // Local change detection (pure polling)
  const lastHash = new Map(); // key -> hash
  let debounceTimer = null, pendingPush = null;

  function computeHashForKey(k){
    const v = localStorage.getItem(k) ?? sessionStorage.getItem(k);
    const obj = safeParse(v||"null");
    if (!isStockPayload(obj)) return null;
    return hash(stable({products: obj.products||[], logs: obj.logs||[]}));
  }

  function scanAndMaybePush(){
    // Re-discover keys (new ones may appear)
    const discovered = discoverStockKeys();
    for (const k of discovered) STOCK_KEYS.add(k);

    // Find the most recently changed stock payload among keys
    let changedKey = null;
    for (const k of STOCK_KEYS){
      const h = computeHashForKey(k);
      if (!h) continue;
      if (lastHash.get(k) !== h){
        lastHash.set(k, h);
        changedKey = k;
      }
    }
    if (!changedKey) return;

    // Prepare payload from changedKey and push to RTDB (debounced)
    const v = localStorage.getItem(changedKey) ?? sessionStorage.getItem(changedKey);
    const obj = safeParse(v||"null");
    if (!isStockPayload(obj)) return;
    pendingPush = { products: obj.products||[], logs: obj.logs||[] };
    if (debounceTimer) clearTimeout(debounceTimer);
    debounceTimer = setTimeout(()=>{
      const payload = pendingPush; pendingPush = null;
      update(rootRef, { products: payload.products, logs: payload.logs, updatedAt: Date.now(), lastAction: "update" }).catch(console.error);
    }, 120);
  }

  // Kick off the poller
  setInterval(scanAndMaybePush, 500);

  // In-place UI notify
  function notifyRender(){
    try {
      if (typeof window.renderStok === "function") { window.renderStok(); return; }
      if (window.app && typeof window.app.render === "function") { window.app.render(); return; }
      document.dispatchEvent(new CustomEvent("rtdb_data_changed"));
      // Also emit a synthetic storage event for listeners
      for (const k of STOCK_KEYS){
        const v = localStorage.getItem(k);
        const evt = new StorageEvent("storage", { key: k, newValue: v, storageArea: localStorage });
        window.dispatchEvent(evt);
      }
    } catch {}
  }

  // Apply from RTDB: write to ALL detected keys with native setItem (no overrides), then notify
  let primed=false, lastApplied=0;
  onValue(rootRef, (snap) => {
    const v = snap.val(); if(!v || typeof v!=="object") return;
    const { products=[], logs=[], updatedAt=0 } = v;

    if (!primed){ primed=true; lastApplied = updatedAt; }
    else { if (updatedAt <= lastApplied) return; lastApplied = updatedAt; }

    // Write payload to all known keys
    const str = JSON.stringify({products, logs});
    // Refresh key discovery before writing
    STOCK_KEYS = discoverStockKeys();
    for (const k of STOCK_KEYS){
      try { localStorage.setItem(k, str); } catch {}
    }
    // Update lastHash so we don't echo back immediately
    for (const k of STOCK_KEYS){ lastHash.set(k, hash(stable({products, logs}))); }

    notifyRender();
  });

  // If DB empty, seed from any local key
  setTimeout(()=>{
    onValue(rootRef, (s)=>{
      if(!s.exists()){
        STOCK_KEYS = discoverStockKeys();
        // Find first valid payload
        let initial = {products:[], logs:[]};
        for (const k of STOCK_KEYS){
          const obj = safeParse(localStorage.getItem(k)||"null");
          if (isStockPayload(obj)){ initial = obj; break; }
        }
        set(rootRef, { products: initial.products||[], logs: initial.logs||[], updatedAt: Date.now(), lastAction: "seed" }).catch(console.error);
      }
    }, { onlyOnce: true });
  }, 400);

// === Dynamic material field only for Kapak categories ===
function ensureMaterialField() {
  const form = document.getElementById('productForm');
  if(!form) return;
  const cat = form.category?.value || '';
  const isKapak = (cat==='kapak'||cat==='islenmisKapak'||cat==='taslanmisKapak');
  const existing = form.querySelector('#materialField');
  if(isKapak){
    if(!existing){
      const unitSelect = form.querySelector('select[name="unit"]');
      const unitDiv = unitSelect ? unitSelect.closest('div') : null;
      const wrap = document.createElement('div');
      wrap.id = 'materialField';
      wrap.innerHTML = `
        <label class="text-sm text-slate-600">Malzeme</label>
        <select name="material" class="w-full px-3 py-2 rounded-xl border border-slate-300">
          <option value="aluminyum">Alüminyum</option>
          <option value="celik">Çelik</option>
          <option value="plastik">Plastik</option>
        </select>
      `;
      if(unitDiv){ unitDiv.insertAdjacentElement('afterend', wrap); }
      else { (form.querySelector('.grid') || form).appendChild(wrap); }
    }
  } else {
    if(existing) existing.remove();
  }
}

</script>
<!-- === /RTDB Sync v26 === -->

</body>
</html>
