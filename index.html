<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Hertz Motor — Entegre Yönetim Platformu</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/tr.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    /* Global Stiller */
    :root { --brand: 205,105,40; }
    body {
        --tw-bg-opacity: 1;
        background-color: rgb(248 250 252 / var(--tw-bg-opacity)); /* bg-slate-50 */
    }
    .btn-brand { background-color: rgb(var(--brand)); color: white; }
    .btn-brand:hover { filter: brightness(0.95); }
    dialog::backdrop { background: rgb(0 0 0 / 0.5); }
    
    /* Sipariş/Servis Modülüne Özel Stiller */
    .siparis-servis-app .highlight { background-color: #fecaca; }
    .siparis-servis-app .date-input { transition: box-shadow .15s ease, border-color .15s ease; }
    .siparis-servis-app .date-input:focus {
      outline: none; border-color: rgba(var(--brand), .55);
      box-shadow: 0 0 0 3px rgba(var(--brand), .20);
    }
    .siparis-servis-app .editable { cursor:text }
    .siparis-servis-app .sortable { cursor: pointer; user-select: none; position: relative; padding-right: 20px; }
    .siparis-servis-app .sortable:hover { background-color: rgba(0,0,0,0.05); }
    .siparis-servis-app .sort-indicator { position: absolute; right: 5px; top: 50%; transform: translateY(-50%); font-size: 10px; color: #64748b; }
    .siparis-servis-app .sortable.asc .sort-indicator::after { content: '▲'; }
    .siparis-servis-app .sortable.desc .sort-indicator::after { content: '▼'; }

    /* Stok Takip Modülüne Özel Stiller */
    .stok-takip-app .badge{display:inline-block;padding:.125rem .5rem;border-radius:.5rem;font-size:.75rem}
    .stok-takip-app .no-scrollbar::-webkit-scrollbar{ display:none; }
    .stok-takip-app .no-scrollbar{ -ms-overflow-style:none; scrollbar-width:none; }
    .stok-takip-app .editable-qty { cursor: pointer; border-radius: 4px; padding: 2px 4px; transition: background-color 0.2s; }
    .stok-takip-app .editable-qty:hover { background-color: #fef9c3; } /* yellow-100 */
    .stok-takip-app .stok-tab.active {
        border-color: rgb(var(--brand));
        color: rgb(var(--brand));
        background-color: white;
    }


    /* === MOBİL UYUMLULUK İÇİN RESPONSIVE TABLO STİLLERİ === */
    @media screen and (max-width: 768px) {
        .siparis-servis-app table.responsive-table {
            border: 0;
        }
        .siparis-servis-app table.responsive-table thead {
            display: none; /* Masaüstü başlıkları gizle */
        }
        .siparis-servis-app table.responsive-table tr {
            display: block;
            margin-bottom: 0.75em;
            border-radius: 0.75rem;
            border: 1px solid #e2e8f0; /* slate-200 */
            box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
            background-color: white;
            padding: 0.5rem 0.75rem;
        }
        .siparis-servis-app table.responsive-table td {
            display: flex;
            justify-content: space-between;
            align-items: center;
            text-align: right;
            font-size: 0.875rem;
            border-bottom: 1px solid #f1f5f9; /* slate-100 */
            padding: 0.6rem 0.2rem;
        }
        .siparis-servis-app table.responsive-table td::before {
            content: attr(data-label);
            text-align: left;
            font-weight: 600;
            color: #475569; /* slate-600 */
        }
        .siparis-servis-app table.responsive-table td:last-child {
            border-bottom: 0;
        }
        /* Özel hücreler için hizalama */
        .siparis-servis-app table.responsive-table td[data-label="Hazır"],
        .siparis-servis-app table.responsive-table td[data-label="Sevke Hazır"] {
            padding: 0.5rem 0.2rem;
        }
        .siparis-servis-app table.responsive-table td[data-label="İşlemler"],
        .siparis-servis-app table.responsive-table td[data-label="Durum"],
        .siparis-servis-app table.responsive-table td[data-label="İşlem"],
        .siparis-servis-app table.responsive-table td[data-label="Açıklama"] {
             display: block;
             text-align: left;
             padding: 0.75rem 0.2rem;
        }
        .siparis-servis-app table.responsive-table td[data-label="İşlemler"]::before,
        .siparis-servis-app table.responsive-table td[data-label="Durum"]::before,
        .siparis-servis-app table.responsive-table td[data-label="İşlem"]::before,
        .siparis-servis-app table.responsive-table td[data-label="Açıklama"]::before {
            display: none; /* Bu etiketleri gizle, içeriği tam genişlik kullanabilsin */
        }
    }
    
    /* === Düğme Görünürlük Kontrolü === */
    #siparis-header-buttons, #stok-header-buttons, 
    #siparis-mobile-buttons, #stok-mobile-buttons {
        display: none;
    }
    
    /* Masaüstü Görünümü */
    @media (min-width: 640px) { /* sm breakpoint */
        body[data-active-app="siparis"] #siparis-header-buttons {
            display: flex;
        }
        body[data-active-app="stok"] #stok-header-buttons {
            display: flex;
        }
    }

    /* Mobil Görünümü */
    @media (max-width: 639.98px) { /* below sm breakpoint */
        body[data-active-app="siparis"] #siparis-mobile-buttons {
            display: grid;
        }
        body[data-active-app="stok"] #stok-mobile-buttons {
            display: grid;
        }
    }

    /* === Yükleme ve Bildirim stilleri === */
    #loading-overlay {
        position: fixed; inset: 0; z-index: 10000;
        background-color: rgba(0,0,0,0.5);
        display: none; align-items: center; justify-content: center;
        color: white; font-size: 1.2rem;
    }
    #toast-notification {
        position: fixed; top: 1.5rem; right: 1.5rem; z-index: 10001;
        padding: 0.75rem 1.5rem; border-radius: 0.5rem;
        color: white; font-weight: 500;
        transform: translateX(200%);
        transition: transform 0.3s ease-in-out;
    }
    #toast-notification.show {
        transform: translateX(0);
    }
    #toast-notification.success { background-color: #22c55e; } /* green-500 */
    #toast-notification.error { background-color: #ef4444; } /* red-500 */
  </style>
</head>

<body class="text-slate-800">

<!-- === Ortak Giriş Ekranı (Login Gate) === -->
<style>
  #authGate {
    position: fixed; inset: 0; display: none; place-items: center; z-index: 99999;
    background: radial-gradient(1000px 600px at 30% 20%, rgba(205,105,40,.08), transparent 60%) , #0b1220;
    color: #e5e7eb; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  }
  #authCard {
    width: min(380px, 92vw); background: #111827; border: 1px solid #1f2937; border-radius: 14px;
    padding: 22px 22px 16px; box-shadow: 0 10px 40px rgba(0,0,0,.35);
  }
</style>
<div id="authGate">
  <div id="authCard">
    <h2 class="text-lg font-semibold text-slate-100">Platform Girişi</h2>
    <p class="text-sm text-slate-400 mb-4">Devam etmek için kullanıcı adı ve şifre girin.</p>
    <form id="authForm">
      <div class="grid gap-2 mb-3">
        <label for="authUser" class="text-sm text-slate-300">Kullanıcı adı</label>
        <input id="authUser" name="u" autocomplete="username" class="bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-slate-100 focus:ring-2 focus:ring-orange-500 focus:border-orange-500" required>
      </div>
      <div class="grid gap-2 mb-4">
        <label for="authPass" class="text-sm text-slate-300">Şifre</label>
        <input id="authPass" name="p" type="password" autocomplete="current-password" class="bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-slate-100 focus:ring-2 focus:ring-orange-500 focus:border-orange-500" required>
      </div>
      <button id="authBtn" type="submit" class="w-full py-2 rounded-lg btn-brand font-semibold">Giriş</button>
      <div id="authErr" class="min-h-[20px] text-rose-400 text-sm mt-2 text-center"></div>
    </form>
  </div>
</div>
<!-- === /Giriş Ekranı === -->

<!-- Yükleme ve Bildirim Elemanları -->
<div id="loading-overlay">
    <span>Veriler Yükleniyor...</span>
</div>
<div id="toast-notification"></div>

<header class="sticky top-0 z-20 bg-white/80 backdrop-blur-lg border-b border-slate-200 shadow-sm">
    <div class="max-w-screen-2xl mx-auto px-2 sm:px-4 py-3 flex flex-wrap items-center justify-between gap-4">
        <div class="flex items-center gap-3 flex-shrink-0">
            <div class="shrink-0 w-10 h-10 grid place-items-center rounded-2xl text-white font-bold" style="background: rgb(var(--brand))">HM</div>
            <div>
                <h1 class="text-base md:text-xl font-semibold truncate">Hertz Motor</h1>
            </div>
        </div>
        
        <div class="flex-1 flex justify-center min-w-full lg:min-w-0 order-3 lg:order-2">
            <div id="main-nav-tabs" class="flex items-center gap-2 bg-slate-200 p-1 rounded-xl">
                <button id="mainTabSiparis" class="main-tab px-2 md:px-4 py-1.5 rounded-lg text-sm font-semibold">Sipariş & Servis</button>
                <button id="mainTabStok" class="main-tab px-2 md:px-4 py-1.5 rounded-lg text-sm font-semibold">Stok Yönetimi</button>
            </div>
        </div>

        <div class="flex items-center gap-2 flex-wrap justify-end flex-shrink-0 order-2 lg:order-3">
            <div id="siparis-header-buttons" class="items-center gap-2">
                <button class="ss_btnImportJSON px-3 py-2 rounded-xl border border-slate-300 bg-white hover:bg-slate-100 text-sm">İçe aktar</button>
                <button class="ss_btnExportJSON px-3 py-2 rounded-xl border border-slate-300 bg-white hover:bg-slate-100 text-sm">Dışa aktar</button>
                <button class="ss_btnExportCSV px-3 py-2 rounded-xl border border-slate-300 bg-white hover:bg-slate-100 text-sm">CSV</button>
                <button class="ss_btnExportLogCSV px-3 py-2 rounded-xl border border-slate-300 bg-white hover:bg-slate-100 text-sm">Log CSV</button>
                <button class="ss_btnClearAll px-3 py-2 rounded-xl bg-rose-600 text-white hover:bg-rose-700 text-sm admin-only">Tüm Veriyi Sil</button>
            </div>
             <div id="stok-header-buttons" class="items-center gap-2">
                <button class="stok_btnAdd px-3 py-2 rounded-xl btn-brand">Ürün Ekle</button>
                <button class="stok_btnImport px-3 py-2 rounded-xl border border-slate-300 bg-white">İçe Aktar</button>
                <button class="stok_btnExport px-3 py-2 rounded-xl border border-slate-300 bg-white">Dışa Aktar</button>
                <button class="stok_btnExportCSV px-3 py-2 rounded-xl border border-slate-300 bg-white">CSV</button>
                <button class="stok_btnExportLogCSV px-3 py-2 rounded-xl border border-slate-300 bg-white">Log CSV</button>
                <button class="stok_btnClear px-3 py-2 rounded-xl text-white bg-rose-600 admin-only">Tüm Veriyi Sil</button>
            </div>
            <div class="h-6 border-l border-slate-300 mx-1 admin-only"></div>
            <div class="items-center gap-2 flex admin-only">
                <button class="btnExportAll px-3 py-2 rounded-xl border border-blue-300 bg-blue-50 hover:bg-blue-100 text-sm text-blue-800 whitespace-nowrap">Tüm Veri Yedekle</button>
                <button class="btnImportAll px-3 py-2 rounded-xl border border-blue-300 bg-blue-50 hover:bg-blue-100 text-sm text-blue-800 whitespace-nowrap">Yedekten Yükle</button>
            </div>
            <button id="logoutBtn" class="px-3 py-2 rounded-xl border border-slate-300 bg-white hover:bg-slate-100 text-sm">Çıkış</button>
        </div>
    </div>
</header>

<main class="max-w-screen-2xl mx-auto">
    <section id="app-siparis-servis" class="app-container siparis-servis-app"></section>
    <section id="app-stok-takip" class="app-container stok-takip-app hidden"></section>
</main>
<input type="file" id="masterFileInput" class="hidden" accept="application/json">

<script>
// ===================================================================================
// ===                      ENTEGRE PLATFORM YÖNETİM SCRİPTİ                       ===
// ===================================================================================
const mainTabSiparis = document.getElementById('mainTabSiparis');
const mainTabStok = document.getElementById('mainTabStok');
const appSiparisServis = document.getElementById('app-siparis-servis');
const appStokTakip = document.getElementById('app-stok-takip');
const allMainTabs = document.querySelectorAll('.main-tab');
const allAppContainers = document.querySelectorAll('.app-container');

// --- Global Yardımcı Fonksiyonlar ---
function showToast(message, type = 'success', duration = 3000) {
    const toast = document.getElementById('toast-notification');
    toast.textContent = message;
    toast.className = 'show';
    toast.classList.add(type);
    setTimeout(() => {
        toast.classList.remove('show');
    }, duration);
}

function showLoadingOverlay() {
    document.getElementById('loading-overlay').style.display = 'flex';
}

function hideLoadingOverlay() {
    document.getElementById('loading-overlay').style.display = 'none';
}

// OPTIMIZASYON: Debounce fonksiyonu eklendi.
// Bu fonksiyon, bir olayın (örneğin klavyeden yazı yazma) çok sık tetiklenmesini engelleyerek
// sadece kullanıcı duraksadığında işlem yapılmasını sağlar. Bu, arama ve filtreleme
// işlemlerinde performansı ciddi şekilde artırır.
function debounce(func, delay = 300) {
    let timeoutId;
    return function(...args) {
        clearTimeout(timeoutId);
        timeoutId = setTimeout(() => {
            func.apply(this, args);
        }, delay);
    };
}


// --- Merkezi Yetki Kontrol Yöneticisi ---
const authManager = {
    USERS: {
        "hertz":   { pass: "hertz", role: "admin" },
        "muhasebe":{ pass: "2",     role: "user"  },
        "imalat1": { pass: "3",     role: "user"  },
        "imalat2": { pass: "4",     role: "user"  },
        "imalat3": { pass: "5",     role: "user"  },
        "imalat4": { pass: "6",     role: "user"  },
        "imalat5": { pass: "7",     role: "user"  },
        "imalat6": { pass: "8",     role: "user"  }
    },
    PERMISSIONS: {
        siparisServis: ['hertz', 'muhasebe', 'imalat1', 'imalat2'],
        hertz: ['hertz'],
        hertzMuhasebe: ['hertz', 'muhasebe']
    },
    
    checkPermission(permissionKey) {
        const user = sessionStorage.getItem("auth_user");
        if (!user || !this.PERMISSIONS[permissionKey]) return false;
        return this.PERMISSIONS[permissionKey].includes(user);
    },
    
    updateUIVisibility() {
        document.querySelectorAll('.admin-only').forEach(el => el.style.display = this.checkPermission('hertz') ? '' : 'none');
        document.querySelectorAll('.hertz-only').forEach(el => el.style.display = this.checkPermission('hertz') ? '' : 'none');
        document.querySelectorAll('.hertz-muhasebe-only').forEach(el => el.style.display = this.checkPermission('hertzMuhasebe') ? '' : 'none');
        
        const canSeeSiparis = this.checkPermission('siparisServis');
        mainTabSiparis.style.display = canSeeSiparis ? 'block' : 'none';
        mainTabStok.style.display = 'block';

        if (!document.body.dataset.activeApp) {
            setActiveMainTab(canSeeSiparis ? 'siparis' : 'stok');
        }
    }
};

function setActiveMainTab(tabName) {
    allAppContainers.forEach(app => app.classList.add('hidden'));
    allMainTabs.forEach(tab => tab.classList.remove('bg-white', 'shadow-md'));
    document.body.dataset.activeApp = tabName;

    if (tabName === 'siparis') {
        appSiparisServis.classList.remove('hidden');
        mainTabSiparis.classList.add('bg-white', 'shadow-md');
    } else if (tabName === 'stok') {
        appStokTakip.classList.remove('hidden');
        mainTabStok.classList.add('bg-white', 'shadow-md');
    }
}

mainTabSiparis.addEventListener('click', () => setActiveMainTab('siparis'));
mainTabStok.addEventListener('click', () => setActiveMainTab('stok'));

(function initAuth() {
  const KEY = "auth_ok", UN = "auth_user", RL = "role";
  const gate = document.getElementById("authGate"), form = document.getElementById("authForm"), err  = document.getElementById("authErr");
  
  function closeGate(){ 
      gate.style.display = "none"; 
      document.dispatchEvent(new Event("auth_ok")); 
  }
  
  if (sessionStorage.getItem(KEY) === "1") { 
    closeGate(); 
  } else { 
    gate.style.display = "grid"; 
  }
  
  form.addEventListener("submit", (e) => {
    e.preventDefault();
    const u = (form.u.value || "").trim(), p = form.p.value || "", rec = authManager.USERS[u];
    if (rec && p === rec.pass){ 
      sessionStorage.setItem(KEY, "1"); 
      sessionStorage.setItem(UN, u); 
      sessionStorage.setItem(RL, rec.role); 
      closeGate(); 
    } else { 
        err.textContent = "Hatalı kullanıcı adı/şifre"; 
        form.p.value = ""; 
    }
  });
  
  document.getElementById("logoutBtn").addEventListener("click", () => { 
    showToast("Çıkış yapıldı.", "success");
    setTimeout(() => {
        sessionStorage.clear(); 
        location.reload(); 
    }, 500);
  });
  
  document.addEventListener("auth_ok", authManager.updateUIVisibility.bind(authManager));
  window.addEventListener("load", authManager.updateUIVisibility.bind(authManager));
})();

// --- Genel Yedekleme Fonksiyonları ---
function setupMasterBackupControls() {
    const masterFileInput = document.getElementById('masterFileInput');

    document.querySelectorAll('.btnImportAll').forEach(btn => {
        btn.addEventListener('click', () => masterFileInput.click());
    });

    masterFileInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = () => {
            try {
                const data = JSON.parse(reader.result);
                if (!data.siparisServisData || !data.stokTakipData) {
                    throw new Error("Bu dosya geçerli bir tam yedek dosyası değil.");
                }

                if (confirm("TÜM VERİLERİN üzerine bu yedek yüklenecek. Bu işlem geri alınamaz. Emin misiniz?")) {
                    showLoadingOverlay();
                    
                    const siparisData = data.siparisServisData;
                    window.dataStore['siparisler'] = window.ensureArray(siparisData.orders || []);
                    window.dataStore['siparisLog'] = window.ensureArray(siparisData.logs || []);
                    window.dataStore['sevkEdilenler'] = window.ensureArray(siparisData.sevkEdilenler || []);
                    window.dataStore['servisKayitlari'] = window.ensureArray(siparisData.servisKayitlari || []);
                    window.dataStore['servisSevkEdilenler'] = window.ensureArray(siparisData.servisSevkEdilenler || []);
                    
                    window.dataStore['stokTakip-v1'] = data.stokTakipData || { products: [], logs: [], suppliers: [] };

                    const allKeys = ["siparisler", "siparisLog", "sevkEdilenler", "servisKayitlari", "servisSevkEdilenler", "stokTakip-v1"];
                    
                    const pushPromises = allKeys.map(key => window.pushData(key));

                    Promise.all(pushPromises).then(() => {
                        showToast("Tüm veriler başarıyla yüklendi. Sayfa yenileniyor...", "success");
                        setTimeout(() => location.reload(), 1500);
                    }).catch(err => {
                        hideLoadingOverlay();
                        showToast("Veriler Firebase'e yazılırken bir hata oluştu.", "error");
                        console.error("Yedekten yükleme hatası:", err);
                    });
                }
            } catch (err) {
                showToast("Yedek dosyası okunamadı veya geçersiz: " + err.message, "error");
            }
        };
        reader.readAsText(file);
        e.target.value = '';
    });

    document.querySelectorAll('.btnExportAll').forEach(btn => {
        btn.addEventListener('click', () => {
            const allData = {
                backupDate: new Date().toISOString(),
                siparisServisData: {
                    orders: window.dataStore['siparisler'] || [],
                    logs: window.dataStore['siparisLog'] || [],
                    sevkEdilenler: window.dataStore['sevkEdilenler'] || [],
                    servisKayitlari: window.dataStore['servisKayitlari'] || [],
                    servisSevkEdilenler: window.dataStore['servisSevkEdilenler'] || []
                },
                stokTakipData: window.dataStore['stokTakip-v1'] || { products: [], logs: [], suppliers: [] }
            };

            const json = JSON.stringify(allData, null, 2);
            const blob = new Blob([json], { type: "application/json" });
            const a = document.createElement("a");
            a.href = URL.createObjectURL(blob);
            a.download = `hertz_motor_tam_yedek_${new Date().toISOString().slice(0,10)}.json`;
            a.click();
            URL.revokeObjectURL(a.href);
            showToast("Tüm veriler başarıyla yedeklendi.", "success");
        });
    });
}

let platformAppsInitialized = false;
function initializePlatformApps() {
    if (platformAppsInitialized) return;
    initializeSiparisServisApp();
    initializeStokTakipApp();
    setupMasterBackupControls();
    platformAppsInitialized = true;
}

document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('app-siparis-servis').innerHTML = SIPARIS_SERVIS_HTML;
    document.getElementById('app-stok-takip').innerHTML = STOK_TAKIP_HTML;
});
</script>

<script>
// ===================================================================================
// ===                     UYGULAMA HTML İÇERİKLERİ VE SCRIPTLERİ                    ===
// ===================================================================================

const SIPARIS_SERVIS_HTML = `
<div class="max-w-7xl mx-auto px-4 py-6">
    <input accept="application/json" class="hidden" id="ss_fileInput" type="file">
    <div class="flex gap-2 mb-5 overflow-x-auto pb-2">
        <button class="tab-btn px-3 py-2 rounded-xl border bg-white hover:bg-slate-50 text-sm whitespace-nowrap" id="ss_tabSiparis">📦 Siparişler</button>
        <button class="tab-btn px-3 py-2 rounded-xl border bg-white hover:bg-slate-50 text-sm whitespace-nowrap" id="ss_tabSevk">🚚 Sevk Listesi</button>
        <button class="tab-btn px-3 py-2 rounded-xl border bg-white hover:bg-slate-50 text-sm whitespace-nowrap" id="ss_tabServis">🛠️ Teknik Servis</button>
    </div>
    <div class="grid grid-cols-2 gap-2 mb-4" id="siparis-mobile-buttons">
        <button class="ss_btnImportJSON w-full px-3 py-2 rounded-xl border border-slate-300 bg-white hover:bg-slate-100 text-sm">İçe aktar</button>
        <button class="ss_btnExportJSON w-full px-3 py-2 rounded-xl border border-slate-300 bg-white hover:bg-slate-100 text-sm">Dışa aktar</button>
        <button class="ss_btnExportCSV w-full px-3 py-2 rounded-xl border border-slate-300 bg-white hover:bg-slate-100 text-sm">CSV</button>
        <button class="ss_btnExportLogCSV w-full px-3 py-2 rounded-xl border border-slate-300 bg-white hover:bg-slate-100 text-sm">Log CSV</button>
        <button class="ss_btnClearAll w-full px-3 py-2 rounded-xl bg-rose-600 text-white hover:bg-rose-700 text-sm admin-only col-span-2">Tüm Veriyi Sil</button>
    </div>
    <section id="ss_pageSiparis">
        <form class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-6 gap-4 mb-6 bg-white p-4 rounded-xl shadow" id="ss_orderForm">
            <input class="px-3 py-2 border rounded-xl col-span-1 sm:col-span-2 md:col-span-2" name="musteri" placeholder="Müşteri" required>
            <input class="px-3 py-2 border rounded-xl col-span-1 sm:col-span-2 md:col-span-1" name="urun" placeholder="Ürün" required>
            <input class="px-3 py-2 border rounded-xl col-span-1 sm:col-span-2 md:col-span-1" name="milKod" placeholder="Mil Kodu" required>
            <input class="px-3 py-2 border rounded-xl" name="kw" placeholder="kW" required step="any" type="number" min="0">
            <input class="px-3 py-2 border rounded-xl" name="rpm" placeholder="RPM" required type="number" min="0">
            <input class="px-3 py-2 border rounded-xl" name="volt" placeholder="Voltaj" required type="number" min="0">
            <input class="sevk-picker date-input px-3 py-2 border rounded-xl col-span-1 sm:col-span-2" id="ss_sevkTarihi" name="sevkTarihi" placeholder="gg/aa/yyyy" type="text">
            <button class="btn-brand px-4 py-2 rounded-xl col-span-1 sm:col-span-2 md:col-span-6">Ekle</button>
        </form>
        <div class="overflow-auto rounded-xl shadow mb-8">
            <table class="w-full text-sm bg-white responsive-table">
                <thead class="bg-slate-200 text-slate-600">
                    <tr>
                        <th class="sortable text-left px-3 py-2" data-sort-key="no" data-sort-type="string">No<span class="sort-indicator"></span></th>
                        <th class="sortable text-left px-3 py-2" data-sort-key="musteri" data-sort-type="string">Müşteri<span class="sort-indicator"></span></th>
                        <th class="sortable text-left px-3 py-2" data-sort-key="urun" data-sort-type="string">Ürün<span class="sort-indicator"></span></th>
                        <th class="sortable text-left px-3 py-2" data-sort-key="milKod" data-sort-type="string">Mil Kodu<span class="sort-indicator"></span></th>
                        <th class="sortable text-right px-3 py-2" data-sort-key="kw" data-sort-type="number">kW<span class="sort-indicator"></span></th>
                        <th class="sortable text-right px-3 py-2" data-sort-key="rpm" data-sort-type="number">RPM<span class="sort-indicator"></span></th>
                        <th class="sortable text-right px-3 py-2" data-sort-key="volt" data-sort-type="number">Voltaj<span class="sort-indicator"></span></th>
                        <th class="sortable text-left px-3 py-2" data-sort-key="sevkTarihi" data-sort-type="date">Sevk Tarihi<span class="sort-indicator"></span></th>
                        <th class="text-left px-3 py-2">Açıklama</th>
                        <th class="text-center px-3 py-2">Hazır</th>
                        <th class="text-center px-3 py-2">Sevke Hazır</th>
                        <th class="text-left px-3 py-2">Durum</th>
                        <th class="text-left px-3 py-2">İşlemler</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-slate-100 md:divide-y-0" id="ss_orderTable"></tbody>
            </table>
        </div>
        <div class="bg-white p-4 rounded-xl shadow">
            <h2 class="text-lg font-semibold mb-2">📜 Hareket Geçmişi</h2>
            <div class="overflow-auto max-h-64">
                <table class="w-full text-xs">
                    <thead class="bg-slate-100 text-slate-600">
                        <tr>
                            <th class="text-left px-2 py-1">Tarih</th>
                            <th class="text-left px-2 py-1">Sipariş No</th>
                            <th class="text-left px-2 py-1">İşlem</th>
                            <th class="text-left px-2 py-1">Kullanıcı</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-100" id="ss_logTable"></tbody>
                </table>
            </div>
        </div>
    </section>
    <section class="hidden" id="ss_pageSevk">
        <!-- Üst Bölüm: Sipariş Sevk Listesi -->
        <div class="bg-white p-4 rounded-xl shadow mb-6">
            <h2 class="text-lg font-semibold mb-3 text-slate-700">Sipariş Sevk Listesi</h2>
            <div class="grid grid-cols-1 md:grid-cols-6 gap-3 items-end mb-3">
                <div class="md:col-span-2"><label class="text-xs text-slate-500 block mb-1">Metne göre ara</label><input class="px-3 py-2 border rounded-xl w-full" id="ss_sevkSearch" placeholder="Müşteri, ürün, No..."></div>
                <div><label class="text-xs text-slate-500 block mb-1">Başlangıç (tarih)</label><input class="date-input px-3 py-2 border rounded-xl w-full" id="ss_sevkDateFrom" placeholder="gg/aa/yyyy" type="text"></div>
                <div><label class="text-xs text-slate-500 block mb-1">Bitiş (tarih)</label><input class="date-input px-3 py-2 border rounded-xl w-full" id="ss_sevkDateTo" placeholder="gg/aa/yyyy" type="text"></div>
                <div class="flex gap-2 flex-wrap"><button class="px-3 py-2 rounded-xl border bg-slate-50 hover:bg-slate-100 text-sm" id="ss_btnSevkFilter">Filtrele</button><button class="px-3 py-2 rounded-xl border bg-slate-50 hover:bg-slate-100 text-sm" id="ss_btnSevkClearFilter">Temizle</button></div>
                <div class="md:ml-auto flex gap-2 flex-wrap justify-start md:justify-end md:col-span-1"><button class="px-3 py-2 rounded-xl border bg-slate-50 hover:bg-slate-100 text-sm" id="ss_btnSevkCSV">CSV</button><button class="px-3 py-2 rounded-xl bg-rose-600 text-white hover:bg-rose-700 text-sm admin-only" id="ss_btnSevkClearAll">Tüm Sevkleri Sil</button></div>
            </div>
            <div class="overflow-auto">
                <table class="w-full text-sm responsive-table">
                    <thead class="bg-slate-100 text-slate-600">
                        <tr>
                            <th class="sortable text-left px-3 py-2" data-sort-key="no" data-sort-type="string">No<span class="sort-indicator"></span></th>
                            <th class="sortable text-left px-3 py-2" data-sort-key="musteri" data-sort-type="string">Müşteri<span class="sort-indicator"></span></th>
                            <th class="sortable text-left px-3 py-2" data-sort-key="urun" data-sort-type="string">Ürün<span class="sort-indicator"></span></th>
                            <th class="sortable text-left px-3 py-2" data-sort-key="milKod" data-sort-type="string">Mil Kodu<span class="sort-indicator"></span></th>
                            <th class="sortable text-right px-3 py-2" data-sort-key="kw" data-sort-type="number">kW<span class="sort-indicator"></span></th>
                            <th class="sortable text-right px-3 py-2" data-sort-key="rpm" data-sort-type="number">RPM<span class="sort-indicator"></span></th>
                            <th class="sortable text-right px-3 py-2" data-sort-key="volt" data-sort-type="number">Voltaj<span class="sort-indicator"></span></th>
                            <th class="sortable text-left px-3 py-2" data-sort-key="sevkTarihi" data-sort-type="date">Sevk Tarihi<span class="sort-indicator"></span></th>
                            <th class="sortable text-left px-3 py-2" data-sort-key="sevkEdildi" data-sort-type="date">Sevk Edildi<span class="sort-indicator"></span></th>
                            <th class="sortable text-left px-3 py-2" data-sort-key="kullanici" data-sort-type="string">Kullanıcı<span class="sort-indicator"></span></th>
                            <th class="text-left px-3 py-2">İşlem</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-100 md:divide-y-0" id="ss_sevkTable"></tbody>
                </table>
            </div>
        </div>

        <!-- Alt Bölüm: Teknik Servis Sevk Listesi -->
        <div class="bg-white p-4 rounded-xl shadow">
            <h2 class="text-lg font-semibold mb-3 text-slate-700">Teknik Servis Sevk Listesi</h2>
            <div class="grid grid-cols-1 md:grid-cols-6 gap-3 items-end mb-3">
                <div class="md:col-span-2"><label class="text-xs text-slate-500 block mb-1">Metne göre ara</label><input class="px-3 py-2 border rounded-xl w-full" id="ss_teknikSevkSearch" placeholder="Firma, ürün, No..."></div>
                <div><label class="text-xs text-slate-500 block mb-1">Başlangıç (tarih)</label><input class="date-input px-3 py-2 border rounded-xl w-full" id="ss_teknikSevkDateFrom" placeholder="gg/aa/yyyy" type="text"></div>
                <div><label class="text-xs text-slate-500 block mb-1">Bitiş (tarih)</label><input class="date-input px-3 py-2 border rounded-xl w-full" id="ss_teknikSevkDateTo" placeholder="gg/aa/yyyy" type="text"></div>
                <div class="flex gap-2 flex-wrap"><button class="px-3 py-2 rounded-xl border bg-slate-50 hover:bg-slate-100 text-sm" id="ss_btnTeknikSevkFilter">Filtrele</button><button class="px-3 py-2 rounded-xl border bg-slate-50 hover:bg-slate-100 text-sm" id="ss_btnTeknikSevkClearFilter">Temizle</button></div>
                <div class="md:ml-auto flex gap-2 flex-wrap justify-start md:justify-end md:col-span-1"><button class="px-3 py-2 rounded-xl border bg-slate-50 hover:bg-slate-100 text-sm" id="ss_btnTeknikSevkCSV">CSV</button><button class="px-3 py-2 rounded-xl bg-rose-600 text-white hover:bg-rose-700 text-sm admin-only" id="ss_btnTeknikSevkClearAll">Tümünü Sil</button></div>
            </div>
            <div class="overflow-auto">
                <table class="w-full text-sm responsive-table">
                    <thead class="bg-slate-100 text-slate-600">
                        <tr>
                            <th class="sortable text-left px-3 py-2" data-sort-key="no" data-sort-type="string">No<span class="sort-indicator"></span></th>
                            <th class="sortable text-left px-3 py-2" data-sort-key="firma" data-sort-type="string">Firma<span class="sort-indicator"></span></th>
                            <th class="sortable text-left px-3 py-2" data-sort-key="urun" data-sort-type="string">Ürün<span class="sort-indicator"></span></th>
                            <th class="sortable text-left px-3 py-2" data-sort-key="milTipi" data-sort-type="string">Mil Tipi<span class="sort-indicator"></span></th>
                            <th class="sortable text-left px-3 py-2" data-sort-key="ariza" data-sort-type="string">Arıza<span class="sort-indicator"></span></th>
                            <th class="sortable text-left px-3 py-2" data-sort-key="sevkEdildi" data-sort-type="date">Sevk Edildi<span class="sort-indicator"></span></th>
                            <th class="sortable text-left px-3 py-2" data-sort-key="kullanici" data-sort-type="string">Kullanıcı<span class="sort-indicator"></span></th>
                            <th class="text-left px-3 py-2">İşlem</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-100 md:divide-y-0" id="ss_teknikServisSevkTable"></tbody>
                </table>
            </div>
        </div>
    </section>
    <section class="hidden" id="ss_pageServis">
        <form class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-8 gap-4 mb-6 bg-white p-4 rounded-xl shadow" id="ss_servisForm">
            <input class="px-3 py-2 border rounded-xl col-span-1 sm:col-span-2" name="firma" placeholder="Firma Adı" required>
            <input class="px-3 py-2 border rounded-xl col-span-1 sm:col-span-2" name="urun" placeholder="Ürün" required>
            <input class="px-3 py-2 border rounded-xl" min="1" name="adet" placeholder="Adet" step="1" type="number">
            <input class="px-3 py-2 border rounded-xl col-span-1 sm:col-span-2" name="ariza" placeholder="Arıza">
            <input class="px-3 py-2 border rounded-xl" name="milTipi" placeholder="Mil Tipi">
            <input class="px-3 py-2 border rounded-xl" name="not" placeholder="Not">
            <input class="px-3 py-2 border rounded-xl" name="iletisim" placeholder="İletişim">
            <input class="px-3 py-2 border rounded-xl" name="kargoTipi" placeholder="Kargo Tipi">
            <input class="px-3 py-2 border rounded-xl col-span-1 sm:col-span-2" name="aciklama" placeholder="Açıklama">
            <div class="col-span-1 sm:col-span-2 md:col-span-8 flex gap-2"><button class="btn-brand px-4 py-2 rounded-xl flex-grow" id="ss_servisFormSubmitButton">Servis Kaydı Ekle</button><button class="hidden px-4 py-2 rounded-xl border bg-white hover:bg-slate-50" id="ss_servisFormCancelButton" type="button">İptal Et</button></div>
        </form>
        <div class="bg-white p-4 rounded-xl shadow mb-3 flex flex-wrap gap-2 items-center"><input class="px-3 py-2 border rounded-xl w-full md:w-auto flex-grow md:flex-grow-0" id="ss_servisSearch" placeholder="Ara: firma, ürün, arıza, not..."><button class="px-3 py-2 rounded-xl border bg-white hover:bg-slate-50 text-sm" id="ss_btnServisCSV">CSV</button><button class="px-3 py-2 rounded-xl bg-rose-600 text-white hover:bg-rose-700 text-sm admin-only" id="ss_btnServisClearAll">Tüm Servis Kayıtlarını Sil</button></div>
        <div class="overflow-auto rounded-xl shadow">
            <table class="w-full text-sm bg-white responsive-table">
                <thead class="bg-slate-200 text-slate-600">
                    <tr>
                        <th class="sortable text-left px-3 py-2" data-sort-key="no" data-sort-type="string">No<span class="sort-indicator"></span></th>
                        <th class="sortable text-left px-3 py-2" data-sort-key="firma" data-sort-type="string">Firma<span class="sort-indicator"></span></th>
                        <th class="sortable text-left px-3 py-2" data-sort-key="urun" data-sort-type="string">Ürün<span class="sort-indicator"></span></th>
                        <th class="sortable text-right px-3 py-2" data-sort-key="adet" data-sort-type="number">Adet<span class="sort-indicator"></span></th>
                        <th class="sortable text-left px-3 py-2" data-sort-key="ariza" data-sort-type="string">Arıza<span class="sort-indicator"></span></th>
                        <th class="sortable text-left px-3 py-2" data-sort-key="milTipi" data-sort-type="string">Mil Tipi<span class="sort-indicator"></span></th>
                        <th class="sortable text-left px-3 py-2" data-sort-key="durum" data-sort-type="string">Durum<span class="sort-indicator"></span></th>
                        <th class="text-left px-3 py-2">Not</th>
                        <th class="text-left px-3 py-2">İletişim</th>
                        <th class="text-left px-3 py-2">Kargo Tipi</th>
                        <th class="sortable text-left px-3 py-2" data-sort-key="sevkTarihi" data-sort-type="date">Sevk Tarihi<span class="sort-indicator"></span></th>
                        <th class="text-left px-3 py-2">Açıklama</th>
                        <th class="text-left px-3 py-2">İşlem</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-slate-100 md:divide-y-0" id="ss_servisTable"></tbody>
            </table>
        </div>
    </section>
</div>
`;

const STOK_TAKIP_HTML = `
<div class="mx-auto max-w-7xl p-3 md:p-4">
    <div class="mb-4 bg-slate-100 p-1 rounded-xl overflow-x-auto no-scrollbar">
        <nav class="-mb-px flex space-x-1" aria-label="Tabs">
            <button data-tab="liste" class="stok-tab whitespace-nowrap py-2 px-3 border-b-2 font-medium text-sm rounded-lg border-transparent text-slate-600 hover:text-slate-800">
                Ürün Listesi
            </button>
            <button data-tab="tedarikciler" class="stok-tab whitespace-nowrap py-2 px-3 border-b-2 font-medium text-sm rounded-lg border-transparent text-slate-600 hover:text-slate-800 hertz-muhasebe-only">
                Tedarikçiler
            </button>
            <button data-tab="analiz" class="stok-tab whitespace-nowrap py-2 px-3 border-b-2 font-medium text-sm rounded-lg border-transparent text-slate-600 hover:text-slate-800">
                Analiz Raporları
            </button>
            <button data-tab="gecmis" class="stok-tab whitespace-nowrap py-2 px-3 border-b-2 font-medium text-sm rounded-lg border-transparent text-slate-600 hover:text-slate-800">
                Hareket Geçmişi
            </button>
        </nav>
    </div>

    <div id="stok_tabContent_liste" class="stok-tab-content">
        <div class="p-4 mb-4 bg-white border border-slate-200 rounded-2xl shadow-sm">
            <h3 class="text-base font-semibold text-slate-700 mb-3">Gösterge Paneli</h3>
            <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 text-center">
                <div>
                    <div class="text-2xl font-bold text-slate-800" id="stok_totalProducts">0</div>
                    <div class="text-xs text-slate-500">Toplam Ürün Çeşidi</div>
                </div>
                <div>
                    <div class="text-2xl font-bold text-amber-600" id="stok_criticalProducts">0</div>
                    <div class="text-xs text-slate-500">Kritik Seviyedeki Ürün</div>
                </div>
                <div class="hertz-only">
                    <div class="text-2xl font-bold text-emerald-600" id="stok_totalValue">€0</div>
                    <div class="text-xs text-slate-500">Toplam Stok Değeri</div>
                </div>
            </div>
        </div>
        <header class="grid grid-cols-1 md:grid-cols-2 gap-3 items-center mb-2 p-4 bg-white border border-slate-200 rounded-2xl shadow-sm">
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                <input id="stok_search" type="search" placeholder="Ara: ad, kod, not..." class="w-full px-3 py-2 rounded-xl border border-slate-300 bg-white" />
                <label class="flex items-center gap-2 text-sm text-slate-600">
                    <input id="stok_onlyLow" type="checkbox" class="w-4 h-4 rounded"> Sadece kritik stok
                </label>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
                <select id="stok_filterKind" class="w-full px-3 py-2 rounded-xl border border-slate-300 bg-white text-sm">
                    <option value="">Tüm Türler</option>
                    <option value="mamul">Mamul</option>
                    <option value="yari">Yarı-mamul</option>
                    <option value="ham">Hammadde</option>
                </select>
                <select id="stok_filterCategory" class="w-full px-3 py-2 rounded-xl border border-slate-300 bg-white text-sm">
                    <option value="">Tüm Çeşitler</option>
                </select>
                <button id="stok_btnClearFilters" class="px-3 py-2 rounded-xl border border-slate-300 bg-slate-50 text-sm">Filtreleri Temizle</button>
            </div>
        </header>
        <p class="text-xs text-slate-500 text-center md:text-left mb-2 px-1">
            İpucu: Gelişmiş arama için <strong>kod:</strong>, <strong>ad:</strong>, <strong>not:</strong> veya çeşit adı (<strong>rulman:</strong>) gibi anahtar kelimeler kullanın.
        </p>
        <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-6 gap-2 mb-4" id="stok-mobile-buttons">
            <button class="stok_btnAdd w-full px-3 py-2 rounded-xl btn-brand">Ürün Ekle</button>
            <button class="stok_btnImport w-full px-3 py-2 rounded-xl border border-slate-300 bg-white">İçe Aktar</button>
            <button class="stok_btnExport w-full px-3 py-2 rounded-xl border border-slate-300 bg-white">Dışa Aktar</button>
            <button class="stok_btnExportCSV w-full px-3 py-2 rounded-xl border border-slate-300 bg-white">CSV</button>
            <button class="stok_btnExportLogCSV w-full px-3 py-2 rounded-xl border border-slate-300 bg-white">Log CSV</button>
            <button class="stok_btnClear w-full px-3 py-2 rounded-xl text-white bg-rose-600 admin-only">Tüm Veriyi Sil</button>
        </div>
        <div class="text-sm text-slate-500 mb-2">Toplam <span id="stok_count" class="font-bold">0</span> kayıt listeleniyor.</div>
        <div class="hidden md:block overflow-auto rounded-2xl border border-slate-200 bg-white">
            <table class="min-w-full text-sm">
                <thead id="stok_thead" class="bg-slate-100 text-slate-700">
                    <tr>
                        <th data-sort="sku" class="text-left px-3 py-2 cursor-pointer select-none">Stok Kodu</th>
                        <th data-sort="name" class="text-left px-3 py-2 cursor-pointer select-none">Ad</th>
                        <th class="text-left px-3 py-2">Tür/Çeşit</th>
                        <th data-sort="qty" class="text-right px-3 py-2 cursor-pointer select-none">Stok</th>
                        <th data-sort="min" class="text-right px-3 py-2 cursor-pointer select-none">Minimum</th>
                        <th data-sort="cost" class="text-right px-3 py-2 cursor-pointer select-none hertz-muhasebe-only">Birim Maliyet</th>
                        <th class="text-left px-3 py-2 hertz-only">Tahmini Tükenme</th>
                        <th class="text-left px-3 py-2">Özellikler</th>
                        <th class="text-left px-3 py-2 hertz-muhasebe-only">Tedarikçi</th>
                        <th class="text-right px-3 py-2">İşlemler</th>
                    </tr>
                </thead>
                <tbody id="stok_tbodyDesktop" class="divide-y divide-slate-100"></tbody>
            </table>
        </div>
        <div id="stok_listMobile" class="md:hidden space-y-2"></div>
    </div>

    <div id="stok_tabContent_tedarikciler" class="stok-tab-content hidden">
        <div class="flex justify-between items-center mb-4">
             <h2 class="text-xl font-semibold text-slate-800">Tedarikçi Yönetimi</h2>
             <button id="stok_btnAddSupplier" class="px-3 py-2 rounded-xl btn-brand">Yeni Tedarikçi Ekle</button>
        </div>
        <div class="overflow-auto rounded-2xl border border-slate-200 bg-white">
            <table class="w-full text-sm">
                <thead class="bg-slate-100 text-slate-700">
                    <tr>
                        <th class="text-left px-3 py-2">Firma Ünvanı</th>
                        <th class="text-left px-3 py-2">İlgili Kişi</th>
                        <th class="text-left px-3 py-2">İletişim</th>
                        <th class="text-right px-3 py-2">İşlemler</th>
                    </tr>
                </thead>
                <tbody id="stok_supplierList" class="divide-y divide-slate-100"></tbody>
            </table>
        </div>
    </div>

    <div id="stok_tabContent_analiz" class="stok-tab-content hidden">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="bg-white p-4 rounded-2xl border border-slate-200 shadow-sm">
                <h3 class="font-semibold text-slate-800 mb-3">En Aktif Ürünler</h3>
                <div class="mb-3">
                    <select id="stok_analiz_aktif_gun" class="text-sm rounded-lg border-slate-300">
                        <option value="30">Son 30 Gün</option>
                        <option value="7">Son 7 Gün</option>
                        <option value="90">Son 90 Gün</option>
                    </select>
                </div>
                <div class="overflow-auto max-h-80">
                    <table class="w-full text-xs">
                        <thead><tr class="text-left text-slate-600"><th class="p-2">Ürün</th><th class="p-2 text-right">İşlem Sayısı</th></tr></thead>
                        <tbody id="stok_analiz_aktif_body"></tbody>
                    </table>
                </div>
            </div>
            <div class="bg-white p-4 rounded-2xl border border-slate-200 shadow-sm">
                <h3 class="font-semibold text-slate-800 mb-3">Hareketsiz Ürünler (Ölü Stok)</h3>
                 <div class="mb-3">
                    <select id="stok_analiz_pasif_gun" class="text-sm rounded-lg border-slate-300">
                        <option value="90">90+ gündür hareketsiz</option>
                        <option value="180">180+ gündür hareketsiz</option>
                        <option value="365">365+ gündür hareketsiz</option>
                    </select>
                </div>
                <div class="overflow-auto max-h-80">
                     <table class="w-full text-xs">
                        <thead><tr class="text-left text-slate-600"><th class="p-2">Ürün</th><th class="p-2">Son Hareket</th><th class="p-2 text-right">Stok</th></tr></thead>
                        <tbody id="stok_analiz_pasif_body"></tbody>
                    </table>
                </div>
            </div>
            <div class="bg-white p-4 rounded-2xl border border-slate-200 shadow-sm hertz-only">
                <div class="flex flex-wrap justify-between items-center mb-3 gap-2">
                    <h3 class="font-semibold text-slate-800">Stok Devir Hızı</h3>
                    <select id="stok_analiz_devir_hizi_gun" class="text-sm rounded-lg border-slate-300">
                        <option value="365">Son 1 Yıl</option>
                        <option value="90" selected>Son 90 Gün</option>
                        <option value="30">Son 30 Gün</option>
                    </select>
                </div>
                <div id="stok_analiz_devir_hizi_body" class="grid grid-cols-2 gap-4 text-center">
                    <!-- Data will be injected by JS -->
                </div>
            </div>
            <div class="bg-white p-4 rounded-2xl border border-slate-200 shadow-sm hertz-only">
                 <h3 class="font-semibold text-slate-800 mb-3">Kullanıcı Aktivitesi</h3>
                 <div class="overflow-auto max-h-80">
                     <table class="w-full text-xs">
                        <thead><tr class="text-left text-slate-600"><th class="p-2">Kullanıcı</th><th class="p-2 text-right">Toplam İşlem Sayısı</th></tr></thead>
                        <tbody id="stok_analiz_kullanici_body"></tbody>
                    </table>
                </div>
            </div>
            <div class="bg-white p-4 rounded-2xl border border-slate-200 shadow-sm hertz-only lg:col-span-2">
                <div class="flex flex-wrap justify-between items-center mb-3 gap-2">
                    <h3 class="font-semibold text-slate-800">Tüketim Trendleri (Son 12 Ay)</h3>
                    <select id="stok_analiz_tuketim_urun" class="text-sm rounded-lg border border-slate-300 w-full md:w-auto max-w-xs">
                        <option value="">-- Ürün Seç --</option>
                    </select>
                </div>
                <div class="min-h-[250px] relative">
                    <canvas id="stok_analiz_tuketim_chart"></canvas>
                </div>
            </div>
            <div class="bg-white p-4 rounded-2xl border border-slate-200 shadow-sm lg:col-span-2 hertz-only">
                 <h3 class="font-semibold text-slate-800 mb-3">ABC Analizi (Yıllık Tüketim Değerine Göre)</h3>
                 <!-- İYİLEŞTİRME: ABC Analizi için bilgilendirme notu eklendi -->
                 <p class="text-xs text-slate-500 mb-2 px-2">Not: Bu analiz, yalnızca birim maliyeti girilmiş olan ürünlerin tüketim verilerine dayanmaktadır.</p>
                 <div class="overflow-auto max-h-96">
                     <table class="w-full text-xs">
                        <thead><tr class="text-left text-slate-600"><th class="p-2">Ürün</th><th class="p-2">Grup</th><th class="p-2 text-right">Yıllık Değer</th><th class="p-2 text-right">Kümülatif Pay</th></tr></thead>
                        <tbody id="stok_analiz_abc_body"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <div id="stok_tabContent_gecmis" class="stok-tab-content hidden">
        <div class="overflow-auto rounded-2xl border border-slate-200 bg-white max-h-[70vh] no-scrollbar">
            <table class="min-w-full text-sm">
                <thead class="bg-slate-100 text-slate-700 sticky top-0">
                    <tr>
                    <th class="text-left px-3 py-2">Tarih</th><th class="text-left px-3 py-2">Ürün</th><th class="text-left px-3 py-2">Tür</th>
                    <th class="text-right px-3 py-2">Miktar</th><th class="text-right px-3 py-2">Önce</th><th class="text-right px-3 py-2">Sonra</th>
                    <th class="text-left px-3 py-2">Not</th><th class="text-left px-3 py-2">Kullanıcı</th>
                    </tr>
                </thead>
                <tbody id="stok_logBody" class="divide-y divide-slate-100"></tbody>
            </table>
        </div>
    </div>
    
    <dialog id="stok_productDialog" class="rounded-2xl p-0 w-[96vw] max-w-xl">
        <form id="stok_productForm" class="p-4" novalidate>
        <h3 id="stok_productDialogTitle" class="text-lg font-semibold mb-4">Ürün Ekle</h3>
        <div class="grid md:grid-cols-2 gap-3">
            <div><label class="text-sm text-slate-600">Ürün Türü</label><select name="kind" id="stok_kind" class="w-full px-3 py-2 rounded-xl border border-slate-300"><option value="mamul">Mamul</option><option value="yari">Yarı-mamul</option><option value="ham">Hammadde</option></select></div>
            <div><label class="text-sm text-slate-600">Ürün Çeşidi</label><select name="category" id="stok_category" class="w-full px-3 py-2 rounded-xl border border-slate-300"><option value="stator">Stator</option><option value="rotor">Rotor</option><option value="mil">Mil</option><option value="rotorluMil">Rotorlu Mil</option><option value="taslanmisMil">Taşlanmış Mil</option><option value="sargiliPaket">Sargılı Paket</option><option value="paketliGovde">Paketli Gövde</option><option value="motor">Motor</option><option value="bakir_tel">Bakır Tel</option><option value="yardimci_parcalar">Yardımcı Parçalar</option><option value="aluminyum_govde">Alüminyum Gövde</option><option value="rulman">Rulman</option><option value="kapak">Kapak</option><option value="islenmisKapak">İşlenmiş Kapak</option><option value="taslanmisKapak">Taşlanmış Kapak</option></select></div>
            <div class="md:col-span-2"><label class="text-sm text-slate-600">Ad</label><input name="name" type="text" required class="w-full px-3 py-2 rounded-xl border border-slate-300"></div>
            <div><label class="text-sm text-slate-600">Stok Kodu</label><div class="flex gap-2"><input name="sku" id="stok_sku" type="text" required class="w-full px-3 py-2 rounded-xl border border-slate-300"><button type="button" id="stok_btnAutoSku" class="px-3 py-2 rounded-xl border border-slate-300">Oluştur</button></div><p class="text-xs text-slate-500 mt-1">Ürün çeşidine göre otomatik kod önerilir. Dilersen düzenleyebilirsin.</p></div>
            <div><label class="text-sm text-slate-600">Birim</label><input name="unit" type="text" placeholder="adet, kg, m…" class="w-full px-3 py-2 rounded-xl border border-slate-300"></div>
            <div class="hertz-muhasebe-only"><label class="text-sm text-slate-600">Birim Maliyet (€)</label><input name="cost" type="number" step="any" min="0" placeholder="0.00" class="w-full px-3 py-2 rounded-xl border border-slate-300"></div>
            <div><label class="text-sm text-slate-600">Minimum Stok</label><input name="min" type="number" step="any" min="0" value="0" class="w-full px-3 py-2 rounded-xl border border-slate-300"></div>
            <div class="md:col-span-2 hertz-muhasebe-only"><label class="text-sm text-slate-600">Tedarikçi</label><select name="supplierId" id="stok_supplierSelect" class="w-full px-3 py-2 rounded-xl border border-slate-300"><option value="">-- Tedarikçi Seç --</option></select></div>
            <div class="md:col-span-2"><label class="text-sm text-slate-600">Not</label><input name="note" type="text" class="w-full px-3 py-2 rounded-xl border border-slate-300"></div>
            <div data-section="sargiliPaket" class="md:col-span-2 hidden"><div class="grid md:grid-cols-3 gap-3"><div><label class="text-sm text-slate-600">kW</label><input name="kw" type="number" step="any" min="0" class="w-full px-3 py-2 rounded-xl border border-slate-300"></div><div><label class="text-sm text-slate-600">Devir (rpm)</label><input name="rpm" type="number" step="1" min="0" class="w-full px-3 py-2 rounded-xl border border-slate-300"></div><div><label class="text-sm text-slate-600">Voltaj (V)</label><input name="volt" type="number" step="1" min="0" class="w-full px-3 py-2 rounded-xl border border-slate-300"></div></div></div>
            <div data-section="paketliGovde" class="md:col-span-2 hidden"><div class="grid md:grid-cols-3 gap-3"><div><label class="text-sm text-slate-600">Devir (rpm)</label><input name="pg_rpm" type="number" step="1" min="0" class="w-full px-3 py-2 rounded-xl border border-slate-300"></div><div><label class="text-sm text-slate-600">kW</label><input name="pg_kw" type="number" step="any" min="0" class="w-full px-3 py-2 rounded-xl border border-slate-300"></div><div><label class="text-sm text-slate-600">Voltaj (V)</label><input name="pg_volt" type="number" step="1" min="0" class="w-full px-3 py-2 rounded-xl border border-slate-300"></div></div><div class="grid md:grid-cols-2 gap-3 mt-3"><div><label class="text-sm text-slate-600">Müşteri</label><input name="pg_customer" type="text" class="w-full px-3 py-2 rounded-xl border border-slate-300"></div><div><label class="text-sm text-slate-600">Bağlantı Tipi</label><select name="pg_conn" class="w-full px-3 py-2 rounded-xl border border-slate-300"><option value="soketli">Soketli</option><option value="duz">Düz klemensli</option><option value="ters">Ters klemensli</option><option value="ykr">YKR</option><option value="ykl">YKL</option></select></div></div></div>
            <div data-section="mil" class="md:col-span-2 hidden"><div class="grid md:grid-cols-2 gap-3"><div><label class="text-sm text-slate-600">Mil Kodu</label><input name="milCode" type="text" class="w-full px-3 py-2 rounded-xl border border-slate-300"></div><div><label class="text-sm text-slate-600">Müşteri</label><input name="customer" type="text" class="w-full px-3 py-2 rounded-xl border border-slate-300"></div></div></div>
            <div data-section="motor" class="md:col-span-2 hidden"><div class="grid md:grid-cols-3 gap-3"><div><label class="text-sm text-slate-600">Müşteri</label><input name="customer" type="text" class="w-full px-3 py-2 rounded-xl border border-slate-300"></div><div><label class="text-sm text-slate-600">Devir (rpm)</label><input name="m_rpm" type="number" step="1" min="0" class="w-full px-3 py-2 rounded-xl border border-slate-300"></div><div><label class="text-sm text-slate-600">kW</label><input name="m_kw" type="number" step="any" min="0" class="w-full px-3 py-2 rounded-xl border border-slate-300"></div><div><label class="text-sm text-slate-600">Voltaj (V)</label><input name="m_volt" type="number" step="1" min="0" class="w-full px-3 py-2 rounded-xl border border-slate-300"></div><div><label class="text-sm text-slate-600">Bağlantı Tipi</label><select name="m_conn" class="w-full px-3 py-2 rounded-xl border border-slate-300"><option value="soketli">Soketli</option><option value="duz">Düz klemensli</option><option value="ters">Ters klemensli</option><option value="ykr">YKR</option><option value="ykl">YKL</option></select></div><div><label class="text-sm text-slate-600">Mil Tipi</label><input name="milType" type="text" placeholder="Örn: DIN 6885" class="w-full px-3 py-2 rounded-xl border border-slate-300"></div><div><label class="text-sm text-slate-600">Kapak Çeşidi</label><select name="m_cover" class="w-full px-3 py-2 rounded-xl border border-slate-300"><option value="AK">AK</option><option value="CK">CK</option><option value="CK/CR">CK/CR</option></select></div></div></div>
        </div>
        <div class="mt-5 flex justify-end gap-2"><button type="button" id="stok_productCancelBtn" class="px-3 py-2 rounded-xl border border-slate-300 bg-white">Vazgeç</button><button id="stok_productSaveBtn" type="submit" class="px-3 py-2 rounded-xl btn-brand">Kaydet</button></div>
        <input type="hidden" name="id">
        </form>
    </dialog>
    <dialog id="stok_supplierDialog" class="rounded-2xl p-0 w-[96vw] max-w-lg">
        <form id="stok_supplierDialogForm" class="p-4" novalidate>
        <h3 id="stok_supplierDialogTitle" class="text-lg font-semibold mb-4">Tedarikçi Ekle</h3>
        <div class="space-y-3">
             <div><label class="text-sm text-slate-600">Firma Ünvanı</label><input name="name" type="text" required class="w-full px-3 py-2 rounded-xl border border-slate-300"></div>
             <div><label class="text-sm text-slate-600">İlgili Kişi</label><input name="contactPerson" type="text" class="w-full px-3 py-2 rounded-xl border border-slate-300"></div>
             <div><label class="text-sm text-slate-600">Telefon</label><input name="phone" type="tel" class="w-full px-3 py-2 rounded-xl border border-slate-300"></div>
             <div><label class="text-sm text-slate-600">E-posta</label><input name="email" type="email" class="w-full px-3 py-2 rounded-xl border border-slate-300"></div>
        </div>
        <div class="mt-5 flex justify-end gap-2"><button type="button" id="stok_supplierCancelBtn" class="px-3 py-2 rounded-xl border border-slate-300 bg-white">Vazgeç</button><button id="stok_supplierSaveBtn" type="submit" class="px-3 py-2 rounded-xl btn-brand">Kaydet</button></div>
        <input type="hidden" name="id">
        </form>
    </dialog>
    <dialog id="stok_moveDialog" class="rounded-2xl p-0 w-[96vw] max-w-md">
        <form id="stok_moveForm" class="p-4" novalidate>
        <h3 class="text-lg font-semibold mb-4">Stok Hareketi</h3>
        <div class="space-y-3">
            <div class="text-sm">Ürün: <span id="stok_moveProductName" class="font-medium"></span></div>
            <div class="grid grid-cols-2 gap-3"><label class="flex items-center gap-2"><input type="radio" name="type" value="in" checked> <span>Giriş</span></label><label class="flex items-center gap-2"><input type="radio" name="type" value="out"> <span>Çıkış</span></label></div>
            <div><label class="text-sm">Miktar</label><input name="amount" type="number" step="any" min="0" required class="w-full px-3 py-2 rounded-xl border border-slate-300"></div>
            <div><label class="text-sm">Not (isteğe bağlı)</label><input name="note" type="text" class="w-full px-3 py-2 rounded-xl border border-slate-300"></div>
        </div>
        <div class="mt-5 flex justify-end gap-2"><button type="button" id="stok_moveCancelBtn" class="px-3 py-2 rounded-xl border border-slate-300 bg-white">Vazgeç</button><button id="stok_moveApplyBtn" type="submit" class="px-3 py-2 rounded-xl btn-brand">Kaydet</button></div>
        <input type="hidden" name="id">
        </form>
    </dialog>
  <input id="stok_fileInput" type="file" accept="application/json" class="hidden">
</div>
`;

function initializeSiparisServisApp() {
    const appContainer = document.getElementById('app-siparis-servis');
    if (!appContainer.innerHTML.trim()) return; 

    const $ = (selector, root = document) => root.querySelector(selector);
    const $$ = (selector, root = document) => Array.from(root.querySelectorAll(selector));
    
    let currentTab = "siparis";
    let siparisSort = { key: 'no', direction: 'desc' };
    let sevkSort = { key: 'sevkEdildi', direction: 'desc' };
    let servisSort = { key: 'no', direction: 'desc' };
    let teknikServisSevkSort = { key: 'sevkEdildi', direction: 'desc' };

    const allPages = $$("section[id^='ss_page']", appContainer);
    const allTabs = $$(".tab-btn", appContainer);
    const table = $('#ss_orderTable', appContainer);
    const form = $('#ss_orderForm', appContainer);
    const logTable = $('#ss_logTable', appContainer);
    const fileInput = $('#ss_fileInput', appContainer);
    const sevkTable = $('#ss_sevkTable', appContainer);
    const teknikServisSevkTable = $('#ss_teknikServisSevkTable', appContainer);
    const searchInput = $('#ss_sevkSearch', appContainer);
    const dateFromInput = $('#ss_sevkDateFrom', appContainer);
    const dateToInput = $('#ss_sevkDateTo', appContainer);
    const servisForm = $('#ss_servisForm', appContainer);
    const servisSearch = $('#ss_servisSearch', appContainer);
    const servisTable = $('#ss_servisTable', appContainer);
    const teknikSevkSearch = $('#ss_teknikSevkSearch', appContainer);
    const teknikSevkDateFrom = $('#ss_teknikSevkDateFrom', appContainer);
    const teknikSevkDateTo = $('#ss_teknikSevkDateTo', appContainer);
    
    let orders, logs, sevkEdilenler, servisKayitlari, servisSevkEdilenler;

    function loadDataFromStorage() {
        orders = window.dataStore['siparisler'] || [];
        logs = window.dataStore['siparisLog'] || [];
        sevkEdilenler = window.dataStore['sevkEdilenler'] || [];
        servisKayitlari = window.dataStore['servisKayitlari'] || [];
        servisSevkEdilenler = window.dataStore['servisSevkEdilenler'] || [];
    }

    function formatDate_TR(input) {
      if (!input) return "";
      const dt = (input instanceof Date) ? input : parseAnyDate(input);
      if (!dt) return "";
      const d = String(dt.getDate()).padStart(2,"0");
      const m = String(dt.getMonth()+1).padStart(2,"0");
      const y = dt.getFullYear();
      return `${d}/${m}/${y}`;
    }

    function parseDdMmYyyy(str){
      const m = String(str || "").match(/^(\d{1,2})[.\/-](\d{1,2})[.\/-](\d{4})$/);
      if (!m) return null;
      const d = parseInt(m[1],10), mo = parseInt(m[2],10)-1, y = parseInt(m[3],10);
      const dt = new Date(y, mo, d);
      return isNaN(dt.getTime()) ? null : dt;
    }

    function parseAnyDate(input) {
        if (input instanceof Date) return input;
        if (typeof input !== 'string') return null;
        let dt = parseDdMmYyyy(input.split(' ')[0]); 
        if (dt) return dt;
        const isoMatch = input.match(/^(\d{4})-(\d{2})-(\d{2})/);
        if (isoMatch) {
            dt = new Date(isoMatch[1], parseInt(isoMatch[2], 10) - 1, isoMatch[3]);
            if (!isNaN(dt.getTime())) return dt;
        }
        dt = new Date(input);
        return isNaN(dt.getTime()) ? null : dt;
    }

    function atLocalMidnight(dt){ return new Date(dt.getFullYear(), dt.getMonth(), dt.getDate()); }
    function todayLocal(){ const n = new Date(); return new Date(n.getFullYear(), n.getMonth(), n.getDate()); }
    function formatDateTime_TR(input) {
      const dt = (input instanceof Date) ? input : new Date(input);
      const d = String(dt.getDate()).padStart(2,"0");
      const m = String(dt.getMonth()+1).padStart(2,"0");
      const y = dt.getFullYear();
      const hh = String(dt.getHours()).padStart(2,"0");
      const mm = String(dt.getMinutes()).padStart(2,"0");
      return `${d}/${m}/${y} ${hh}:${mm}`;
    }

    function getFPBaseOptions(){ return { dateFormat: "d/m/Y", altInput: true, altFormat: "j F Y", allowInput: true, locale: flatpickr.l10ns.tr }; }
    
    const Y_LIGHT = "#fef9c3", Y_FULL  = "#fcd34d", R_FULL  = "#ef4444", B_ROW   = "#bfdbfe";
    function hexToRgb(hex){ const h=hex.replace('#',''); const n=parseInt(h,16); return {r:(n>>16)&255,g:(n>>8)&255,b:n&255}; }
    function mixHex(c1,c2,t){ const a=hexToRgb(c1),b=hexToRgb(c2); const r=Math.round(a.r+(b.r-a.r)*t); const g=Math.round(a.g+(b.g-a.g)*t); const b2=Math.round(a.b+(b.b-a.b)*t); return `rgb(${r}, ${g}, ${b2})`; }

    function getRowBgByDue(sevkStr, isHazir){
      const due = parseAnyDate(sevkStr);
      if (!due) return null;
      const today = todayLocal();
      const dayMs = 86400000;
      const diff = (atLocalMidnight(due) - today) / dayMs;

      if (diff < 0) { // Termin tarihi geçmiş
        return isHazir ? Y_FULL : R_FULL;
      }

      if (diff <= 3){ // Termine 3 gün veya daha az kalmış
        const t = (3 - diff) / 3; 
        return mixHex(Y_LIGHT, Y_FULL, t); 
      }
      
      return null; // Diğer durumlar için özel renk yok
    }
    
    function getNextSiparisNo() {
        const now = new Date();
        const yy = String(now.getFullYear()).slice(-2);
        const mm = String(now.getMonth() + 1).padStart(2, '0');
        const prefix = `ORD-${yy}${mm}`;
        const all = [...orders, ...sevkEdilenler];
        let maxSeq = 0;
        for (const it of all) {
            if (it && it.no && String(it.no).startsWith(prefix)) {
            const n = parseInt(String(it.no).slice(prefix.length), 10);
            if (!isNaN(n) && n > maxSeq) maxSeq = n;
            }
        }
        return `${prefix}${String(maxSeq + 1).padStart(4, '0')}`;
    }

    function getNextServisNo() {
        const now = new Date();
        const yy = String(now.getFullYear()).slice(-2);
        const mm = String(now.getMonth() + 1).padStart(2, '0');
        const prefix = `TS-${yy}${mm}`;
        const all = [...servisKayitlari, ...servisSevkEdilenler];
        let maxSeq = 0;
        for (const it of all) {
            if (it && it.no && String(it.no).startsWith(prefix)) {
            const n = parseInt(String(it.no).slice(prefix.length), 10);
            if (!isNaN(n) && n > maxSeq) maxSeq = n;
            }
        }
        return `${prefix}${String(maxSeq + 1).padStart(4, '0')}`;
    }

    function logAction(no, islem) {
      logs.unshift({ no, islem, user: sessionStorage.getItem("auth_user") || "(anonim)", tarih: formatDateTime_TR(new Date()) });
      window.dataStore['siparisLog'] = logs;
      window.pushData('siparisLog');
      renderLogs();
    }
    
    let lastPaintDay = todayLocal().toDateString();
    function scheduleMidnightRefresh(){
      const now = new Date();
      const next = new Date(now.getFullYear(), now.getMonth(), now.getDate()+1, 0, 0, 1);
      setTimeout(()=>{
        checkDayAndRefresh();
        scheduleMidnightRefresh();
      }, next - now);
    }
    function checkDayAndRefresh(){
      const todayStr = todayLocal().toDateString();
      if (todayStr !== lastPaintDay){
        renderAllTables();
        lastPaintDay = todayStr;
      }
    }
    
    function setTab(tabId){
      currentTab = tabId;
      const pageMap = {
          siparis: '#ss_pageSiparis', sevk: '#ss_pageSevk', servis: '#ss_pageServis'
      };
      const tabMap = {
          siparis: '#ss_tabSiparis', sevk: '#ss_tabSevk', servis: '#ss_tabServis'
      };

      allPages.forEach(p => p.classList.add("hidden"));
      allTabs.forEach(t => t.classList.remove("font-medium", "bg-slate-100"));
      
      const pageToShow = appContainer.querySelector(pageMap[tabId]);
      const tabToActivate = appContainer.querySelector(tabMap[tabId]);
      
      if(pageToShow) pageToShow.classList.remove("hidden");
      if(tabToActivate) tabToActivate.classList.add("font-medium", "bg-slate-100");

      if (tabId === 'sevk') {
        renderSevkList();
        renderTeknikServisSevkList();
      }
      if (tabId === 'servis') renderServisList();
    }

    allTabs.forEach(tab => {
        const tabId = tab.id.replace('ss_tab', '').toLowerCase();
        tab.addEventListener("click", () => setTab(tabId));
    });
    
    function geriAlServisSevk(no){
      const idx = servisSevkEdilenler.findIndex(x => x.no === no);
      if (idx === -1) return;
      const [rec] = servisSevkEdilenler.splice(idx, 1);
      delete rec.sevkEdildi;
      delete rec.kullanici;
      servisKayitlari.push(rec);
      window.dataStore['servisSevkEdilenler'] = servisSevkEdilenler;
      window.pushData('servisSevkEdilenler');
      window.dataStore['servisKayitlari'] = servisKayitlari;
      window.pushData('servisKayitlari');
      logAction(rec.no || "(servis)", "Servis sevk geri alındı");
      showToast(`${rec.no} no'lu servis sevki geri alındı.`, "success");
      renderServisList();
      if (currentTab === "sevk") renderTeknikServisSevkList();
    }

    // YENİ EKLENDİ: Çalışmayan sevk etme özelliğini düzelten fonksiyon.
    function markServisAsSevk(index) {
        if (index < 0 || index >= servisKayitlari.length) {
            showToast("Hata: Geçersiz servis kaydı.", "error");
            return;
        }
        const servisToShip = servisKayitlari[index];
        const user = sessionStorage.getItem("auth_user") || "(bilinmiyor)";
        
        servisSevkEdilenler.push({ 
            ...servisToShip, 
            sevkEdildi: formatDateTime_TR(new Date()), 
            kullanici: user 
        });
        window.dataStore['servisSevkEdilenler'] = servisSevkEdilenler;
        window.pushData('servisSevkEdilenler');
        
        logAction(servisToShip.no, "Teknik servis kaydı sevk edildi");
        servisKayitlari.splice(index, 1);
        window.dataStore['servisKayitlari'] = servisKayitlari;
        window.pushData('servisKayitlari');
        
        showToast(`${servisToShip.no} no'lu servis kaydı sevk edildi.`, "success");
        renderServisList();
        renderTeknikServisSevkList();
    }

    function renderLogs() {
      logTable.innerHTML = "";
      logs.slice(0, 100).forEach(log => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="px-2 py-1">${log.tarih}</td>
          <td class="px-2 py-1 font-medium">${log.no}</td>
          <td class="px-2 py-1">${log.islem}</td>
          <td class="px-2 py-1 text-slate-500">${log.user}</td>
        `;
        logTable.appendChild(tr);
      });
    }

    function createOrderRow(o) {
        const tr = document.createElement("tr");
        tr.dataset.no = o.no; 

        if (o.sevkeHazir) {
          tr.style.backgroundColor = B_ROW;
        } else if (!o.sevkTarihi) {
          tr.classList.add("highlight");
        } else {
          const bg = getRowBgByDue(o.sevkTarihi, o.hazir);
          if (bg) tr.style.backgroundColor = bg;
        }

        const showVal = (v) => (v === undefined || v === null || v === '' ? '<span class="text-slate-400 italic">—</span>' : String(v));
        const span = (text, field, type, extraCls='') => `<span class="editable block min-h-[28px] w-full px-1 rounded ${extraCls}" data-field="${field}" data-type="${type}">${showVal(text)}</span>`;

        tr.innerHTML = `
          <td data-label="No"><span class="font-semibold">${o.no}</span></td>
          <td data-label="Müşteri">${span(o.musteri, 'musteri', 'text')}</td>
          <td data-label="Ürün">${span(o.urun, 'urun', 'text')}</td>
          <td data-label="Mil Kodu">${span(o.milKod, 'milKod', 'text')}</td>
          <td data-label="kW">${span(o.kw, 'kw', 'number','text-right')}</td>
          <td data-label="RPM">${span(o.rpm, 'rpm', 'number','text-right')}</td>
          <td data-label="Voltaj">${span(o.volt, 'volt', 'number','text-right')}</td>
          <td data-label="Sevk Tarihi">${span(formatDate_TR(o.sevkTarihi), 'sevkTarihi', 'date')}</td>
          <td data-label="Açıklama"><button class="px-2 py-1 rounded-md border bg-white hover:bg-slate-50 text-xs underline" data-action="edit-desc">${(o.aciklama || '').trim() ? 'Açıklamayı Gör' : 'Açıklama Ekle'}</button></td>
          <td data-label="Hazır" class="${o.hazir ? 'bg-green-100' : ''}"><input type="checkbox" ${o.hazir?'checked':''} data-action="toggle-hazir" /></td>
          <td data-label="Sevke Hazır" class="${o.sevkeHazir ? 'bg-blue-100' : ''}"><input type="checkbox" ${o.sevkeHazir?'checked':''} ${o.hazir?'':'disabled'} data-action="toggle-sevke-hazir" /></td>
          <td data-label="Durum">${o.sevkeHazir ? (o.sevkTarihi ? `<button data-action="sevk-et" class="text-blue-600 underline">Sevk Et</button>` : '<span class="text-slate-400 italic">Tarih belirtilmemiş</span>') : '<span class="text-slate-400 italic">Sevke hazır değil</span>'}</td>
          <td data-label="İşlemler"><button class="text-rose-600 underline" data-action="delete">Sil</button></td>
        `;
        return tr;
    }

    function renderOrders() {
      sortData(orders, siparisSort.key, siparisSort.direction, appContainer.querySelector(`#ss_pageSiparis th[data-sort-key="${siparisSort.key}"]`)?.dataset.sortType);
      
      const fragment = document.createDocumentFragment();
      orders.forEach(o => fragment.appendChild(createOrderRow(o)));
      
      table.innerHTML = "";
      table.appendChild(fragment);

      lastPaintDay = todayLocal().toDateString();
      updateSortIndicators(table.id, siparisSort);
    }
    
    function renderTeknikServisSevkList() {
        sortData(servisSevkEdilenler, teknikServisSevkSort.key, teknikServisSevkSort.direction, appContainer.querySelector(`#ss_teknikServisSevkTable th[data-sort-key="${teknikServisSevkSort.key}"]`)?.dataset.sortType);

        const q = (teknikSevkSearch.value || "").toLowerCase();
        const df = parseDdMmYyyy(teknikSevkDateFrom.value);
        const dt = parseDdMmYyyy(teknikSevkDateTo.value);

        const filtered = servisSevkEdilenler.filter(item => {
            const txt = [item.no, item.firma, item.urun, item.milTipi, item.ariza].join(" ").toLowerCase();
            const okTxt = !q || txt.includes(q);
            const sevkDate = item.sevkEdildi ? parseAnyDate(item.sevkEdildi.split(' ')[0]) : null;
            const okFrom = !df || (sevkDate && atLocalMidnight(sevkDate) >= df);
            const okTo   = !dt || (sevkDate && atLocalMidnight(sevkDate) <= dt);
            return okTxt && okFrom && okTo;
        });

        const fragment = document.createDocumentFragment();
        filtered.forEach((o) => {
            const tr = document.createElement("tr");
            tr.dataset.no = o.no;
            tr.innerHTML = `
                <td data-label="No"><span class="font-semibold">${o.no}</span></td>
                <td data-label="Firma">${o.firma || ""}</td>
                <td data-label="Ürün">${o.urun || ""}</td>
                <td data-label="Mil Tipi">${o.milTipi || ""}</td>
                <td data-label="Arıza">${o.ariza || ""}</td>
                <td data-label="Sevk Edildi">${o.sevkEdildi || ""}</td>
                <td data-label="Kullanıcı">${o.kullanici || ""}</td>
                <td data-label="İşlem"><button class="text-slate-600 underline" data-action="geri-al-servis-sevk">Geri Al</button></td>
            `;
            fragment.appendChild(tr);
        });
        teknikServisSevkTable.innerHTML = "";
        teknikServisSevkTable.appendChild(fragment);
        updateSortIndicators(teknikServisSevkTable.id, teknikServisSevkSort);
    }

    function renderSevkList(){
      sortData(sevkEdilenler, sevkSort.key, sevkSort.direction, appContainer.querySelector(`#ss_pageSevk th[data-sort-key="${sevkSort.key}"]`)?.dataset.sortType);
      const q = (searchInput.value || "").toLowerCase();
      const df = parseDdMmYyyy(dateFromInput.value);
      const dt = parseDdMmYyyy(dateToInput.value);

      const filtered = sevkEdilenler.filter(item => {
        const txt = [item.no, item.musteri, item.urun, item.milKod].join(" ").toLowerCase();
        const okTxt = !q || txt.includes(q);
        const sevkDate = item.sevkEdildi ? parseAnyDate(item.sevkEdildi.split(' ')[0]) : null;
        const okFrom = !df || (sevkDate && atLocalMidnight(sevkDate) >= df);
        const okTo   = !dt || (sevkDate && atLocalMidnight(sevkDate) <= dt);
        return okTxt && okFrom && okTo;
      });
      
      const fragment = document.createDocumentFragment();
      filtered.forEach((o) => {
        const tr = document.createElement("tr");
        tr.dataset.no = o.no;
        tr.innerHTML = `
          <td data-label="No"><span class="font-semibold">${o.no}</span></td>
          <td data-label="Müşteri">${o.musteri || ""}</td>
          <td data-label="Ürün">${o.urun || ""}</td>
          <td data-label="Mil Kodu">${o.milKod || ""}</td>
          <td data-label="kW">${o.kw || ""}</td>
          <td data-label="RPM">${o.rpm || ""}</td>
          <td data-label="Voltaj">${o.volt || ""}</td>
          <td data-label="Sevk Tarihi">${formatDate_TR(o.sevkTarihi) || ""}</td>
          <td data-label="Sevk Edildi">${o.sevkEdildi || ""}</td>
          <td data-label="Kullanıcı">${o.kullanici || ""}</td>
          <td data-label="İşlem"><button class="text-slate-600 underline" data-action="geri-al-sevk">Geri Al</button></td>
        `;
        fragment.appendChild(tr);
      });
      sevkTable.innerHTML = "";
      sevkTable.appendChild(fragment);
      updateSortIndicators(sevkTable.id, sevkSort);
    }

    function servisRowBg(durum){
      switch((durum || '').toUpperCase()){
        case "HAZIR": return "#fef3c7";
        case "BEKLEMEDE": return "#f1f5f9";
        case "İNCELENİYOR": case "INCELENIYOR": return "#fef3c7";
        case "TEKLİF BEKLİYOR": case "TEKLIF BEKLIYOR": return "#ede9fe";
        default: return "";
      }
    }
    
    function renderServisList(){
      sortData(servisKayitlari, servisSort.key, servisSort.direction, appContainer.querySelector(`#ss_pageServis th[data-sort-key="${servisSort.key}"]`)?.dataset.sortType);

      const q = (servisSearch.value || "").toLowerCase();
      const filtered = servisKayitlari.filter(it => {
        const txt = [it.no, it.firma, it.urun, it.ariza, it.milTipi, it.not, it.aciklama, it.durum].join(" ").toLowerCase();
        return !q || txt.includes(q);
      });

      const fragment = document.createDocumentFragment();
      filtered.forEach((s) => {
        const tr = document.createElement("tr");
        tr.dataset.no = s.no;
        
        let bg = null;
        const isServisHazir = (s.durum || '').toUpperCase() === 'HAZIR';

        // Öncelik: Sevk tarihine göre renklendirme (siparişlerdeki gibi)
        if (s.sevkTarihi) {
            bg = getRowBgByDue(s.sevkTarihi, isServisHazir);
        }
        
        // Sevk tarihi rengi yoksa, duruma göre renklendirme
        if (!bg) {
            bg = servisRowBg(s.durum);
        }

        if (bg) {
            tr.style.backgroundColor = bg;
        }
        
        const showVal = (v) => (v === undefined || v === null || v === '' ? '<span class="text-slate-400 italic">—</span>' : String(v));
        const span = (text, field, type, extraCls='') => `<span class="editable block min-h-[28px] w-full px-1 rounded ${extraCls}" data-field="${field}" data-type="${type}">${showVal(text)}</span>`;

        tr.innerHTML = `
          <td data-label="No"><span class="font-semibold">${s.no || ''}</span></td>
          <td data-label="Firma">${span(s.firma, 'firma', 'text')}</td>
          <td data-label="Ürün">${span(s.urun, 'urun', 'text')}</td>
          <td data-label="Adet">${span(s.adet, 'adet', 'number','text-right')}</td>
          <td data-label="Arıza">${span(s.ariza, 'ariza', 'text')}</td>
          <td data-label="Mil Tipi">${span(s.milTipi, 'milTipi', 'text')}</td>
          <td data-label="Durum">${span(s.durum, 'durum', 'select')}</td>
          <td data-label="Not">${span(s.not, 'not', 'text')}</td>
          <td data-label="İletişim">${span(s.iletisim, 'iletisim', 'text')}</td>
          <td data-label="Kargo Tipi">${span(s.kargoTipi, 'kargoTipi', 'text')}</td>
          <td data-label="Sevk Tarihi">${span(formatDate_TR(s.sevkTarihi), 'sevkTarihi', 'date')}</td>
          <td data-label="Açıklama"><button class="px-2 py-1 rounded-md border bg-white hover:bg-slate-50 text-xs underline" data-action="edit-desc-servis">${(s.aciklama || '').trim() ? 'Açıklamayı Gör' : 'Açıklama Ekle'}</button></td>
          <td data-label="İşlem">
            <div class="flex flex-wrap gap-x-2 gap-y-1">
            ${(s.durum || '').toUpperCase() === 'HAZIR' ? `<button class="text-blue-600 underline" data-action="sevk-et-servis">Sevk Et</button>` : '<span class="text-slate-400 italic">Sevk edilemez</span>'}
            <button class="text-blue-600 underline" data-action="edit-servis">Düzenle</button>
            <button class="text-rose-600 underline" data-action="delete-servis">Sil</button>
            </div>
          </td>
        `;
        fragment.appendChild(tr);
      });
      servisTable.innerHTML = "";
      servisTable.appendChild(fragment);
      updateSortIndicators(servisTable.id, servisSort);
    }
    
    // İYİLEŞTİRME: Servis durumu değiştiğinde log kaydı ekleniyor.
    function setServisDurum(i, val){
      const s = servisKayitlari[i];
      if (!s) return;
      const old = s.durum || "";
      const newVal = (val || "").toUpperCase();
      if(old === newVal) return;

      s.durum = newVal;
      window.dataStore['servisKayitlari'] = servisKayitlari;
      window.pushData('servisKayitlari');
      logAction(s.no || "(servis)", `Teknik servis durumu değişti: ${old} -> ${s.durum}`);
      renderServisList();
    }
    
    function deleteServis(no){
      const index = servisKayitlari.findIndex(s => s.no === no);
      if (index === -1) return;
      if (!confirm('Kayıt silinsin mi?')) return;
      
      servisKayitlari.splice(index,1);
      window.dataStore['servisKayitlari'] = servisKayitlari;
      window.pushData('servisKayitlari');
      if (no) logAction(no, 'Teknik servis kaydı silindi');
      showToast(`${no} no'lu servis kaydı silindi.`, 'success');
      
      const rowToDelete = servisTable.querySelector(`tr[data-no="${no}"]`);
      if (rowToDelete) rowToDelete.remove();
    }
    
    function deleteOrder(no){
      const index = orders.findIndex(o => o.no === no);
      if (index === -1) {
          console.error("Silinecek sipariş bulunamadı:", no);
          showToast("Hata: Silinecek sipariş bulunamadı.", 'error');
          return;
      }
      const o = orders[index];
      if (!confirm(`#${o.no} numaralı siparişi silmek istediğinize emin misiniz?`)) return;
      
      orders.splice(index, 1);
      window.dataStore['siparisler'] = orders;
      window.pushData('siparisler');
      logAction(o.no, "Sipariş silindi");

      const rowToDelete = table.querySelector(`tr[data-no="${no}"]`);
      if (rowToDelete) rowToDelete.remove();

      showToast(`${o.no} numaralı sipariş silindi.`, 'success');
    }
    
    function inlineUpdate(index, field, value){
      if (!orders[index]) return;
      const oldVal = orders[index][field];
      orders[index][field] = value;
      window.dataStore['siparisler'] = orders;
      window.pushData('siparisler');
      if (field !== 'sevkTarihi'){
        logAction(orders[index].no, `Alan güncellendi: ${field} = "${oldVal ?? ''}" -> "${value}"`);
      }
    }

    let ss_descOverlay;
    function ensureDescOverlay(){
      if (ss_descOverlay) return ss_descOverlay;
      ss_descOverlay = document.createElement('div');
      ss_descOverlay.id = 'ss_descOverlay';
      ss_descOverlay.className = 'fixed inset-0 bg-black bg-opacity-50 z-[1000] flex items-center justify-center p-4 hidden';
      ss_descOverlay.innerHTML = `
        <div class="w-full max-w-3xl bg-white rounded-2xl shadow-2xl border border-slate-200">
          <div class="px-4 py-3 border-b flex items-center justify-between">
            <h3 class="font-semibold text-slate-800">Açıklama</h3>
            <button id="ss_descClose" class="px-3 py-1 border rounded-lg bg-white hover:bg-slate-50">Kapat</button>
          </div>
          <div class="p-4"><textarea id="ss_descText" class="w-full h-72 p-3 border rounded-lg" placeholder="Açıklama yazın..."></textarea></div>
          <div class="px-4 py-3 border-t flex gap-2 justify-end"><button id="ss_descSave" class="btn-brand px-4 py-2 rounded-xl">Kaydet</button></div>
        </div>`;
      document.body.appendChild(ss_descOverlay);
      ss_descOverlay.querySelector('#ss_descClose').onclick = () => ss_descOverlay.classList.add('hidden');
      return ss_descOverlay;
    }

    let currentDescCtx = null;
    function openDescEditor(type, index){
      currentDescCtx = { type, index };
      const ov = ensureDescOverlay();
      let text = '';
      if (type === 'siparis' && orders[index]) text = orders[index].aciklama || '';
      if (type === 'servis' && servisKayitlari[index]) text = servisKayitlari[index].aciklama || '';
      const ta = ov.querySelector('#ss_descText');
      ta.value = text;
      ov.classList.remove('hidden');
      
      ov.querySelector('#ss_descSave').onclick = () => {
        const val = ta.value || '';
        if (!currentDescCtx) return;
        const { type, index } = currentDescCtx;
        if (type === 'siparis' && orders[index]){
          orders[index].aciklama = val;
          window.dataStore['siparisler'] = orders;
          window.pushData('siparisler');
          logAction(orders[index].no, 'Açıklama güncellendi');
          renderOrders();
        } else if (type === 'servis' && servisKayitlari[index]){
          servisKayitlari[index].aciklama = val;
          window.dataStore['servisKayitlari'] = servisKayitlari;
          window.pushData('servisKayitlari');
          logAction(servisKayitlari[index].no, 'Servis açıklaması güncellendi');
          renderServisList();
        }
        ov.classList.add('hidden');
      };
    }
    
    // İYİLEŞTİRME: Sayısal alanlar için sıkı veri doğrulama eklendi.
    function makeEditable(el, index, field, type){
      const originalIndex = index;
      const current = orders[originalIndex] ? orders[originalIndex][field] : '';
      const td = el.parentElement;
      let input;
      if (type === 'date'){
        input = document.createElement('input');
        input.className = 'sevk-picker date-input px-2 py-1 border rounded-md bg-white w-[160px]';
      } else {
        input = document.createElement('input');
        input.type = type === 'number' ? 'number' : 'text';
        input.className = `px-2 py-1 border rounded-md w-full ${type==='number' ? 'text-right' : ''}`;
        if (type === 'number') {
            input.min = 0;
            input.step = "any";
        }
        input.value = current ?? '';
      }
      td.innerHTML = '';
      td.appendChild(input);
      input.focus();
      
      const commit = () => {
        let val = input.value.trim().replace(',', '.');
        if(type === 'date') {
          const date = parseDdMmYyyy(val);
          if(date) setSevkDate(originalIndex, date);
          else renderOrders(); 
        } else {
            let finalValue = val;
            if (type === 'number') {
                if (val === '') {
                    finalValue = null;
                } else {
                    const numVal = parseFloat(val);
                    if (!Number.isFinite(numVal) || numVal < 0) {
                        showToast("Lütfen geçerli bir pozitif sayı girin.", "error");
                        renderOrders(); 
                        return;
                    }
                    finalValue = numVal;
                }
            }
            inlineUpdate(originalIndex, field, finalValue);
            renderOrders();
        }
      };
      
      input.addEventListener('keydown', e => { if (e.key === 'Enter') commit(); else if (e.key === 'Escape') renderOrders(); });
      input.addEventListener('blur', commit);

      if (type === 'date'){
        flatpickr(input, { ...getFPBaseOptions(), defaultDate: parseAnyDate(current) || undefined, onClose: (sel) => { if (sel && sel[0]) setSevkDate(originalIndex, sel[0]); else renderOrders(); } }).open();
      }
    }

    function makeEditableServis(el, index, field, type){
      const s = servisKayitlari[index];
      if (!s) return;
      const td = el.parentElement;
      let input;

      const commitAndRender = () => {
        let val = input.value.trim().replace(',', '.');
        let finalValue = val;
        
        if (type === 'number') {
            if (val === '') {
                finalValue = null;
            } else {
                 const numVal = parseFloat(val);
                 if (!Number.isFinite(numVal) || numVal < 0) {
                     showToast("Lütfen geçerli bir pozitif sayı girin.", "error");
                     renderServisList();
                     return;
                 }
                 finalValue = numVal;
            }
        } else if (type === 'date') {
            const date = parseDdMmYyyy(val);
            if(date) setServisSevkDate(index, date);
            else renderServisList();
            return; 
        }

        s[field] = finalValue;
        window.dataStore['servisKayitlari'] = servisKayitlari;
        window.pushData('servisKayitlari');
        logAction(s.no || "(servis)", `Alan güncellendi: ${field}`);
        renderServisList();
      };

      if (type === 'select'){
        input = document.createElement('select');
        input.className = 'px-2 py-1 border rounded-md bg-white w-full';
        ["", "HAZIR", "BEKLEMEDE", "İNCELENİYOR", "TEKLİF BEKLİYOR"].forEach(op => {
          const o = document.createElement('option');
          o.value = op;
          o.textContent = op || '(Seçiniz)';
          if ((s[field] || "").toUpperCase() === op) o.selected = true;
          input.appendChild(o);
        });
        input.onchange = () => setServisDurum(index, input.value);
        input.onblur = () => renderServisList(); 
      } else {
        input = document.createElement('input');
        input.type = (type === 'date') ? 'text' : (type === 'number' ? 'number' : 'text');
        input.className = `px-2 py-1 border rounded-md w-full ${type==='number' ? 'text-right' : ''}`;
        if (type === 'number') {
            input.min = 0;
            input.step = "any";
        }
        input.value = (type === 'date') ? formatDate_TR(s[field]) : (s[field] ?? '');
        
        input.addEventListener('keydown', e => { if (e.key === 'Enter') commitAndRender(); if (e.key === 'Escape') renderServisList(); });
        input.addEventListener('blur', commitAndRender);
      }

      td.innerHTML = '';
      td.appendChild(input);
      input.focus();

      if (type === 'date'){
        flatpickr(input, { ...getFPBaseOptions(), defaultDate: parseAnyDate(s[field]) || undefined, onClose: (sel) => { if (sel && sel[0]) { setServisSevkDate(index, sel[0]); } else { renderServisList(); } } }).open();
      }
    }
    
    function setSevkDate(index, dateObj){
      orders[index].sevkTarihi = formatDate_TR(dateObj);
      window.dataStore['siparisler'] = orders;
      window.pushData('siparisler');
      logAction(orders[index].no, "Sevk tarihi güncellendi");
      renderOrders();
    }
    
    function setServisSevkDate(index, dateObj){
      if (!servisKayitlari[index]) return;
      servisKayitlari[index].sevkTarihi = formatDate_TR(dateObj);
       window.dataStore['servisKayitlari'] = servisKayitlari;
      window.pushData('servisKayitlari');
      logAction(servisKayitlari[index].no || '(servis)', 'Servis sevk tarihi güncellendi');
      renderServisList();
    }

    function toggleHazir(index, val){
      orders[index].hazir = !!val;
      if (!val) orders[index].sevkeHazir = false;
      window.dataStore['siparisler'] = orders;
      window.pushData('siparisler');
      logAction(orders[index].no, val ? "İmalat: Hazır" : "İmalat: Hazır değil");
      renderOrders();
    }
    function toggleSevkeHazir(index, val){
      if (val && !orders[index].hazir) {
        alert("Önce 'Hazır' işaretlenmeli.");
        renderOrders(); return;
      }
      orders[index].sevkeHazir = !!val;
      window.dataStore['siparisler'] = orders;
      window.pushData('siparisler');
      logAction(orders[index].no, val ? "Sevke Hazır" : "Sevke Hazır değil");
      renderOrders();
    }
    function markAsSevk(no) {
      const index = orders.findIndex(o => o.no === no);
      if (index === -1) {
          console.error("Sevk edilecek sipariş bulunamadı:", no);
          showToast("Hata: Sevk edilecek sipariş bulunamadı.", "error");
          return;
      }
      const orderToShip = orders[index];
      const user = sessionStorage.getItem("auth_user") || "(bilinmiyor)";
      sevkEdilenler.push({ ...orderToShip, sevkEdildi: formatDateTime_TR(new Date()), kullanici: user });
      window.dataStore['sevkEdilenler'] = sevkEdilenler;
      window.pushData('sevkEdilenler');
      
      logAction(orderToShip.no, "Sipariş sevk edildi");
      orders.splice(index, 1);
      window.dataStore['siparisler'] = orders;
      window.pushData('siparisler');
      
      showToast(`${orderToShip.no} no'lu sipariş sevk edildi.`, "success");
      const rowToDelete = table.querySelector(`tr[data-no="${no}"]`);
      if(rowToDelete) rowToDelete.remove();
      renderSevkList();
    }
    function geriAlSevk(no){
      const idx = sevkEdilenler.findIndex(x => x.no === no);
      if (idx === -1) return;
      const [rec] = sevkEdilenler.splice(idx,1);
      delete rec.sevkEdildi;
      delete rec.kullanici;
      rec.sevkeHazir = false; 
      orders.push(rec);
      window.dataStore['sevkEdilenler'] = sevkEdilenler;
      window.pushData('sevkEdilenler');
      window.dataStore['siparisler'] = orders;
      window.pushData('siparisler');
      logAction(rec.no, "Sevk geri alındı");
      showToast(`${rec.no} no'lu sevk geri alındı.`, 'success');
      renderSevkList();
      renderOrders();
    }

    form.addEventListener("submit", function (e) {
      e.preventDefault();
      const data = Object.fromEntries(new FormData(form).entries());
      
      const fieldsToValidate = ['kw', 'rpm', 'volt'];
      for (const field of fieldsToValidate) {
          if (data[field] && (isNaN(Number(data[field])) || Number(data[field]) < 0)) {
              showToast(`'${field.toUpperCase()}' alanı geçerli bir pozitif sayı olmalıdır.`, "error");
              return;
          }
      }

      const newOrder = { 
        ...data, 
        kw: data.kw ? Number(data.kw) : null,
        rpm: data.rpm ? Number(data.rpm) : null,
        volt: data.volt ? Number(data.volt) : null,
        sevkTarihi: formatDate_TR(parseDdMmYyyy(data.sevkTarihi)), 
        no: getNextSiparisNo(), 
        kullanici: sessionStorage.getItem("auth_user") || "(anonim)", 
        hazir: false, 
        sevkeHazir: false 
      };
      orders.push(newOrder);
      window.dataStore['siparisler'] = orders;
      window.pushData('siparisler');
      logAction(newOrder.no, "Yeni sipariş eklendi");
      showToast(`${newOrder.no} no'lu yeni sipariş eklendi.`, "success");
      
      table.prepend(createOrderRow(newOrder));

      form.reset();
      form.querySelector(".sevk-picker")?._flatpickr.clear();
    });

    servisForm.addEventListener('submit', function(e){
      e.preventDefault();
      const data = Object.fromEntries(new FormData(servisForm).entries());
      const adet = data.adet ? parseInt(data.adet, 10) : null;
      if (adet !== null && (isNaN(adet) || adet < 1)) {
          showToast("Adet geçerli bir pozitif sayı olmalıdır.", "error");
          return;
      }
      const norm = { ...data, adet };

      const editIndex = servisForm.dataset.editIndex;
      if (editIndex !== undefined){
        const idx = parseInt(editIndex, 10);
        const existing = servisKayitlari[idx];
        if(existing) {
            servisKayitlari[idx] = Object.assign(existing, norm);
            logAction(existing.no, 'Teknik servis kaydı güncellendi');
            showToast(`${existing.no} no'lu servis kaydı güncellendi.`, "success");
        }
      } else {
        const no = getNextServisNo();
        servisKayitlari.unshift({ ...norm, no, durum: 'BEKLEMEDE', sevkTarihi: '' });
        logAction(no, 'Teknik servis kaydı eklendi');
        showToast(`${no} no'lu yeni servis kaydı eklendi.`, "success");
      }

      window.dataStore['servisKayitlari'] = servisKayitlari;
      window.pushData('servisKayitlari');
      resetServisForm(); // İYİLEŞTİRME: Formu temizle
      renderServisList();
    });
    
    function editServis(index) {
        const s = servisKayitlari[index];
        if (!s) return;
        Object.keys(s).forEach(key => {
            if (servisForm.elements[key]) {
                servisForm.elements[key].value = s[key] ?? '';
            }
        });
        servisForm.dataset.editIndex = index;
        appContainer.querySelector('#ss_servisFormSubmitButton').textContent = 'Kaydı Güncelle';
        appContainer.querySelector('#ss_servisFormCancelButton').classList.remove('hidden');
        servisForm.scrollIntoView({ behavior: 'smooth' });
    }

    function resetServisForm() {
        servisForm.reset();
        delete servisForm.dataset.editIndex;
        appContainer.querySelector('#ss_servisFormSubmitButton').textContent = 'Servis Kaydı Ekle';
        appContainer.querySelector('#ss_servisFormCancelButton').classList.add('hidden');
    }
    
    appContainer.querySelector('#ss_servisFormCancelButton').addEventListener('click', resetServisForm);
    
    function downloadCSV(filename, rows){
      const csv = rows.map(r => r.map(c => `"${(c ?? "").toString().replace(/"/g, '""')}"`).join(",")).join("\n");
      const blob = new Blob([`\uFEFF${csv}`], { type: "text/csv;charset=utf-8;" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = filename;
      a.click();
    }

    function handleImport(e) {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        try {
          const data = JSON.parse(reader.result);
          if (confirm("Mevcut verilerin üzerine içe aktarılan veriler yazılsın mı? Bu işlem geri alınamaz.")){
            window.dataStore['siparisler'] = window.ensureArray(data.orders || []);
            window.dataStore['siparisLog'] = window.ensureArray(data.logs || []);
            window.dataStore['sevkEdilenler'] = window.ensureArray(data.sevkEdilenler || []);
            window.dataStore['servisKayitlari'] = window.ensureArray(data.servisKayitlari || []);
            window.dataStore['servisSevkEdilenler'] = window.ensureArray(data.servisSevkEdilenler || []);
            
            window.pushData('siparisler');
            window.pushData('siparisLog');
            window.pushData('sevkEdilenler');
            window.pushData('servisKayitlari');
            window.pushData('servisSevkEdilenler');

            loadDataFromStorage();
            renderAllTables();
            showToast("Sipariş/Servis verileri başarıyla yüklendi.", "success");
          }
        } catch (err) { showToast("Geçersiz JSON dosyası.", "error"); }
      };
      reader.readAsText(file);
      e.target.value = '';
    }
    
    $$('.ss_btnImportJSON', document).forEach(btn => btn.onclick = () => fileInput.click());
    fileInput.addEventListener("change", handleImport);

    const exportAction = () => {
      const json = JSON.stringify({ orders, logs, sevkEdilenler, servisKayitlari, servisSevkEdilenler }, null, 2);
      const blob = new Blob([json], { type: "application/json" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = `hertz_motor_siparis_servis_yedek_${new Date().toISOString().slice(0,10)}.json`;
      a.click();
      showToast("Sipariş/Servis verileri yedeklendi.", "success");
    };
    $$('.ss_btnExportJSON', document).forEach(btn => btn.onclick = exportAction);
    
    const exportCSVAction = () => downloadCSV("siparisler.csv", [
      ["No", "Müşteri", "Ürün", "Mil Kodu", "kW", "RPM", "Voltaj", "Sevk Tarihi", "Hazır", "Sevke Hazır", "Kullanıcı"],
      ...orders.map(o => [o.no, o.musteri, o.urun, o.milKod, o.kw, o.rpm, o.volt, formatDate_TR(o.sevkTarihi), o.hazir?"Evet":"Hayır", o.sevkeHazir?"Evet":"Hayır", o.kullanici])
    ]);
    $$('.ss_btnExportCSV', document).forEach(btn => btn.onclick = exportCSVAction);

    const exportLogCSVAction = () => downloadCSV("siparis_log.csv", [
      ["Tarih", "No", "İşlem", "Kullanıcı"],
      ...logs.map(l => [l.tarih, l.no, l.islem, l.user])
    ]);
    $$('.ss_btnExportLogCSV', document).forEach(btn => btn.onclick = exportLogCSVAction);

    const clearAllAction = () => {
      if (confirm("TÜM SİPARİŞ/SERVİS VERİLERİ (sipariş, sevk, servis, log) silinecek. Emin misiniz?\n\nİşlemden önce otomatik olarak yedek indirilecektir.")) {
        exportAction();
        const keysToClear = ["siparisler", "sevkEdilenler", "servisKayitlari", "siparisLog", "servisSevkEdilenler"];
        keysToClear.forEach(k => {
            window.dataStore[k] = [];
            window.pushData(k);
        });
        loadDataFromStorage();
        renderAllTables();
        showToast("Tüm Sipariş/Servis verileri temizlendi.", "success");
      }
    };
    $$('.ss_btnClearAll', document).forEach(btn => btn.onclick = clearAllAction);

    const debouncedRenderSevkList = debounce(renderSevkList);
    searchInput.addEventListener('input', debouncedRenderSevkList);
    dateFromInput.addEventListener('change', debouncedRenderSevkList);
    dateToInput.addEventListener('change', debouncedRenderSevkList);
    
    appContainer.querySelector('#ss_btnSevkFilter').onclick = renderSevkList;
    appContainer.querySelector('#ss_btnSevkClearFilter').onclick = () => { searchInput.value = ""; dateFromInput.value = ""; dateToInput.value = ""; renderSevkList(); };
    appContainer.querySelector('#ss_btnSevkClearAll').onclick = () => { if(confirm("Tüm sipariş sevk kayıtları silinecek?")){ 
        sevkEdilenler=[]; 
        window.dataStore['sevkEdilenler'] = sevkEdilenler;
        window.pushData('sevkEdilenler');
        showToast("Tüm sevk kayıtları silindi.", "success");
        renderSevkList();
    }};
    
    const debouncedRenderTeknikSevkList = debounce(renderTeknikServisSevkList);
    teknikSevkSearch.addEventListener('input', debouncedRenderTeknikSevkList);
    teknikSevkDateFrom.addEventListener('change', debouncedRenderTeknikSevkList);
    teknikSevkDateTo.addEventListener('change', debouncedRenderTeknikSevkList);

    appContainer.querySelector('#ss_btnTeknikSevkFilter').addEventListener('click', renderTeknikServisSevkList);
    appContainer.querySelector('#ss_btnTeknikSevkClearFilter').addEventListener('click', () => {
        teknikSevkSearch.value = "";
        teknikSevkDateFrom.value = "";
        teknikSevkDateTo.value = "";
        renderTeknikServisSevkList();
    });
    appContainer.querySelector('#ss_btnTeknikSevkCSV').addEventListener('click', () => {
      downloadCSV("teknik_servis_sevk_listesi.csv", [
        ["No", "Firma", "Ürün", "Mil Tipi", "Arıza", "Sevk Edildi", "Kullanıcı"],
        ...Array.from(teknikServisSevkTable.querySelectorAll('tr')).map(tr => Array.from(tr.children).slice(0,-1).map(td => td.textContent))
      ]);
    });
    appContainer.querySelector('#ss_btnTeknikSevkClearAll').addEventListener('click', () => {
        if (confirm("Tüm teknik servis sevk kayıtları silinecek. Emin misiniz?")) {
            servisSevkEdilenler = [];
            window.dataStore['servisSevkEdilenler'] = servisSevkEdilenler;
            window.pushData('servisSevkEdilenler');
            showToast("Tüm teknik servis sevk kayıtları silindi.", "success");
            renderTeknikServisSevkList();
        }
    });

    servisSearch.addEventListener('input', debounce(renderServisList));
    appContainer.querySelector('#ss_btnServisClearAll').onclick = () => { if(confirm('Tüm teknik servis kayıtları silinecek?')){ 
        servisKayitlari = []; 
        window.dataStore['servisKayitlari'] = servisKayitlari;
        window.pushData('servisKayitlari');
        showToast("Tüm servis kayıtları silindi.", "success");
        renderServisList(); 
    }};
    
    
    function sortData(data, key, direction = 'asc', type = 'string') {
        if (!Array.isArray(data)) return;
        data.sort((a, b) => {
            let valA = a[key], valB = b[key];
            if (type === 'number') { valA = parseFloat(valA) || 0; valB = parseFloat(valB) || 0; }
            else if (type === 'date') { valA = parseAnyDate(valA)?.getTime() || 0; valB = parseAnyDate(valB)?.getTime() || 0; }
            else { valA = String(valA || '').toLocaleLowerCase('tr-TR'); valB = String(valB || '').toLocaleLowerCase('tr-TR'); }
            if (valA < valB) return direction === 'asc' ? -1 : 1;
            if (valA > valB) return direction === 'asc' ? 1 : -1;
            return 0;
        });
    }

    function updateSortIndicators(tableBodyId, sortState) {
        const table = appContainer.querySelector(`#${tableBodyId}`)?.closest('table');
        if (!table) return;
        table.querySelectorAll('thead .sortable').forEach(th => {
            th.classList.remove('asc', 'desc');
            if (th.dataset.sortKey === sortState.key) th.classList.add(sortState.direction);
        });
    }

    function setupTableSorting() {
        appContainer.querySelectorAll('table thead').forEach(thead => {
            thead.addEventListener('click', (e) => {
                const header = e.target.closest('.sortable');
                if (!header) return;
                const tableId = header.closest('table').querySelector('tbody').id;
                let currentSort, renderFunction;
                
                switch(tableId) {
                    case 'ss_orderTable': currentSort = siparisSort; renderFunction = renderOrders; break;
                    case 'ss_sevkTable': currentSort = sevkSort; renderFunction = renderSevkList; break;
                    case 'ss_teknikServisSevkTable': currentSort = teknikServisSevkSort; renderFunction = renderTeknikServisSevkList; break;
                    case 'ss_servisTable': currentSort = servisSort; renderFunction = renderServisList; break;
                    default: return;
                }

                const sortKey = header.dataset.sortKey;
                if (currentSort.key === sortKey) {
                    currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
                } else {
                    currentSort.key = sortKey;
                    currentSort.direction = 'asc';
                }
                renderFunction();
            });
        });
    }
    function renderAllTables() {
        renderOrders(); 
        renderLogs(); 
        renderSevkList(); 
        renderServisList();
        renderTeknikServisSevkList();
    }
    
    function setupEventListeners() {
        table.addEventListener('click', e => {
            const target = e.target.closest('[data-action]');
            if (!target) return;
            const action = target.dataset.action;
            const no = target.closest('tr').dataset.no;
            const index = orders.findIndex(o => o.no === no);

            if (action === 'delete') deleteOrder(no);
            else if (action === 'sevk-et') markAsSevk(no);
            else if (action === 'edit-desc') openDescEditor('siparis', index);
        });
        table.addEventListener('change', e => {
            const target = e.target.closest('input[type="checkbox"][data-action]');
            if (!target) return;
            const action = target.dataset.action;
            const no = target.closest('tr').dataset.no;
            const index = orders.findIndex(o => o.no === no);

            if (action === 'toggle-hazir') toggleHazir(index, target.checked);
            else if (action === 'toggle-sevke-hazir') toggleSevkeHazir(index, target.checked);
        });
        table.addEventListener('dblclick', e => {
            const target = e.target.closest('.editable');
            if (!target) return;
            const no = target.closest('tr').dataset.no;
            const index = orders.findIndex(o => o.no === no);
            makeEditable(target, index, target.dataset.field, target.dataset.type);
        });
        
        sevkTable.addEventListener('click', e => {
             const target = e.target.closest('[data-action="geri-al-sevk"]');
             if(!target) return;
             const no = target.closest('tr').dataset.no;
             geriAlSevk(no);
        });
        teknikServisSevkTable.addEventListener('click', e => {
            const target = e.target.closest('[data-action="geri-al-servis-sevk"]');
             if(!target) return;
             const no = target.closest('tr').dataset.no;
             geriAlServisSevk(no);
        });

        servisTable.addEventListener('click', e => {
            const target = e.target.closest('[data-action]');
            if (!target) return;
            const action = target.dataset.action;
            const no = target.closest('tr').dataset.no;
            const index = servisKayitlari.findIndex(s => s.no === no);

            if(index === -1) return;

            if (action === 'delete-servis') deleteServis(no);
            else if (action === 'edit-servis') editServis(index);
            else if (action === 'sevk-et-servis') markServisAsSevk(index); // DÜZELTME: Çalışmayan sevk etme özelliği eklendi.
            else if (action === 'edit-desc-servis') openDescEditor('servis', index);
        });

        servisTable.addEventListener('dblclick', e => {
            const target = e.target.closest('.editable');
            if (!target) return;
            const no = target.closest('tr').dataset.no;
            const index = servisKayitlari.findIndex(s => s.no === no);
            if(index > -1) {
                makeEditableServis(target, index, target.dataset.field, target.dataset.type);
            }
        });
    }

    loadDataFromStorage();
    flatpickr($('#ss_sevkTarihi', appContainer), getFPBaseOptions());
    flatpickr(dateFromInput, getFPBaseOptions());
    flatpickr(dateToInput, getFPBaseOptions());
    flatpickr(teknikSevkDateFrom, getFPBaseOptions());
    flatpickr(teknikSevkDateTo, getFPBaseOptions());


    document.addEventListener("visibilitychange", checkDayAndRefresh);
    window.addEventListener("focus", checkDayAndRefresh);
    
    setupTableSorting();
    setupEventListeners(); 
    renderAllTables();
    setTab("siparis");
    scheduleMidnightRefresh();

    window.setSiparisServisRefresher(() => {
        loadDataFromStorage();
        renderAllTables();
    });
}

function initializeStokTakipApp() {
    const appContainer = document.getElementById('app-stok-takip');
    if (!appContainer.innerHTML.trim()) return;

    const $=(s,r=document)=>r.querySelector(s);
    const $$=(s,r=document)=>Array.from(r.querySelectorAll(s));
    
    const LS_KEY='stokTakip-v1';
    const CATEGORY_PREFIX={stator:'ST',rotor:'RT',mil:'MIL',rotorluMil:'RMIL',taslanmisMil:'TMIL',sargiliPaket:'SP',paketliGovde:'PG',motor:'MOT',kapak:'KAP',islenmisKapak:'IKAP',taslanmisKapak:'TKAP', rulman:'RUL', aluminyum_govde:'ALU', bakir_tel:'CUW',  yardimci_parcalar:'ACC'};
    const CATEGORY_LABEL={'stator':'Stator','rotor':'Rotor','mil':'Mil','rotorluMil':'Rotorlu Mil','taslanmisMil':'Taşlanmış Mil','sargiliPaket':'Sargılı Paket','paketliGovde':'Paketli Gövde','motor':'Motor','kapak':'Kapak','islenmisKapak':'İşlenmiş Kapak','taslanmisKapak':'Taşlanmış Kapak', 'rulman':'Rulman', 'aluminyum_govde':'Alüminyum Gövde', 'bakir_tel':'Bakır Tel',  'yardimci_parcalar':'Yardımcı Parçalar'};

    let state={products:[],logs:[], suppliers: []};
    let tuketimChart; 

    const uuid=()=> (crypto?.randomUUID?.() || 'id-'+Math.random().toString(36).slice(2)+Date.now());

    function load(){ 
        const data = window.dataStore[LS_KEY] || {products:[], logs:[], suppliers: []};
        state.products = window.ensureArray(data.products);
        state.logs = window.ensureArray(data.logs);
        state.suppliers = window.ensureArray(data.suppliers);
    }
    function save(){ 
        window.dataStore[LS_KEY] = state;
        window.pushData(LS_KEY);
        render(); 
    }

    const fmt=n=>{const v=Number(n); return Number.isFinite(v)? new Intl.NumberFormat('tr-TR',{maximumFractionDigits:3}).format(v):n};
    const fmtCurrency=n=>{const v=Number(n); return Number.isFinite(v)? new Intl.NumberFormat('de-DE',{style:'currency', currency:'EUR'}).format(v):'€0,00'};
    const nowISO=()=>new Date().toISOString();
    const currentUser=()=> (sessionStorage.getItem('auth_user')||'anon');
    const addLog=(entry)=> state.logs.unshift({id:uuid(),ts:nowISO(),user:currentUser(),...entry});
    const findProduct=id=>state.products.find(p=>p.id===id);
    const findSupplier=id=>state.suppliers.find(s=>s.id===id);
    
    const normalizeTR = (s) => String(s||'').toLowerCase().replace(/ı/g, 'i').replace(/İ/g, 'i').replace(/ğ/g, 'g').replace(/Ğ/g, 'g').replace(/ü/g, 'u').replace(/Ü/g, 'u').replace(/ş/g, 's').replace(/Ş/g, 's').replace(/ö/g, 'o').replace(/Ö/g, 'o').replace(/ç/g, 'c').replace(/Ç/g, 'c');
    
    const SEARCH_ALIASES = {
        'ad': 'name', 'isim': 'name',
        'kod': 'sku', 'sku': 'sku',
        'not': 'note',
        'tur': 'kind', 'tür': 'kind',
        'cesit': 'category', 'çeşit': 'category',
        ...Object.fromEntries(Object.entries(CATEGORY_PREFIX).map(([cat, prefix]) => [prefix.toLowerCase(), cat])),
        ...Object.fromEntries(Object.entries(CATEGORY_LABEL).map(([cat, label]) => [normalizeTR(label), cat]))
    };

    let sortBy='name', sortDir='asc';
    
    function specs(p){
      const parts=[];
      if(p.category==='paketliGovde'){ if(p.pg_rpm) parts.push(`${p.pg_rpm} rpm`); if(p.pg_kw) parts.push(`${p.pg_kw} kW`); if(p.pg_volt) parts.push(`${p.pg_volt} V`); if(p.pg_customer) parts.push(`${p.pg_customer}`); if(p.pg_conn) parts.push(`${p.pg_conn}`); }
      else if(p.category==='motor'){ if(p.m_rpm) parts.push(`${p.m_rpm} rpm`); if(p.m_kw) parts.push(`${p.m_kw} kW`); if(p.m_volt) parts.push(`${p.m_volt} V`); if(p.milType) parts.push(`${p.milType}`); if(p.m_customer || p.customer) parts.push(`${p.m_customer||p.customer}`); if(p.m_conn) parts.push(`${p.m_conn}`); if(p.m_cover) parts.push(`${p.m_cover}`); if(p.milCode) parts.push(`${p.milCode}`); }
      else{ if(p.rpm) parts.push(`${p.rpm} rpm`); if(p.kw) parts.push(`${p.kw} kW`); if(p.volt) parts.push(`${p.volt} V`); if(p.material) parts.push(`${p.material}`); if(p.milCode) parts.push(`Mil: ${p.milCode}`); if(p.customer) parts.push(`${p.customer}`); }
      return parts.join(' • ');
    }

    function searchable(p){
      const base = [(p.name||''),(p.sku||''),(p.note||''),(CATEGORY_LABEL[p.category]||p.category||'')].join(' ');
      const extra = [p.pg_rpm,p.pg_kw,p.pg_volt,p.pg_customer,p.pg_conn,p.m_rpm,p.m_kw,p.m_volt,p.m_customer,p.m_conn,p.m_cover,p.material,p.milType,p.milCode,p.rpm,p.kw,p.volt,p.customer].filter(Boolean).join(' ');
      return normalizeTR(base+' '+extra);
    }

    function populateSupplierDropdownInForm() {
        const supplierSelect = $('#stok_supplierSelect');
        if (!supplierSelect) return;
        const currentVal = supplierSelect.value;
        supplierSelect.innerHTML = '<option value="">-- Tedarikçi Seç --</option>';
        state.suppliers
            .slice() 
            .sort((a, b) => (a.name || '').localeCompare(b.name || '', 'tr'))
            .forEach(s => {
                const option = document.createElement('option');
                option.value = s.id;
                option.textContent = s.name;
                supplierSelect.appendChild(option);
            });
        
        if (findSupplier(currentVal)) {
            supplierSelect.value = currentVal;
        }
    }
    
    function render(){
        renderProductList();
        renderLogList();
        if (document.querySelector('#stok_tabContent_analiz:not(.hidden)')) {
            renderAnalysisReports();
        }
        renderSupplierList();
        authManager.updateUIVisibility();
    }
    
    function renderProductList() {
        // Tükenme tahmini için son 90 günlük logları önceden alalım
        const ninetyDaysAgo = new Date();
        ninetyDaysAgo.setDate(ninetyDaysAgo.getDate() - 90);
        const recentLogs = state.logs.filter(l => l.type === 'out' && new Date(l.ts) > ninetyDaysAgo);

        function calculateStockoutPrediction(product) {
            const productLogs = recentLogs.filter(l => l.productId === product.id);
            if (productLogs.length === 0) return null;
            
            const totalConsumption = productLogs.reduce((sum, l) => sum + Number(l.amount || 0), 0);
            const avgDailyConsumption = totalConsumption / 90;
            
            if (avgDailyConsumption <= 0) return null;
            
            const currentQty = Number(product.qty || 0);
            const daysLeft = Math.floor(currentQty / avgDailyConsumption);
            
            if (daysLeft < 0) return "Tükendi";
            if (daysLeft > 365) return "> 1 yıl";
            return `~${daysLeft} gün`;
        }

        let list = window.ensureArray(state.products).map(p => ({
            ...p,
            stockOutPrediction: calculateStockoutPrediction(p)
        }));

        const qRaw=$('#stok_search', appContainer).value.trim();
        const onlyLow=$('#stok_onlyLow', appContainer).checked;
        const filterKindVal = $('#stok_filterKind', appContainer).value;
        const filterCategoryVal = $('#stok_filterCategory', appContainer).value;
        
        if (qRaw.includes(':')) {
            const parts = qRaw.split(':');
            const keyRaw = normalizeTR(parts[0]);
            const val = normalizeTR(parts.slice(1).join(':'));
            const target = SEARCH_ALIASES[keyRaw];

            if (target) {
                if (['name', 'sku', 'note', 'kind', 'category'].includes(target)) {
                    list = list.filter(p => p[target] && normalizeTR(p[target]).includes(val));
                } else {
                    list = list.filter(p => p.category === target && searchable(p).includes(val));
                }
            } else {
                const q = normalizeTR(qRaw);
                list = list.filter(p => searchable(p).includes(q));
            }
        } else if (qRaw) {
            const q = normalizeTR(qRaw);
            list = list.filter(p => searchable(p).includes(q));
        }

        if(onlyLow) { list=list.filter(p=>Number(p.qty||0) < Number(p.min||0)); }
        if(filterKindVal) { list=list.filter(p => p.kind === filterKindVal); }
        if(filterCategoryVal) { list=list.filter(p => p.category === filterCategoryVal); }

        const tbody=$('#stok_tbodyDesktop', appContainer); 
        const listMobile=$('#stok_listMobile', appContainer); 

        list.sort((a,b)=>{ let va,vb; switch(sortBy){ case 'sku': va=(a.sku||'').toLowerCase(); vb=(b.sku||'').toLowerCase(); break; case 'qty': va=Number(a.qty||0); vb=Number(b.qty||0); break; case 'min': va=Number(a.min||0); vb=Number(b.min||0); break; case 'cost': va=Number(a.cost||0); vb=Number(b.cost||0); break; default: va=(a.name||'').toLowerCase(); vb=(b.name||'').toLowerCase(); } return (va<vb?-1:va>vb?1:0) * (sortDir==='asc'?1:-1); });

        $('#stok_totalProducts', appContainer).textContent = state.products.length;
        $('#stok_criticalProducts', appContainer).textContent = state.products.filter(p => Number(p.qty||0) < Number(p.min||0)).length;
        const totalValue = state.products.reduce((sum, p) => sum + (Number(p.qty||0) * Number(p.cost||0)), 0);
        $('#stok_totalValue', appContainer).textContent = fmtCurrency(totalValue);

        $('#stok_count', appContainer).textContent=list.length;

        const desktopFragment = document.createDocumentFragment();
        const mobileFragment = document.createDocumentFragment();

        for(const p of list){
            const low=Number(p.qty||0) < Number(p.min||0);
            const lowIcon = low ? ' <span title="Stok kritik seviyede">⚠️</span>' : '';
            const kindBadge=p.kind?`<span class="badge bg-slate-100 border border-slate-200 mr-1">${p.kind==='ham'?'Hammadde':(p.kind==='yari'?'Yarı-mamul':'Mamul')}</span>`:'';
            const catBadge=p.category?`<span class="badge" style="background: rgba(var(--brand), .15); border:1px solid rgba(var(--brand), .4); color: rgb(var(--brand))">${CATEGORY_LABEL[p.category]||p.category}</span>`:'';
            const supplier = findSupplier(p.supplierId);
            
            const tr=document.createElement('tr');
            tr.className=low? 'bg-amber-50':'';
            tr.dataset.id = p.id;
            tr.innerHTML=`
            <td class="px-3 py-2 align-top">${p.sku||'-'}</td>
            <td class="px-3 py-2 align-top">${p.name||'-'}</td>
            <td class="px-3 py-2 align-top">${kindBadge} ${catBadge}</td>
            <td class="px-3 py-2 align-top text-right font-medium ${low?'text-amber-700':''}"><span class="editable-qty" data-id="${p.id}">${fmt(p.qty||0)}${lowIcon}</span></td>
            <td class="px-3 py-2 align-top text-right">${fmt(p.min||0)}</td>
            <td class="px-3 py-2 align-top text-right hertz-muhasebe-only">${fmtCurrency(p.cost)}</td>
            <td class="px-3 py-2 align-top text-center text-xs font-semibold ${p.stockOutPrediction === 'Tükendi' ? 'text-red-600' : 'text-slate-600'} hertz-only">${p.stockOutPrediction || '—'}</td>
            <td class="px-3 py-2 align-top text-slate-700">${specs(p)}</td>
            <td class="px-3 py-2 align-top text-slate-600 hertz-muhasebe-only">${supplier ? supplier.name : '-'}</td>
            <td class="px-3 py-2 align-top text-right">
                <div class="flex justify-end gap-1">
                <button type="button" class="px-2 py-1 rounded-lg border border-slate-300 bg-white" data-act="move-in" data-id="${p.id}">Giriş</button>
                <button type="button" class="px-2 py-1 rounded-lg border border-slate-300 bg-white" data-act="move-out" data-id="${p.id}">Çıkış</button>
                <button type="button" class="px-2 py-1 rounded-lg" style="border:1px solid rgba(var(--brand), .5); color: rgb(var(--brand)); background:transparent" data-act="edit" data-id="${p.id}">Düzenle</button>
                <button type="button" class="px-2 py-1 rounded-lg border border-rose-300 text-rose-700 bg-white admin-only" data-act="del" data-id="${p.id}">Sil</button>
                </div></td>`;
            desktopFragment.appendChild(tr);

            const card=document.createElement('div');
            card.className='rounded-2xl border border-slate-200 bg-white p-3';
            card.dataset.id = p.id;
            card.innerHTML=`
            <div class="flex items-start justify-between gap-2">
                <div class="min-w-0"><div class="text-sm text-slate-500">${p.sku||'-'}</div><div class="font-medium truncate">${p.name||'-'}</div><div class="mt-1 text-xs">${kindBadge} ${catBadge}</div><div class="mt-1 text-xs text-slate-600 truncate">${specs(p)}</div></div>
                <div class="text-right"><div class="text-xs text-slate-500">Stok</div><div class="text-base font-semibold ${low?'text-amber-700':''}">${fmt(p.qty||0)}${lowIcon}</div><div class="text-xs text-slate-500">Min ${fmt(p.min||0)}</div></div>
            </div>
            <div class="hertz-only text-xs text-slate-500 mt-2 pt-2 border-t border-slate-100">Tahmini Tükenme: <span class="font-medium ${p.stockOutPrediction === 'Tükendi' ? 'text-red-600' : ''}">${p.stockOutPrediction || '—'}</span></div>
            ${p.note?`<div class="mt-2 text-xs text-slate-600">${p.note}</div>`:''}
            <div class="mt-3 flex flex-wrap gap-1">
                <button type="button" class="px-2 py-1 rounded-lg border border-slate-300 bg-white" data-act="move-in" data-id="${p.id}">Giriş</button>
                <button type="button" class="px-2 py-1 rounded-lg border border-slate-300 bg-white" data-act="move-out" data-id="${p.id}">Çıkış</button>
                <button type="button" class="px-2 py-1 rounded-lg" style="border:1px solid rgba(var(--brand), .5); color: rgb(var(--brand)); background:transparent" data-act="edit" data-id="${p.id}">Düzenle</button>
                <button type="button" class="px-2 py-1 rounded-lg border border-rose-300 text-rose-700 bg-white admin-only" data-act="del" data-id="${p.id}">Sil</button>
            </div>`;
            mobileFragment.appendChild(card);
        }
        tbody.innerHTML = '';
        listMobile.innerHTML = '';
        tbody.appendChild(desktopFragment);
        listMobile.appendChild(mobileFragment);
    }
    
    function renderLogList() {
        const logBody=$('#stok_logBody', appContainer); logBody.innerHTML='';
        for(const L of state.logs){ const p=findProduct(L.productId)||{name:'(silinmiş ürün)'}; const tr=document.createElement('tr'); const typeTxt=L.type==='in'?'Giriş':(L.type==='out'?'Çıkış':(L.type==='adjustment'?'Düzeltme':L.type)); tr.innerHTML=`
            <td class="px-3 py-2">${new Date(L.ts).toLocaleString('tr-TR')}</td><td class="px-3 py-2">${p.name}</td>
            <td class="px-3 py-2">${typeTxt}</td><td class="px-3 py-2 text-right">${fmt(L.amount)}</td>
            <td class="px-3 py-2 text-right">${fmt(L.fromQty)}</td><td class="px-3 py-2 text-right">${fmt(L.toQty)}</td>
            <td class="px-3 py-2">${L.note||''}</td><td class="px-3 py-2">${L.user||"(bilinmiyor)"}</td>`; logBody.appendChild(tr); }
    }
    
    function renderAnalysisReports() {
        const aktifBody = $('#stok_analiz_aktif_body', appContainer);
        aktifBody.innerHTML = '<tr><td colspan="2" class="p-4 text-center text-slate-500">Rapor oluşturuluyor...</td></tr>';
        
        setTimeout(() => {
            // --- Herkesin Görebileceği Analizler ---
            const aktifGun = parseInt($('#stok_analiz_aktif_gun', appContainer).value, 10);
            const aktifThreshold = new Date(); aktifThreshold.setDate(aktifThreshold.getDate() - aktifGun);
            const hareketler = {};
            state.logs.forEach(log => { if (new Date(log.ts) > aktifThreshold && log.productId) { hareketler[log.productId] = (hareketler[log.productId] || 0) + 1; }});
            const enAktif = Object.entries(hareketler).map(([productId, count]) => ({ product: findProduct(productId), count })).filter(item => item.product).sort((a, b) => b.count - a.count).slice(0, 20);
            aktifBody.innerHTML = '';
            enAktif.forEach(item => { const tr = document.createElement('tr'); tr.innerHTML = `<td class="p-2 border-t border-slate-100">${item.product.name}</td><td class="p-2 border-t border-slate-100 text-right">${item.count}</td>`; aktifBody.appendChild(tr);});
            if(enAktif.length === 0) aktifBody.innerHTML = '<tr><td colspan="2" class="p-2 text-slate-500 text-center">Veri bulunamadı.</td></tr>';

            const pasifGun = parseInt($('#stok_analiz_pasif_gun', appContainer).value, 10);
            const pasifThreshold = new Date(); pasifThreshold.setDate(pasifThreshold.getDate() - pasifGun);
            const sonHareket = {};
            state.logs.forEach(log => { if (log.productId && (!sonHareket[log.productId] || new Date(log.ts) > sonHareket[log.productId])) { sonHareket[log.productId] = new Date(log.ts); }});
            const hareketsiz = state.products.filter(p => !sonHareket[p.id] || sonHareket[p.id] < pasifThreshold).sort((a, b) => (sonHareket[a.id] || 0) - (sonHareket[b.id] || 0));
            const pasifBody = $('#stok_analiz_pasif_body', appContainer);
            pasifBody.innerHTML = '';
            hareketsiz.forEach(p => { const tr = document.createElement('tr'); const sonTarih = sonHareket[p.id] ? sonHareket[p.id].toLocaleDateString('tr-TR') : 'Hiç'; tr.innerHTML = `<td class="p-2 border-t border-slate-100">${p.name}</td><td class="p-2 border-t border-slate-100">${sonTarih}</td><td class="p-2 border-t border-slate-100 text-right">${fmt(p.qty || 0)}</td>`; pasifBody.appendChild(tr);});
            if(hareketsiz.length === 0) pasifBody.innerHTML = '<tr><td colspan="3" class="p-2 text-slate-500 text-center">Veri bulunamadı.</td></tr>';
            
            // --- 'hertz' Yetkisi Gerektiren Gelişmiş Analizler ---
            if (!authManager.checkPermission('hertz')) {
                 if (tuketimChart) { tuketimChart.destroy(); tuketimChart = null; }
                 $$('#stok_tabContent_analiz .hertz-only').forEach(el => {
                     if (el.querySelector('canvas')) {
                         el.innerHTML = '<div class="p-4"><p class="text-center text-slate-500 p-4">Bu raporu görüntüleme yetkiniz yok.</p></div>';
                     }
                 });
                 return;
            }
            
            const kullaniciAktivite = {};
            state.logs.forEach(log => { if (log.user) { kullaniciAktivite[log.user] = (kullaniciAktivite[log.user] || 0) + 1; }});
            const enAktifKullanicilar = Object.entries(kullaniciAktivite).sort((a, b) => b[1] - a[1]);
            const kullaniciBody = $('#stok_analiz_kullanici_body', appContainer);
            kullaniciBody.innerHTML = '';
            enAktifKullanicilar.forEach(([user, count]) => { const tr = document.createElement('tr'); tr.innerHTML = `<td class="p-2 border-t border-slate-100">${user}</td><td class="p-2 border-t border-slate-100 text-right">${count}</td>`; kullaniciBody.appendChild(tr);});
            if(enAktifKullanicilar.length === 0) kullaniciBody.innerHTML = '<tr><td colspan="2" class="p-2 text-slate-500 text-center">Veri bulunamadı.</td></tr>';
            
            const devirHiziGun = parseInt($('#stok_analiz_devir_hizi_gun', appContainer).value, 10);
            const devirHiziThreshold = new Date(); devirHiziThreshold.setDate(devirHiziThreshold.getDate() - devirHiziGun);
            const cogs = state.logs.filter(l => l.type === 'out' && new Date(l.ts) > devirHiziThreshold)
                .reduce((sum, l) => {
                    const p = findProduct(l.productId);
                    return sum + (Number(l.amount) * (p?.cost || 0));
                }, 0);
            const totalInventoryValue = state.products.reduce((sum, p) => sum + (Number(p.qty || 0) * Number(p.cost || 0)), 0);
            const turnoverRate = totalInventoryValue > 0 ? cogs / totalInventoryValue : 0;
            const daysInStock = turnoverRate > 0 ? (365 / turnoverRate) : 0;
            const devirHiziBody = $('#stok_analiz_devir_hizi_body', appContainer);
            devirHiziBody.innerHTML = `
                <div><div class="text-2xl font-bold text-slate-800">${turnoverRate.toFixed(2)}</div><div class="text-xs text-slate-500">Stok Devir Hızı</div></div>
                <div><div class="text-2xl font-bold text-slate-800">${daysInStock.toFixed(1)} gün</div><div class="text-xs text-slate-500">Ort. Stokta Kalma Süresi</div></div>`;

            renderConsumptionTrendAnalysis();

            const abcBody = $('#stok_analiz_abc_body', appContainer);
            const oneYearAgo = new Date(); oneYearAgo.setFullYear(oneYearAgo.getFullYear() - 1);
            const consumption = {};
            state.logs.forEach(log => { if (log.type === 'out' && new Date(log.ts) > oneYearAgo && log.productId) { consumption[log.productId] = (consumption[log.productId] || 0) + Number(log.amount || 0); }});
            let productsWithValue = state.products.map(p => ({ ...p, annualConsumption: consumption[p.id] || 0, annualValue: (consumption[p.id] || 0) * (Number(p.cost) || 0) })).filter(p => p.annualValue > 0).sort((a, b) => b.annualValue - a.annualValue);
            const totalAnnualValue = productsWithValue.reduce((sum, p) => sum + p.annualValue, 0);
            let cumulativeValue = 0;
            abcBody.innerHTML = '';
            productsWithValue.forEach(p => {
                cumulativeValue += p.annualValue;
                const cumulativePercent = totalAnnualValue > 0 ? (cumulativeValue / totalAnnualValue) * 100 : 0;
                let group = 'C';
                if (cumulativePercent <= 80) group = 'A'; else if (cumulativePercent <= 95) group = 'B';
                const groupColor = group === 'A' ? 'bg-red-100 text-red-800' : (group === 'B' ? 'bg-yellow-100 text-yellow-800' : 'bg-green-100 text-green-800');
                const tr = document.createElement('tr');
                tr.innerHTML = `<td class="p-2 border-t border-slate-100">${p.name} <span class="text-slate-500">(${p.sku})</span></td><td class="p-2 border-t border-slate-100 text-center"><span class="px-2 py-1 text-xs font-semibold rounded-full ${groupColor}">${group}</span></td><td class="p-2 border-t border-slate-100 text-right">${fmtCurrency(p.annualValue)}</td><td class="p-2 border-t border-slate-100 text-right">${cumulativePercent.toFixed(2)}%</td>`;
                abcBody.appendChild(tr);
            });
            if (productsWithValue.length === 0) abcBody.innerHTML = '<tr><td colspan="4" class="p-2 text-slate-500 text-center">Yeterli veri (maliyet ve stok çıkışı) bulunamadı.</td></tr>';

        }, 10);
    }

    function renderConsumptionTrendAnalysis() {
        if (!authManager.checkPermission('hertz')) return;

        const select = $('#stok_analiz_tuketim_urun', appContainer);
        const productId = select.value;
        const twelveMonthsAgo = new Date();
        twelveMonthsAgo.setMonth(twelveMonthsAgo.getMonth() - 12);
        
        const monthlyConsumption = Array(12).fill(0);
        const labels = [];
        for (let i = 11; i >= 0; i--) {
            const d = new Date();
            d.setMonth(d.getMonth() - i);
            labels.push(d.toLocaleDateString('tr-TR', { month: 'short', year: '2-digit' }));
        }

        if (productId) {
            state.logs.forEach(log => {
                const logDate = new Date(log.ts);
                if (log.type === 'out' && log.productId === productId && logDate > twelveMonthsAgo) {
                    const monthDiff = (new Date().getFullYear() - logDate.getFullYear()) * 12 + (new Date().getMonth() - logDate.getMonth());
                    if (monthDiff >= 0 && monthDiff < 12) {
                        monthlyConsumption[11 - monthDiff] += Number(log.amount || 0);
                    }
                }
            });
        }
        
        if (tuketimChart) tuketimChart.destroy();
        tuketimChart = new Chart($('#stok_analiz_tuketim_chart').getContext('2d'), {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Aylık Tüketim',
                    data: monthlyConsumption,
                    borderColor: 'rgb(var(--brand))',
                    backgroundColor: 'rgba(var(--brand), 0.1)',
                    fill: true,
                    tension: 0.3
                }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
        });
    }


    function renderSupplierList() {
        const listEl = $('#stok_supplierList', appContainer);
        listEl.innerHTML = '';
        if (state.suppliers.length === 0) {
            listEl.innerHTML = '<tr><td colspan="4" class="p-4 text-center text-slate-500">Kayıtlı tedarikçi yok.</td></tr>';
            return;
        }
        state.suppliers
            .slice()
            .sort((a,b) => (a.name || '').localeCompare(b.name || '', 'tr'))
            .forEach(s => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="p-3">${s.name || '-'}</td>
                    <td class="p-3">${s.contactPerson || '-'}</td>
                    <td class="p-3">
                        ${s.phone ? `<div class="text-xs">${s.phone}</div>` : ''}
                        ${s.email ? `<div class="text-xs text-blue-600">${s.email}</div>` : ''}
                    </td>
                    <td class="p-3 text-right">
                        <button type="button" data-id="${s.id}" data-act="edit" class="px-2 py-1 rounded-lg border border-slate-300 text-xs">Düzenle</button>
                        <button type="button" data-id="${s.id}" data-act="del" class="px-2 py-1 rounded-lg border border-rose-200 text-rose-700 text-xs ml-1">Sil</button>
                    </td>
                `;
                listEl.appendChild(tr);
            });
    }

    function openProductDialog(product){ 
        const dlg=$('#stok_productDialog'); const form=$('#stok_productForm'); form.reset(); 
        
        authManager.updateUIVisibility();
        populateSupplierDropdownInForm();
        
        toggleConditionalSections(); 
        if(product){ 
            $('#stok_productDialogTitle').textContent='Ürünü Düzenle'; 
            form.kind.value=product.kind||'mamul'; 
            form.category.value=product.category||'stator'; 
            form.name.value=product.name||''; 
            form.sku.value=product.sku||''; 
            form.unit.value=product.unit||''; 
            form.min.value=product.min??0; 
            form.note.value=product.note||'';
            form.cost.value=product.cost??'';
            form.supplierId.value=product.supplierId||'';
            form.kw.value=product.kw??''; form.rpm.value=product.rpm??''; form.volt.value=product.volt??''; form.milCode.value=product.milCode??''; form.customer.value=product.customer??''; form.pg_rpm.value=product.pg_rpm??''; form.pg_kw.value=product.pg_kw??''; form.pg_volt.value=product.pg_volt??''; form.pg_customer.value=product.pg_customer??''; form.pg_conn.value=product.pg_conn??'soketli'; form.m_rpm.value=product.m_rpm??''; form.m_kw.value=product.m_kw??''; form.m_volt.value=product.m_volt??''; form.m_conn.value=product.m_conn??'soketli'; form.milType.value=product.milType??''; form.m_cover.value=product.m_cover??'AK'; 
            form.id.value=product.id; 
            toggleConditionalSections(); 
        } else { 
            $('#stok_productDialogTitle').textContent='Ürün Ekle'; 
            form.kind.value='mamul'; 
            form.category.value='stator'; 
            form.id.value=''; 
            suggestSku(true); 
            toggleConditionalSections(); 
        }
        
        dlg.showModal(); 
    }

    function openSupplierDialog(supplier) {
        const dlg = $('#stok_supplierDialog');
        const form = $('#stok_supplierDialogForm');
        form.reset();
        if (supplier) {
            $('#stok_supplierDialogTitle').textContent = 'Tedarikçiyi Düzenle';
            form.name.value = supplier.name || '';
            form.contactPerson.value = supplier.contactPerson || '';
            form.phone.value = supplier.phone || '';
            form.email.value = supplier.email || '';
            form.id.value = supplier.id;
        } else {
            $('#stok_supplierDialogTitle').textContent = 'Yeni Tedarikçi Ekle';
            form.id.value = '';
        }
        dlg.showModal();
    }
    
    function openMoveDialog(product,type){ const dlg=$('#stok_moveDialog'); const form=$('#stok_moveForm'); form.reset(); form.id.value=product.id; $('#stok_moveProductName').textContent=`${product.name} (${product.sku||'kod yok'})`; if(type){ document.querySelectorAll('#stok_moveForm input[name="type"]').forEach(r=>r.checked=(r.value===type)); } dlg.showModal(); }
    
    function exportJSON(){ const blob=new Blob([JSON.stringify({products:state.products,logs:state.logs, suppliers: state.suppliers},null,2)],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=`stok-data-${new Date().toISOString().replace(/[:.]/g,'-')}.json`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); showToast("Stok verileri yedeklendi.", "success"); }
    function exportCSV(){ const rows=[[ 'id','sku','name','kind','category','unit','material','qty','min', 'cost', 'supplier', 'note','kw','rpm','volt','milCode','customer','pg_kw','pg_rpm','pg_volt','pg_customer','pg_conn','m_kw','m_rpm','m_volt','m_conn','milType' ]].concat( state.products.map(p=>[ p.id, p.sku, p.name, p.kind, p.category, p.unit, p.material,p.qty,p.min, p.cost, findSupplier(p.supplierId)?.name || '', (p.note||'').replaceAll('\n',' '), p.kw??'',p.rpm??'',p.volt??'',p.milCode??'',p.customer??'', p.pg_kw??'',p.pg_rpm??'',p.pg_volt??'',p.pg_customer??'',p.pg_conn??'', p.m_kw??'',p.m_rpm??'',p.m_volt??'',p.m_conn??'',p.milType??'' ]) ); const csv=rows.map(r=>r.map(x=>'"'+(String(x??'').replaceAll('"','""'))+'"').join(',')).join('\n'); const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=`stok-urunler-${new Date().toISOString().slice(0,10)}.csv`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); }
    function exportLogCSV(){ const rows=[['ts','product','type','amount','from','to','note','user']]; for(const L of state.logs){ const p=findProduct(L.productId)||{}; rows.push([L.ts,p.name||'',L.type,L.amount,L.fromQty,L.toQty,(L.note||'').replaceAll('\\n',' '), (L.user||'')]);} const csv=rows.map(r=>r.map(x=>'"'+(String(x??'').replaceAll('"','""'))+'"').join(',')).join('\n'); const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=`stok-log-${new Date().toISOString().slice(0,10)}.csv`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); }
    
    function importJSONFile(file){ const reader=new FileReader(); reader.onload=()=>{ try{ const data=JSON.parse(reader.result); if(!data||typeof data!=='object') throw new Error('Geçersiz dosya'); state.products=window.ensureArray(data.products||[]); state.logs=window.ensureArray(data.logs||[]); state.suppliers=window.ensureArray(data.suppliers||[]); save(); showToast('Stok verileri başarıyla içe aktarıldı.', 'success'); }catch(e){ showToast('Dosya okunamadı: '+e.message, 'error'); } }; reader.readAsText(file); }
    
    function toggleConditionalSections(){ 
        const form=$('#stok_productForm'); const cat=form.category.value; 
        $$('[data-section]', form).forEach(el => el.classList.add('hidden'));

        let sectionName = null;
        if (['mil', 'rotorluMil', 'taslanmisMil'].includes(cat)) {
            sectionName = 'mil';
        } else if (['sargiliPaket', 'paketliGovde', 'motor'].includes(cat)) {
            sectionName = cat;
        }

        if (sectionName) {
            const section = $(`[data-section="${sectionName}"]`, form);
            if (section) section.classList.remove('hidden');
        }
    }
    
    function nextSkuForCategory(cat){ const prefix=CATEGORY_PREFIX[cat]||'PRD'; let max=0; for(const p of state.products){ if(p.category!==cat) continue; const m=String(p.sku||'').match(new RegExp('^'+prefix+'-(\\d+)$')); if(m){ const n=parseInt(m[1],10); if(n>max) max=n; } } const next=String(max+1).padStart(4,'0'); return `${prefix}-${next}`; }
    function suggestSku(force=false){ const form=$('#stok_productForm'); const cat=form.category.value; const suggestion=nextSkuForCategory(cat); const prefix=(CATEGORY_PREFIX[cat]||'PRD')+'-'; if(force || !form.sku.value || !form.sku.value.startsWith(prefix)){ form.sku.value=suggestion; } else { if(state.products.some(p=>(p.sku||'').toLowerCase()===form.sku.value.toLowerCase())) form.sku.value=suggestion; } }
    
    function populateFilters() {
        const catSelect = $('#stok_filterCategory', appContainer);
        catSelect.innerHTML = '<option value="">Tüm Çeşitler</option>'; // Reset
        Object.entries(CATEGORY_LABEL).forEach(([key, label]) => {
            const option = document.createElement('option');
            option.value = key;
            option.textContent = label;
            catSelect.appendChild(option);
        });
    }

    function setupTabListeners() {
        const tabs = $$('.stok-tab', appContainer);
        const contents = $$('.stok-tab-content', appContainer);
        let analysisTabInitialized = false;
        
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const target = tab.dataset.tab;
                
                tabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                
                contents.forEach(c => c.classList.add('hidden'));
                const activeContent = $(`#stok_tabContent_${target}`, appContainer);
                if (activeContent) activeContent.classList.remove('hidden');
                
                if (target === 'analiz') {
                    if (!analysisTabInitialized) {
                        const productSelect = $('#stok_analiz_tuketim_urun');
                        productSelect.innerHTML = '<option value="">-- Ürün Seç --</option>';
                        state.products
                            .slice()
                            .sort((a,b) => (a.name || '').localeCompare(b.name || ''))
                            .forEach(p => {
                                const opt = document.createElement('option');
                                opt.value = p.id;
                                opt.textContent = `${p.name} (${p.sku})`;
                                productSelect.appendChild(opt);
                            });
                        analysisTabInitialized = true;
                    }
                    renderAnalysisReports();
                }
            });
        });
        
        const defaultTab = $('[data-tab="liste"]', appContainer);
        if (defaultTab) defaultTab.click();
    }

    $$('.stok_btnAdd', document).forEach(btn => btn.addEventListener('click', ()=>openProductDialog()));
    $$('.stok_btnExport', document).forEach(btn => btn.addEventListener('click', exportJSON));
    $$('.stok_btnExportCSV', document).forEach(btn => btn.addEventListener('click', exportCSV));
    $$('.stok_btnExportLogCSV', document).forEach(btn => btn.addEventListener('click', exportLogCSV));
    
    const fileInput = $('#stok_fileInput');
    $$('.stok_btnImport', document).forEach(btn => btn.addEventListener('click', ()=>fileInput.click()));
    fileInput.addEventListener('change', e => { 
        const f=e.target.files?.[0]; 
        if(f) importJSONFile(f); 
        e.target.value='';
    });

    const clearAction = () => {
        if(!state.products.length && !state.logs.length && !state.suppliers.length){ showToast('Stok verisi zaten boş.', 'error'); return; } 
        if(confirm('Tüm ürünler, tedarikçiler ve hareket geçmişi silinsin mi? Bu işlem geri alınamaz.\nİşlemden önce otomatik yedek indirilecektir.')){ 
            exportJSON(); 
            state.products=[]; 
            state.logs=[]; 
            state.suppliers=[];
            save();
            showToast("Tüm stok verileri silindi.", "success");
        }
    };
    $$('.stok_btnClear', document).forEach(btn => btn.addEventListener('click', clearAction));

    const debouncedRenderProductList = debounce(renderProductList);
    $$('#stok_search, #stok_onlyLow, #stok_filterKind, #stok_filterCategory', appContainer)
        .forEach(el => el.addEventListener('input', debouncedRenderProductList));
    
    // Analiz filtreleri için event listener'lar
    $$('#stok_analiz_aktif_gun, #stok_analiz_pasif_gun, #stok_analiz_devir_hizi_gun, #stok_analiz_tuketim_urun', appContainer).forEach(el => el.addEventListener('change', renderAnalysisReports));

    $('#stok_btnClearFilters', appContainer).addEventListener('click', () => {
        $('#stok_search', appContainer).value = '';
        $('#stok_onlyLow', appContainer).checked = false;
        $('#stok_filterKind', appContainer).value = '';
        $('#stok_filterCategory', appContainer).value = '';
        renderProductList();
    });

    $('#stok_thead', appContainer).addEventListener('click',e=>{ const th=e.target.closest('th[data-sort]'); if(!th) return; const key=th.dataset.sort; if(sortBy===key) sortDir=(sortDir==='asc'?'desc':'asc'); else { sortBy=key; sortDir='asc'; } renderProductList(); });
    
    function delegate(container, selector, event, handler) {
        container.addEventListener(event, e => {
            const el = e.target.closest(selector);
            if (!el) return;
            handler(el, e);
        });
    }

    delegate(appContainer, 'button[data-id][data-act]', 'click', (btn) => {
        const id = btn.dataset.id;
        const act = btn.dataset.act;
        const p = findProduct(id);
        if (!p) return;
        if(act === 'edit') openProductDialog(p);
        else if(act === 'del') { if(confirm(`'${p.name}' adlı ürünü silmek istediğinize emin misiniz?`)) { state.products = state.products.filter(x => x.id !== p.id); addLog({productId: p.id, type: 'delete', note: 'Ürün silindi'}); save(); showToast(`'${p.name}' silindi.`, 'success'); }}
        else if(act === 'move-in') openMoveDialog(p, 'in');
        else if(act === 'move-out') openMoveDialog(p, 'out');
    });
    
    // İYİLEŞTİRME: Satır içi düzenlemede sayısal doğrulama eklendi.
    delegate($('#stok_tbodyDesktop', appContainer), '.editable-qty', 'dblclick', (td) => {
        const pId = td.dataset.id;
        const p = findProduct(pId);
        if (!p || td.querySelector('input')) return;

        const originalValue = Number(p.qty || 0);
        td.innerHTML = `<input type="number" step="any" value="${originalValue}" class="w-24 text-right px-1 py-0.5 border rounded-md bg-white">`;
        const input = td.querySelector('input');
        input.focus();
        input.select();

        const commitChange = () => {
            const rawValue = input.value.trim().replace(',', '.');
            const newValue = parseFloat(rawValue);

            if (!Number.isFinite(newValue) || newValue < 0) {
                showToast("Lütfen geçerli bir pozitif sayı girin.", "error");
                render(); 
                return;
            }

            if (newValue === originalValue) {
                render();
                return;
            }
            
            p.qty = newValue;
            
            addLog({
                productId: p.id,
                type: 'adjustment',
                amount: newValue - originalValue,
                fromQty: originalValue,
                toQty: newValue,
                note: 'Manuel düzeltme'
            });
            save(); 
            showToast(`${p.name} stoğu güncellendi.`, 'success');
        };

        input.addEventListener('blur', commitChange);
        input.addEventListener('keydown', e => {
            if (e.key === 'Enter') { e.preventDefault(); commitChange(); } 
            else if (e.key === 'Escape') { e.preventDefault(); render(); }
        });
    });
    
    $('#stok_btnAddSupplier', appContainer).addEventListener('click', () => openSupplierDialog());
    
    $('#stok_supplierDialogForm').addEventListener('submit', e => {
        e.preventDefault();
        const form = e.target;
        const data = Object.fromEntries(new FormData(form).entries());
        const name = data.name.trim();
        if (!name) {
            showToast("Firma ünvanı zorunludur.", "error");
            return;
        }

        if (data.id) { // Düzenleme
            const supplier = findSupplier(data.id);
            if (supplier) {
                Object.assign(supplier, data);
            }
        } else { // Yeni ekleme
            const { id, ...supplierData } = data;
            state.suppliers.push({ id: uuid(), ...supplierData });
        }
        
        $('#stok_supplierDialog').close();
        save();
        populateSupplierDropdownInForm();
        showToast(data.id ? "Tedarikçi güncellendi." : "Tedarikçi eklendi.", "success");
    });
    
    $('#stok_supplierCancelBtn').addEventListener('click', () => $('#stok_supplierDialog').close());

    delegate($('#stok_supplierList', appContainer), 'button', 'click', (btn) => {
        const id = btn.dataset.id;
        const act = btn.dataset.act;
        const supplier = findSupplier(id);
        if (!supplier) return;

        if (act === 'edit') {
            openSupplierDialog(supplier);
        } else if (act === 'del') {
             if (confirm(`'${supplier.name}' silinsin mi? Bu işlem geri alınamaz.`)) {
                state.suppliers = state.suppliers.filter(sup => sup.id !== id);
                state.products.forEach(p => {
                    if (p.supplierId === id) { p.supplierId = ''; }
                });
                save();
                showToast("Tedarikçi silindi.", "success");
            }
        }
    });


    $('#stok_productForm').addEventListener('submit',e=>{
        e.preventDefault();
        const form=e.target;
        const data=Object.fromEntries(new FormData(form).entries());
        const isEdit=!!data.id;
        
        const min=Number(data.min||0);
        if(isNaN(min)||min<0){ showToast('Minimum stok 0 veya daha büyük olmalı', 'error'); return; }
        if(!data.name||!data.sku){ showToast('Ad ve stok kodu zorunlu', 'error'); return; }
        const clash=state.products.some(x=>x.id!==data.id && (x.sku||'').toLowerCase()===data.sku.toLowerCase());
        if(clash){ showToast('Bu stok kodu başka bir üründe kullanılıyor.', 'error'); return; }
        
        const toNumOrNull = v => {const n=Number(v); return (Number.isFinite(n) && n >= 0) ? n : null;};
        
        const pData = {};
        for(const key in data) {
           if(Object.prototype.hasOwnProperty.call(data, key) && key !== 'id' && form.elements[key]) {
                const isNumericField = ['min', 'cost', 'kw', 'rpm', 'volt', 'pg_rpm', 'pg_kw', 'pg_volt', 'm_rpm', 'm_kw', 'm_volt'].includes(key);
                if (isNumericField) {
                    const numVal = toNumOrNull(data[key]);
                    if (data[key] && numVal === null) {
                        showToast(`'${key}' alanı geçerli bir pozitif sayı olmalıdır.`, 'error');
                        return;
                    }
                    pData[key] = numVal;
                } else {
                    pData[key] = data[key];
                }
           }
        }

        if(isEdit){
            const p = findProduct(data.id);
            if(!p) return;
            Object.assign(p, pData);
            addLog({productId:p.id,type:'edit',note:'Ürün bilgisi güncellendi'});
            showToast(`'${p.name}' ürünü güncellendi.`, 'success');
        } else {
            const newProduct = {id:uuid(), qty:0, ...pData};
            state.products.unshift(newProduct);
            addLog({productId:newProduct.id,type:'new',note:'Yeni ürün eklendi'});
            showToast(`'${newProduct.name}' adlı yeni ürün eklendi.`, 'success');
        }
        $('#stok_productDialog').close();
        save();
    });

    $('#stok_productCancelBtn').addEventListener('click',()=> $('#stok_productDialog').close());
    $('#stok_moveCancelBtn').addEventListener('click',()=> $('#stok_moveDialog').close());

    $('#stok_moveForm').addEventListener('submit', (e) => {
      e.preventDefault();
      const form = e.target;
      const data = Object.fromEntries(new FormData(form).entries());
      const p = findProduct(data.id);
      if(!p){ showToast('Ürün bulunamadı', 'error'); return; }
      const amt = Number(data.amount);
      if(!(amt>0)){ showToast('Miktar 0\'dan büyük olmalı', 'error'); return; }
      const from = Number(p.qty||0);

      if (data.type === 'out' && amt > from) {
          showToast(`Yetersiz stok! Mevcut stok (${from}) miktarından fazla çıkış yapılamaz.`, 'error');
          return;
      }

      const to = data.type==='in' ? from + amt : from - amt;
      p.qty = to;
      addLog({ productId:p.id, type:data.type, amount:amt, fromQty:from, toQty:to, note:data.note });
      $('#stok_moveDialog').close();
      save();
      showToast(`${p.name} stoğu güncellendi: ${to}`, "success");
    });

    $('#stok_btnAutoSku', appContainer).addEventListener('click', () => suggestSku());
    $('#stok_category', appContainer).addEventListener('change', () => { if (!$('#stok_productForm').id.value) suggestSku(true); toggleConditionalSections(); });
    $('#stok_kind', appContainer).addEventListener('change', toggleConditionalSections);

    document.addEventListener('keydown',e=>{ if((e.ctrlKey||e.metaKey)&&e.key.toLowerCase()==='k'){ e.preventDefault(); $('#stok_search', appContainer).focus(); } });
    
    load();
    populateFilters();
    setupTabListeners();
    render();

    window.setStokTakipRefresher(() => {
        load();
        render();
    });
}
</script>

<!-- === Firebase RTDB Bridge === -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getDatabase, ref, onValue, set, get } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAyx_HVYwckqw2bYl_sdu57XPUP_tdDsxA",
    authDomain: "hertz-stok-takip.firebaseapp.com",
    databaseURL: "https://hertz-stok-takip-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "hertz-stok-takip",
    storageBucket: "hertz-stok-takip.firebasestorage.app",
    messagingSenderId: "512663727455",
    appId: "1:512663727455:web:99e15a20f7ae9b77a39aea",
    measurementId: "G-00WN8FD5K9"
  };

  const app = initializeApp(firebaseConfig);
  const db  = getDatabase(app);

  const KEYS = ["siparisler","siparisLog","sevkEdilenler","servisKayitlari","servisSevkEdilenler","stokTakip-v1"];
  const CLIENT_ID = 'client-' + Math.random().toString(36).slice(2);

  const enc = (s)=>encodeURIComponent(s);
  
  window.ensureArray = function(data) {
    let arr;
    if (Array.isArray(data)) {
        arr = data;
    } else if (data && typeof data === 'object') {
        arr = Object.values(data);
    } else {
        return [];
    }
    return arr.filter(item => item && typeof item === 'object' && Object.keys(item).length > 0);
  }

  window.dataStore = {};
  window.siparisServisRefresher = () => console.warn("Sipariş yenileme fonksiyonu henüz ayarlanmadı.");
  window.stokTakipRefresher = () => console.warn("Stok yenileme fonksiyonu henüz ayarlanmadı.");
  window.setSiparisServisRefresher = (fn) => { window.siparisServisRefresher = fn; };
  window.setStokTakipRefresher = (fn) => { window.stokTakipRefresher = fn; };
  
  window.pushData = async function(key) {
    if (!KEYS.includes(key)) return;
    const payload = { 
        value: window.dataStore[key], 
        updatedAt: Date.now(), 
        user: sessionStorage.getItem("auth_user") || "unknown",
        updatedBy: CLIENT_ID 
    };
    try {
        await set(ref(db, "ls/" + enc(key)), payload);
    } catch (error) {
        console.error(`Firebase set failed for key ${key}:`, error);
        showToast("Bağlantı hatası: Veri kaydedilemedi. Lütfen internet bağlantınızı kontrol edip tekrar deneyin.", "error");
    }
  }
  
  showLoadingOverlay();
  const initialLoadPromises = KEYS.map(key => {
    return new Promise((resolve) => {
        const dbRef = ref(db, "ls/" + enc(key));
        get(dbRef).then(snap => {
            if (snap.exists()) {
                const remoteData = snap.val().value;
                window.dataStore[key] = (key === 'stokTakip-v1') ? (remoteData || {products:[], logs:[], suppliers: []}) : window.ensureArray(remoteData);
            } else {
                console.log(`Key ${key} Firebase'de bulunamadı, varsayılan değerle oluşturuluyor.`);
                window.dataStore[key] = key === 'stokTakip-v1' ? { products: [], logs: [], suppliers: [] } : [];
                pushData(key);
            }
            resolve();
        }).catch(error => {
            console.error(`Firebase'den veri okunurken hata oluştu (${key}):`, error);
            showToast(`"${key}" verisi yüklenemedi. Çevrimdışı modda çalışılıyor olabilir.`, "error");
            window.dataStore[key] = key === 'stokTakip-v1' ? { products: [], logs: [], suppliers: [] } : [];
            resolve();
        });
    });
  });

  Promise.all(initialLoadPromises).then(() => {
      hideLoadingOverlay();
      showToast("Tüm veriler başarıyla yüklendi.", "success");
      console.log("İlk veri senkronizasyonu tamamlandı. Arayüz başlatılıyor.");
      initializePlatformApps();

      KEYS.forEach(key => {
          const dbRef = ref(db, "ls/" + enc(key));
          onValue(dbRef, (snap) => {
              const data = snap.val();
              if (!data || data.updatedBy === CLIENT_ID) {
                  return; 
              }
              
              console.log(`${key} için uzaktan güncelleme geldi, arayüz yenileniyor.`);
              showToast("Veriler başka bir kullanıcı tarafından güncellendi.", "success");
              window.dataStore[key] = (key === 'stokTakip-v1') ? data.value : window.ensureArray(data.value);
              
              if (key === 'stokTakip-v1') {
                  stokTakipRefresher();
              } else {
                  siparisServisRefresher();
              }
          });
      });

      console.log("%cRTDB köprü aktif: Gerçek zamanlı senkronizasyon başladı.","color:#16a34a;font-weight:600");
  });
</script>

</body>
</html>
