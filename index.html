<!DOCTYPE html>
<html lang="tr" class="scroll-smooth">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Hertz Motor — Stok Takip</title>
  <!-- Tailwind (dark mode kaldırıldı) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="theme-color" content="rgb(205,105,40)" />
  <style>
    :root { --brand: 205,105,40; }
    dialog::backdrop { background: rgb(0 0 0 / 0.5); }
    .badge{display:inline-block;padding:.125rem .5rem;border-radius:.5rem;font-size:.75rem}
    .btn-brand{ background: rgb(var(--brand)); color:white; }
    .btn-brand:hover{ filter: brightness(0.95); }
    .no-scrollbar::-webkit-scrollbar{ display:none; }
    .no-scrollbar{ -ms-overflow-style:none; scrollbar-width:none; }
  </style>
</head>
<body class="bg-slate-50 text-slate-800">
  <header class="sticky top-0 z-10 bg-white/90 backdrop-blur border-b border-slate-200">
    <div class="mx-auto max-w-7xl px-3 md:px-4 py-3 flex items-center gap-3">
      <div class="shrink-0 w-10 h-10 grid place-items-center rounded-2xl text-white font-bold" style="background: rgb(var(--brand))">HM</div>
      <div class="grow min-w-0">
        <h1 class="text-lg md:text-2xl font-semibold truncate">Hertz Motor — Stok Takip</h1>
        <p class="hidden md:block text-xs text-slate-500">Üretim odaklı alanlar • İçe/Dışa aktar • Yerel kayıt</p>
      </div>
      <div class="flex flex-wrap gap-2 items-center">
        <button id="btnAdd" class="px-3 py-2 rounded-xl btn-brand">Ürün Ekle</button>
        <button id="btnImport" class="px-3 py-2 rounded-xl border border-slate-300 bg-white">İçe aktar</button>
        <button id="btnExport" class="px-3 py-2 rounded-xl border border-slate-300 bg-white">Dışa aktar</button>
        <button id="btnExportCSV" class="px-3 py-2 rounded-xl border border-slate-300 bg-white">CSV</button>
        <button id="btnExportLogCSV" class="px-3 py-2 rounded-xl border border-slate-300 bg-white">Log CSV</button>
        <button id="btnClear" class="px-3 py-2 rounded-xl text-white bg-rose-600">Tüm Veriyi Sil</button>
      </div>
    </div>
  </header>

  <main class="mx-auto max-w-7xl p-3 md:p-4">
    <!-- Üst araç çubuğu -->
    <div class="flex flex-col md:flex-row gap-2 md:gap-3 items-stretch md:items-center mb-3 md:mb-4">
      <div class="flex items-center gap-2 grow">
        <input id="search" type="search" placeholder="Ara: ad, stok kodu…" class="w-full md:max-w-sm px-3 py-2 rounded-xl border border-slate-300 bg-white" />
        <label class="flex items-center gap-2 text-sm text-slate-600">
          <input id="onlyLow" type="checkbox" class="w-4 h-4"> Sadece kritik stok
        </label>
      </div>
      <div class="text-sm text-slate-500">Kayıt: <span id="count">0</span></div>
    </div>

    <!-- Masaüstü tablo -->
    <div class="hidden md:block overflow-auto rounded-2xl border border-slate-200 bg-white">
      <table class="min-w-full text-sm">
        <thead id="thead" class="bg-slate-100 text-slate-700">
          <tr>
            <th data-sort="sku" class="text-left px-3 py-2 cursor-pointer select-none">Stok Kodu</th>
            <th data-sort="name" class="text-left px-3 py-2 cursor-pointer select-none">Ad</th>
            <th class="text-left px-3 py-2">Tür/Çeşit</th>
            <th data-sort="qty" class="text-right px-3 py-2 cursor-pointer select-none">Stok</th>
            <th data-sort="min" class="text-right px-3 py-2 cursor-pointer select-none">Minimum</th>
            <th class="text-left px-3 py-2">Not</th>
            <th class="text-right px-3 py-2">İşlemler</th>
          </tr>
        </thead>
        <tbody id="tbodyDesktop" class="divide-y divide-slate-100"></tbody>
      </table>
    </div>

    <!-- Mobil kart liste -->
    <div id="listMobile" class="md:hidden space-y-2"></div>

    <!-- Log -->
    <details class="mt-5 group">
      <summary class="cursor-pointer select-none text-sm text-slate-600 flex items-center gap-2">
        <span class="inline-block w-2 h-2 rounded-full" style="background: rgb(var(--brand))"></span>
        Hareket Geçmişi
      </summary>
      <div class="mt-3 overflow-auto rounded-2xl border border-slate-200 bg-white max-h-[50vh] no-scrollbar">
        <table class="min-w-full text-sm">
          <thead class="bg-slate-100 text-slate-700">
            <tr>
              <th class="text-left px-3 py-2">Tarih</th>
              <th class="text-left px-3 py-2">Ürün</th>
              <th class="text-left px-3 py-2">Tür</th>
              <th class="text-right px-3 py-2">Miktar</th>
              <th class="text-right px-3 py-2">Önce</th>
              <th class="text-right px-3 py-2">Sonra</th>
              <th class="text-left px-3 py-2">Not</th>
            </tr>
          </thead>
          <tbody id="logBody" class="divide-y divide-slate-100"></tbody>
        </table>
      </div>
    </details>
  </main>

  <!-- Ürün formu -->
  <dialog id="productDialog" class="rounded-2xl p-0 w-[96vw] max-w-xl">
    <form id="productForm" class="p-4" novalidate>
      <h3 id="productDialogTitle" class="text-lg font-semibold mb-4">Ürün Ekle</h3>
      <div class="grid md:grid-cols-2 gap-3">
        <div>
          <label class="text-sm text-slate-600">Ürün Türü</label>
          <select name="kind" id="kind" class="w-full px-3 py-2 rounded-xl border border-slate-300">
            <option value="mamul">Mamul</option>
            <option value="yari">Yarı-mamul</option>
            <option value="ham">Hammadde</option>
          </select>
        </div>
        <div>
          <label class="text-sm text-slate-600">Ürün Çeşidi</label>
          <select name="category" id="category" class="w-full px-3 py-2 rounded-xl border border-slate-300">
            <option value="stator">Stator</option>
            <option value="rotor">Rotor</option>
            <option value="mil">Mil</option>
            <option value="rotorluMil">Rotorlu Mil</option>
            <option value="taslanmisMil">Taşlanmış Mil</option>
            <option value="sargiliPaket">Sargılı Paket</option>
            <option value="paketliGovde">Paketli Gövde</option>
            <option value="motor">Motor</option>
          </select>
        </div>
        <div class="md:col-span-2">
          <label class="text-sm text-slate-600">Ad</label>
          <input name="name" type="text" required class="w-full px-3 py-2 rounded-xl border border-slate-300" />
        </div>
        <div>
          <label class="text-sm text-slate-600">Stok Kodu</label>
          <div class="flex gap-2">
            <input name="sku" id="sku" type="text" required class="w-full px-3 py-2 rounded-xl border border-slate-300" />
            <button id="btnAutoSku" type="button" class="px-3 py-2 rounded-xl border border-slate-300">Oluştur</button>
          </div>
          <p class="text-xs text-slate-500 mt-1">Ürün çeşidine göre otomatik kod önerilir. Dilersen düzenleyebilirsin.</p>
        </div>
        <div>
          <label class="text-sm text-slate-600">Birim</label>
          <input name="unit" type="text" placeholder="adet, kg, m…" class="w-full px-3 py-2 rounded-xl border border-slate-300" />
        </div>
        <div>
          <label class="text-sm text-slate-600">Minimum Stok</label>
          <input name="min" type="number" step="any" value="0" class="w-full px-3 py-2 rounded-xl border border-slate-300" />
        </div>
        <div class="md:col-span-2">
          <label class="text-sm text-slate-600">Not</label>
          <input name="note" type="text" class="w-full px-3 py-2 rounded-xl border border-slate-300" />
        </div>

        <!-- Koşullu alanlar -->
        <div data-section="sargiliPaket" class="md:col-span-2 hidden">
          <div class="grid md:grid-cols-3 gap-3">
            <div>
              <label class="text-sm text-slate-600">kW</label>
              <input name="kw" type="number" step="any" class="w-full px-3 py-2 rounded-xl border border-slate-300" />
            </div>
            <div>
              <label class="text-sm text-slate-600">Devir (rpm)</label>
              <input name="rpm" type="number" step="1" class="w-full px-3 py-2 rounded-xl border border-slate-300" />
            </div>
            <div>
              <label class="text-sm text-slate-600">Voltaj (V)</label>
              <input name="volt" type="number" step="1" class="w-full px-3 py-2 rounded-xl border border-slate-300" />
            </div>
          </div>
        </div>

        <div data-section="paketliGovde" class="md:col-span-2 hidden">
          <div class="grid md:grid-cols-3 gap-3">
            <div>
              <label class="text-sm text-slate-600">Devir (rpm)</label>
              <input name="pg_rpm" type="number" step="1" class="w-full px-3 py-2 rounded-xl border border-slate-300" />
            </div>
            <div>
              <label class="text-sm text-slate-600">kW</label>
              <input name="pg_kw" type="number" step="any" class="w-full px-3 py-2 rounded-xl border border-slate-300" />
            </div>
            <div>
              <label class="text-sm text-slate-600">Voltaj (V)</label>
              <input name="pg_volt" type="number" step="1" class="w-full px-3 py-2 rounded-xl border border-slate-300" />
            </div>
          </div>
          <div class="grid md:grid-cols-2 gap-3 mt-3">
            <div>
              <label class="text-sm text-slate-600">Müşteri</label>
              <input name="pg_customer" type="text" class="w-full px-3 py-2 rounded-xl border border-slate-300" />
            </div>
            <div>
              <label class="text-sm text-slate-600">Bağlantı Tipi</label>
              <select name="pg_conn" class="w-full px-3 py-2 rounded-xl border border-slate-300">
                <option value="soketli">Soketli</option>
                <option value="duz">Düz klemensli</option>
                <option value="ters">Ters klemensli</option>
                <option value="ykr">YKR</option>
                <option value="ykl">YKL</option>
              </select>
            </div>
          </div>
        </div>

        <div data-section="mil" class="md:col-span-2 hidden">
          <label class="text-sm text-slate-600">Mil Kodu</label>
          <input name="milCode" type="text" class="w-full px-3 py-2 rounded-xl border border-slate-300" />
        </div>

        <div data-section="motor" class="md:col-span-2 hidden">
          <div class="grid md:grid-cols-3 gap-3">
            <div>
              <label class="text-sm text-slate-600">Müşteri</label>
              <input name="customer" type="text" class="w-full px-3 py-2 rounded-xl border border-slate-300" />
            </div>
            <div>
              <label class="text-sm text-slate-600">Devir (rpm)</label>
              <input name="m_rpm" type="number" step="1" class="w-full px-3 py-2 rounded-xl border border-slate-300" />
            </div>
            <div>
              <label class="text-sm text-slate-600">kW</label>
              <input name="m_kw" type="number" step="any" class="w-full px-3 py-2 rounded-xl border border-slate-300" />
            </div>
            <div>
              <label class="text-sm text-slate-600">Voltaj (V)</label>
              <input name="m_volt" type="number" step="1" class="w-full px-3 py-2 rounded-xl border border-slate-300" />
            </div>
            <div>
              <label class="text-sm text-slate-600">Bağlantı Tipi</label>
              <select name="m_conn" class="w-full px-3 py-2 rounded-xl border border-slate-300">
                <option value="soketli">Soketli</option>
                <option value="duz">Düz klemensli</option>
                <option value="ters">Ters klemensli</option>
                <option value="ykr">YKR</option>
                <option value="ykl">YKL</option>
              </select>
            </div>
            <div>
              <label class="text-sm text-slate-600">Mil Tipi</label>
              <input name="milType" type="text" placeholder="Örn: DIN 6885" class="w-full px-3 py-2 rounded-xl border border-slate-300" />
            </div>
          </div>
        </div>
      </div>
      <div class="mt-5 flex justify-end gap-2">
        <button id="productCancelBtn" type="button" class="px-3 py-2 rounded-xl border border-slate-300 bg-white">Vazgeç</button>
        <button id="productSaveBtn" type="submit" class="px-3 py-2 rounded-xl btn-brand">Kaydet</button>
      </div>
      <input type="hidden" name="id" />
    </form>
  </dialog>

  <!-- Stok hareketi formu -->
  <dialog id="moveDialog" class="rounded-2xl p-0 w-[96vw] max-w-md">
    <form id="moveForm" class="p-4" novalidate>
      <h3 class="text-lg font-semibold mb-4">Stok Hareketi</h3>
      <div class="space-y-3">
        <div class="text-sm">Ürün: <span id="moveProductName" class="font-medium"></span></div>
        <div class="grid grid-cols-2 gap-3">
          <label class="flex items-center gap-2"><input type="radio" name="type" value="in" checked> <span>Giriş</span></label>
          <label class="flex items-center gap-2"><input type="radio" name="type" value="out"> <span>Çıkış</span></label>
        </div>
        <div>
          <label class="text-sm">Miktar</label>
          <input name="amount" type="number" step="any" required class="w-full px-3 py-2 rounded-xl border border-slate-300" />
        </div>
        <div>
          <label class="text-sm">Not (isteğe bağlı)</label>
          <input name="note" type="text" class="w-full px-3 py-2 rounded-xl border border-slate-300" />
        </div>
      </div>
      <div class="mt-5 flex justify-end gap-2">
        <button id="moveCancelBtn" type="button" class="px-3 py-2 rounded-xl border border-slate-300 bg-white">Vazgeç</button>
        <button id="moveApplyBtn" type="submit" class="px-3 py-2 rounded-xl btn-brand">Uygula</button>
      </div>
      <input type="hidden" name="id" />
    </form>
  </dialog>

  <input id="fileInput" type="file" accept="application/json" class="hidden" />

  <footer class="mx-auto max-w-7xl p-3 md:p-4 text-xs text-slate-500">
    <p>Veriler bu cihazın tarayıcısında saklanır. Cihazlar arasında paylaşmak için <strong>Dışa aktar</strong> ile dosya indirip diğer cihazda <strong>İçe aktar</strong> yapabilirsiniz.</p>
  </footer>

  <script>
  ;(() => {
    const LS_KEY='stokTakip.v1';
    const $=(s,r=document)=>r.querySelector(s);
    const $$=(s,r=document)=>Array.from(r.querySelectorAll(s));

    // Kategori/etiket sabitleri
    const CATEGORY_PREFIX={stator:'ST',rotor:'RT',mil:'MIL',rotorluMil:'RMIL',taslanmisMil:'TMIL',sargiliPaket:'SP',paketliGovde:'PG',motor:'MOT'};
    const CATEGORY_LABEL={stator:'Stator',rotor:'Rotor',mil:'Mil',rotorluMil:'Rotorlu Mil',taslanmisMil:'Taşlanmış Mil',sargiliPaket:'Sargılı Paket',paketliGovde:'Paketli Gövde',motor:'Motor'};

    const state={products:[],logs:[]};
    const uuid=()=> (crypto?.randomUUID?.() || 'id-'+Math.random().toString(36).slice(2)+Date.now());

    function load(){ try{ const raw=localStorage.getItem(LS_KEY); if(!raw) return; const data=JSON.parse(raw); state.products=data.products||[]; state.logs=data.logs||[]; }catch(e){ console.error('Yükleme hatası',e);} }
    function save(){ try{ localStorage.setItem(LS_KEY, JSON.stringify({products:state.products,logs:state.logs})); }catch(e){ console.error('Kaydetme hatası',e);} render(); }

    const fmt=n=>{const v=Number(n); return Number.isFinite(v)? new Intl.NumberFormat('tr-TR',{maximumFractionDigits:3}).format(v):n};
    const nowISO=()=>new Date().toISOString();
    const addLog=(entry)=>state.logs.unshift({id:uuid(),ts:nowISO(),...entry});
    const findProduct=id=>state.products.find(p=>p.id===id);

    let sortBy='name', sortDir='asc';

    function render(){
      const q=$('#search').value.trim().toLowerCase();
      const onlyLow=$('#onlyLow').checked;
      const tbody=$('#tbodyDesktop'); tbody.innerHTML='';
      const listMobile=$('#listMobile'); listMobile.innerHTML='';

      let list=[...state.products];
      if(q) list=list.filter(p=>(p.name+' '+p.sku+' '+(p.note||'')+' '+(CATEGORY_LABEL[p.category]||'')).toLowerCase().includes(q));
      if(onlyLow) list=list.filter(p=>Number(p.qty||0) < Number(p.min||0));

      // Sıralama
      list.sort((a,b)=>{ let va,vb; switch(sortBy){ case 'sku': va=(a.sku||'').toLowerCase(); vb=(b.sku||'').toLowerCase(); break; case 'qty': va=Number(a.qty||0); vb=Number(b.qty||0); break; case 'min': va=Number(a.min||0); vb=Number(b.min||0); break; default: va=(a.name||'').toLowerCase(); vb=(b.name||'').toLowerCase(); } return (va<vb?-1:va>vb?1:0) * (sortDir==='asc'?1:-1); });

      $('#count').textContent=list.length;

      for(const p of list){
        const low=Number(p.qty||0) < Number(p.min||0);
        // Masaüstü satırı
        const tr=document.createElement('tr');
        const kindBadge=p.kind?`<span class="badge bg-slate-100 border border-slate-200 mr-1">${p.kind==='ham'?'Hammadde':(p.kind==='yari'?'Yarı-mamul':'Mamul')}</span>`:'';
        const catBadge=p.category?`<span class="badge" style="background: rgba(var(--brand), .15); border:1px solid rgba(var(--brand), .4); color: rgb(var(--brand))">${CATEGORY_LABEL[p.category]||p.category}</span>`:'';
        tr.className=low? 'bg-amber-50':'';
        tr.innerHTML=`
          <td class="px-3 py-2 align-top">${p.sku||'-'}</td>
          <td class="px-3 py-2 align-top">${p.name||'-'}</td>
          <td class="px-3 py-2 align-top">${kindBadge} ${catBadge}</td>
          <td class="px-3 py-2 align-top text-right font-medium ${low?'text-amber-700':''}">${fmt(p.qty||0)}</td>
          <td class="px-3 py-2 align-top text-right">${fmt(p.min||0)}</td>
          <td class="px-3 py-2 align-top text-slate-600">${p.note||''}</td>
          <td class="px-3 py-2 align-top text-right">
            <div class="flex justify-end gap-1">
              <button class="px-2 py-1 rounded-lg border border-slate-300 bg-white" data-act="move-in" data-id="${p.id}">Giriş</button>
              <button class="px-2 py-1 rounded-lg border border-slate-300 bg-white" data-act="move-out" data-id="${p.id}">Çıkış</button>
              <button class="px-2 py-1 rounded-lg" style="border:1px solid rgba(var(--brand), .5); color: rgb(var(--brand)); background:transparent" data-act="edit" data-id="${p.id}">Düzenle</button>
              <button class="px-2 py-1 rounded-lg border border-rose-300 text-rose-700 bg-white" data-act="del" data-id="${p.id}">Sil</button>
            </div>
          </td>`;
        tbody.appendChild(tr);

        // Mobil kartı
        const card=document.createElement('div');
        card.className='rounded-2xl border border-slate-200 bg-white p-3';
        card.innerHTML=`
          <div class="flex items-start justify-between gap-2">
            <div class="min-w-0">
              <div class="text-sm text-slate-500">${p.sku||'-'}</div>
              <div class="font-medium truncate">${p.name||'-'}</div>
              <div class="mt-1 text-xs">${kindBadge} ${catBadge}</div>
            </div>
            <div class="text-right">
              <div class="text-xs text-slate-500">Stok</div>
              <div class="text-base font-semibold ${low?'text-amber-700':''}">${fmt(p.qty||0)}</div>
              <div class="text-xs text-slate-500">Min ${fmt(p.min||0)}</div>
            </div>
          </div>
          ${p.note?`<div class="mt-2 text-xs text-slate-600">${p.note}</div>`:''}
          <div class="mt-3 flex flex-wrap gap-1">
            <button class="px-2 py-1 rounded-lg border border-slate-300 bg-white" data-act="move-in" data-id="${p.id}">Giriş</button>
            <button class="px-2 py-1 rounded-lg border border-slate-300 bg-white" data-act="move-out" data-id="${p.id}">Çıkış</button>
            <button class="px-2 py-1 rounded-lg" style="border:1px solid rgba(var(--brand), .5); color: rgb(var(--brand)); background:transparent" data-act="edit" data-id="${p.id}">Düzenle</button>
            <button class="px-2 py-1 rounded-lg border border-rose-300 text-rose-700 bg-white" data-act="del" data-id="${p.id}">Sil</button>
          </div>`;
        listMobile.appendChild(card);
      }

      // Log
      const logBody=$('#logBody'); logBody.innerHTML='';
      for(const L of state.logs){ const p=findProduct(L.productId)||{name:'(silinmiş ürün)'}; const tr=document.createElement('tr'); const typeTxt=L.type==='in'?'Giriş':(L.type==='out'?'Çıkış':L.type); tr.innerHTML=`
        <td class="px-3 py-2">${new Date(L.ts).toLocaleString('tr-TR')}</td>
        <td class="px-3 py-2">${p.name}</td>
        <td class="px-3 py-2">${typeTxt}</td>
        <td class="px-3 py-2 text-right">${fmt(L.amount)}</td>
        <td class="px-3 py-2 text-right">${fmt(L.fromQty)}</td>
        <td class="px-3 py-2 text-right">${fmt(L.toQty)}</td>
        <td class="px-3 py-2">${L.note||''}</td>`; logBody.appendChild(tr); }
    }

    function openProductDialog(product){ const dlg=$('#productDialog'); const form=$('#productForm'); form.reset(); toggleConditionalSections(); if(product){ $('#productDialogTitle').textContent='Ürünü Düzenle'; form.kind.value=product.kind||'mamul'; form.category.value=product.category||'stator'; form.name.value=product.name||''; form.sku.value=product.sku||''; form.unit.value=product.unit||''; form.min.value=product.min??0; form.note.value=product.note||''; form.kw.value=product.kw??''; form.rpm.value=product.rpm??''; form.volt.value=product.volt??''; form.milCode.value=product.milCode??''; form.customer.value=product.customer??''; form.pg_rpm.value=product.pg_rpm??''; form.pg_kw.value=product.pg_kw??''; form.pg_volt.value=product.pg_volt??''; form.pg_customer.value=product.pg_customer??''; form.pg_conn.value=product.pg_conn??'soketli'; form.m_rpm.value=product.m_rpm??''; form.m_kw.value=product.m_kw??''; form.m_volt.value=product.m_volt??''; form.m_conn.value=product.m_conn??'soketli'; form.milType.value=product.milType??''; form.id.value=product.id; toggleConditionalSections(); } else { $('#productDialogTitle').textContent='Ürün Ekle'; form.kind.value='mamul'; form.category.value='stator'; form.id.value=''; suggestSku(true); toggleConditionalSections(); } dlg.showModal(); }

    function openMoveDialog(product,type){ const dlg=$('#moveDialog'); const form=$('#moveForm'); form.reset(); form.id.value=product.id; $('#moveProductName').textContent=`${product.name} (${product.sku||'kod yok'})`; if(type){ $$('input[name="type"]').forEach(r=>r.checked=(r.value===type)); } dlg.showModal(); }

    function exportJSON(){ const blob=new Blob([JSON.stringify({products:state.products,logs:state.logs},null,2)],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=`stok-data-${new Date().toISOString().replace(/[:.]/g,'-')}.json`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); }
    function exportCSV(){ const rows=[[ 'id','sku','name','kind','category','unit','qty','min','note','kw','rpm','volt','milCode','customer','pg_kw','pg_rpm','pg_volt','pg_customer','pg_conn','m_kw','m_rpm','m_volt','m_conn','milType' ]].concat( state.products.map(p=>[ p.id,p.sku,p.name,p.kind,p.category,p.unit,p.qty,p.min,(p.note||'').replaceAll('\n',' '), p.kw??'',p.rpm??'',p.volt??'',p.milCode??'',p.customer??'', p.pg_kw??'',p.pg_rpm??'',p.pg_volt??'',p.pg_customer??'',p.pg_conn??'', p.m_kw??'',p.m_rpm??'',p.m_volt??'',p.m_conn??'',p.milType??'' ]) ); const csv=rows.map(r=>r.map(x=>'"'+(String(x??'').replaceAll('"','""'))+'"').join(',')).join('\n'); const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=`stok-urunler-${new Date().toISOString().slice(0,10)}.csv`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); }
    function exportLogCSV(){ const rows=[['ts','product','type','amount','from','to','note']]; for(const L of state.logs){ const p=findProduct(L.productId)||{}; rows.push([L.ts,p.name||'',L.type,L.amount,L.fromQty,L.toQty,(L.note||'').replaceAll('\n',' ')]);} const csv=rows.map(r=>r.map(x=>'"'+(String(x??'').replaceAll('"','""'))+'"').join(',')).join('\n'); const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=`stok-log-${new Date().toISOString().slice(0,10)}.csv`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); }

    function importJSONFile(file){ const reader=new FileReader(); reader.onload=()=>{ try{ const data=JSON.parse(reader.result); if(!data||typeof data!=='object') throw new Error('Geçersiz dosya'); state.products=Array.isArray(data.products)?data.products:[]; state.logs=Array.isArray(data.logs)?data.logs:[]; save(); alert('İçe aktarıldı'); }catch(e){ alert('Dosya okunamadı: '+e.message); } }; reader.readAsText(file); }

    function toggleConditionalSections(){ const form=$('#productForm'); const cat=form.category.value; $('[data-section="sargiliPaket"]').classList.toggle('hidden', cat!=='sargiliPaket'); $('[data-section="paketliGovde"]').classList.toggle('hidden', cat!=='paketliGovde'); const isMil=(cat==='mil'||cat==='rotorluMil'||cat==='taslanmisMil'); $('[data-section="mil"]').classList.toggle('hidden', !isMil); $('[data-section="motor"]').classList.toggle('hidden', cat!=='motor'); }

    function nextSkuForCategory(cat){ const prefix=CATEGORY_PREFIX[cat]||'PRD'; let max=0; for(const p of state.products){ if(p.category!==cat) continue; const m=String(p.sku||'').match(new RegExp('^'+prefix+'-(\\d+)$')); if(m){ const n=parseInt(m[1],10); if(n>max) max=n; } } const next=String(max+1).padStart(4,'0'); return `${prefix}-${next}`; }
    function suggestSku(force=false){ const form=$('#productForm'); const cat=form.category.value; const suggestion=nextSkuForCategory(cat); const prefix=(CATEGORY_PREFIX[cat]||'PRD')+'-'; if(force || !form.sku.value || !form.sku.value.startsWith(prefix)){ form.sku.value=suggestion; } else { if(state.products.some(p=>(p.sku||'').toLowerCase()===form.sku.value.toLowerCase())) form.sku.value=suggestion; } }

    // Eventler
    $('#btnAdd').addEventListener('click',()=>openProductDialog());
    $('#btnExport').addEventListener('click',exportJSON);
    $('#btnExportCSV').addEventListener('click',exportCSV);
    $('#btnExportLogCSV').addEventListener('click',exportLogCSV);
    $('#btnImport').addEventListener('click',()=>$('#fileInput').click());
    $('#fileInput').addEventListener('change',e=>{ const f=e.target.files?.[0]; if(f) importJSONFile(f); e.target.value=''; });

    $('#btnClear').addEventListener('click',()=>{ if(!state.products.length && !state.logs.length){ alert('Zaten boş.'); return; } if(confirm('Tüm ürünler ve hareket geçmişi silinsin mi? Bu işlem geri alınamaz.\nİşlemden önce otomatik yedek indirilecektir.')){ exportJSON(); state.products=[]; state.logs=[]; try{ localStorage.removeItem(LS_KEY);}catch{} render(); } });

    $('#search').addEventListener('input',render);
    $('#onlyLow').addEventListener('change',render);
    $('#thead').addEventListener('click',e=>{ const th=e.target.closest('th[data-sort]'); if(!th) return; const key=th.dataset.sort; if(sortBy===key) sortDir=(sortDir==='asc'?'desc':'asc'); else { sortBy=key; sortDir='asc'; } render(); });

    // Masaüstü ve mobilde ortak buton delegasyonu
    function delegate(container){ container.addEventListener('click', e=>{ const btn=e.target.closest('button'); if(!btn) return; const id=btn.dataset.id; const p=findProduct(id); if(!p) return; const act=btn.dataset.act; if(act==='edit'){ openProductDialog(p); } else if(act==='del'){ if(confirm('Silinsin mi?')){ state.products=state.products.filter(x=>x.id!==id); addLog({productId:id,type:'delete',amount:0,fromQty:p.qty||0,toQty:0,note:'Ürün silindi'}); save(); } } else if(act==='move-in'){ openMoveDialog(p,'in'); } else if(act==='move-out'){ openMoveDialog(p,'out'); } }); }
    delegate(document.body);

    $('#productForm').addEventListener('submit',e=>{ e.preventDefault(); const form=e.target; const data=Object.fromEntries(new FormData(form).entries()); const isEdit=!!data.id; const min=Number(data.min||0); if(isNaN(min)||min<0){ alert('Minimum stok 0 veya daha büyük olmalı'); return; } if(!data.name||!data.sku){ alert('Ad ve stok kodu zorunlu'); return; } if(data.category==='sargiliPaket'){ if(!(data.kw && data.rpm && data.volt)){ alert('Sargılı paket için kW, rpm ve Volt zorunludur.'); return; } } if(['mil','rotorluMil','taslanmisMil'].includes(data.category)){ if(!data.milCode){ alert('Mil türlerinde Mil Kodu zorunludur.'); return; } }
      const clash=state.products.some(x=>x.id!==data.id && (x.sku||'').toLowerCase()===data.sku.toLowerCase()); if(clash){ alert('Bu stok kodu başka bir üründe kullanılıyor. Otomatik yeni kod önerilecek.'); form.sku.value=nextSkuForCategory(data.category); data.sku=form.sku.value; }
      if(isEdit){ const p=findProduct(data.id); if(!p) return; Object.assign(p,{ kind:data.kind, category:data.category, name:data.name, sku:data.sku, unit:data.unit, min, note:data.note, kw:toNumOrNull(data.kw), rpm:toNumOrNull(data.rpm), volt:toNumOrNull(data.volt), milCode:data.milCode||'', customer:data.customer||'', m_rpm:toNumOrNull(data.m_rpm), m_kw:toNumOrNull(data.m_kw), m_volt:toNumOrNull(data.m_volt), m_conn:data.m_conn||'', milType:data.milType||'', pg_rpm:toNumOrNull(data.pg_rpm), pg_kw:toNumOrNull(data.pg_kw), pg_volt:toNumOrNull(data.pg_volt), pg_customer:data.pg_customer||'', pg_conn:data.pg_conn||'' }); addLog({productId:p.id,type:'edit',amount:0,fromQty:p.qty||0,toQty:p.qty||0,note:'Ürün bilgisi güncellendi'}); } else { const p={ id:uuid(), kind:data.kind, category:data.category, name:data.name, sku:data.sku, unit:data.unit, qty:0, min, note:data.note, kw:toNumOrNull(data.kw), rpm:toNumOrNull(data.rpm), volt:toNumOrNull(data.volt), milCode:data.milCode||'', customer:data.customer||'', m_rpm:toNumOrNull(data.m_rpm), m_kw:toNumOrNull(data.m_kw), m_volt:toNumOrNull(data.m_volt), m_conn:data.m_conn||'', milType:data.milType||'', pg_rpm:toNumOrNull(data.pg_rpm), pg_kw:toNumOrNull(data.pg_kw), pg_volt:toNumOrNull(data.pg_volt), pg_customer:data.pg_customer||'', pg_conn:data.pg_conn||'' }; state.products.unshift(p); addLog({productId:p.id,type:'new',amount:0,fromQty:0,toQty:0,note:'Yeni ürün eklendi'}); }
      $('#productDialog').close(); save(); });

    // İPTAL butonları — diyalogları kapat
    $('#productCancelBtn').addEventListener('click',()=> $('#productDialog').close());
    $('#moveCancelBtn').addEventListener('click',()=> $('#moveDialog').close());

    // Stok hareketini uygula
    $('#moveForm').addEventListener('submit', (e) => {
      e.preventDefault();
      const form = e.target;
      const data = Object.fromEntries(new FormData(form).entries());
      const p = findProduct(data.id);
      if(!p){ alert('Ürün bulunamadı'); return; }
      const amt = Number(data.amount);
      if(!(amt>0)){ alert('Miktar pozitif olmalı'); return; }
      const from = Number(p.qty||0);
      const to = data.type==='in' ? from + amt : from - amt;
      p.qty = to;
      addLog({ productId:p.id, type:data.type, amount:amt, fromQty:from, toQty:to, note:data.note });
      $('#moveDialog').close();
      save();
    });

    function toNumOrNull(v){ const n=Number(v); return Number.isFinite(n)?n:null; }

    // İlk yükleme
    load();
    render();
    // Kısayol: Ctrl/Cmd+K arama
    document.addEventListener('keydown',e=>{ if((e.ctrlKey||e.metaKey)&&e.key.toLowerCase()==='k'){ e.preventDefault(); $('#search').focus(); } });
    // Sekmeler arası senkron
    window.addEventListener('storage',e=>{ if(e.key===LS_KEY){ load(); render(); } });
  })();
  </script>

<!-- === Firebase Live Sync (Sync-Fix: LS watcher + periodic flush) === -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
  import { getDatabase, ref, onValue, update, set, onDisconnect } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAyx_HVYwckqw2bYl_sdu57XPUP_tdDsxA",
    authDomain: "muhallebi06.firebaseapp.com",
    databaseURL: "https://hertz-stok-takip-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "hertz-stok-takip",
    storageBucket: "hertz-stok-takip.appspot.com",
    messagingSenderId: "512663727455",
    appId: "1:512663727455:web:99e15a20f7ae9b77a39aea"
  };

  const app = initializeApp(firebaseConfig);
  const db  = getDatabase(app);

  // DOC (room) id from URL or default
  const urlDoc = new URLSearchParams(location.search).get("doc");
  const DOC_ID = urlDoc || "stoktakip-paylasimli-orta-oda";
  const rootRef = ref(db, `docs/${DOC_ID}`);
  const presRef = ref(db, `docs/${DOC_ID}/presence`);
  const meId    = crypto.randomUUID();
  const meRef   = ref(db, `docs/${DOC_ID}/presence/${meId}`);
  set(meRef, { at: Date.now(), ua: navigator.userAgent.slice(0,64) }).catch(()=>{});
  onDisconnect(meRef).remove();

  // Helper to safely parse LS
  function safeParse(x){ try { return JSON.parse(x); } catch { return null; } }

  // 1) Mirror LocalStorage writes for LS_KEY into RTDB
  const _setItem = localStorage.setItem.bind(localStorage);
  window.LS_KEY = window.LS_KEY || "stok-uyg";
  localStorage.setItem = function(k, v){
    _setItem(k, v);
    if(k === window.LS_KEY){
      const obj = safeParse(v) || {};
      const data = { products: obj.products || [], logs: obj.logs || [], updatedAt: Date.now() };
      update(rootRef, data).catch(err => console.error("Buluta yazma hatası:", err));
    }
  };

  // 2) Periodic flush (fallback): her 1 sn'de bir LS'deki ile son gönderileni kıyasla
  let lastSent = "";
  setInterval(() => {
    const now = localStorage.getItem(window.LS_KEY) || "";
    if(now && now !== lastSent){
      lastSent = now;
      const obj = safeParse(now) || {};
      const data = { products: obj.products || [], logs: obj.logs || [], updatedAt: Date.now() };
      update(rootRef, data).catch(err => console.error("Buluta yazma hatası:", err));
    }
  }, 1000);

  // 3) Remote -> UI: anlık dinle ve uygula
  onValue(rootRef, (snap) => {
    const v = snap.val();
    if(!v || typeof v !== "object") return;
    const { products = [], logs = [] } = v;

    // Yerel ile aynı ise atla
    const local = safeParse(localStorage.getItem(window.LS_KEY) || "null") || {products:[], logs:[]};
    if (JSON.stringify(local.products||[]) === JSON.stringify(products) &&
        JSON.stringify(local.logs||[])     === JSON.stringify(logs)) return;

    // LS'yi güncelle → uygulamanın kendi akışı render'ı tetikleyecek
    const merged = JSON.stringify({ products, logs });
    localStorage.setItem(window.LS_KEY, merged);
    try { if (typeof render === "function") render(); } catch(e){ console.warn("render() çağrısı hata:", e); }
  }, (err)=> console.error("RTDB dinleme hatası:", err));

  // 4) İlk seed: RTDB boşsa LS'den al
  setTimeout(() => {
    onValue(rootRef, (snap) => {
      if(!snap.exists()){
        const local = safeParse(localStorage.getItem(window.LS_KEY) || "null") || {products:[], logs:[]};
        const data = { products: local.products||[], logs: local.logs||[], updatedAt: Date.now() };
        set(rootRef, data).catch(console.error);
      }
    }, { onlyOnce: true });
  }, 300);

  // 5) Ekranda "statusOnline" varsa sayacı yaz
  onValue(presRef, (snap) => {
    const n = snap.exists() ? Object.keys(snap.val()||{}).length : 0;
    const el = document.getElementById("statusOnline");
    if (el) el.textContent = `Çevrimiçi: ${n}`;
  });
</script>
<!-- === /Sync-Fix === -->

</body>
</html>
