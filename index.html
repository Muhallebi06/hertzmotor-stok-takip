<!DOCTYPE html>
<html lang="tr" class="scroll-smooth">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Hertz Motor — Stok Takip</title>
  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root { --brand: 205,105,40; }
    .btn-brand{background:rgb(var(--brand));color:#fff}
    .badge{display:inline-block;padding:.125rem .5rem;border-radius:.5rem;font-size:.75rem}
    dialog::backdrop{background:rgb(0 0 0/.5)}
  </style>
</head>
<body class="bg-slate-50 text-slate-800">
<header class="sticky top-0 z-10 bg-white/90 backdrop-blur border-b border-slate-200">
  <div class="mx-auto max-w-7xl px-3 md:px-4 py-3 flex items-center gap-3">
    <div class="w-10 h-10 grid place-items-center rounded-2xl text-white font-bold" style="background:rgb(var(--brand))">HM</div>
    <div class="grow min-w-0">
      <h1 class="text-lg md:text-2xl font-semibold truncate">Hertz Motor — Stok Takip</h1>
      <p class="hidden md:block text-xs text-slate-500">Yerel Kayıt • Firebase Senkronizasyon • CSV Aktarım</p>
    </div>
    <div class="flex flex-wrap gap-2 items-center">
      <button id="btnAdd" class="px-3 py-2 rounded-xl btn-brand">Ürün Ekle</button>
      <button id="btnImport" class="px-3 py-2 rounded-xl border border-slate-300 bg-white">İçe Aktar</button>
      <button id="btnExport" class="px-3 py-2 rounded-xl border border-slate-300 bg-white">Dışa Aktar</button>
      <button id="btnExportCSV" class="px-3 py-2 rounded-xl border border-slate-300 bg-white">CSV</button>
      <button id="btnExportLogCSV" class="px-3 py-2 rounded-xl border border-slate-300 bg-white">Log CSV</button>
      <button id="btnClear" class="px-3 py-2 rounded-xl text-white bg-rose-600">Tüm Veriyi Sil</button>
    </div>
  </div>
</header>

<main class="mx-auto max-w-7xl p-3 md:p-4">
  <div class="flex flex-col md:flex-row gap-2 md:gap-3 items-stretch md:items-center mb-3 md:mb-4">
    <div class="flex items-center gap-2 grow">
      <input id="search" type="search" placeholder="Ara: ad, stok kodu…" class="w-full md:max-w-sm px-3 py-2 rounded-xl border border-slate-300 bg-white" />
      <label class="flex items-center gap-2 text-sm text-slate-600 whitespace-nowrap">
        <input id="onlyLow" type="checkbox" class="w-4 h-4"> Sadece kritik stok
      </label>
    </div>
    <div id="statusOnline" class="text-sm text-slate-500 mr-4"></div>
    <div class="text-sm text-slate-500">Kayıt: <span id="count">0</span></div>
  </div>

  <div class="hidden md:block overflow-auto rounded-2xl border border-slate-200 bg-white">
    <table class="min-w-full text-sm">
      <thead id="thead" class="bg-slate-100 text-slate-700">
        <tr>
          <th data-sort="sku" class="text-left px-3 py-2 cursor-pointer select-none">Stok Kodu</th>
          <th data-sort="name" class="text-left px-3 py-2 cursor-pointer select-none">Ad</th>
          <th class="text-left px-3 py-2">Tür/Çeşit</th>
          <th data-sort="qty" class="text-right px-3 py-2 cursor-pointer select-none">Stok</th>
          <th data-sort="min" class="text-right px-3 py-2 cursor-pointer select-none">Minimum</th>
          <th class="text-left px-3 py-2">Not</th>
          <th class="text-right px-3 py-2">İşlemler</th>
        </tr>
      </thead>
      <tbody id="tbodyDesktop" class="divide-y divide-slate-100"></tbody>
    </table>
  </div>

  <div id="listMobile" class="md:hidden space-y-2"></div>

  <details class="mt-5 group">
    <summary class="cursor-pointer select-none text-sm text-slate-600 flex items-center gap-2">
      <span class="inline-block w-2 h-2 rounded-full" style="background: rgb(var(--brand))"></span>
      Hareket Geçmişi
    </summary>
    <div class="mt-3 overflow-auto rounded-2xl border border-slate-200 bg-white max-h-[50vh]">
      <table class="min-w-full text-sm">
        <thead class="bg-slate-100 text-slate-700">
          <tr>
            <th class="text-left px-3 py-2">Tarih</th>
            <th class="text-left px-3 py-2">Ürün</th>
            <th class="text-left px-3 py-2">Tür</th>
            <th class="text-right px-3 py-2">Miktar</th>
            <th class="text-right px-3 py-2">Önce</th>
            <th class="text-right px-3 py-2">Sonra</th>
            <th class="text-left px-3 py-2">Not</th>
          </tr>
        </thead>
        <tbody id="logBody" class="divide-y divide-slate-100"></tbody>
      </table>
    </div>
  </details>
</main>

<dialog id="productDialog" class="rounded-2xl p-0 w-[96vw] max-w-xl">
  <form id="productForm" class="p-4" novalidate>
    <h3 id="productDialogTitle" class="text-lg font-semibold mb-4">Ürün Ekle</h3>
    <div id="productFormFields" class="grid md:grid-cols-2 gap-3"></div>
    <div class="mt-5 flex justify-end gap-2">
      <button id="productCancelBtn" type="button" class="px-3 py-2 rounded-xl border border-slate-300 bg-white">Vazgeç</button>
      <button id="productSaveBtn" type="submit" class="px-3 py-2 rounded-xl btn-brand">Kaydet</button>
    </div>
    <input type="hidden" name="id" />
  </form>
</dialog>

<dialog id="moveDialog" class="rounded-2xl p-0 w-[96vw] max-w-md">
  <form id="moveForm" class="p-4" novalidate>
    <h3 class="text-lg font-semibold mb-4">Stok Hareketi</h3>
    <div class="space-y-3">
      <div class="text-sm">Ürün: <span id="moveProductName" class="font-medium"></span></div>
      <div class="grid grid-cols-2 gap-3">
        <label class="flex items-center gap-2"><input type="radio" name="type" value="in" checked> <span>Giriş</span></label>
        <label class="flex items-center gap-2"><input type="radio" name="type" value="out"> <span>Çıkış</span></label>
      </div>
      <div>
        <label class="text-sm">Miktar</label>
        <input name="amount" type="number" step="any" required class="w-full px-3 py-2 rounded-xl border border-slate-300" />
      </div>
      <div>
        <label class="text-sm">Not (isteğe bağlı)</label>
        <input name="note" type="text" class="w-full px-3 py-2 rounded-xl border border-slate-300" />
      </div>
    </div>
    <div class="mt-5 flex justify-end gap-2">
      <button id="moveCancelBtn" type="button" class="px-3 py-2 rounded-xl border border-slate-300 bg-white">Vazgeç</button>
      <button id="moveApplyBtn" type="submit" class="px-3 py-2 rounded-xl btn-brand">Uygula</button>
    </div>
    <input type="hidden" name="id" />
  </form>
</dialog>

<input id="fileInput" type="file" accept="application/json" class="hidden" />

<footer class="mx-auto max-w-7xl p-3 md:p-4 text-xs text-slate-500">
  <p>Veriler bu cihazın tarayıcısında saklanır. Cihazlar arasında anlık senkronizasyon için Firebase bağlantısı kullanılır.</p>
</footer>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getDatabase, ref, onValue, update, set, onDisconnect } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

  // ---- State ----
  const $ = (s)=>document.querySelector(s);
  const DOM = {
    btnAdd: $('#btnAdd'), btnImport: $('#btnImport'), btnExport: $('#btnExport'), btnExportCSV: $('#btnExportCSV'),
    btnExportLogCSV: $('#btnExportLogCSV'), btnClear: $('#btnClear'), search: $('#search'), onlyLow: $('#onlyLow'),
    count: $('#count'), thead: $('#thead'), tbodyDesktop: $('#tbodyDesktop'), listMobile: $('#listMobile'),
    logBody: $('#logBody'), productDialog: $('#productDialog'), productForm: $('#productForm'),
    productFormFields: $('#productFormFields'), productDialogTitle: $('#productDialogTitle'),
    productCancelBtn: $('#productCancelBtn'), moveDialog: $('#moveDialog'), moveForm: $('#moveForm'),
    moveProductName: $('#moveProductName'), moveCancelBtn: $('#moveCancelBtn'), fileInput: $('#fileInput'),
    statusOnline: $('#statusOnline'),
  };

  const LS_KEY = 'stokTakip.v42';
  let state = { products: [], logs: [], sortBy: 'name', sortDir: 'asc' };
  const CATEGORY_PREFIX = { stator: 'ST', rotor: 'RT', mil: 'MIL', rotorluMil: 'RMIL', taslanmisMil: 'TMIL', sargiliPaket: 'SP', paketliGovde: 'PG', motor: 'MOT' };
  const CATEGORY_LABEL  = { stator: 'Stator', rotor: 'Rotor', mil: 'Mil', rotorluMil: 'Rotorlu Mil', taslanmisMil: 'Taşlanmış Mil', sargiliPaket: 'Sargılı Paket', paketliGovde: 'Paketli Gövde', motor: 'Motor' };

  const uuid = () => (crypto.randomUUID ? crypto.randomUUID() : Math.random().toString(36).slice(2)+Date.now());
  const nowISO = () => new Date().toISOString();

  function loadState(){
    try{
      const raw = localStorage.getItem(LS_KEY);
      if(!raw) return;
      const d = JSON.parse(raw);
      state.products = Array.isArray(d.products)?d.products:[];
      state.logs = Array.isArray(d.logs)?d.logs:[];
    }catch(e){ console.warn(e); }
  }
  function saveState(push=true){
    const data = { products: state.products, logs: state.logs };
    localStorage.setItem(LS_KEY, JSON.stringify(data));
    if (push && window.firebasePush) window.firebasePush(data);
    render();
  }
  const addLog = (e)=>state.logs.unshift({ id: uuid(), ts: nowISO(), ...e });
  const findP = id => state.products.find(p=>p.id===id);

  function render(){
    const q = (DOM.search.value||'').trim().toLowerCase();
    const onlyLow = DOM.onlyLow.checked;
    let list = [...state.products];
    if(q) list = list.filter(p => (p.name+' '+p.sku).toLowerCase().includes(q));
    if(onlyLow) list = list.filter(p => Number(p.qty||0) < Number(p.min||0));

    list.sort((a,b)=>{
      let A,B,k=state.sortBy;
      if(k==='qty'||k==='min'){ A=Number(a[k]||0); B=Number(b[k]||0) }
      else { A=(a[k]||'').toLowerCase(); B=(b[k]||'').toLowerCase(); }
      return (A<B?-1:A>B?1:0) * (state.sortDir==='asc'?1:-1);
    });

    DOM.count.textContent = list.length;
    DOM.tbodyDesktop.innerHTML='';
    DOM.listMobile.innerHTML='';

    list.forEach(p=>{
      const isLow = Number(p.qty||0)<Number(p.min||0);
      const qtyClass = isLow ? 'text-amber-700' : '';
      const kindBadge = p.kind ? `<span class="badge bg-slate-100 border border-slate-200 mr-1">${p.kind==='ham'?'Hammadde':(p.kind==='yari'?'Yarı-mamul':'Mamul')}</span>` : '';
      const catBadge = p.category ? `<span class="badge" style="background: rgba(var(--brand), .15); border:1px solid rgba(var(--brand), .4); color: rgb(var(--brand))">${CATEGORY_LABEL[p.category]||p.category}</span>` : '';
      const buttons = `
        <div class="flex justify-end gap-1 flex-wrap">
          <button class="px-2 py-1 text-xs rounded-lg border border-slate-300 bg-white" data-act="move-in" data-id="${p.id}">Giriş</button>
          <button class="px-2 py-1 text-xs rounded-lg border border-slate-300 bg-white" data-act="move-out" data-id="${p.id}">Çıkış</button>
          <button class="px-2 py-1 text-xs rounded-lg" style="border:1px solid rgba(var(--brand), .5); color: rgb(var(--brand)); background:transparent" data-act="edit" data-id="${p.id}">Düzenle</button>
          <button class="px-2 py-1 text-xs rounded-lg border border-rose-300 text-rose-700 bg-white" data-act="del" data-id="${p.id}">Sil</button>
        </div>`;

      DOM.tbodyDesktop.innerHTML += `
        <tr class="${isLow?'bg-amber-50':''}">
          <td class="px-3 py-2 align-top">${p.sku||'-'}</td>
          <td class="px-3 py-2 align-top">${p.name||'-'}</td>
          <td class="px-3 py-2 align-top">${kindBadge} ${catBadge}</td>
          <td class="px-3 py-2 align-top text-right font-medium ${qtyClass}">${p.qty||0}</td>
          <td class="px-3 py-2 align-top text-right">${p.min||0}</td>
          <td class="px-3 py-2 align-top text-slate-600">${p.note||''}</td>
          <td class="px-3 py-2 align-top text-right">${buttons}</td>
        </tr>`;

      DOM.listMobile.innerHTML += `
        <div class="rounded-2xl border border-slate-200 bg-white p-3">
          <div class="flex items-start justify-between gap-2">
            <div class="min-w-0">
              <div class="text-sm text-slate-500">${p.sku||'-'}</div>
              <div class="font-medium truncate">${p.name||'-'}</div>
              <div class="mt-1 text-xs">${kindBadge} ${catBadge}</div>
            </div>
            <div class="text-right">
              <div class="text-xs text-slate-500">Stok</div>
              <div class="text-base font-semibold ${qtyClass}">${p.qty||0}</div>
              <div class="text-xs text-slate-500">Min ${p.min||0}</div>
            </div>
          </div>
          ${p.note?`<div class="mt-2 text-xs text-slate-600">${p.note}</div>`:''}
          <div class="mt-3">${buttons}</div>
        </div>`;
    });

    DOM.logBody.innerHTML='';
    state.logs.slice(0,100).forEach(L=>{
      const p=findP(L.productId)||{name:'(silinmiş ürün)'};
      const t=L.type==='in'?'Giriş':(L.type==='out'?'Çıkış':L.type);
      DOM.logBody.innerHTML += `
        <tr>
          <td class="px-3 py-2">${new Date(L.ts).toLocaleString('tr-TR')}</td>
          <td class="px-3 py-2">${p.name}</td>
          <td class="px-3 py-2">${t}</td>
          <td class="px-3 py-2 text-right">${L.amount||''}</td>
          <td class="px-3 py-2 text-right">${L.fromQty??''}</td>
          <td class="px-3 py-2 text-right">${L.toQty??''}</td>
          <td class="px-3 py-2">${L.note||''}</td>
        </tr>`;
    });
  }

  function initEvents(){
    DOM.btnAdd.addEventListener('click', ()=>openProductDialog());
    DOM.btnExport.addEventListener('click', exportJSON);
    DOM.btnExportCSV.addEventListener('click', exportCSV);
    DOM.btnExportLogCSV.addEventListener('click', exportLogCSV);
    DOM.btnImport.addEventListener('click', ()=>DOM.fileInput.click());
    DOM.fileInput.addEventListener('change', e=>{ if(e.target.files[0]) importJSONFile(e.target.files[0]); e.target.value=''; });
    DOM.btnClear.addEventListener('click', clearAllData);
    DOM.search.addEventListener('input', render);
    DOM.onlyLow.addEventListener('change', render);

    DOM.thead.addEventListener('click', e=>{
      const th=e.target.closest('th[data-sort]');
      if(!th) return;
      const k=th.dataset.sort;
      if(state.sortBy===k) state.sortDir=(state.sortDir==='asc'?'desc':'asc');
      else { state.sortBy=k; state.sortDir='asc'; }
      render();
    });

    document.body.addEventListener('click', e=>{
      const b=e.target.closest('button[data-act]');
      if(!b) return;
      const id=b.dataset.id;
      const p=findP(id);
      if(!p) return;
      switch(b.dataset.act){
        case 'edit': openProductDialog(p); break;
        case 'del': deleteProduct(p); break;
        case 'move-in': openMoveDialog(p,'in'); break;
        case 'move-out': openMoveDialog(p,'out'); break;
      }
    });

    DOM.productForm.addEventListener('submit', handleProductSave);
    DOM.moveForm.addEventListener('submit', handleMoveSave);
    DOM.productCancelBtn.addEventListener('click', ()=>DOM.productDialog.close());
    DOM.moveCancelBtn.addEventListener('click', ()=>DOM.moveDialog.close());
  }

  function openProductDialog(product=null){
    DOM.productForm.reset();
    DOM.productForm.id.value = product ? product.id : '';
    DOM.productDialogTitle.textContent = product ? 'Ürünü Düzenle' : 'Ürün Ekle';
    DOM.productFormFields.innerHTML = `
      <div><label class="text-sm text-slate-600">Ürün Türü</label><select name="kind" class="w-full px-3 py-2 rounded-xl border border-slate-300"><option value="mamul">Mamul</option><option value="yari">Yarı-mamul</option><option value="ham">Hammadde</option></select></div>
      <div><label class="text-sm text-slate-600">Ürün Çeşidi</label><select name="category" class="w-full px-3 py-2 rounded-xl border border-slate-300"><option value="stator">Stator</option><option value="rotor">Rotor</option><option value="mil">Mil</option><option value="rotorluMil">Rotorlu Mil</option><option value="taslanmisMil">Taşlanmış Mil</option><option value="sargiliPaket">Sargılı Paket</option><option value="paketliGovde">Paketli Gövde</option><option value="motor">Motor</option></select></div>
      <div class="md:col-span-2"><label class="text-sm text-slate-600">Ad</label><input name="name" type="text" required class="w-full px-3 py-2 rounded-xl border border-slate-300" /></div>
      <div><label class="text-sm text-slate-600">Stok Kodu</label><div class="flex gap-2"><input name="sku" type="text" required class="w-full px-3 py-2 rounded-xl border border-slate-300" /><button id="btnAutoSku" type="button" class="px-3 py-2 rounded-xl border border-slate-300">Oluştur</button></div></div>
      <div><label class="text-sm text-slate-600">Birim</label><input name="unit" type="text" placeholder="adet, kg, m…" class="w-full px-3 py-2 rounded-xl border border-slate-300" /></div>
      <div><label class="text-sm text-slate-600">Minimum Stok</label><input name="min" type="number" step="any" value="0" class="w-full px-3 py-2 rounded-xl border border-slate-300" /></div>
      <div class="md:col-span-2"><label class="text-sm text-slate-600">Not</label><input name="note" type="text" class="w-full px-3 py-2 rounded-xl border border-slate-300" /></div>`;

    document.querySelector('#btnAutoSku').addEventListener('click', ()=>{
      const cat = DOM.productForm.category.value;
      DOM.productForm.sku.value = nextSkuForCategory(cat);
    });

    if(product){ for(const k in product){ if(DOM.productForm[k]) DOM.productForm[k].value = product[k]; } }
    else { DOM.productForm.sku.value = nextSkuForCategory(DOM.productForm.category.value); }
    DOM.productDialog.showModal();
  }

  function handleProductSave(e){
    e.preventDefault();
    const d = Object.fromEntries(new FormData(DOM.productForm).entries());
    d.min = Number(d.min||0);
    if(!d.name || !d.sku){ alert('Ad ve stok kodu zorunludur.'); return; }
    const exists = state.products.some(p=>p.sku.toLowerCase()===d.sku.toLowerCase() && p.id!==d.id);
    if(exists){ alert('Bu stok kodu zaten kullanılıyor.'); return; }
    if(d.id){
      const idx = state.products.findIndex(p=>p.id===d.id);
      if(idx>-1){ state.products[idx] = { ...state.products[idx], ...d }; addLog({ productId:d.id, type:'edit', note:'Ürün bilgisi güncellendi' }); }
    } else {
      const item = { ...d, id: uuid(), qty: 0 };
      state.products.unshift(item);
      addLog({ productId:item.id, type:'new', note:'Yeni ürün eklendi' });
    }
    saveState(true);
    DOM.productDialog.close();
  }

  function nextSkuForCategory(cat){
    const prefix = CATEGORY_PREFIX[cat] || 'PRD';
    let max = 0;
    state.products.forEach(p=>{
      if(p.sku && p.sku.startsWith(prefix)){
        const num = parseInt(p.sku.replace(prefix+'-',''), 10);
        if(!isNaN(num) && num>max) max=num;
      }
    });
    return `${prefix}-${String(max+1).padStart(4,'0')}`;
  }

  function deleteProduct(p){
    if(!confirm(`'${p.name}' adlı ürünü silmek istiyor musunuz?`)) return;
    state.products = state.products.filter(x=>x.id!==p.id);
    addLog({ productId:p.id, type:'delete', note:'Ürün silindi' });
    saveState(true);
  }

  function openMoveDialog(p, type){
    DOM.moveForm.reset();
    DOM.moveForm.id.value = p.id;
    DOM.moveProductName.textContent = `${p.name} (Stok: ${p.qty||0})`;
    DOM.moveForm.type.value = type;
    DOM.moveDialog.showModal();
  }

  function handleMoveSave(e){
    e.preventDefault();
    const d = Object.fromEntries(new FormData(DOM.moveForm).entries());
    const p = findP(d.id); if(!p) return;
    const amt = Number(d.amount);
    if(!amt || amt<=0){ alert('Miktar pozitif olmalı.'); return; }
    const fromQty = Number(p.qty||0);
    const toQty = d.type==='in' ? fromQty+amt : fromQty-amt;
    if(toQty<0){ alert('Stok eksiye düşemez.'); return; }
    p.qty = toQty;
    addLog({ productId:p.id, type:d.type, amount:amt, fromQty, toQty, note:d.note });
    saveState(true);
    DOM.moveDialog.close();
  }

  function clearAllData(){
    if(!confirm('TÜM ürünler ve hareket geçmişi silinecek. Emin misiniz?\n\nDevam etmeden önce otomatik yedek alınacak.')) return;
    exportJSON();
    state.products=[]; state.logs=[];
    saveState(true);
  }

  function exportJSON(){
    const s = JSON.stringify({products:state.products, logs:state.logs}, null, 2);
    downloadFile(s,'application/json',`stok-yedek-${new Date().toISOString().slice(0,10)}.json`);
  }
  function exportCSV(){
    const headers=['sku','name','kind','category','unit','qty','min','note'];
    const rows = state.products.map(p=>headers.map(h=>p[h]||''));
    const csv = [headers.join(','), ...rows.map(r=>r.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(','))].join('\n');
    downloadFile(csv,'text/csv;charset=utf-8;','stok-urunler.csv');
  }
  function exportLogCSV(){
    const headers=['Tarih','Ürün Adı','SKU','İşlem','Miktar','Önceki Stok','Sonraki Stok','Not'];
    const rows = state.logs.map(L=>{ const p=findP(L.productId)||{}; return [ new Date(L.ts).toLocaleString('tr-TR'), p.name||'', p.sku||'', L.type, L.amount||'', L.fromQty??'', L.toQty??'', L.note||'' ]; });
    const csv = [headers.join(','), ...rows.map(r=>r.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(','))].join('\n');
    downloadFile(csv,'text/csv;charset=utf-8;','stok-loglar.csv');
  }
  function importJSONFile(file){
    const reader = new FileReader();
    reader.onload = e=>{
      try{
        const data = JSON.parse(e.target.result);
        if(Array.isArray(data.products) && Array.isArray(data.logs)){
          if(!confirm('İçe aktarma mevcut tüm verilerin üzerine yazacak. Emin misiniz?')) return;
          state.products=data.products; state.logs=data.logs; saveState(true); alert('Veri içe aktarıldı.');
        } else throw new Error('Geçersiz dosya.');
      }catch(err){ alert('Hata: '+err.message); }
    };
    reader.readAsText(file);
  }
  function downloadFile(content,mime,name){
    const blob=new Blob([content],{type:mime}); const url=URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download=name; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  }

  // ---- Firebase realtime (products/logs only) ----
  function startFirebase(){
    const firebaseConfig = {
      apiKey: "AIzaSyAyx_HVYwckqw2bYl_sdu57XPUP_tdDsxA",
      authDomain: "hertz-stok-takip.firebaseapp.com",
      databaseURL: "https://hertz-stok-takip-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "hertz-stok-takip",
      storageBucket: "hertz-stok-takip.appspot.com",
      messagingSenderId: "512663727455",
      appId: "1:512663727455:web:99e15a20f7ae9b77a39aea"
    };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const docId = new URLSearchParams(location.search).get("doc") || "varsayilan-stok-odasi";
    const rootRef = ref(db, `stok/${docId}`);
    const presenceRef = ref(db, `stok/${docId}/_presence`);
    const meRef = ref(db, `stok/${docId}/_presence/${uuid()}`);

    set(meRef, { at: nowISO() }); onDisconnect(meRef).remove();

    // Push: sadece products/logs gönder
    window.firebasePush = (data)=>{
      const payload = {
        products: Array.isArray(data.products)?data.products:[],
        logs: Array.isArray(data.logs)?data.logs:[],
        updatedAt: nowISO()
      };
      update(rootRef, payload).catch(e=>console.error('RTDB push error', e));
    };

    // Pull: sadece products/logs kıyasla, sayfayı yenilemeden uygula
    let first = True = true
    onValue(rootRef, (snap)=>{
      const raw = snap.val() || {};
      const remote = {
        products: Array.isArray(raw.products)?raw.products:[],
        logs: Array.isArray(raw.logs)?raw.logs:[]
      };
      let localObj={}; try{ localObj=JSON.parse(localStorage.getItem(LS_KEY))||{} }catch{}
      const local = {
        products: Array.isArray(localObj.products)?localObj.products:[],
        logs: Array.isArray(localObj.logs)?localObj.logs:[]
      };
      const same = (JSON.stringify(remote.products)===JSON.stringify(local.products) &&
                    JSON.stringify(remote.logs)===JSON.stringify(local.logs));
      if(!same){
        state.products = remote.products;
        state.logs = remote.logs;
        saveState(false);
      }
    });

    onValue(presenceRef, (snap)=>{
      const count = snap.exists()? Object.keys(snap.val()).length : 0;
      DOM.statusOnline.textContent = `Çevrimiçi: ${count}`;
    });
  }

  // ---- bootstrap ----
  function init(){
    loadState(); render(); initEvents(); startFirebase();
  }
  document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
