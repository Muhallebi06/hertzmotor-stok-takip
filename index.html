<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Hertz Motor ‚Äî Entegre Y√∂netim Platformu</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/tr.js"></script>

  <style>
    /* Global Stiller */
    :root { --brand: 205,105,40; }
    body {
        --tw-bg-opacity: 1;
        background-color: rgb(248 250 252 / var(--tw-bg-opacity)); /* bg-slate-50 */
    }
    .btn-brand { background-color: rgb(var(--brand)); color: white; }
    .btn-brand:hover { filter: brightness(0.95); }
    dialog::backdrop { background: rgb(0 0 0 / 0.5); }
    
    /* Sipari≈ü/Servis Mod√ºl√ºne √ñzel Stiller */
    .siparis-servis-app .highlight { background-color: #fecaca; }
    .siparis-servis-app .date-input { transition: box-shadow .15s ease, border-color .15s ease; }
    .siparis-servis-app .date-input:focus {
      outline: none; border-color: rgba(var(--brand), .55);
      box-shadow: 0 0 0 3px rgba(var(--brand), .20);
    }
    .siparis-servis-app .editable { cursor:text }
    .siparis-servis-app .sortable { cursor: pointer; user-select: none; position: relative; padding-right: 20px; }
    .siparis-servis-app .sortable:hover { background-color: rgba(0,0,0,0.05); }
    .siparis-servis-app .sort-indicator { position: absolute; right: 5px; top: 50%; transform: translateY(-50%); font-size: 10px; color: #64748b; }
    .siparis-servis-app .sortable.asc .sort-indicator::after { content: '‚ñ≤'; }
    .siparis-servis-app .sortable.desc .sort-indicator::after { content: '‚ñº'; }

    /* Stok Takip Mod√ºl√ºne √ñzel Stiller */
    .stok-takip-app .badge{display:inline-block;padding:.125rem .5rem;border-radius:.5rem;font-size:.75rem}
    .stok-takip-app .no-scrollbar::-webkit-scrollbar{ display:none; }
    .stok-takip-app .no-scrollbar{ -ms-overflow-style:none; scrollbar-width:none; }
    .stok-takip-app .editable-qty { cursor: pointer; border-radius: 4px; padding: 2px 4px; transition: background-color 0.2s; }
    .stok-takip-app .editable-qty:hover { background-color: #fef9c3; } /* yellow-100 */

    /* === MOBƒ∞L UYUMLULUK ƒ∞√áƒ∞N RESPONSIVE TABLO STƒ∞LLERƒ∞ === */
    @media screen and (max-width: 768px) {
        .siparis-servis-app table.responsive-table {
            border: 0;
        }
        .siparis-servis-app table.responsive-table thead {
            display: none; /* Masa√ºst√º ba≈ülƒ±klarƒ± gizle */
        }
        .siparis-servis-app table.responsive-table tr {
            display: block;
            margin-bottom: 0.75em;
            border-radius: 0.75rem;
            border: 1px solid #e2e8f0; /* slate-200 */
            box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
            background-color: white;
            padding: 0.5rem 0.75rem;
        }
        .siparis-servis-app table.responsive-table td {
            display: flex;
            justify-content: space-between;
            align-items: center;
            text-align: right;
            font-size: 0.875rem;
            border-bottom: 1px solid #f1f5f9; /* slate-100 */
            padding: 0.6rem 0.2rem;
        }
        .siparis-servis-app table.responsive-table td::before {
            content: attr(data-label);
            text-align: left;
            font-weight: 600;
            color: #475569; /* slate-600 */
        }
        .siparis-servis-app table.responsive-table td:last-child {
            border-bottom: 0;
        }
        /* √ñzel h√ºcreler i√ßin hizalama */
        .siparis-servis-app table.responsive-table td[data-label="Hazƒ±r"],
        .siparis-servis-app table.responsive-table td[data-label="Sevke Hazƒ±r"] {
            padding: 0.5rem 0.2rem;
        }
        .siparis-servis-app table.responsive-table td[data-label="ƒ∞≈ülemler"],
        .siparis-servis-app table.responsive-table td[data-label="Durum"],
        .siparis-servis-app table.responsive-table td[data-label="ƒ∞≈ülem"],
        .siparis-servis-app table.responsive-table td[data-label="A√ßƒ±klama"] {
             display: block;
             text-align: left;
             padding: 0.75rem 0.2rem;
        }
        .siparis-servis-app table.responsive-table td[data-label="ƒ∞≈ülemler"]::before,
        .siparis-servis-app table.responsive-table td[data-label="Durum"]::before,
        .siparis-servis-app table.responsive-table td[data-label="ƒ∞≈ülem"]::before,
        .siparis-servis-app table.responsive-table td[data-label="A√ßƒ±klama"]::before {
            display: none; /* Bu etiketleri gizle, i√ßeriƒüi tam geni≈ülik kullanabilsin */
        }
    }
    
    /* === D√ºƒüme G√∂r√ºn√ºrl√ºk Kontrol√º === */
    #siparis-header-buttons, #stok-header-buttons, 
    #siparis-mobile-buttons, #stok-mobile-buttons {
        display: none;
    }
    
    /* Masa√ºst√º G√∂r√ºn√ºm√º */
    @media (min-width: 640px) { /* sm breakpoint */
        body[data-active-app="siparis"] #siparis-header-buttons {
            display: flex;
        }
        body[data-active-app="stok"] #stok-header-buttons {
            display: flex;
        }
    }

    /* Mobil G√∂r√ºn√ºm√º */
    @media (max-width: 639.98px) { /* below sm breakpoint */
        body[data-active-app="siparis"] #siparis-mobile-buttons {
            display: flex;
        }
        body[data-active-app="stok"] #stok-mobile-buttons {
            display: flex;
        }
    }
  </style>
</head>

<body class="text-slate-800">

<!-- === Ortak Giri≈ü Ekranƒ± (Login Gate) === -->
<style>
  #authGate {
    position: fixed; inset: 0; display: none; place-items: center; z-index: 99999;
    background: radial-gradient(1000px 600px at 30% 20%, rgba(205,105,40,.08), transparent 60%) , #0b1220;
    color: #e5e7eb; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  }
  #authCard {
    width: min(380px, 92vw); background: #111827; border: 1px solid #1f2937; border-radius: 14px;
    padding: 22px 22px 16px; box-shadow: 0 10px 40px rgba(0,0,0,.35);
  }
</style>
<div id="authGate">
  <div id="authCard">
    <h2 class="text-lg font-semibold text-slate-100">Platform Giri≈üi</h2>
    <p class="text-sm text-slate-400 mb-4">Devam etmek i√ßin kullanƒ±cƒ± adƒ± ve ≈üifre girin.</p>
    <form id="authForm">
      <div class="grid gap-2 mb-3">
        <label for="authUser" class="text-sm text-slate-300">Kullanƒ±cƒ± adƒ±</label>
        <input id="authUser" name="u" autocomplete="username" class="bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-slate-100 focus:ring-2 focus:ring-orange-500 focus:border-orange-500" required>
      </div>
      <div class="grid gap-2 mb-4">
        <label for="authPass" class="text-sm text-slate-300">≈ûifre</label>
        <input id="authPass" name="p" type="password" autocomplete="current-password" class="bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-slate-100 focus:ring-2 focus:ring-orange-500 focus:border-orange-500" required>
      </div>
      <button id="authBtn" type="submit" class="w-full py-2 rounded-lg btn-brand font-semibold">Giri≈ü</button>
      <div id="authErr" class="min-h-[20px] text-rose-400 text-sm mt-2 text-center"></div>
    </form>
  </div>
</div>
<!-- === /Giri≈ü Ekranƒ± === -->

<header class="sticky top-0 z-20 bg-white/80 backdrop-blur-lg border-b border-slate-200 shadow-sm">
    <div class="max-w-screen-2xl mx-auto px-2 sm:px-4 py-3 flex flex-wrap items-center justify-between gap-4">
        <div class="flex items-center gap-3 flex-shrink-0">
            <div class="shrink-0 w-10 h-10 grid place-items-center rounded-2xl text-white font-bold" style="background: rgb(var(--brand))">HM</div>
            <div>
                <h1 class="text-base md:text-xl font-semibold truncate">Hertz Motor</h1>
            </div>
        </div>
        
        <div class="flex-1 flex justify-center min-w-full sm:min-w-0 order-3 sm:order-2">
            <div id="main-nav-tabs" class="flex items-center gap-2 bg-slate-200 p-1 rounded-xl">
                <button id="mainTabSiparis" class="main-tab px-2 md:px-4 py-1.5 rounded-lg text-sm font-semibold">Sipari≈ü & Servis</button>
                <button id="mainTabStok" class="main-tab px-2 md:px-4 py-1.5 rounded-lg text-sm font-semibold">Stok Y√∂netimi</button>
            </div>
        </div>

        <div class="flex items-center gap-2 flex-shrink-0 order-2 sm:order-3">
            <div id="siparis-header-buttons" class="items-center gap-2">
                <label class="text-sm">
                    <input accept="application/json" class="hidden" id="ss_fileInput" type="file">
                    <button class="px-3 py-2 rounded-xl border border-slate-300 bg-white hover:bg-slate-100 text-sm" id="ss_btnImportJSON">ƒ∞√ße aktar</button>
                </label>
                <button class="px-3 py-2 rounded-xl border border-slate-300 bg-white hover:bg-slate-100 text-sm" id="ss_btnExportJSON">Dƒ±≈üa aktar</button>
                <button class="px-3 py-2 rounded-xl border border-slate-300 bg-white hover:bg-slate-100 text-sm" id="ss_btnExportCSV">CSV</button>
                <button class="px-3 py-2 rounded-xl border border-slate-300 bg-white hover:bg-slate-100 text-sm" id="ss_btnExportLogCSV">Log CSV</button>
                <button class="px-3 py-2 rounded-xl bg-rose-600 text-white hover:bg-rose-700 text-sm admin-only" id="ss_btnClearAll">T√ºm Veriyi Sil</button>
            </div>
             <div id="stok-header-buttons" class="items-center gap-2">
                <button id="stok_btnAdd" class="px-3 py-2 rounded-xl btn-brand">√úr√ºn Ekle</button>
                <button id="stok_btnImport" class="px-3 py-2 rounded-xl border border-slate-300 bg-white">ƒ∞√ße Aktar</button>
                <button id="stok_btnExport" class="px-3 py-2 rounded-xl border border-slate-300 bg-white">Dƒ±≈üa Aktar</button>
                <button id="stok_btnExportCSV" class="px-3 py-2 rounded-xl border border-slate-300 bg-white">CSV</button>
                <button id="stok_btnExportLogCSV" class="px-3 py-2 rounded-xl border border-slate-300 bg-white">Log CSV</button>
                <button id="stok_btnClear" class="px-3 py-2 rounded-xl text-white bg-rose-600 admin-only">T√ºm Veriyi Sil</button>
            </div>
            <button id="logoutBtn" class="px-3 py-2 rounded-xl border border-slate-300 bg-white hover:bg-slate-100 text-sm">√áƒ±kƒ±≈ü</button>
        </div>
    </div>
</header>

<main class="max-w-screen-2xl mx-auto">
    <section id="app-siparis-servis" class="app-container siparis-servis-app"></section>
    <section id="app-stok-takip" class="app-container stok-takip-app hidden"></section>
</main>

<script>
// ===================================================================================
// ===                      ENTEGRE PLATFORM Y√ñNETƒ∞M SCRƒ∞PTƒ∞                       ===
// ===================================================================================
const mainTabSiparis = document.getElementById('mainTabSiparis');
const mainTabStok = document.getElementById('mainTabStok');
const appSiparisServis = document.getElementById('app-siparis-servis');
const appStokTakip = document.getElementById('app-stok-takip');
const allMainTabs = document.querySelectorAll('.main-tab');
const allAppContainers = document.querySelectorAll('.app-container');

function setActiveMainTab(tabName) {
    allAppContainers.forEach(app => app.classList.add('hidden'));
    allMainTabs.forEach(tab => tab.classList.remove('bg-white', 'shadow-md'));

    document.body.dataset.activeApp = tabName;

    if (tabName === 'siparis') {
        appSiparisServis.classList.remove('hidden');
        mainTabSiparis.classList.add('bg-white', 'shadow-md');
    } else if (tabName === 'stok') {
        appStokTakip.classList.remove('hidden');
        mainTabStok.classList.add('bg-white', 'shadow-md');
    }
}
mainTabSiparis.addEventListener('click', () => setActiveMainTab('siparis'));
mainTabStok.addEventListener('click', () => setActiveMainTab('stok'));

(function(){
  const USERS = {
    "hertz":   { pass: "hertz", role: "admin" },
    "muhasebe":{ pass: "2",     role: "user"  },
    "imalat1": { pass: "3",     role: "user"  },
    "imalat2": { pass: "4",     role: "user"  },
    "imalat3": { pass: "5",     role: "user"  },
    "imalat4": { pass: "6",     role: "user"  },
    "imalat5": { pass: "7",     role: "user"  },
    "imalat6": { pass: "8",     role: "user"  }
  };
  const KEY  = "auth_ok", UN = "auth_user", RL = "role";
  const gate = document.getElementById("authGate"), form = document.getElementById("authForm"), err  = document.getElementById("authErr");
  
  const siparisServisYetkili = ['hertz', 'muhasebe', 'imalat1', 'imalat2'];

  function applyRoleUI(){
    const role = sessionStorage.getItem(RL);
    const user = sessionStorage.getItem(UN);
    const isAdmin = (role === "admin");
    
    document.querySelectorAll('.admin-only').forEach(el => {
        el.style.display = isAdmin ? '' : 'none';
    });

    if (siparisServisYetkili.includes(user)) {
        mainTabSiparis.style.display = 'block';
        mainTabStok.style.display = 'block';
        setActiveMainTab('siparis');
    } else {
        mainTabSiparis.style.display = 'none';
        mainTabStok.style.display = 'block';
        setActiveMainTab('stok');
    }
  }
  
  function closeGate(){ 
      gate.style.display = "none"; 
      document.dispatchEvent(new Event("auth_ok")); 
  }
  
  if (sessionStorage.getItem(KEY) === "1") { 
    closeGate(); 
  } else { 
    gate.style.display = "grid"; 
  }
  
  form.addEventListener("submit", (e)=>{
    e.preventDefault();
    const u = (form.u.value || "").trim(), p = form.p.value || "", rec = USERS[u];
    if (rec && p === rec.pass){ 
      sessionStorage.setItem(KEY, "1"); 
      sessionStorage.setItem(UN, u); 
      sessionStorage.setItem(RL, rec.role); 
      closeGate(); 
    } 
    else { err.textContent = "Hatalƒ± kullanƒ±cƒ± adƒ±/≈üifre"; form.p.value = ""; }
  });
  
  document.getElementById("logoutBtn").addEventListener("click", ()=>{ 
    alert("√áƒ±kƒ±≈ü yapƒ±ldƒ±.");
    sessionStorage.clear(); 
    location.reload(); 
  });
  
  document.addEventListener("auth_ok", applyRoleUI);
  window.addEventListener("load", applyRoleUI);
})();

let platformAppsInitialized = false;
function initializePlatformApps() {
    if (platformAppsInitialized) return;
    initializeSiparisServisApp();
    initializeStokTakipApp();
    platformAppsInitialized = true;
}

document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('app-siparis-servis').innerHTML = SIPARIS_SERVIS_HTML;
    document.getElementById('app-stok-takip').innerHTML = STOK_TAKIP_HTML;
});
</script>

<script>
// ===================================================================================
// ===                     UYGULAMA HTML ƒ∞√áERƒ∞KLERƒ∞ VE SCRIPTLERƒ∞                    ===
// ===================================================================================

function ensureArray(data) {
    let arr;
    if (Array.isArray(data)) {
        arr = data;
    } else if (data && typeof data === 'object') {
        arr = Object.values(data);
    } else {
        return [];
    }
    return arr.filter(item => item && typeof item === 'object' && Object.keys(item).length > 0);
}

const SIPARIS_SERVIS_HTML = `
<div class="max-w-7xl mx-auto px-4 py-6">
    <div class="flex gap-2 mb-5 overflow-x-auto pb-2">
        <button class="tab-btn px-3 py-2 rounded-xl border bg-white hover:bg-slate-50 text-sm whitespace-nowrap" id="ss_tabSiparis">üì¶ Sipari≈üler</button>
        <button class="tab-btn px-3 py-2 rounded-xl border bg-white hover:bg-slate-50 text-sm whitespace-nowrap" id="ss_tabSevk">üöö Sevk Listesi</button>
        <button class="tab-btn px-3 py-2 rounded-xl border bg-white hover:bg-slate-50 text-sm whitespace-nowrap" id="ss_tabServis">üõ†Ô∏è Teknik Servis</button>
    </div>
    <div class="flex flex-wrap gap-2 mb-4" id="siparis-mobile-buttons">
        <label class="text-sm flex-1">
            <input accept="application/json" class="hidden" id="ss_fileInput_mobile" type="file">
            <button class="w-full px-3 py-2 rounded-xl border border-slate-300 bg-white hover:bg-slate-100 text-sm" id="ss_btnImportJSON_mobile">ƒ∞√ße aktar</button>
        </label>
        <button class="flex-1 px-3 py-2 rounded-xl border border-slate-300 bg-white hover:bg-slate-100 text-sm" id="ss_btnExportJSON_mobile">Dƒ±≈üa aktar</button>
        <button class="flex-1 px-3 py-2 rounded-xl border border-slate-300 bg-white hover:bg-slate-100 text-sm" id="ss_btnExportCSV_mobile">CSV</button>
        <button class="flex-1 px-3 py-2 rounded-xl border border-slate-300 bg-white hover:bg-slate-100 text-sm" id="ss_btnExportLogCSV_mobile">Log CSV</button>
        <button class="flex-1 px-3 py-2 rounded-xl bg-rose-600 text-white hover:bg-rose-700 text-sm admin-only" id="ss_btnClearAll_mobile">T√ºm Veriyi Sil</button>
    </div>
    <section id="ss_pageSiparis">
        <form class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-6 gap-4 mb-6 bg-white p-4 rounded-xl shadow" id="ss_orderForm">
            <input class="px-3 py-2 border rounded-xl col-span-1 sm:col-span-2 md:col-span-2" name="musteri" placeholder="M√º≈üteri" required>
            <input class="px-3 py-2 border rounded-xl col-span-1 sm:col-span-2 md:col-span-1" name="urun" placeholder="√úr√ºn" required>
            <input class="px-3 py-2 border rounded-xl col-span-1 sm:col-span-2 md:col-span-1" name="milKod" placeholder="Mil Kodu" required>
            <input class="px-3 py-2 border rounded-xl" name="kw" placeholder="kW" required step="any" type="number">
            <input class="px-3 py-2 border rounded-xl" name="rpm" placeholder="RPM" required type="number">
            <input class="px-3 py-2 border rounded-xl" name="volt" placeholder="Voltaj" required type="number">
            <input class="sevk-picker date-input px-3 py-2 border rounded-xl col-span-1 sm:col-span-2" id="ss_sevkTarihi" name="sevkTarihi" placeholder="gg/aa/yyyy" type="text">
            <button class="btn-brand px-4 py-2 rounded-xl col-span-1 sm:col-span-2 md:col-span-6">Ekle</button>
        </form>
        <div class="overflow-auto rounded-xl shadow mb-8">
            <table class="w-full text-sm bg-white responsive-table">
                <thead class="bg-slate-200 text-slate-600">
                    <tr>
                        <th class="sortable text-left px-3 py-2" data-sort-key="no" data-sort-type="string">No<span class="sort-indicator"></span></th>
                        <th class="sortable text-left px-3 py-2" data-sort-key="musteri" data-sort-type="string">M√º≈üteri<span class="sort-indicator"></span></th>
                        <th class="sortable text-left px-3 py-2" data-sort-key="urun" data-sort-type="string">√úr√ºn<span class="sort-indicator"></span></th>
                        <th class="sortable text-left px-3 py-2" data-sort-key="milKod" data-sort-type="string">Mil Kodu<span class="sort-indicator"></span></th>
                        <th class="sortable text-right px-3 py-2" data-sort-key="kw" data-sort-type="number">kW<span class="sort-indicator"></span></th>
                        <th class="sortable text-right px-3 py-2" data-sort-key="rpm" data-sort-type="number">RPM<span class="sort-indicator"></span></th>
                        <th class="sortable text-right px-3 py-2" data-sort-key="volt" data-sort-type="number">Voltaj<span class="sort-indicator"></span></th>
                        <th class="sortable text-left px-3 py-2" data-sort-key="sevkTarihi" data-sort-type="date">Sevk Tarihi<span class="sort-indicator"></span></th>
                        <th class="text-left px-3 py-2">A√ßƒ±klama</th>
                        <th class="text-center px-3 py-2">Hazƒ±r</th>
                        <th class="text-center px-3 py-2">Sevke Hazƒ±r</th>
                        <th class="text-left px-3 py-2">Durum</th>
                        <th class="text-left px-3 py-2">ƒ∞≈ülemler</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-slate-100 md:divide-y-0" id="ss_orderTable"></tbody>
            </table>
        </div>
        <div class="bg-white p-4 rounded-xl shadow">
            <h2 class="text-lg font-semibold mb-2">üìú Hareket Ge√ßmi≈üi</h2>
            <div class="overflow-auto max-h-64">
                <table class="w-full text-xs">
                    <thead class="bg-slate-100 text-slate-600">
                        <tr>
                            <th class="text-left px-2 py-1">Tarih</th>
                            <th class="text-left px-2 py-1">Sipari≈ü No</th>
                            <th class="text-left px-2 py-1">ƒ∞≈ülem</th>
                            <th class="text-left px-2 py-1">Kullanƒ±cƒ±</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-100" id="ss_logTable"></tbody>
                </table>
            </div>
        </div>
    </section>
    <section class="hidden" id="ss_pageSevk">
        <!-- √úst B√∂l√ºm: Sipari≈ü Sevk Listesi -->
        <div class="bg-white p-4 rounded-xl shadow mb-6">
            <h2 class="text-lg font-semibold mb-3 text-slate-700">Sipari≈ü Sevk Listesi</h2>
            <div class="grid grid-cols-1 md:grid-cols-6 gap-3 items-end mb-3">
                <div class="md:col-span-2"><label class="text-xs text-slate-500 block mb-1">Metne g√∂re ara</label><input class="px-3 py-2 border rounded-xl w-full" id="ss_sevkSearch" placeholder="M√º≈üteri, √ºr√ºn, No..."></div>
                <div><label class="text-xs text-slate-500 block mb-1">Ba≈ülangƒ±√ß (tarih)</label><input class="date-input px-3 py-2 border rounded-xl w-full" id="ss_sevkDateFrom" placeholder="gg/aa/yyyy" type="text"></div>
                <div><label class="text-xs text-slate-500 block mb-1">Biti≈ü (tarih)</label><input class="date-input px-3 py-2 border rounded-xl w-full" id="ss_sevkDateTo" placeholder="gg/aa/yyyy" type="text"></div>
                <div class="flex gap-2 flex-wrap"><button class="px-3 py-2 rounded-xl border bg-slate-50 hover:bg-slate-100 text-sm" id="ss_btnSevkFilter">Filtrele</button><button class="px-3 py-2 rounded-xl border bg-slate-50 hover:bg-slate-100 text-sm" id="ss_btnSevkClearFilter">Temizle</button></div>
                <div class="md:ml-auto flex gap-2 flex-wrap justify-start md:justify-end md:col-span-1"><button class="px-3 py-2 rounded-xl border bg-slate-50 hover:bg-slate-100 text-sm" id="ss_btnSevkCSV">CSV</button><button class="px-3 py-2 rounded-xl bg-rose-600 text-white hover:bg-rose-700 text-sm admin-only" id="ss_btnSevkClearAll">T√ºm Sevkleri Sil</button></div>
            </div>
            <div class="overflow-auto">
                <table class="w-full text-sm responsive-table">
                    <thead class="bg-slate-100 text-slate-600">
                        <tr>
                            <th class="sortable text-left px-3 py-2" data-sort-key="no" data-sort-type="string">No<span class="sort-indicator"></span></th>
                            <th class="sortable text-left px-3 py-2" data-sort-key="musteri" data-sort-type="string">M√º≈üteri<span class="sort-indicator"></span></th>
                            <th class="sortable text-left px-3 py-2" data-sort-key="urun" data-sort-type="string">√úr√ºn<span class="sort-indicator"></span></th>
                            <th class="sortable text-left px-3 py-2" data-sort-key="milKod" data-sort-type="string">Mil Kodu<span class="sort-indicator"></span></th>
                            <th class="sortable text-right px-3 py-2" data-sort-key="kw" data-sort-type="number">kW<span class="sort-indicator"></span></th>
                            <th class="sortable text-right px-3 py-2" data-sort-key="rpm" data-sort-type="number">RPM<span class="sort-indicator"></span></th>
                            <th class="sortable text-right px-3 py-2" data-sort-key="volt" data-sort-type="number">Voltaj<span class="sort-indicator"></span></th>
                            <th class="sortable text-left px-3 py-2" data-sort-key="sevkTarihi" data-sort-type="date">Sevk Tarihi<span class="sort-indicator"></span></th>
                            <th class="sortable text-left px-3 py-2" data-sort-key="sevkEdildi" data-sort-type="date">Sevk Edildi<span class="sort-indicator"></span></th>
                            <th class="sortable text-left px-3 py-2" data-sort-key="kullanici" data-sort-type="string">Kullanƒ±cƒ±<span class="sort-indicator"></span></th>
                            <th class="text-left px-3 py-2">ƒ∞≈ülem</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-100 md:divide-y-0" id="ss_sevkTable"></tbody>
                </table>
            </div>
        </div>

        <!-- Alt B√∂l√ºm: Teknik Servis Sevk Listesi -->
        <div class="bg-white p-4 rounded-xl shadow">
            <h2 class="text-lg font-semibold mb-3 text-slate-700">Teknik Servis Sevk Listesi</h2>
            <div class="grid grid-cols-1 md:grid-cols-6 gap-3 items-end mb-3">
                <div class="md:col-span-2"><label class="text-xs text-slate-500 block mb-1">Metne g√∂re ara</label><input class="px-3 py-2 border rounded-xl w-full" id="ss_teknikSevkSearch" placeholder="Firma, √ºr√ºn, No..."></div>
                <div><label class="text-xs text-slate-500 block mb-1">Ba≈ülangƒ±√ß (tarih)</label><input class="date-input px-3 py-2 border rounded-xl w-full" id="ss_teknikSevkDateFrom" placeholder="gg/aa/yyyy" type="text"></div>
                <div><label class="text-xs text-slate-500 block mb-1">Biti≈ü (tarih)</label><input class="date-input px-3 py-2 border rounded-xl w-full" id="ss_teknikSevkDateTo" placeholder="gg/aa/yyyy" type="text"></div>
                <div class="flex gap-2 flex-wrap"><button class="px-3 py-2 rounded-xl border bg-slate-50 hover:bg-slate-100 text-sm" id="ss_btnTeknikSevkFilter">Filtrele</button><button class="px-3 py-2 rounded-xl border bg-slate-50 hover:bg-slate-100 text-sm" id="ss_btnTeknikSevkClearFilter">Temizle</button></div>
                <div class="md:ml-auto flex gap-2 flex-wrap justify-start md:justify-end md:col-span-1"><button class="px-3 py-2 rounded-xl border bg-slate-50 hover:bg-slate-100 text-sm" id="ss_btnTeknikSevkCSV">CSV</button><button class="px-3 py-2 rounded-xl bg-rose-600 text-white hover:bg-rose-700 text-sm admin-only" id="ss_btnTeknikSevkClearAll">T√ºm√ºn√º Sil</button></div>
            </div>
            <div class="overflow-auto">
                <table class="w-full text-sm responsive-table">
                    <thead class="bg-slate-100 text-slate-600">
                        <tr>
                            <th class="sortable text-left px-3 py-2" data-sort-key="no" data-sort-type="string">No<span class="sort-indicator"></span></th>
                            <th class="sortable text-left px-3 py-2" data-sort-key="firma" data-sort-type="string">Firma<span class="sort-indicator"></span></th>
                            <th class="sortable text-left px-3 py-2" data-sort-key="urun" data-sort-type="string">√úr√ºn<span class="sort-indicator"></span></th>
                            <th class="sortable text-left px-3 py-2" data-sort-key="milTipi" data-sort-type="string">Mil Tipi<span class="sort-indicator"></span></th>
                            <th class="sortable text-left px-3 py-2" data-sort-key="ariza" data-sort-type="string">Arƒ±za<span class="sort-indicator"></span></th>
                            <th class="sortable text-left px-3 py-2" data-sort-key="sevkEdildi" data-sort-type="date">Sevk Edildi<span class="sort-indicator"></span></th>
                            <th class="sortable text-left px-3 py-2" data-sort-key="kullanici" data-sort-type="string">Kullanƒ±cƒ±<span class="sort-indicator"></span></th>
                            <th class="text-left px-3 py-2">ƒ∞≈ülem</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-100 md:divide-y-0" id="ss_teknikServisSevkTable"></tbody>
                </table>
            </div>
        </div>
    </section>
    <section class="hidden" id="ss_pageServis">
        <form class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-8 gap-4 mb-6 bg-white p-4 rounded-xl shadow" id="ss_servisForm">
            <input class="px-3 py-2 border rounded-xl col-span-1 sm:col-span-2" name="firma" placeholder="Firma Adƒ±" required>
            <input class="px-3 py-2 border rounded-xl col-span-1 sm:col-span-2" name="urun" placeholder="√úr√ºn" required>
            <input class="px-3 py-2 border rounded-xl" min="1" name="adet" placeholder="Adet" step="1" type="number">
            <input class="px-3 py-2 border rounded-xl col-span-1 sm:col-span-2" name="ariza" placeholder="Arƒ±za">
            <input class="px-3 py-2 border rounded-xl" name="milTipi" placeholder="Mil Tipi">
            <input class="px-3 py-2 border rounded-xl" name="not" placeholder="Not">
            <input class="px-3 py-2 border rounded-xl" name="iletisim" placeholder="ƒ∞leti≈üim">
            <input class="px-3 py-2 border rounded-xl" name="kargoTipi" placeholder="Kargo Tipi">
            <input class="px-3 py-2 border rounded-xl col-span-1 sm:col-span-2" name="aciklama" placeholder="A√ßƒ±klama">
            <div class="col-span-1 sm:col-span-2 md:col-span-8 flex gap-2"><button class="btn-brand px-4 py-2 rounded-xl flex-grow" id="ss_servisFormSubmitButton">Servis Kaydƒ± Ekle</button><button class="hidden px-4 py-2 rounded-xl border bg-white hover:bg-slate-50" id="ss_servisFormCancelButton" type="button">ƒ∞ptal Et</button></div>
        </form>
        <div class="bg-white p-4 rounded-xl shadow mb-3 flex flex-wrap gap-2 items-center"><input class="px-3 py-2 border rounded-xl w-full md:w-auto flex-grow md:flex-grow-0" id="ss_servisSearch" placeholder="Ara: firma, √ºr√ºn, arƒ±za, not..."><button class="px-3 py-2 rounded-xl border bg-white hover:bg-slate-50 text-sm" id="ss_btnServisCSV">CSV</button><button class="px-3 py-2 rounded-xl bg-rose-600 text-white hover:bg-rose-700 text-sm admin-only" id="ss_btnServisClearAll">T√ºm Servis Kayƒ±tlarƒ±nƒ± Sil</button></div>
        <div class="overflow-auto rounded-xl shadow">
            <table class="w-full text-sm bg-white responsive-table">
                <thead class="bg-slate-200 text-slate-600">
                    <tr>
                        <th class="sortable text-left px-3 py-2" data-sort-key="no" data-sort-type="string">No<span class="sort-indicator"></span></th>
                        <th class="sortable text-left px-3 py-2" data-sort-key="firma" data-sort-type="string">Firma<span class="sort-indicator"></span></th>
                        <th class="sortable text-left px-3 py-2" data-sort-key="urun" data-sort-type="string">√úr√ºn<span class="sort-indicator"></span></th>
                        <th class="sortable text-right px-3 py-2" data-sort-key="adet" data-sort-type="number">Adet<span class="sort-indicator"></span></th>
                        <th class="sortable text-left px-3 py-2" data-sort-key="ariza" data-sort-type="string">Arƒ±za<span class="sort-indicator"></span></th>
                        <th class="sortable text-left px-3 py-2" data-sort-key="milTipi" data-sort-type="string">Mil Tipi<span class="sort-indicator"></span></th>
                        <th class="sortable text-left px-3 py-2" data-sort-key="durum" data-sort-type="string">Durum<span class="sort-indicator"></span></th>
                        <th class="text-left px-3 py-2">Not</th>
                        <th class="text-left px-3 py-2">ƒ∞leti≈üim</th>
                        <th class="text-left px-3 py-2">Kargo Tipi</th>
                        <th class="sortable text-left px-3 py-2" data-sort-key="sevkTarihi" data-sort-type="date">Sevk Tarihi<span class="sort-indicator"></span></th>
                        <th class="text-left px-3 py-2">A√ßƒ±klama</th>
                        <th class="text-left px-3 py-2">ƒ∞≈ülem</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-slate-100 md:divide-y-0" id="ss_servisTable"></tbody>
            </table>
        </div>
    </section>
</div>
`;

const STOK_TAKIP_HTML = `
<div class="mx-auto max-w-7xl p-3 md:p-4">
     <div class="p-4 mb-4 bg-white border border-slate-200 rounded-2xl shadow-sm">
        <h3 class="text-base font-semibold text-slate-700 mb-3">G√∂sterge Paneli</h3>
        <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 text-center">
            <div>
                <div class="text-2xl font-bold text-slate-800" id="stok_totalProducts">0</div>
                <div class="text-xs text-slate-500">Toplam √úr√ºn</div>
            </div>
            <div>
                <div class="text-2xl font-bold text-amber-600" id="stok_criticalProducts">0</div>
                <div class="text-xs text-slate-500">Kritik Seviyedeki √úr√ºn</div>
            </div>
        </div>
    </div>
     <header class="grid grid-cols-1 md:grid-cols-2 gap-3 items-center mb-2 p-4 bg-white border border-slate-200 rounded-2xl shadow-sm">
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
            <input id="stok_search" type="search" placeholder="Ara: ad, kod, not..." class="w-full px-3 py-2 rounded-xl border border-slate-300 bg-white" />
            <label class="flex items-center gap-2 text-sm text-slate-600">
                <input id="stok_onlyLow" type="checkbox" class="w-4 h-4 rounded"> Sadece kritik stok
            </label>
        </div>
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
             <select id="stok_filterKind" class="w-full px-3 py-2 rounded-xl border border-slate-300 bg-white text-sm">
                <option value="">T√ºm T√ºrler</option>
                <option value="mamul">Mamul</option>
                <option value="yari">Yarƒ±-mamul</option>
                <option value="ham">Hammadde</option>
            </select>
            <select id="stok_filterCategory" class="w-full px-3 py-2 rounded-xl border border-slate-300 bg-white text-sm">
                <option value="">T√ºm √áe≈üitler</option>
            </select>
            <button id="stok_btnClearFilters" class="px-3 py-2 rounded-xl border border-slate-300 bg-slate-50 text-sm">Filtreleri Temizle</button>
        </div>
    </header>
    <p class="text-xs text-slate-500 text-center md:text-left mb-2 px-1">
        ƒ∞pucu: Geli≈ümi≈ü arama i√ßin <strong>kod:</strong>, <strong>ad:</strong>, <strong>not:</strong> veya √ße≈üit adƒ± (<strong>rulman:</strong>) gibi anahtar kelimeler kullanƒ±n.
    </p>
     <div class="flex flex-wrap gap-2 mb-4" id="stok-mobile-buttons">
        <button id="stok_btnAdd_mobile" class="flex-1 px-3 py-2 rounded-xl btn-brand">√úr√ºn Ekle</button>
        <button id="stok_btnImport_mobile" class="flex-1 px-3 py-2 rounded-xl border border-slate-300 bg-white">ƒ∞√ße Aktar</button>
        <button id="stok_btnExport_mobile" class="flex-1 px-3 py-2 rounded-xl border border-slate-300 bg-white">Dƒ±≈üa aktar</button>
        <button id="stok_btnExportCSV_mobile" class="flex-1 px-3 py-2 rounded-xl border border-slate-300 bg-white">CSV</button>
        <button id="stok_btnExportLogCSV_mobile" class="flex-1 px-3 py-2 rounded-xl border border-slate-300 bg-white">Log CSV</button>
        <button id="stok_btnClear_mobile" class="flex-1 px-3 py-2 rounded-xl text-white bg-rose-600 admin-only">T√ºm Veriyi Sil</button>
    </div>
    <div class="text-sm text-slate-500 mb-2">Toplam <span id="stok_count" class="font-bold">0</span> kayƒ±t listeleniyor.</div>
    <div class="hidden md:block overflow-auto rounded-2xl border border-slate-200 bg-white">
      <table class="min-w-full text-sm">
        <thead id="stok_thead" class="bg-slate-100 text-slate-700">
          <tr>
            <th data-sort="sku" class="text-left px-3 py-2 cursor-pointer select-none">Stok Kodu</th>
            <th data-sort="name" class="text-left px-3 py-2 cursor-pointer select-none">Ad</th>
            <th class="text-left px-3 py-2">T√ºr/√áe≈üit</th>
            <th data-sort="qty" class="text-right px-3 py-2 cursor-pointer select-none">Stok</th>
            <th data-sort="min" class="text-right px-3 py-2 cursor-pointer select-none">Minimum</th>
            <th class="text-left px-3 py-2">√ñzellikler</th>
            <th class="text-left px-3 py-2">Not</th>
            <th class="text-right px-3 py-2">ƒ∞≈ülemler</th>
          </tr>
        </thead>
        <tbody id="stok_tbodyDesktop" class="divide-y divide-slate-100"></tbody>
      </table>
    </div>
    <div id="stok_listMobile" class="md:hidden space-y-2"></div>
    <details class="mt-5 group">
      <summary class="cursor-pointer select-none text-sm text-slate-600 flex items-center gap-2">
        <span class="inline-block w-2 h-2 rounded-full" style="background: rgb(var(--brand))"></span>
        Hareket Ge√ßmi≈üi
      </summary>
      <div class="mt-3 overflow-auto rounded-2xl border border-slate-200 bg-white max-h-[50vh] no-scrollbar">
        <table class="min-w-full text-sm">
          <thead class="bg-slate-100 text-slate-700">
            <tr>
              <th class="text-left px-3 py-2">Tarih</th><th class="text-left px-3 py-2">√úr√ºn</th><th class="text-left px-3 py-2">T√ºr</th>
              <th class="text-right px-3 py-2">Miktar</th><th class="text-right px-3 py-2">√ñnce</th><th class="text-right px-3 py-2">Sonra</th>
              <th class="text-left px-3 py-2">Not</th><th class="text-left px-3 py-2">Kullanƒ±cƒ±</th>
            </tr>
          </thead>
          <tbody id="stok_logBody" class="divide-y divide-slate-100"></tbody>
        </table>
      </div>
    </details>
  </div>
  <dialog id="stok_productDialog" class="rounded-2xl p-0 w-[96vw] max-w-xl">
    <form id="stok_productForm" class="p-4" novalidate>
      <h3 id="stok_productDialogTitle" class="text-lg font-semibold mb-4">√úr√ºn Ekle</h3>
      <div class="grid md:grid-cols-2 gap-3">
        <div><label class="text-sm text-slate-600">√úr√ºn T√ºr√º</label><select name="kind" id="stok_kind" class="w-full px-3 py-2 rounded-xl border border-slate-300"><option value="mamul">Mamul</option><option value="yari">Yarƒ±-mamul</option><option value="ham">Hammadde</option></select></div>
        <div><label class="text-sm text-slate-600">√úr√ºn √áe≈üidi</label><select name="category" id="stok_category" class="w-full px-3 py-2 rounded-xl border border-slate-300"><option value="stator">Stator</option><option value="rotor">Rotor</option><option value="mil">Mil</option><option value="rotorluMil">Rotorlu Mil</option><option value="taslanmisMil">Ta≈ülanmƒ±≈ü Mil</option><option value="sargiliPaket">Sargƒ±lƒ± Paket</option><option value="paketliGovde">Paketli G√∂vde</option><option value="motor">Motor</option><option value="bakir_tel">Bakƒ±r Tel</option><option value="yardimci_parcalar">Yardƒ±mcƒ± Par√ßalar</option><option value="aluminyum_govde">Al√ºminyum G√∂vde</option><option value="rulman">Rulman</option><option value="kapak">Kapak</option><option value="islenmisKapak">ƒ∞≈ülenmi≈ü Kapak</option><option value="taslanmisKapak">Ta≈ülanmƒ±≈ü Kapak</option></select></div>
        <div class="md:col-span-2"><label class="text-sm text-slate-600">Ad</label><input name="name" type="text" required class="w-full px-3 py-2 rounded-xl border border-slate-300"></div>
        <div><label class="text-sm text-slate-600">Stok Kodu</label><div class="flex gap-2"><input name="sku" id="stok_sku" type="text" required class="w-full px-3 py-2 rounded-xl border border-slate-300"><button id="stok_btnAutoSku" type="button" class="px-3 py-2 rounded-xl border border-slate-300">Olu≈ütur</button></div><p class="text-xs text-slate-500 mt-1">√úr√ºn √ße≈üidine g√∂re otomatik kod √∂nerilir. Dilersen d√ºzenleyebilirsin.</p></div>
        <div><label class="text-sm text-slate-600">Birim</label><input name="unit" type="text" placeholder="adet, kg, m‚Ä¶" class="w-full px-3 py-2 rounded-xl border border-slate-300"></div>
        <div><label class="text-sm text-slate-600">Minimum Stok</label><input name="min" type="number" step="any" value="0" class="w-full px-3 py-2 rounded-xl border border-slate-300"></div>
        <div class="md:col-span-2"><label class="text-sm text-slate-600">Not</label><input name="note" type="text" class="w-full px-3 py-2 rounded-xl border border-slate-300"></div>
        <div data-section="sargiliPaket" class="md:col-span-2 hidden"><div class="grid md:grid-cols-3 gap-3"><div><label class="text-sm text-slate-600">kW</label><input name="kw" type="number" step="any" class="w-full px-3 py-2 rounded-xl border border-slate-300"></div><div><label class="text-sm text-slate-600">Devir (rpm)</label><input name="rpm" type="number" step="1" class="w-full px-3 py-2 rounded-xl border border-slate-300"></div><div><label class="text-sm text-slate-600">Voltaj (V)</label><input name="volt" type="number" step="1" class="w-full px-3 py-2 rounded-xl border border-slate-300"></div></div></div>
        <div data-section="paketliGovde" class="md:col-span-2 hidden"><div class="grid md:grid-cols-3 gap-3"><div><label class="text-sm text-slate-600">Devir (rpm)</label><input name="pg_rpm" type="number" step="1" class="w-full px-3 py-2 rounded-xl border border-slate-300"></div><div><label class="text-sm text-slate-600">kW</label><input name="pg_kw" type="number" step="any" class="w-full px-3 py-2 rounded-xl border border-slate-300"></div><div><label class="text-sm text-slate-600">Voltaj (V)</label><input name="pg_volt" type="number" step="1" class="w-full px-3 py-2 rounded-xl border border-slate-300"></div></div><div class="grid md:grid-cols-2 gap-3 mt-3"><div><label class="text-sm text-slate-600">M√º≈üteri</label><input name="pg_customer" type="text" class="w-full px-3 py-2 rounded-xl border border-slate-300"></div><div><label class="text-sm text-slate-600">Baƒülantƒ± Tipi</label><select name="pg_conn" class="w-full px-3 py-2 rounded-xl border border-slate-300"><option value="soketli">Soketli</option><option value="duz">D√ºz klemensli</option><option value="ters">Ters klemensli</option><option value="ykr">YKR</option><option value="ykl">YKL</option></select></div></div></div>
        <div data-section="mil" class="md:col-span-2 hidden"><label class="text-sm text-slate-600">Mil Kodu</label><input name="milCode" type="text" class="w-full px-3 py-2 rounded-xl border border-slate-300"></div>
        <div data-section="motor" class="md:col-span-2 hidden"><div class="grid md:grid-cols-3 gap-3"><div><label class="text-sm text-slate-600">M√º≈üteri</label><input name="customer" type="text" class="w-full px-3 py-2 rounded-xl border border-slate-300"></div><div><label class="text-sm text-slate-600">Devir (rpm)</label><input name="m_rpm" type="number" step="1" class="w-full px-3 py-2 rounded-xl border border-slate-300"></div><div><label class="text-sm text-slate-600">kW</label><input name="m_kw" type="number" step="any" class="w-full px-3 py-2 rounded-xl border border-slate-300"></div><div><label class="text-sm text-slate-600">Voltaj (V)</label><input name="m_volt" type="number" step="1" class="w-full px-3 py-2 rounded-xl border border-slate-300"></div><div><label class="text-sm text-slate-600">Baƒülantƒ± Tipi</label><select name="m_conn" class="w-full px-3 py-2 rounded-xl border border-slate-300"><option value="soketli">Soketli</option><option value="duz">D√ºz klemensli</option><option value="ters">Ters klemensli</option><option value="ykr">YKR</option><option value="ykl">YKL</option></select></div><div><label class="text-sm text-slate-600">Mil Tipi</label><input name="milType" type="text" placeholder="√ñrn: DIN 6885" class="w-full px-3 py-2 rounded-xl border border-slate-300"></div><div><label class="text-sm text-slate-600">Kapak √áe≈üidi</label><select name="m_cover" class="w-full px-3 py-2 rounded-xl border border-slate-300"><option value="AK">AK</option><option value="CK">CK</option><option value="CK/CR">CK/CR</option></select></div></div></div>
      </div>
      <div class="mt-5 flex justify-end gap-2"><button id="stok_productCancelBtn" type="button" class="px-3 py-2 rounded-xl border border-slate-300 bg-white">Vazge√ß</button><button id="stok_productSaveBtn" type="submit" class="px-3 py-2 rounded-xl btn-brand">Kaydet</button></div>
      <input type="hidden" name="id">
    </form>
  </dialog>
  <dialog id="stok_moveDialog" class="rounded-2xl p-0 w-[96vw] max-w-md">
    <form id="stok_moveForm" class="p-4" novalidate>
      <h3 class="text-lg font-semibold mb-4">Stok Hareketi</h3>
      <div class="space-y-3">
        <div class="text-sm">√úr√ºn: <span id="stok_moveProductName" class="font-medium"></span></div>
        <div class="grid grid-cols-2 gap-3"><label class="flex items-center gap-2"><input type="radio" name="type" value="in" checked> <span>Giri≈ü</span></label><label class="flex items-center gap-2"><input type="radio" name="type" value="out"> <span>√áƒ±kƒ±≈ü</span></label></div>
        <div><label class="text-sm">Miktar</label><input name="amount" type="number" step="any" required class="w-full px-3 py-2 rounded-xl border border-slate-300"></div>
        <div><label class="text-sm">Not (isteƒüe baƒülƒ±)</label><input name="note" type="text" class="w-full px-3 py-2 rounded-xl border border-slate-300"></div>
      </div>
      <div class="mt-5 flex justify-end gap-2"><button id="stok_moveCancelBtn" type="button" class="px-3 py-2 rounded-xl border border-slate-300 bg-white">Vazge√ß</button><button id="stok_moveApplyBtn" type="submit" class="px-3 py-2 rounded-xl btn-brand">Uygula</button></div>
      <input type="hidden" name="id">
    </form>
  </dialog>
  <input id="stok_fileInput" type="file" accept="application/json" class="hidden">
`;

function initializeSiparisServisApp() {
    const appContainer = document.getElementById('app-siparis-servis');
    if (!appContainer.innerHTML.trim()) return; 

    const $ = (selector) => document.querySelector(selector);
    const $$ = (selector) => Array.from(appContainer.querySelectorAll(selector));
    
    let currentTab = "siparis";
    let siparisSort = { key: 'no', direction: 'desc' };
    let sevkSort = { key: 'sevkEdildi', direction: 'desc' };
    let servisSort = { key: 'no', direction: 'desc' };
    let teknikServisSevkSort = { key: 'sevkEdildi', direction: 'desc' };

    const allPages = $$("section[id^='ss_page']");
    const allTabs = $$(".tab-btn");
    const table = appContainer.querySelector('#ss_orderTable');
    const form = appContainer.querySelector('#ss_orderForm');
    const logTable = appContainer.querySelector('#ss_logTable');
    const fileInput = $('#ss_fileInput');
    const fileInputMobile = $('#ss_fileInput_mobile');
    const sevkTable = appContainer.querySelector('#ss_sevkTable');
    const teknikServisSevkTable = appContainer.querySelector('#ss_teknikServisSevkTable');
    const searchInput = appContainer.querySelector('#ss_sevkSearch');
    const dateFromInput = appContainer.querySelector('#ss_sevkDateFrom');
    const dateToInput = appContainer.querySelector('#ss_sevkDateTo');
    const servisForm = appContainer.querySelector('#ss_servisForm');
    const servisSearch = appContainer.querySelector('#ss_servisSearch');
    const servisTable = appContainer.querySelector('#ss_servisTable');
    const teknikSevkSearch = appContainer.querySelector('#ss_teknikSevkSearch');
    const teknikSevkDateFrom = appContainer.querySelector('#ss_teknikSevkDateFrom');
    const teknikSevkDateTo = appContainer.querySelector('#ss_teknikSevkDateTo');
    
    let orders, logs, sevkEdilenler, servisKayitlari, servisSevkEdilenler;

    function loadDataFromStorage() {
        orders = window.dataStore['siparisler'] || [];
        logs = window.dataStore['siparisLog'] || [];
        sevkEdilenler = window.dataStore['sevkEdilenler'] || [];
        servisKayitlari = window.dataStore['servisKayitlari'] || [];
        servisSevkEdilenler = window.dataStore['servisSevkEdilenler'] || [];
    }

    function formatDate_TR(input) {
      if (!input) return "";
      const dt = (input instanceof Date) ? input : parseAnyDate(input);
      if (!dt) return "";
      const d = String(dt.getDate()).padStart(2,"0");
      const m = String(dt.getMonth()+1).padStart(2,"0");
      const y = dt.getFullYear();
      return `${d}/${m}/${y}`;
    }

    function parseDdMmYyyy(str){
      const m = String(str || "").match(/^(\d{1,2})[./-](\d{1,2})[./-](\d{4})$/);
      if (!m) return null;
      const d = parseInt(m[1],10), mo = parseInt(m[2],10)-1, y = parseInt(m[3],10);
      const dt = new Date(y, mo, d);
      return isNaN(dt.getTime()) ? null : dt;
    }

    function parseAnyDate(input) {
        if (input instanceof Date) return input;
        if (typeof input !== 'string') return null;
        let dt = parseDdMmYyyy(input.split(' ')[0]); 
        if (dt) return dt;
        const isoMatch = input.match(/^(\d{4})-(\d{2})-(\d{2})/);
        if (isoMatch) {
            dt = new Date(isoMatch[1], parseInt(isoMatch[2], 10) - 1, isoMatch[3]);
            if (!isNaN(dt.getTime())) return dt;
        }
        dt = new Date(input);
        return isNaN(dt.getTime()) ? null : dt;
    }

    function atLocalMidnight(dt){ return new Date(dt.getFullYear(), dt.getMonth(), dt.getDate()); }
    function todayLocal(){ const n = new Date(); return new Date(n.getFullYear(), n.getMonth(), n.getDate()); }
    function formatDateTime_TR(input) {
      const dt = (input instanceof Date) ? input : new Date(input);
      const d = String(dt.getDate()).padStart(2,"0");
      const m = String(dt.getMonth()+1).padStart(2,"0");
      const y = dt.getFullYear();
      const hh = String(dt.getHours()).padStart(2,"0");
      const mm = String(dt.getMinutes()).padStart(2,"0");
      return `${d}/${m}/${y} ${hh}:${mm}`;
    }

    function getFPBaseOptions(){ return { dateFormat: "d/m/Y", altInput: true, altFormat: "j F Y", allowInput: true, locale: flatpickr.l10ns.tr }; }
    
    const Y_LIGHT = "#fef9c3", Y_FULL  = "#fcd34d", R_FULL  = "#ef4444", B_ROW   = "#bfdbfe";
    function hexToRgb(hex){ const h=hex.replace('#',''); const n=parseInt(h,16); return {r:(n>>16)&255,g:(n>>8)&255,b:n&255}; }
    function mixHex(c1,c2,t){ const a=hexToRgb(c1),b=hexToRgb(c2); const r=Math.round(a.r+(b.r-a.r)*t); const g=Math.round(a.g+(b.g-a.g)*t); const b2=Math.round(a.b+(b.b-a.b)*t); return `rgb(${r}, ${g}, ${b2})`; }

    function getRowBgByDue(sevkStr, isHazir){
      const due = parseAnyDate(sevkStr);
      if (!due) return null;
      const today = todayLocal();
      const dayMs = 86400000;
      const diff = (atLocalMidnight(due) - today) / dayMs;

      if (diff < 0) { // Termin tarihi ge√ßmi≈ü
        return isHazir ? Y_FULL : R_FULL;
      }

      if (diff <= 3){ // Termine 3 g√ºn veya daha az kalmƒ±≈ü
        const t = (3 - diff) / 3; 
        return mixHex(Y_LIGHT, Y_FULL, t); 
      }
      
      return null; // Diƒüer durumlar i√ßin √∂zel renk yok
    }
    
    function getNextSiparisNo() {
        const now = new Date();
        const yy = String(now.getFullYear()).slice(-2);
        const mm = String(now.getMonth() + 1).padStart(2, '0');
        const prefix = `ORD-${yy}${mm}`;
        const all = [...orders, ...sevkEdilenler];
        let maxSeq = 0;
        for (const it of all) {
            if (it && it.no && String(it.no).startsWith(prefix)) {
            const n = parseInt(String(it.no).slice(prefix.length), 10);
            if (!isNaN(n) && n > maxSeq) maxSeq = n;
            }
        }
        return `${prefix}${String(maxSeq + 1).padStart(4, '0')}`;
    }

    function getNextServisNo() {
        const now = new Date();
        const yy = String(now.getFullYear()).slice(-2);
        const mm = String(now.getMonth() + 1).padStart(2, '0');
        const prefix = `TS-${yy}${mm}`;
        const all = [...servisKayitlari, ...servisSevkEdilenler];
        let maxSeq = 0;
        for (const it of all) {
            if (it && it.no && String(it.no).startsWith(prefix)) {
            const n = parseInt(String(it.no).slice(prefix.length), 10);
            if (!isNaN(n) && n > maxSeq) maxSeq = n;
            }
        }
        return `${prefix}${String(maxSeq + 1).padStart(4, '0')}`;
    }

    function logAction(no, islem) {
      logs.unshift({ no, islem, user: sessionStorage.getItem("auth_user") || "(anonim)", tarih: formatDateTime_TR(new Date()) });
      window.dataStore['siparisLog'] = logs;
      window.pushData('siparisLog');
      renderLogs();
    }
    
    let lastPaintDay = todayLocal().toDateString();
    function scheduleMidnightRefresh(){
      const now = new Date();
      const next = new Date(now.getFullYear(), now.getMonth(), now.getDate()+1, 0, 0, 1);
      setTimeout(()=>{
        checkDayAndRefresh();
        scheduleMidnightRefresh();
      }, next - now);
    }
    function checkDayAndRefresh(){
      const todayStr = todayLocal().toDateString();
      if (todayStr !== lastPaintDay){
        renderAllTables();
        lastPaintDay = todayStr;
      }
    }
    
    function setTab(tabId){
      currentTab = tabId;
      const pageMap = {
          siparis: '#ss_pageSiparis', sevk: '#ss_pageSevk', servis: '#ss_pageServis'
      };
      const tabMap = {
          siparis: '#ss_tabSiparis', sevk: '#ss_tabSevk', servis: '#ss_tabServis'
      };

      allPages.forEach(p => p.classList.add("hidden"));
      allTabs.forEach(t => t.classList.remove("font-medium", "bg-slate-100"));
      
      const pageToShow = appContainer.querySelector(pageMap[tabId]);
      const tabToActivate = appContainer.querySelector(tabMap[tabId]);
      
      if(pageToShow) pageToShow.classList.remove("hidden");
      if(tabToActivate) tabToActivate.classList.add("font-medium", "bg-slate-100");

      if (tabId === 'sevk') {
        renderSevkList();
        renderTeknikServisSevkList();
      }
      if (tabId === 'servis') renderServisList();
    }

    allTabs.forEach(tab => {
        const tabId = tab.id.replace('ss_tab', '').toLowerCase();
        tab.addEventListener("click", () => setTab(tabId));
    });

    function markServisAsSevk(index){
      const user = sessionStorage.getItem("auth_user") || "(bilinmiyor)";
      servisSevkEdilenler.push({ ...servisKayitlari[index], sevkEdildi: formatDateTime_TR(new Date()), kullanici: user });
      window.dataStore['servisSevkEdilenler'] = servisSevkEdilenler;
      window.pushData('servisSevkEdilenler');
      
      logAction(servisKayitlari[index].no || "(servis)", "Servis kaydƒ± sevk edildi");
      servisKayitlari.splice(index, 1);
      window.dataStore['servisKayitlari'] = servisKayitlari;
      window.pushData('servisKayitlari');

      renderServisList();
      if (currentTab === "sevk") renderTeknikServisSevkList();
    }
    
    function geriAlServisSevk(no){
      const idx = servisSevkEdilenler.findIndex(x => x.no === no);
      if (idx === -1) return;
      const [rec] = servisSevkEdilenler.splice(idx, 1);
      delete rec.sevkEdildi;
      delete rec.kullanici;
      servisKayitlari.push(rec);
      window.dataStore['servisSevkEdilenler'] = servisSevkEdilenler;
      window.pushData('servisSevkEdilenler');
      window.dataStore['servisKayitlari'] = servisKayitlari;
      window.pushData('servisKayitlari');
      logAction(rec.no || "(servis)", "Servis sevk geri alƒ±ndƒ±");
      renderServisList();
      if (currentTab === "sevk") renderTeknikServisSevkList();
    }

    function renderLogs() {
      logTable.innerHTML = "";
      logs.slice(0, 100).forEach(log => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="px-2 py-1">${log.tarih}</td>
          <td class="px-2 py-1 font-medium">${log.no}</td>
          <td class="px-2 py-1">${log.islem}</td>
          <td class="px-2 py-1 text-slate-500">${log.user}</td>
        `;
        logTable.appendChild(tr);
      });
    }

    function renderOrders() {
      sortData(orders, siparisSort.key, siparisSort.direction, appContainer.querySelector(`#ss_pageSiparis th[data-sort-key="${siparisSort.key}"]`)?.dataset.sortType);
      table.innerHTML = "";
      orders.forEach((o, i) => {
        const tr = document.createElement("tr");
        if (o.sevkeHazir) {
          tr.style.backgroundColor = B_ROW;
        } else if (!o.sevkTarihi) {
          tr.classList.add("highlight");
        } else {
          const bg = getRowBgByDue(o.sevkTarihi, o.hazir);
          if (bg) tr.style.backgroundColor = bg;
        }

        const showVal = (v) => (v === undefined || v === null || v === '' ? '<span class="text-slate-400 italic">‚Äî</span>' : String(v));
        const span = (text, field, type, extraCls='') => `<span class="editable block min-h-[28px] w-full px-1 rounded ${extraCls}" data-field="${field}" data-type="${type}" ondblclick="window.ssApp.makeEditable(this, ${i}, '${field}', '${type}')">${showVal(text)}</span>`;

        tr.innerHTML = `
          <td data-label="No"><span class="font-semibold">${o.no}</span></td>
          <td data-label="M√º≈üteri">${span(o.musteri, 'musteri', 'text')}</td>
          <td data-label="√úr√ºn">${span(o.urun, 'urun', 'text')}</td>
          <td data-label="Mil Kodu">${span(o.milKod, 'milKod', 'text')}</td>
          <td data-label="kW">${span(o.kw, 'kw', 'number','text-right')}</td>
          <td data-label="RPM">${span(o.rpm, 'rpm', 'number','text-right')}</td>
          <td data-label="Voltaj">${span(o.volt, 'volt', 'number','text-right')}</td>
          <td data-label="Sevk Tarihi">${span(formatDate_TR(o.sevkTarihi), 'sevkTarihi', 'date')}</td>
          <td data-label="A√ßƒ±klama"><button class="px-2 py-1 rounded-md border bg-white hover:bg-slate-50 text-xs underline" onclick="window.ssApp.openDescEditor('siparis', ${i})">${(o.aciklama || '').trim() ? 'A√ßƒ±klamayƒ± G√∂r' : 'A√ßƒ±klama Ekle'}</button></td>
          <td data-label="Hazƒ±r" class="${o.hazir ? 'bg-green-100' : ''}"><input type="checkbox" ${o.hazir?'checked':''} onchange="window.ssApp.toggleHazir(${i}, this.checked)" /></td>
          <td data-label="Sevke Hazƒ±r" class="${o.sevkeHazir ? 'bg-blue-100' : ''}"><input type="checkbox" ${o.sevkeHazir?'checked':''} ${o.hazir?'':'disabled'} onchange="window.ssApp.toggleSevkeHazir(${i}, this.checked)" /></td>
          <td data-label="Durum">${o.sevkeHazir? `<button onclick="window.ssApp.markAsSevk('${o.no}')" class="text-blue-600 underline">Sevk Et</button>` : '<span class="text-slate-400 italic">Sevke hazƒ±r deƒüil</span>'}</td>
          <td data-label="ƒ∞≈ülemler"><button class="text-rose-600 underline" onclick="window.ssApp.deleteOrder('${o.no}')">Sil</button></td>
        `;
        table.appendChild(tr);
      });
      lastPaintDay = todayLocal().toDateString();
      updateSortIndicators(table.id, siparisSort);
    }
    
    function renderTeknikServisSevkList() {
        sortData(servisSevkEdilenler, teknikServisSevkSort.key, teknikServisSevkSort.direction, appContainer.querySelector(`#ss_teknikServisSevkTable th[data-sort-key="${teknikServisSevkSort.key}"]`)?.dataset.sortType);

        const q = (teknikSevkSearch.value || "").toLowerCase();
        const df = parseDdMmYyyy(teknikSevkDateFrom.value);
        const dt = parseDdMmYyyy(teknikSevkDateTo.value);

        const filtered = servisSevkEdilenler.filter(item => {
            const txt = [item.no, item.firma, item.urun, item.milTipi, item.ariza].join(" ").toLowerCase();
            const okTxt = !q || txt.includes(q);
            const sevkDate = item.sevkEdildi ? parseAnyDate(item.sevkEdildi.split(' ')[0]) : null;
            const okFrom = !df || (sevkDate && atLocalMidnight(sevkDate) >= df);
            const okTo   = !dt || (sevkDate && atLocalMidnight(sevkDate) <= dt);
            return okTxt && okFrom && okTo;
        });

        teknikServisSevkTable.innerHTML = "";
        filtered.forEach((o) => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
                <td data-label="No"><span class="font-semibold">${o.no}</span></td>
                <td data-label="Firma">${o.firma || ""}</td>
                <td data-label="√úr√ºn">${o.urun || ""}</td>
                <td data-label="Mil Tipi">${o.milTipi || ""}</td>
                <td data-label="Arƒ±za">${o.ariza || ""}</td>
                <td data-label="Sevk Edildi">${o.sevkEdildi || ""}</td>
                <td data-label="Kullanƒ±cƒ±">${o.kullanici || ""}</td>
                <td data-label="ƒ∞≈ülem"><button class="text-slate-600 underline" onclick="window.ssApp.geriAlServisSevk('${o.no}')">Geri Al</button></td>
            `;
            teknikServisSevkTable.appendChild(tr);
        });
        updateSortIndicators(teknikServisSevkTable.id, teknikServisSevkSort);
    }

    function renderSevkList(){
      sortData(sevkEdilenler, sevkSort.key, sevkSort.direction, appContainer.querySelector(`#ss_pageSevk th[data-sort-key="${sevkSort.key}"]`)?.dataset.sortType);
      const q = (searchInput.value || "").toLowerCase();
      const df = parseDdMmYyyy(dateFromInput.value);
      const dt = parseDdMmYyyy(dateToInput.value);

      const filtered = sevkEdilenler.filter(item => {
        const txt = [item.no, item.musteri, item.urun, item.milKod].join(" ").toLowerCase();
        const okTxt = !q || txt.includes(q);
        const sevkDate = item.sevkEdildi ? parseAnyDate(item.sevkEdildi.split(' ')[0]) : null;
        const okFrom = !df || (sevkDate && atLocalMidnight(sevkDate) >= df);
        const okTo   = !dt || (sevkDate && atLocalMidnight(sevkDate) <= dt);
        return okTxt && okFrom && okTo;
      });

      sevkTable.innerHTML = "";
      filtered.forEach((o) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td data-label="No"><span class="font-semibold">${o.no}</span></td>
          <td data-label="M√º≈üteri">${o.musteri || ""}</td>
          <td data-label="√úr√ºn">${o.urun || ""}</td>
          <td data-label="Mil Kodu">${o.milKod || ""}</td>
          <td data-label="kW">${o.kw || ""}</td>
          <td data-label="RPM">${o.rpm || ""}</td>
          <td data-label="Voltaj">${o.volt || ""}</td>
          <td data-label="Sevk Tarihi">${formatDate_TR(o.sevkTarihi) || ""}</td>
          <td data-label="Sevk Edildi">${o.sevkEdildi || ""}</td>
          <td data-label="Kullanƒ±cƒ±">${o.kullanici || ""}</td>
          <td data-label="ƒ∞≈ülem"><button class="text-slate-600 underline" onclick="window.ssApp.geriAlSevk('${o.no}')">Geri Al</button></td>
        `;
        sevkTable.appendChild(tr);
      });
      updateSortIndicators(sevkTable.id, sevkSort);
    }

    function servisRowBg(durum){
      switch((durum || '').toUpperCase()){
        case "HAZIR": return "#fef3c7";
        case "BEKLEMEDE": return "#f1f5f9";
        case "ƒ∞NCELENƒ∞YOR": case "INCELENIYOR": return "#fef3c7";
        case "TEKLƒ∞F BEKLƒ∞YOR": case "TEKLIF BEKLIYOR": return "#ede9fe";
        default: return "";
      }
    }
    
    function renderServisList(){
      sortData(servisKayitlari, servisSort.key, servisSort.direction, appContainer.querySelector(`#ss_pageServis th[data-sort-key="${servisSort.key}"]`)?.dataset.sortType);

      const q = (servisSearch.value || "").toLowerCase();
      const filtered = servisKayitlari.filter(it => {
        const txt = [it.no, it.firma, it.urun, it.ariza, it.milTipi, it.not, it.aciklama, it.durum].join(" ").toLowerCase();
        return !q || txt.includes(q);
      });

      servisTable.innerHTML = "";
      filtered.forEach((s) => {
        const originalIndex = servisKayitlari.indexOf(s);
        const tr = document.createElement("tr");
        
        let bg = null;
        const isServisHazir = (s.durum || '').toUpperCase() === 'HAZIR';

        if (s.sevkTarihi) {
            bg = getRowBgByDue(s.sevkTarihi, isServisHazir);
        }
        
        if (!bg) {
            bg = servisRowBg(s.durum);
        }

        if (bg) {
            tr.style.backgroundColor = bg;
        }
        
        const showVal = (v) => (v === undefined || v === null || v === '' ? '<span class="text-slate-400 italic">‚Äî</span>' : String(v));
        const span = (text, field, type, extraCls='') => `<span class="editable block min-h-[28px] w-full px-1 rounded ${extraCls}" ondblclick="window.ssApp.makeEditableServis(this, ${originalIndex}, '${field}', '${type}')">${showVal(text)}</span>`;

        tr.innerHTML = `
          <td data-label="No"><span class="font-semibold">${s.no || ''}</span></td>
          <td data-label="Firma">${span(s.firma, 'firma', 'text')}</td>
          <td data-label="√úr√ºn">${span(s.urun, 'urun', 'text')}</td>
          <td data-label="Adet">${span(s.adet, 'adet', 'number','text-right')}</td>
          <td data-label="Arƒ±za">${span(s.ariza, 'ariza', 'text')}</td>
          <td data-label="Mil Tipi">${span(s.milTipi, 'milTipi', 'text')}</td>
          <td data-label="Durum">${span(s.durum, 'durum', 'select')}</td>
          <td data-label="Not">${span(s.not, 'not', 'text')}</td>
          <td data-label="ƒ∞leti≈üim">${span(s.iletisim, 'iletisim', 'text')}</td>
          <td data-label="Kargo Tipi">${span(s.kargoTipi, 'kargoTipi', 'text')}</td>
          <td data-label="Sevk Tarihi">${span(formatDate_TR(s.sevkTarihi), 'sevkTarihi', 'date')}</td>
          <td data-label="A√ßƒ±klama"><button class="px-2 py-1 rounded-md border bg-white hover:bg-slate-50 text-xs underline" onclick="window.ssApp.openDescEditor('servis', ${originalIndex})">${(s.aciklama || '').trim() ? 'A√ßƒ±klamayƒ± G√∂r' : 'A√ßƒ±klama Ekle'}</button></td>
          <td data-label="ƒ∞≈ülem">
            <div class="flex flex-wrap gap-x-2 gap-y-1">
            ${(s.durum || '').toUpperCase() === 'HAZIR' ? `<button class="text-blue-600 underline" onclick="window.ssApp.markServisAsSevk(${originalIndex})">Sevk Et</button>` : '<span class="text-slate-400 italic">Sevk edilemez</span>'}
            <button class="text-blue-600 underline" onclick="window.ssApp.editServis(${originalIndex})">D√ºzenle</button>
            <button class="text-rose-600 underline" onclick="window.ssApp.deleteServis(${originalIndex})">Sil</button>
            </div>
          </td>
        `;
        servisTable.appendChild(tr);
      });
      updateSortIndicators(servisTable.id, servisSort);
    }
    
    function setServisDurum(i, val){
      const s = servisKayitlari[i];
      if (!s) return;
      const old = s.durum || "";
      s.durum = (val || "").toUpperCase();
      window.dataStore['servisKayitlari'] = servisKayitlari;
      window.pushData('servisKayitlari');
      logAction(s.no || "(servis)", `Teknik servis durumu deƒüi≈üti: ${old} -> ${s.durum}`);
      renderServisList();
    }
    
    function deleteServis(i){
      if (!confirm('Kayƒ±t silinsin mi?')) return;
      const no = servisKayitlari[i]?.no;
      servisKayitlari.splice(i,1);
      window.dataStore['servisKayitlari'] = servisKayitlari;
      window.pushData('servisKayitlari');
      if (no) logAction(no, 'Teknik servis kaydƒ± silindi');
      renderServisList();
    }
    
    function deleteOrder(no){
      const index = orders.findIndex(o => o.no === no);
      if (index === -1) {
          console.error("Silinecek sipari≈ü bulunamadƒ±:", no);
          alert("Hata: Silinecek sipari≈ü bulunamadƒ±.");
          return;
      }
      const o = orders[index];
      if (!confirm(`#${o.no} numaralƒ± sipari≈üi silmek istediƒüinize emin misiniz?`)) return;
      
      orders.splice(index, 1);
      window.dataStore['siparisler'] = orders;
      window.pushData('siparisler');
      logAction(o.no, "Sipari≈ü silindi");
      renderOrders();
    }
    
    function inlineUpdate(index, field, value){
      if (!orders[index]) return;
      const oldVal = orders[index][field];
      orders[index][field] = value;
      window.dataStore['siparisler'] = orders;
      window.pushData('siparisler');
      if (field !== 'sevkTarihi'){
        logAction(orders[index].no, `Alan g√ºncellendi: ${field} = "${oldVal ?? ''}" -> "${value}"`);
      }
    }

    let ss_descOverlay;
    function ensureDescOverlay(){
      if (ss_descOverlay) return ss_descOverlay;
      ss_descOverlay = document.createElement('div');
      ss_descOverlay.id = 'ss_descOverlay';
      ss_descOverlay.className = 'fixed inset-0 bg-black bg-opacity-50 z-[1000] flex items-center justify-center p-4 hidden';
      ss_descOverlay.innerHTML = `
        <div class="w-full max-w-3xl bg-white rounded-2xl shadow-2xl border border-slate-200">
          <div class="px-4 py-3 border-b flex items-center justify-between">
            <h3 class="font-semibold text-slate-800">A√ßƒ±klama</h3>
            <button id="ss_descClose" class="px-3 py-1 border rounded-lg bg-white hover:bg-slate-50">Kapat</button>
          </div>
          <div class="p-4"><textarea id="ss_descText" class="w-full h-72 p-3 border rounded-lg" placeholder="A√ßƒ±klama yazƒ±n..."></textarea></div>
          <div class="px-4 py-3 border-t flex gap-2 justify-end"><button id="ss_descSave" class="btn-brand px-4 py-2 rounded-xl">Kaydet</button></div>
        </div>`;
      document.body.appendChild(ss_descOverlay);
      ss_descOverlay.querySelector('#ss_descClose').onclick = () => ss_descOverlay.classList.add('hidden');
      return ss_descOverlay;
    }

    let currentDescCtx = null;
    function openDescEditor(type, index){
      currentDescCtx = { type, index };
      const ov = ensureDescOverlay();
      let text = '';
      if (type === 'siparis' && orders[index]) text = orders[index].aciklama || '';
      if (type === 'servis' && servisKayitlari[index]) text = servisKayitlari[index].aciklama || '';
      const ta = ov.querySelector('#ss_descText');
      ta.value = text;
      ov.classList.remove('hidden');
      
      ov.querySelector('#ss_descSave').onclick = () => {
        const val = ta.value || '';
        if (!currentDescCtx) return;
        const { type, index } = currentDescCtx;
        if (type === 'siparis' && orders[index]){
          orders[index].aciklama = val;
          window.dataStore['siparisler'] = orders;
          window.pushData('siparisler');
          logAction(orders[index].no, 'A√ßƒ±klama g√ºncellendi');
          renderOrders();
        } else if (type === 'servis' && servisKayitlari[index]){
          servisKayitlari[index].aciklama = val;
          window.dataStore['servisKayitlari'] = servisKayitlari;
          window.pushData('servisKayitlari');
          logAction(servisKayitlari[index].no, 'Servis a√ßƒ±klamasƒ± g√ºncellendi');
          renderServisList();
        }
        ov.classList.add('hidden');
      };
    }
    
    function makeEditable(el, index, field, type){
      const originalIndex = index;
      const current = orders[originalIndex] ? orders[originalIndex][field] : '';
      const td = el.parentElement;
      let input;
      if (type === 'date'){
        input = document.createElement('input');
        input.className = 'sevk-picker date-input px-2 py-1 border rounded-md bg-white w-[160px]';
      } else {
        input = document.createElement('input');
        input.type = type === 'number' ? 'number' : 'text';
        input.className = `px-2 py-1 border rounded-md w-full ${type==='number' ? 'text-right' : ''}`;
        input.value = current ?? '';
      }
      td.innerHTML = '';
      td.appendChild(input);
      input.focus();
      
      const commit = () => {
        let val = input.value;
        if(type === 'date') {
          const date = parseDdMmYyyy(val);
          if(date) setSevkDate(originalIndex, date);
          else renderOrders(); 
        } else {
          inlineUpdate(originalIndex, field, type==='number' ? (val===''? null : Number(val)) : val);
          renderOrders();
        }
      };
      
      input.addEventListener('keydown', e => { if (e.key === 'Enter') commit(); else if (e.key === 'Escape') renderOrders(); });
      input.addEventListener('blur', commit);

      if (type === 'date'){
        flatpickr(input, { ...getFPBaseOptions(), defaultDate: parseAnyDate(current) || undefined, onClose: (sel) => { if (sel && sel[0]) setSevkDate(originalIndex, sel[0]); else renderOrders(); } }).open();
      }
    }

    function makeEditableServis(el, index, field, type){
      const s = servisKayitlari[index];
      if (!s) return;
      const td = el.parentElement;
      let input;

      const commitAndRender = () => {
        const val = input.value;
        if (type === 'number'){ s[field] = (val === '' ? null : Number(val)); }
        else if (type === 'date') {
            const date = parseDdMmYyyy(val);
            if(date) setServisSevkDate(index, date);
            else renderServisList();
            return; 
        } else { s[field] = val; }
        
        window.dataStore['servisKayitlari'] = servisKayitlari;
        window.pushData('servisKayitlari');
        logAction(s.no || "(servis)", `Alan g√ºncellendi: ${field}`);
        renderServisList();
      };

      if (type === 'select'){
        input = document.createElement('select');
        input.className = 'px-2 py-1 border rounded-md bg-white w-full';
        ["", "HAZIR", "BEKLEMEDE", "ƒ∞NCELENƒ∞YOR", "TEKLƒ∞F BEKLƒ∞YOR"].forEach(op => {
          const o = document.createElement('option');
          o.value = op;
          o.textContent = op || '(Se√ßiniz)';
          if ((s[field] || "").toUpperCase() === op) o.selected = true;
          input.appendChild(o);
        });
        input.onchange = () => setServisDurum(index, input.value);
        input.onblur = () => renderServisList(); 
      } else {
        input = document.createElement('input');
        input.type = (type === 'date') ? 'text' : (type === 'number' ? 'number' : 'text');
        input.className = `px-2 py-1 border rounded-md w-full ${type==='number' ? 'text-right' : ''}`;
        input.value = (type === 'date') ? formatDate_TR(s[field]) : (s[field] ?? '');
        
        input.addEventListener('keydown', e => { if (e.key === 'Enter') commitAndRender(); if (e.key === 'Escape') renderServisList(); });
        input.addEventListener('blur', commitAndRender);
      }

      td.innerHTML = '';
      td.appendChild(input);
      input.focus();

      if (type === 'date'){
        flatpickr(input, { ...getFPBaseOptions(), defaultDate: parseAnyDate(s[field]) || undefined, onClose: (sel) => { if (sel && sel[0]) { setServisSevkDate(index, sel[0]); } else { renderServisList(); } } }).open();
      }
    }
    
    function setSevkDate(index, dateObj){
      orders[index].sevkTarihi = formatDate_TR(dateObj);
      window.dataStore['siparisler'] = orders;
      window.pushData('siparisler');
      logAction(orders[index].no, "Sevk tarihi g√ºncellendi");
      renderOrders();
    }
    
    function setServisSevkDate(index, dateObj){
      if (!servisKayitlari[index]) return;
      servisKayitlari[index].sevkTarihi = formatDate_TR(dateObj);
       window.dataStore['servisKayitlari'] = servisKayitlari;
      window.pushData('servisKayitlari');
      logAction(servisKayitlari[index].no || '(servis)', 'Servis sevk tarihi g√ºncellendi');
      renderServisList();
    }

    function toggleHazir(index, val){
      orders[index].hazir = !!val;
      if (!val) orders[index].sevkeHazir = false;
      window.dataStore['siparisler'] = orders;
      window.pushData('siparisler');
      logAction(orders[index].no, val ? "ƒ∞malat: Hazƒ±r" : "ƒ∞malat: Hazƒ±r deƒüil");
      renderOrders();
    }
    function toggleSevkeHazir(index, val){
      if (val && !orders[index].hazir) {
        alert("√ñnce 'Hazƒ±r' i≈üaretlenmeli.");
        renderOrders(); return;
      }
      orders[index].sevkeHazir = !!val;
      window.dataStore['siparisler'] = orders;
      window.pushData('siparisler');
      logAction(orders[index].no, val ? "Sevke Hazƒ±r" : "Sevke Hazƒ±r deƒüil");
      renderOrders();
    }
    function markAsSevk(no) {
      const index = orders.findIndex(o => o.no === no);
      if (index === -1) {
          console.error("Sevk edilecek sipari≈ü bulunamadƒ±:", no);
          alert("Hata: Sevk edilecek sipari≈ü bulunamadƒ±. L√ºtfen sayfayƒ± yenileyip tekrar deneyin.");
          return;
      }
      const orderToShip = orders[index];
      const user = sessionStorage.getItem("auth_user") || "(bilinmiyor)";
      sevkEdilenler.push({ ...orderToShip, sevkEdildi: formatDateTime_TR(new Date()), kullanici: user });
      window.dataStore['sevkEdilenler'] = sevkEdilenler;
      window.pushData('sevkEdilenler');
      
      logAction(orderToShip.no, "Sipari≈ü sevk edildi");
      orders.splice(index, 1);
      window.dataStore['siparisler'] = orders;
      window.pushData('siparisler');
      
      renderOrders();
      renderSevkList();
    }
    function geriAlSevk(no){
      const idx = sevkEdilenler.findIndex(x => x.no === no);
      if (idx === -1) return;
      const [rec] = sevkEdilenler.splice(idx,1);
      delete rec.sevkEdildi;
      delete rec.kullanici;
      rec.sevkeHazir = false; 
      orders.push(rec);
      window.dataStore['sevkEdilenler'] = sevkEdilenler;
      window.pushData('sevkEdilenler');
      window.dataStore['siparisler'] = orders;
      window.pushData('siparisler');
      logAction(rec.no, "Sevk geri alƒ±ndƒ±");
      renderSevkList();
      renderOrders();
    }

    form.addEventListener("submit", function (e) {
      e.preventDefault();
      const data = Object.fromEntries(new FormData(form).entries());
      orders.push({ 
        ...data, 
        kw: data.kw ? Number(data.kw) : null,
        rpm: data.rpm ? Number(data.rpm) : null,
        volt: data.volt ? Number(data.volt) : null,
        sevkTarihi: formatDate_TR(parseDdMmYyyy(data.sevkTarihi)), 
        no: getNextSiparisNo(), 
        kullanici: sessionStorage.getItem("auth_user") || "(anonim)", 
        hazir: false, 
        sevkeHazir: false 
      });
      window.dataStore['siparisler'] = orders;
      window.pushData('siparisler');
      logAction(orders[orders.length-1].no, "Yeni sipari≈ü eklendi");
      form.reset();
      form.querySelector(".sevk-picker")?._flatpickr.clear();
      renderOrders();
    });

    servisForm.addEventListener('submit', function(e){
      e.preventDefault();
      const data = Object.fromEntries(new FormData(servisForm).entries());
      const norm = { ...data, adet: data.adet ? parseInt(data.adet,10) : null };

      const editIndex = servisForm.dataset.editIndex;
      if (editIndex !== undefined){
        const idx = parseInt(editIndex, 10);
        const existing = servisKayitlari[idx];
        if(existing) {
            servisKayitlari[idx] = Object.assign(existing, norm);
            logAction(existing.no, 'Teknik servis kaydƒ± g√ºncellendi');
        }
      } else {
        const no = getNextServisNo();
        servisKayitlari.unshift({ ...norm, no, durum: 'BEKLEMEDE', sevkTarihi: '' });
        logAction(no, 'Teknik servis kaydƒ± eklendi');
      }

      window.dataStore['servisKayitlari'] = servisKayitlari;
      window.pushData('servisKayitlari');
      resetServisForm();
      renderServisList();
    });
    
    function editServis(index) {
        const s = servisKayitlari[index];
        if (!s) return;
        Object.keys(s).forEach(key => {
            if (servisForm.elements[key]) {
                servisForm.elements[key].value = s[key] ?? '';
            }
        });
        servisForm.dataset.editIndex = index;
        appContainer.querySelector('#ss_servisFormSubmitButton').textContent = 'Kaydƒ± G√ºncelle';
        appContainer.querySelector('#ss_servisFormCancelButton').classList.remove('hidden');
        servisForm.scrollIntoView({ behavior: 'smooth' });
    }

    function resetServisForm() {
        servisForm.reset();
        delete servisForm.dataset.editIndex;
        appContainer.querySelector('#ss_servisFormSubmitButton').textContent = 'Servis Kaydƒ± Ekle';
        appContainer.querySelector('#ss_servisFormCancelButton').classList.add('hidden');
    }
    
    appContainer.querySelector('#ss_servisFormCancelButton').addEventListener('click', resetServisForm);
    
    function downloadCSV(filename, rows){
      const csv = rows.map(r => r.map(c => `"${(c ?? "").toString().replace(/"/g, '""')}"`).join(",")).join("\n");
      const blob = new Blob([`\uFEFF${csv}`], { type: "text/csv;charset=utf-8;" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = filename;
      a.click();
    }

    function handleImport(e) {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        try {
          const data = JSON.parse(reader.result);
          if (confirm("Mevcut verilerin √ºzerine i√ße aktarƒ±lan veriler yazƒ±lsƒ±n mƒ±? Bu i≈ülem geri alƒ±namaz.")){
            window.dataStore['siparisler'] = ensureArray(data.orders || []);
            window.dataStore['siparisLog'] = ensureArray(data.logs || []);
            window.dataStore['sevkEdilenler'] = ensureArray(data.sevkEdilenler || []);
            window.dataStore['servisKayitlari'] = ensureArray(data.servisKayitlari || []);
            window.dataStore['servisSevkEdilenler'] = ensureArray(data.servisSevkEdilenler || []);
            
            window.pushData('siparisler');
            window.pushData('siparisLog');
            window.pushData('sevkEdilenler');
            window.pushData('servisKayitlari');
            window.pushData('servisSevkEdilenler');

            loadDataFromStorage();
            renderAllTables();
            alert("Veri ba≈üarƒ±yla y√ºklendi.");
          }
        } catch (err) { alert("Ge√ßersiz JSON dosyasƒ±."); }
      };
      reader.readAsText(file);
    }
    
    $('#ss_btnImportJSON').onclick = () => fileInput.click();
    $('#ss_btnImportJSON_mobile').onclick = () => fileInputMobile.click();
    fileInput.addEventListener("change", handleImport);
    fileInputMobile.addEventListener("change", handleImport);

    const exportAction = () => {
      const json = JSON.stringify({ orders, logs, sevkEdilenler, servisKayitlari, servisSevkEdilenler }, null, 2);
      const blob = new Blob([json], { type: "application/json" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = `hertz_motor_yedek_${new Date().toISOString().slice(0,10)}.json`;
      a.click();
    };
    $('#ss_btnExportJSON').onclick = exportAction;
    $('#ss_btnExportJSON_mobile').onclick = exportAction;
    

    const exportCSVAction = () => downloadCSV("siparisler.csv", [
      ["No", "M√º≈üteri", "√úr√ºn", "Mil Kodu", "kW", "RPM", "Voltaj", "Sevk Tarihi", "Hazƒ±r", "Sevke Hazƒ±r", "Kullanƒ±cƒ±"],
      ...orders.map(o => [o.no, o.musteri, o.urun, o.milKod, o.kw, o.rpm, o.volt, formatDate_TR(o.sevkTarihi), o.hazir?"Evet":"Hayƒ±r", o.sevkeHazir?"Evet":"Hayƒ±r", o.kullanici])
    ]);
    $('#ss_btnExportCSV').onclick = exportCSVAction;
    $('#ss_btnExportCSV_mobile').onclick = exportCSVAction;

    const exportLogCSVAction = () => downloadCSV("siparis_log.csv", [
      ["Tarih", "No", "ƒ∞≈ülem", "Kullanƒ±cƒ±"],
      ...logs.map(l => [l.tarih, l.no, l.islem, l.user])
    ]);
    $('#ss_btnExportLogCSV').onclick = exportLogCSVAction;
    $('#ss_btnExportLogCSV_mobile').onclick = exportLogCSVAction;

    const clearAllAction = () => {
      if (confirm("T√úM Sƒ∞PARƒ∞≈û/SERVƒ∞S VERƒ∞LERƒ∞ (sipari≈ü, sevk, servis, log) silinecek. Emin misiniz?\n\nƒ∞≈ülemden √∂nce otomatik olarak yedek indirilecektir.")) {
        $('#ss_btnExportJSON').click();
        
        const keysToClear = ["siparisler", "sevkEdilenler", "servisKayitlari", "siparisLog", "servisSevkEdilenler"];
        keysToClear.forEach(k => {
            window.dataStore[k] = [];
            window.pushData(k);
        });

        loadDataFromStorage();
        renderAllTables();
        alert("T√ºm Sipari≈ü/Servis verileri temizlendi.");
      }
    };
    $('#ss_btnClearAll').onclick = clearAllAction;
    $('#ss_btnClearAll_mobile').onclick = clearAllAction;

    
    appContainer.querySelector('#ss_btnSevkFilter').onclick = renderSevkList;
    appContainer.querySelector('#ss_btnSevkClearFilter').onclick = () => { searchInput.value = ""; dateFromInput.value = ""; dateToInput.value = ""; renderSevkList(); };
    appContainer.querySelector('#ss_btnSevkClearAll').onclick = () => { if(confirm("T√ºm sipari≈ü sevk kayƒ±tlarƒ± silinecek?")){ 
        sevkEdilenler=[]; 
        window.dataStore['sevkEdilenler'] = sevkEdilenler;
        window.pushData('sevkEdilenler');
        renderSevkList();
    }};
    
    appContainer.querySelector('#ss_btnTeknikSevkFilter').addEventListener('click', renderTeknikServisSevkList);
    appContainer.querySelector('#ss_btnTeknikSevkClearFilter').addEventListener('click', () => {
        teknikSevkSearch.value = "";
        teknikSevkDateFrom.value = "";
        teknikSevkDateTo.value = "";
        renderTeknikServisSevkList();
    });
    appContainer.querySelector('#ss_btnTeknikSevkCSV').addEventListener('click', () => {
      downloadCSV("teknik_servis_sevk_listesi.csv", [
        ["No", "Firma", "√úr√ºn", "Mil Tipi", "Arƒ±za", "Sevk Edildi", "Kullanƒ±cƒ±"],
        ...Array.from(teknikServisSevkTable.querySelectorAll('tr')).map(tr => Array.from(tr.children).slice(0,-1).map(td => td.textContent))
      ]);
    });
    appContainer.querySelector('#ss_btnTeknikSevkClearAll').addEventListener('click', () => {
        if (confirm("T√ºm teknik servis sevk kayƒ±tlarƒ± silinecek. Emin misiniz?")) {
            servisSevkEdilenler = [];
            window.dataStore['servisSevkEdilenler'] = servisSevkEdilenler;
            window.pushData('servisSevkEdilenler');
            renderTeknikServisSevkList();
        }
    });

    appContainer.querySelector('#ss_btnServisClearAll').onclick = () => { if(confirm('T√ºm teknik servis kayƒ±tlarƒ± silinecek?')){ 
        servisKayitlari = []; 
        window.dataStore['servisKayitlari'] = servisKayitlari;
        window.pushData('servisKayitlari');
        renderServisList(); 
    }};
    
    
    function sortData(data, key, direction = 'asc', type = 'string') {
        if (!Array.isArray(data)) return;
        data.sort((a, b) => {
            let valA = a[key], valB = b[key];
            if (type === 'number') { valA = parseFloat(valA) || 0; valB = parseFloat(valB) || 0; }
            else if (type === 'date') { valA = parseAnyDate(valA)?.getTime() || 0; valB = parseAnyDate(valB)?.getTime() || 0; }
            else { valA = String(valA || '').toLocaleLowerCase('tr-TR'); valB = String(valB || '').toLocaleLowerCase('tr-TR'); }
            if (valA < valB) return direction === 'asc' ? -1 : 1;
            if (valA > valB) return direction === 'asc' ? 1 : -1;
            return 0;
        });
    }

    function updateSortIndicators(tableBodyId, sortState) {
        const table = appContainer.querySelector(`#${tableBodyId}`)?.closest('table');
        if (!table) return;
        table.querySelectorAll('thead .sortable').forEach(th => {
            th.classList.remove('asc', 'desc');
            if (th.dataset.sortKey === sortState.key) th.classList.add(sortState.direction);
        });
    }

    function setupTableSorting() {
        appContainer.querySelectorAll('table thead').forEach(thead => {
            thead.addEventListener('click', (e) => {
                const header = e.target.closest('.sortable');
                if (!header) return;
                const tableId = header.closest('table').querySelector('tbody').id;
                let currentSort, renderFunction;
                
                switch(tableId) {
                    case 'ss_orderTable': currentSort = siparisSort; renderFunction = renderOrders; break;
                    case 'ss_sevkTable': currentSort = sevkSort; renderFunction = renderSevkList; break;
                    case 'ss_teknikServisSevkTable': currentSort = teknikServisSevkSort; renderFunction = renderTeknikServisSevkList; break;
                    case 'ss_servisTable': currentSort = servisSort; renderFunction = renderServisList; break;
                    default: return;
                }

                const sortKey = header.dataset.sortKey;
                if (currentSort.key === sortKey) {
                    currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
                } else {
                    currentSort.key = sortKey;
                    currentSort.direction = 'asc';
                }
                renderFunction();
            });
        });
    }
    function renderAllTables() {
        renderOrders(); 
        renderLogs(); 
        renderSevkList(); 
        renderServisList();
        renderTeknikServisSevkList();
    }
    
    loadDataFromStorage();
    flatpickr(appContainer.querySelector('#ss_sevkTarihi'), getFPBaseOptions());
    flatpickr(dateFromInput, getFPBaseOptions());
    flatpickr(dateToInput, getFPBaseOptions());
    flatpickr(teknikSevkDateFrom, getFPBaseOptions());
    flatpickr(teknikSevkDateTo, getFPBaseOptions());


    document.addEventListener("visibilitychange", checkDayAndRefresh);
    window.addEventListener("focus", checkDayAndRefresh);
    
    setupTableSorting();
    renderAllTables();
    setTab("siparis");
    scheduleMidnightRefresh(); // Gece yarƒ±sƒ± yenilemesini etkinle≈ütir.

    window.ssApp = { makeEditable, makeEditableServis, openDescEditor, toggleHazir, toggleSevkeHazir, markAsSevk, deleteOrder, geriAlSevk, editServis, deleteServis, markServisAsSevk, geriAlServisSevk, setServisDurum, resetServisForm, setSevkDate, setServisSevkDate };

    window.setSiparisServisRefresher(() => {
        loadDataFromStorage();
        renderAllTables();
    });
}

function initializeStokTakipApp() {
    const appContainer = document.getElementById('app-stok-takip');
    if (!appContainer.innerHTML.trim()) return;

    const $=(s,r=document)=>r.querySelector(s);
    const $$=(s,r=appContainer)=>Array.from(r.querySelectorAll(s));
    
    const LS_KEY='stokTakip-v1';
    const CATEGORY_PREFIX={stator:'ST',rotor:'RT',mil:'MIL',rotorluMil:'RMIL',taslanmisMil:'TMIL',sargiliPaket:'SP',paketliGovde:'PG',motor:'MOT',kapak:'KAP',islenmisKapak:'IKAP',taslanmisKapak:'TKAP', rulman:'RUL', aluminyum_govde:'ALU', bakir_tel:'CUW',  yardimci_parcalar:'ACC'};
    const CATEGORY_LABEL={'stator':'Stator','rotor':'Rotor','mil':'Mil','rotorluMil':'Rotorlu Mil','taslanmisMil':'Ta≈ülanmƒ±≈ü Mil','sargiliPaket':'Sargƒ±lƒ± Paket','paketliGovde':'Paketli G√∂vde','motor':'Motor','kapak':'Kapak','islenmisKapak':'ƒ∞≈ülenmi≈ü Kapak','taslanmisKapak':'Ta≈ülanmƒ±≈ü Kapak', 'rulman':'Rulman', 'aluminyum_govde':'Al√ºminyum G√∂vde', 'bakir_tel':'Bakƒ±r Tel',  'yardimci_parcalar':'Yardƒ±mcƒ± Par√ßalar'};

    let state={products:[],logs:[]};
    const uuid=()=> (crypto?.randomUUID?.() || 'id-'+Math.random().toString(36).slice(2)+Date.now());

    function load(){ 
        const data = window.dataStore[LS_KEY] || {products:[], logs:[]};
        state.products = ensureArray(data.products);
        state.logs = ensureArray(data.logs);
    }
    function save(){ 
        window.dataStore[LS_KEY] = state;
        window.pushData(LS_KEY);
        render(); 
    }

    const fmt=n=>{const v=Number(n); return Number.isFinite(v)? new Intl.NumberFormat('tr-TR',{maximumFractionDigits:3}).format(v):n};
    const nowISO=()=>new Date().toISOString();
    const currentUser=()=> (sessionStorage.getItem('auth_user')||'anon');
    const addLog=(entry)=> state.logs.unshift({id:uuid(),ts:nowISO(),user:currentUser(),...entry});
    const findProduct=id=>state.products.find(p=>p.id===id);
    
    const normalizeTR = (s) => String(s||'').toLowerCase().replace(/ƒ±/g, 'i').replace(/ƒ∞/g, 'i').replace(/ƒü/g, 'g').replace(/ƒû/g, 'g').replace(/√º/g, 'u').replace(/√ú/g, 'u').replace(/≈ü/g, 's').replace(/≈û/g, 's').replace(/√∂/g, 'o').replace(/√ñ/g, 'o').replace(/√ß/g, 'c').replace(/√á/g, 'c');
    
    const SEARCH_ALIASES = {
        'ad': 'name', 'isim': 'name',
        'kod': 'sku', 'sku': 'sku',
        'not': 'note',
        'tur': 'kind', 't√ºr': 'kind',
        'cesit': 'category', '√ße≈üit': 'category',
        ...Object.fromEntries(Object.entries(CATEGORY_PREFIX).map(([cat, prefix]) => [prefix.toLowerCase(), cat])),
        ...Object.fromEntries(Object.entries(CATEGORY_LABEL).map(([cat, label]) => [normalizeTR(label), cat]))
    };

    let sortBy='name', sortDir='asc';
    
    function specs(p){
      const parts=[];
      if(p.category==='paketliGovde'){ if(p.pg_rpm) parts.push(`${p.pg_rpm} rpm`); if(p.pg_kw) parts.push(`${p.pg_kw} kW`); if(p.pg_volt) parts.push(`${p.pg_volt} V`); if(p.pg_customer) parts.push(`${p.pg_customer}`); if(p.pg_conn) parts.push(`${p.pg_conn}`); }
      else if(p.category==='motor'){ if(p.m_rpm) parts.push(`${p.m_rpm} rpm`); if(p.m_kw) parts.push(`${p.m_kw} kW`); if(p.m_volt) parts.push(`${p.m_volt} V`); if(p.milType) parts.push(`${p.milType}`); if(p.m_customer || p.customer) parts.push(`${p.m_customer||p.customer}`); if(p.m_conn) parts.push(`${p.m_conn}`); if(p.m_cover) parts.push(`${p.m_cover}`); if(p.milCode) parts.push(`${p.milCode}`); }
      else{ if(p.rpm) parts.push(`${p.rpm} rpm`); if(p.kw) parts.push(`${p.kw} kW`); if(p.volt) parts.push(`${p.volt} V`); if(p.material) parts.push(`${p.material}`); if(p.milCode) parts.push(`Mil: ${p.milCode}`); if(p.customer) parts.push(`${p.customer}`); }
      return parts.join(' ‚Ä¢ ');
    }

    function searchable(p){
      const base = [(p.name||''),(p.sku||''),(p.note||''),(CATEGORY_LABEL[p.category]||p.category||'')].join(' ');
      const extra = [p.pg_rpm,p.pg_kw,p.pg_volt,p.pg_customer,p.pg_conn,p.m_rpm,p.m_kw,p.m_volt,p.m_customer,p.m_conn,p.m_cover,p.material,p.milType,p.milCode,p.rpm,p.kw,p.volt,p.customer].filter(Boolean).join(' ');
      return normalizeTR(base+' '+extra);
    }
    
    function render(){
        let list=ensureArray(state.products);
        const qRaw=$('#stok_search').value.trim();
        const onlyLow=$('#stok_onlyLow').checked;
        const filterKindVal = $('#stok_filterKind').value;
        const filterCategoryVal = $('#stok_filterCategory').value;
        
        // Geli≈ümi≈ü arama mantƒ±ƒüƒ±
        if (qRaw.includes(':')) {
            const parts = qRaw.split(':');
            const keyRaw = normalizeTR(parts[0]);
            const val = normalizeTR(parts.slice(1).join(':'));
            const target = SEARCH_ALIASES[keyRaw];

            if (target) {
                if (['name', 'sku', 'note', 'kind', 'category'].includes(target)) {
                    list = list.filter(p => p[target] && normalizeTR(p[target]).includes(val));
                } else {
                    list = list.filter(p => p.category === target && searchable(p).includes(val));
                }
            } else {
                const q = normalizeTR(qRaw);
                list = list.filter(p => searchable(p).includes(q));
            }
        } else if (qRaw) {
            const q = normalizeTR(qRaw);
            list = list.filter(p => searchable(p).includes(q));
        }

        if(onlyLow) { list=list.filter(p=>Number(p.qty||0) < Number(p.min||0)); }
        if(filterKindVal) { list=list.filter(p => p.kind === filterKindVal); }
        if(filterCategoryVal) { list=list.filter(p => p.category === filterCategoryVal); }

        const tbody=$('#stok_tbodyDesktop'); tbody.innerHTML='';
        const listMobile=$('#stok_listMobile'); listMobile.innerHTML='';

        list.sort((a,b)=>{ let va,vb; switch(sortBy){ case 'sku': va=(a.sku||'').toLowerCase(); vb=(b.sku||'').toLowerCase(); break; case 'qty': va=Number(a.qty||0); vb=Number(b.qty||0); break; case 'min': va=Number(a.min||0); vb=Number(b.min||0); break; default: va=(a.name||'').toLowerCase(); vb=(b.name||'').toLowerCase(); } return (va<vb?-1:va>vb?1:0) * (sortDir==='asc'?1:-1); });

        $('#stok_totalProducts').textContent = state.products.length;
        $('#stok_criticalProducts').textContent = state.products.filter(p => Number(p.qty||0) < Number(p.min||0)).length;
        $('#stok_count').textContent=list.length;

        for(const p of list){
            const low=Number(p.qty||0) < Number(p.min||0);
            const lowIcon = low ? ' <span title="Stok kritik seviyede">‚ö†Ô∏è</span>' : '';
            const kindBadge=p.kind?`<span class="badge bg-slate-100 border border-slate-200 mr-1">${p.kind==='ham'?'Hammadde':(p.kind==='yari'?'Yarƒ±-mamul':'Mamul')}</span>`:'';
            const catBadge=p.category?`<span class="badge" style="background: rgba(var(--brand), .15); border:1px solid rgba(var(--brand), .4); color: rgb(var(--brand))">${CATEGORY_LABEL[p.category]||p.category}</span>`:'';
            
            const tr=document.createElement('tr');
            tr.className=low? 'bg-amber-50':'';
            tr.innerHTML=`
            <td class="px-3 py-2 align-top">${p.sku||'-'}</td><td class="px-3 py-2 align-top">${p.name||'-'}</td>
            <td class="px-3 py-2 align-top">${kindBadge} ${catBadge}</td>
            <td class="px-3 py-2 align-top text-right font-medium ${low?'text-amber-700':''}">
                 <span class="editable-qty" data-id="${p.id}">${fmt(p.qty||0)}${lowIcon}</span>
            </td>
            <td class="px-3 py-2 align-top text-right">${fmt(p.min||0)}</td><td class="px-3 py-2 align-top text-slate-700">${specs(p)}</td>
            <td class="px-3 py-2 align-top text-slate-600">${p.note||''}</td><td class="px-3 py-2 align-top text-right">
                <div class="flex justify-end gap-1">
                <button class="px-2 py-1 rounded-lg border border-slate-300 bg-white" data-act="move-in" data-id="${p.id}">Giri≈ü</button>
                <button class="px-2 py-1 rounded-lg border border-slate-300 bg-white" data-act="move-out" data-id="${p.id}">√áƒ±kƒ±≈ü</button>
                <button class="px-2 py-1 rounded-lg" style="border:1px solid rgba(var(--brand), .5); color: rgb(var(--brand)); background:transparent" data-act="edit" data-id="${p.id}">D√ºzenle</button>
                <button class="px-2 py-1 rounded-lg border border-rose-300 text-rose-700 bg-white" data-act="del" data-id="${p.id}">Sil</button>
                </div></td>`;
            tbody.appendChild(tr);

            const card=document.createElement('div');
            card.className='rounded-2xl border border-slate-200 bg-white p-3';
            card.innerHTML=`
            <div class="flex items-start justify-between gap-2">
                <div class="min-w-0"><div class="text-sm text-slate-500">${p.sku||'-'}</div><div class="font-medium truncate">${p.name||'-'}</div><div class="mt-1 text-xs">${kindBadge} ${catBadge}</div><div class="mt-1 text-xs text-slate-600 truncate">${specs(p)}</div></div>
                <div class="text-right"><div class="text-xs text-slate-500">Stok</div><div class="text-base font-semibold ${low?'text-amber-700':''}">${fmt(p.qty||0)}${lowIcon}</div><div class="text-xs text-slate-500">Min ${fmt(p.min||0)}</div></div>
            </div>
            ${p.note?`<div class="mt-2 text-xs text-slate-600">${p.note}</div>`:''}
            <div class="mt-3 flex flex-wrap gap-1">
                <button class="px-2 py-1 rounded-lg border border-slate-300 bg-white" data-act="move-in" data-id="${p.id}">Giri≈ü</button>
                <button class="px-2 py-1 rounded-lg border border-slate-300 bg-white" data-act="move-out" data-id="${p.id}">√áƒ±kƒ±≈ü</button>
                <button class="px-2 py-1 rounded-lg" style="border:1px solid rgba(var(--brand), .5); color: rgb(var(--brand)); background:transparent" data-act="edit" data-id="${p.id}">D√ºzenle</button>
                <button class="px-2 py-1 rounded-lg border border-rose-300 text-rose-700 bg-white" data-act="del" data-id="${p.id}">Sil</button>
            </div>`;
            listMobile.appendChild(card);
        }

        const logBody=$('#stok_logBody'); logBody.innerHTML='';
        for(const L of state.logs){ const p=findProduct(L.productId)||{name:'(silinmi≈ü √ºr√ºn)'}; const tr=document.createElement('tr'); const typeTxt=L.type==='in'?'Giri≈ü':(L.type==='out'?'√áƒ±kƒ±≈ü':(L.type==='adjustment'?'D√ºzeltme':L.type)); tr.innerHTML=`
            <td class="px-3 py-2">${new Date(L.ts).toLocaleString('tr-TR')}</td><td class="px-3 py-2">${p.name}</td>
            <td class="px-3 py-2">${typeTxt}</td><td class="px-3 py-2 text-right">${fmt(L.amount)}</td>
            <td class="px-3 py-2 text-right">${fmt(L.fromQty)}</td><td class="px-3 py-2 text-right">${fmt(L.toQty)}</td>
            <td class="px-3 py-2">${L.note||''}</td><td class="px-3 py-2">${L.user||"(bilinmiyor)"}</td>`; logBody.appendChild(tr); }
    }

    function openProductDialog(product){ const dlg=$('#stok_productDialog'); const form=$('#stok_productForm'); form.reset(); toggleConditionalSections(); if(product){ $('#stok_productDialogTitle').textContent='√úr√ºn√º D√ºzenle'; form.kind.value=product.kind||'mamul'; form.category.value=product.category||'stator'; form.name.value=product.name||''; form.sku.value=product.sku||''; form.unit.value=product.unit||''; form.min.value=product.min??0; form.note.value=product.note||''; form.kw.value=product.kw??''; form.rpm.value=product.rpm??''; form.volt.value=product.volt??''; form.milCode.value=product.milCode??''; form.customer.value=product.customer??''; form.pg_rpm.value=product.pg_rpm??''; form.pg_kw.value=product.pg_kw??''; form.pg_volt.value=product.pg_volt??''; form.pg_customer.value=product.pg_customer??''; form.pg_conn.value=product.pg_conn??'soketli'; form.m_rpm.value=product.m_rpm??''; form.m_kw.value=product.m_kw??''; form.m_volt.value=product.m_volt??''; form.m_conn.value=product.m_conn??'soketli'; form.milType.value=product.milType??''; form.m_cover.value=product.m_cover??'AK'; form.id.value=product.id; toggleConditionalSections(); } else { $('#stok_productDialogTitle').textContent='√úr√ºn Ekle'; form.kind.value='mamul'; form.category.value='stator'; form.id.value=''; suggestSku(true); toggleConditionalSections(); } dlg.showModal(); }
    
    function openMoveDialog(product,type){ const dlg=$('#stok_moveDialog'); const form=$('#stok_moveForm'); form.reset(); form.id.value=product.id; $('#stok_moveProductName').textContent=`${product.name} (${product.sku||'kod yok'})`; if(type){ document.querySelectorAll('#stok_moveForm input[name="type"]').forEach(r=>r.checked=(r.value===type)); } dlg.showModal(); }
    
    function exportJSON(){ const blob=new Blob([JSON.stringify({products:state.products,logs:state.logs},null,2)],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=`stok-data-${new Date().toISOString().replace(/[:.]/g,'-')}.json`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); }
    function exportCSV(){ const rows=[[ 'id','sku','name','kind','category','unit','material','qty','min','note','kw','rpm','volt','milCode','customer','pg_kw','pg_rpm','pg_volt','pg_customer','pg_conn','m_kw','m_rpm','m_volt','m_conn','milType' ]].concat( state.products.map(p=>[ p.id, p.sku, p.name, p.kind, p.category, p.unit, p.material,p.qty,p.min,(p.note||'').replaceAll('\n',' '), p.kw??'',p.rpm??'',p.volt??'',p.milCode??'',p.customer??'', p.pg_kw??'',p.pg_rpm??'',p.pg_volt??'',p.pg_customer??'',p.pg_conn??'', p.m_kw??'',p.m_rpm??'',p.m_volt??'',p.m_conn??'',p.milType??'' ]) ); const csv=rows.map(r=>r.map(x=>'"'+(String(x??'').replaceAll('"','""'))+'"').join(',')).join('\n'); const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=`stok-urunler-${new Date().toISOString().slice(0,10)}.csv`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); }
    function exportLogCSV(){ const rows=[['ts','product','type','amount','from','to','note','user']]; for(const L of state.logs){ const p=findProduct(L.productId)||{}; rows.push([L.ts,p.name||'',L.type,L.amount,L.fromQty,L.toQty,(L.note||'').replaceAll('\\n',' '), (L.user||'')]);} const csv=rows.map(r=>r.map(x=>'"'+(String(x??'').replaceAll('"','""'))+'"').join(',')).join('\n'); const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=`stok-log-${new Date().toISOString().slice(0,10)}.csv`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); }
    
    function importJSONFile(file){ const reader=new FileReader(); reader.onload=()=>{ try{ const data=JSON.parse(reader.result); if(!data||typeof data!=='object') throw new Error('Ge√ßersiz dosya'); state.products=ensureArray(data.products||[]); state.logs=ensureArray(data.logs||[]); save(); alert('ƒ∞√ße aktarƒ±ldƒ±'); }catch(e){ alert('Dosya okunamadƒ±: '+e.message); } }; reader.readAsText(file); }
    
    function toggleConditionalSections(){ 
        const form=$('#stok_productForm'); const cat=form.category.value; 
        document.querySelectorAll('#stok_productForm [data-section]').forEach(el => el.classList.add('hidden'));
        const section = document.querySelector(`#stok_productForm [data-section="${cat}"]`);
        if (section) section.classList.remove('hidden');
    }
    
    function nextSkuForCategory(cat){ const prefix=CATEGORY_PREFIX[cat]||'PRD'; let max=0; for(const p of state.products){ if(p.category!==cat) continue; const m=String(p.sku||'').match(new RegExp('^'+prefix+'-(\\d+)$')); if(m){ const n=parseInt(m[1],10); if(n>max) max=n; } } const next=String(max+1).padStart(4,'0'); return `${prefix}-${next}`; }
    function suggestSku(force=false){ const form=$('#stok_productForm'); const cat=form.category.value; const suggestion=nextSkuForCategory(cat); const prefix=(CATEGORY_PREFIX[cat]||'PRD')+'-'; if(force || !form.sku.value || !form.sku.value.startsWith(prefix)){ form.sku.value=suggestion; } else { if(state.products.some(p=>(p.sku||'').toLowerCase()===form.sku.value.toLowerCase())) form.sku.value=suggestion; } }
    
    function populateFilters() {
        const catSelect = $('#stok_filterCategory');
        catSelect.innerHTML = '<option value="">T√ºm √áe≈üitler</option>'; // Reset
        Object.entries(CATEGORY_LABEL).forEach(([key, label]) => {
            const option = document.createElement('option');
            option.value = key;
            option.textContent = label;
            catSelect.appendChild(option);
        });
    }

    $('#stok_btnAdd').addEventListener('click',()=>openProductDialog());
    $('#stok_btnAdd_mobile').addEventListener('click',()=>openProductDialog());
    
    const exportAction = () => exportJSON();
    $('#stok_btnExport').onclick = exportAction;
    $('#stok_btnExport_mobile').onclick = exportAction;

    const exportCSVAction = () => exportCSV();
    $('#stok_btnExportCSV').onclick = exportCSVAction;
    $('#stok_btnExportCSV_mobile').onclick = exportCSVAction;

    const exportLogCSVAction = () => exportLogCSV();
    $('#stok_btnExportLogCSV').onclick = exportLogCSVAction;
    $('#stok_btnExportLogCSV_mobile').onclick = exportLogCSVAction;

    const fileInput = $('#stok_fileInput');
    $('#stok_btnImport').onclick = () => fileInput.click();
    $('#stok_btnImport_mobile').onclick = () => fileInput.click();
    fileInput.addEventListener('change', e => { 
        const f=e.target.files?.[0]; 
        if(f) importJSONFile(f); 
        e.target.value='';
    });

    const clearAction = () => {
        if(!state.products.length && !state.logs.length){ alert('Zaten bo≈ü.'); return; } 
        if(confirm('T√ºm √ºr√ºnler ve hareket ge√ßmi≈üi silinsin mi? Bu i≈ülem geri alƒ±namaz.\nƒ∞≈ülemden √∂nce otomatik yedek indirilecektir.')){ 
            exportJSON(); 
            state.products=[]; 
            state.logs=[]; 
            save(); 
        }
    };
    $('#stok_btnClear').onclick = clearAction;
    $('#stok_btnClear_mobile').onclick = clearAction;

    $$('#stok_search, #stok_onlyLow, #stok_filterKind, #stok_filterCategory').forEach(el => el.addEventListener('input', render));
    $('#stok_btnClearFilters').addEventListener('click', () => {
        $('#stok_search').value = '';
        $('#stok_onlyLow').checked = false;
        $('#stok_filterKind').value = '';
        $('#stok_filterCategory').value = '';
        render();
    });

    $('#stok_thead').addEventListener('click',e=>{ const th=e.target.closest('th[data-sort]'); if(!th) return; const key=th.dataset.sort; if(sortBy===key) sortDir=(sortDir==='asc'?'desc':'asc'); else { sortBy=key; sortDir='asc'; } render(); });
    
    function delegate(container, selector, event, handler) {
        container.addEventListener(event, e => {
            const el = e.target.closest(selector);
            if (!el) return;
            handler(el, e);
        });
    }

    delegate(appContainer, 'button[data-id]', 'click', (btn) => {
        const id = btn.dataset.id;
        const p = findProduct(id);
        if (!p) return;
        const act = btn.dataset.act;
        if(act==='edit'){ openProductDialog(p); } 
        else if(act==='del'){ if(confirm('Silinsin mi?')){ state.products=state.products.filter(x=>x.id!==p.id); addLog({productId:p.id,type:'delete',amount:0,fromQty:p.qty||0,toQty:0,note:'√úr√ºn silindi'}); save(); } } 
        else if(act==='move-in'){ openMoveDialog(p,'in'); } 
        else if(act==='move-out'){ openMoveDialog(p,'out'); }
    });

    delegate($('#stok_tbodyDesktop'), '.editable-qty', 'dblclick', (td) => {
        const pId = td.dataset.id;
        const p = findProduct(pId);
        if (!p || td.querySelector('input')) return;

        const originalValue = Number(p.qty || 0);
        td.innerHTML = `<input type="number" step="any" value="${originalValue}" class="w-24 text-right px-1 py-0.5 border rounded-md bg-white">`;
        const input = td.querySelector('input');
        input.focus();
        input.select();

        const commitChange = () => {
            const newValue = Number(input.value);
            if (!Number.isFinite(newValue) || newValue === originalValue) {
                render(); return;
            }
            
            const diff = newValue - originalValue;
            p.qty = newValue;
            
            addLog({
                productId: p.id,
                type: 'adjustment',
                amount: diff,
                fromQty: originalValue,
                toQty: newValue,
                note: 'Manuel d√ºzeltme'
            });
            save(); 
        };

        input.addEventListener('blur', commitChange);
        input.addEventListener('keydown', e => {
            if (e.key === 'Enter') { e.preventDefault(); commitChange(); } 
            else if (e.key === 'Escape') { e.preventDefault(); render(); }
        });
    });

    $('#stok_productForm').addEventListener('submit',e=>{ e.preventDefault(); const form=e.target; const data=Object.fromEntries(new FormData(form).entries()); const isEdit=!!data.id; const min=Number(data.min||0); if(isNaN(min)||min<0){ alert('Minimum stok 0 veya daha b√ºy√ºk olmalƒ±'); return; } if(!data.name||!data.sku){ alert('Ad ve stok kodu zorunlu'); return; } if(data.category==='sargiliPaket'){ if(!(data.kw && data.rpm && data.volt)){ alert('Sargƒ±lƒ± paket i√ßin kW, rpm ve Volt zorunludur.'); return; } } if(['mil','rotorluMil','taslanmisMil'].includes(data.category)){ if(!data.milCode){ alert('Mil t√ºrlerinde Mil Kodu zorunludur.'); return; } }
      const clash=state.products.some(x=>x.id!==data.id && (x.sku||'').toLowerCase()===data.sku.toLowerCase()); if(clash){ alert('Bu stok kodu ba≈üka bir √ºr√ºnde kullanƒ±lƒ±yor. Otomatik yeni kod √∂nerilecek.'); form.sku.value=nextSkuForCategory(data.category); data.sku=form.sku.value; }
      const toNumOrNull = v => {const n=Number(v); return Number.isFinite(n)?n:null;};
      const pData = { kind:data.kind, category:data.category, name:data.name, sku:data.sku, unit:data.unit, min, note:data.note, kw:toNumOrNull(data.kw), rpm:toNumOrNull(data.rpm), volt:toNumOrNull(data.volt), milCode:data.milCode||'', customer:data.customer||'', m_rpm:toNumOrNull(data.m_rpm), m_kw:toNumOrNull(data.m_kw), m_volt:toNumOrNull(data.m_volt), m_conn:data.m_conn||'', m_cover:data.m_cover||'', milType:data.milType||'', pg_rpm:toNumOrNull(data.pg_rpm), pg_kw:toNumOrNull(data.pg_kw), pg_volt:toNumOrNull(data.pg_volt), pg_customer:data.pg_customer||'', pg_conn:data.pg_conn||'' };
      if(isEdit){ const p=findProduct(data.id); if(!p) return; Object.assign(p, pData); addLog({productId:p.id,type:'edit',amount:0,fromQty:p.qty||0,toQty:p.qty||0,note:'√úr√ºn bilgisi g√ºncellendi'}); } 
      else { const p={ id:uuid(), qty:0, ...pData }; state.products.unshift(p); addLog({productId:p.id,type:'new',amount:0,fromQty:0,toQty:0,note:'Yeni √ºr√ºn eklendi'}); }
      $('#stok_productDialog').close(); save(); });

    $('#stok_productCancelBtn').addEventListener('click',()=> $('#stok_productDialog').close());
    $('#stok_moveCancelBtn').addEventListener('click',()=> $('#stok_moveDialog').close());

    $('#stok_moveForm').addEventListener('submit', (e) => {
      e.preventDefault();
      const form = e.target;
      const data = Object.fromEntries(new FormData(form).entries());
      const p = findProduct(data.id);
      if(!p){ alert('√úr√ºn bulunamadƒ±'); return; }
      const amt = Number(data.amount);
      if(!(amt>0)){ alert('Miktar pozitif olmalƒ±'); return; }
      const from = Number(p.qty||0);
      const to = data.type==='in' ? from + amt : from - amt;
      p.qty = to;
      addLog({ productId:p.id, type:data.type, amount:amt, fromQty:from, toQty:to, note:data.note });
      $('#stok_moveDialog').close();
      save();
    });

    $('#stok_btnAutoSku').addEventListener('click', () => suggestSku());
    $('#stok_category').addEventListener('change', () => { if (!$('#stok_productForm').id.value) suggestSku(true); toggleConditionalSections(); });
    $('#stok_kind').addEventListener('change', toggleConditionalSections);

    document.addEventListener('keydown',e=>{ if((e.ctrlKey||e.metaKey)&&e.key.toLowerCase()==='k'){ e.preventDefault(); appContainer.querySelector('#stok_search').focus(); } });
    
    load();
    populateFilters();
    render();

    window.setStokTakipRefresher(() => {
        load();
        render();
    });
}
</script>

<!-- === Firebase RTDB Bridge === -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
  import { getDatabase, ref, onValue, set, get } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAyx_HVYwckqw2bYl_sdu57XPUP_tdDsxA",
    authDomain: "hertz-stok-takip.firebaseapp.com",
    databaseURL: "https://hertz-stok-takip-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "hertz-stok-takip",
    storageBucket: "hertz-stok-takip.firebasestorage.app",
    messagingSenderId: "512663727455",
    appId: "1:512663727455:web:99e15a20f7ae9b77a39aea",
    measurementId: "G-00WN8FD5K9"
  };

  const app = initializeApp(firebaseConfig);
  const db  = getDatabase(app);

  const KEYS = ["siparisler","siparisLog","sevkEdilenler","servisKayitlari","servisSevkEdilenler","stokTakip-v1"];
  const CLIENT_ID = 'client-' + Math.random().toString(36).slice(2);

  const enc = (s)=>encodeURIComponent(s);

  window.dataStore = {};
  let siparisServisRefresher = () => console.warn("Sipari≈ü yenileme fonksiyonu hen√ºz ayarlanmadƒ±.");
  let stokTakipRefresher = () => console.warn("Stok yenileme fonksiyonu hen√ºz ayarlanmadƒ±.");
  window.setSiparisServisRefresher = (fn) => { siparisServisRefresher = fn; };
  window.setStokTakipRefresher = (fn) => { stokTakipRefresher = fn; };
  
  window.pushData = async function(key) {
    if (!KEYS.includes(key)) return;
    const payload = { 
        value: window.dataStore[key], 
        updatedAt: Date.now(), 
        user: sessionStorage.getItem("auth_user") || "unknown",
        updatedBy: CLIENT_ID 
    };
    try {
        await set(ref(db, "ls/" + enc(key)), payload);
    } catch (error) {
        console.error(`Firebase set failed for key ${key}:`, error);
    }
  }
  
  const initialLoadPromises = KEYS.map(key => {
    return new Promise((resolve) => {
        const dbRef = ref(db, "ls/" + enc(key));
        get(dbRef).then(snap => {
            if (snap.exists()) {
                const remoteData = snap.val().value;
                window.dataStore[key] = (key === 'stokTakip-v1') ? (remoteData || {products:[], logs:[]}) : ensureArray(remoteData);
            } else {
                console.log(`Key ${key} Firebase'de bulunamadƒ±, varsayƒ±lan deƒüerle olu≈üturuluyor.`);
                window.dataStore[key] = key === 'stokTakip-v1' ? { products: [], logs: [] } : [];
                pushData(key);
            }
            resolve();
        }).catch(error => {
            console.error(`Firebase'den veri okunurken hata olu≈ütu (${key}):`, error);
            window.dataStore[key] = key === 'stokTakip-v1' ? { products: [], logs: [] } : [];
            resolve();
        });
    });
  });

  Promise.all(initialLoadPromises).then(() => {
      console.log("ƒ∞lk veri senkronizasyonu tamamlandƒ±. Aray√ºz ba≈ülatƒ±lƒ±yor.");
      initializePlatformApps();

      KEYS.forEach(key => {
          const dbRef = ref(db, "ls/" + enc(key));
          onValue(dbRef, (snap) => {
              const data = snap.val();
              if (!data || data.updatedBy === CLIENT_ID) {
                  return; 
              }
              
              console.log(`${key} i√ßin uzaktan g√ºncelleme geldi, aray√ºz yenileniyor.`);
              window.dataStore[key] = (key === 'stokTakip-v1') ? data.value : ensureArray(data.value);
              
              if (key === 'stokTakip-v1') {
                  stokTakipRefresher();
              } else {
                  siparisServisRefresher();
              }
          });
      });

      console.log("%cRTDB k√∂pr√º aktif: Ger√ßek zamanlƒ± senkronizasyon ba≈üladƒ±.","color:#16a34a;font-weight:600");
  });
</script>

</body>
</html>

